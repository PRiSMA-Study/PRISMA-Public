---
title: "Lab Report - Missingness Table"
date: "Issued: `r Sys.Date()`"
output:
  pdf_document:
    toc: no
    toc_depth: 5
    number_sections: true
    latex_engine: xelatex
    keep_tex: true
---

**Date of included data upload to Synapse: ** 2025-03-07

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%", fig.align = "center") 

library(tidyverse)
library(gt)

path_to_data = paste0("D:/Users/stacie.loisate/Documents/PRISMA-Analysis-Stacie/Lab-Missingness/data/")
load(paste0(path_to_data, "df_lab.RData"))


#define table format 
tb_theme2 <- function(matrix){
  tb <- matrix %>% 
    gt(
      rownames_to_stub = TRUE
    ) %>% 
    opt_align_table_header(align = "left") %>% 
    tab_spanner(
      label = "Site",
      columns = c(-Total)
    ) %>% 
    opt_stylize(style = 6, color = 'cyan') %>% 
    tab_style(
      style = list(
        cell_fill(color = "#016795"),
        cell_text(weight = "bold"),
        cell_text(v_align = "middle"),
        cell_text(color = "white")
      ),
      locations = list(
        cells_title()
      )
    ) %>% 
    tab_style(
      style = list(
        cell_fill(color = "#9edee0"),
        cell_text(weight = "bold"),
        cell_text(color = "black"),
        cell_text(v_align = "middle") 
      ),
      locations = list(
        cells_stubhead(),
        cells_column_spanners(),
        cells_column_labels() 
      )
    ) %>% 
    tab_style(
      style = list(
        cell_fill(color = "#ebfcf9"),
        cell_text(v_align = "middle") 
      ),
      locations = list(
        cells_stub()
      ) 
    ) %>% 
    tab_style(
      style = list(
        cell_text(align = "center") 
      ),
      locations = list(
        cells_column_labels(columns = everything())
      )
    ) %>% 
    tab_style(
      style = list(
        cell_text(align = "center") 
      ),
      locations = list(
        cells_body(columns = everything())
      ) 
    ) %>%
    fmt_markdown(columns = everything()) %>%
    tab_options(table.width = pct(100)) %>%
    cols_width(1 ~ px(200))
} 


setwd("D:/Users/stacie.loisate/Documents/PRISMA-Analysis-Stacie/Lab-Missingness/results/")
```

\tableofcontents

```{r define form missingness table}

#table
  #*****************table 1******************
matrix1 <- df_lab %>% 
  group_by(SITE) %>% 
  summarise(
    #en - expect forms as long as enrolled
    "Expected Form: N" = n(),
    "Missing MNH06: n (%)" = paste0(
      sum(is.na(M06_TYPE_VISIT_1), na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M06_TYPE_VISIT_1), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing MNH08: n (%)" = paste0(
      sum(is.na(M08_TYPE_VISIT_1), na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M08_TYPE_VISIT_1), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
      ")"),
    #anc20
    "Expected Form: N " = sum(denom_form_2 == 1, na.rm = TRUE),
    "Missing MNH06: n (%) " = paste0(
      sum(is.na(M06_TYPE_VISIT_2) & denom_form_2 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M06_TYPE_VISIT_2) & denom_form_2 == 1, na.rm = TRUE)/sum(denom_form_2 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing MNH08: n (%) " = paste0(
      sum(is.na(M08_TYPE_VISIT_2) & denom_form_2 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M08_TYPE_VISIT_2) & denom_form_2 == 1, na.rm = TRUE)/sum(denom_form_2 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    #anc28
    "Expected Form: N  " = sum(denom_form_3 == 1, na.rm = TRUE),
    "Missing MNH06: n (%)  " = paste0(
      sum(is.na(M06_TYPE_VISIT_3) & denom_form_3 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M06_TYPE_VISIT_3) & denom_form_3 == 1, na.rm = TRUE)/sum(denom_form_3 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing MNH08: n (%)  " = paste0(
      sum(is.na(M08_TYPE_VISIT_3) & denom_form_3 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M08_TYPE_VISIT_3) & denom_form_3 == 1, na.rm = TRUE)/sum(denom_form_3 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    #anc32
    "Expected Form: N   " = sum(denom_form_4 == 1, na.rm = TRUE),
    "Missing MNH06: n (%)   " = paste0(
      sum(is.na(M06_TYPE_VISIT_4) & denom_form_4 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M06_TYPE_VISIT_4) & denom_form_4 == 1, na.rm = TRUE)/sum(denom_form_4 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing MNH08: n (%)   " = paste0(
      sum(is.na(M08_TYPE_VISIT_4) & denom_form_4 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M08_TYPE_VISIT_4) & denom_form_4 == 1, na.rm = TRUE)/sum(denom_form_4 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    #anc36
    "Expected Form: N    " = sum(denom_form_5 == 1, na.rm = TRUE),
    "Missing MNH06: n (%)    " = paste0(
      sum(is.na(M06_TYPE_VISIT_5) & denom_form_5 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M06_TYPE_VISIT_5) & denom_form_5 == 1, na.rm = TRUE)/sum(denom_form_5 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing MNH08: n (%)    " = paste0(
      sum(is.na(M08_TYPE_VISIT_5) & denom_form_5 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M08_TYPE_VISIT_5) & denom_form_5 == 1, na.rm = TRUE)/sum(denom_form_5 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    #pnc0
    "Expected Form: N     " = sum(denom_form_7 == 1, na.rm = TRUE),
    "Missing MNH06: n (%)     " = paste0(
      sum(is.na(M06_TYPE_VISIT_7) & denom_form_7 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M06_TYPE_VISIT_7) & denom_form_7 == 1, na.rm = TRUE)/sum(denom_form_7 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing MNH08: n (%)     " = paste0(
      sum(is.na(M08_TYPE_VISIT_7) & denom_form_7 == 1 & SITE %in% c("Ghana", "India-CMC", "Zambia"), na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M08_TYPE_VISIT_7) & denom_form_7 == 1 & SITE %in% c("Ghana", "India-CMC", "Zambia"), na.rm = TRUE)/
                     sum(denom_form_7 == 1 & SITE %in% c("Ghana", "India-CMC", "Zambia"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    #pnc1
    "Expected Form: N      " = sum(denom_form_8 == 1, na.rm = TRUE),
    "Missing MNH06: n (%)      " = paste0(
      sum(is.na(M06_TYPE_VISIT_8) & denom_form_8 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M06_TYPE_VISIT_8) & denom_form_8 == 1, na.rm = TRUE)/sum(denom_form_8 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing MNH08: n (%)      " = paste0(
      sum(is.na(M08_TYPE_VISIT_8) & denom_form_8 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M08_TYPE_VISIT_8) & denom_form_8 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)/
                     sum(denom_form_8 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    #pnc4
    "Expected Form: N       " = sum(denom_form_9 == 1, na.rm = TRUE),
    "Missing MNH06: n (%)       " = paste0(
      sum(is.na(M06_TYPE_VISIT_9) & denom_form_9 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M06_TYPE_VISIT_9) & denom_form_9 == 1, na.rm = TRUE)/sum(denom_form_9 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing MNH08: n (%)       " = paste0(
      sum(is.na(M08_TYPE_VISIT_9) & denom_form_9 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M08_TYPE_VISIT_9) & denom_form_9 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)/
                     sum(denom_form_9 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    #pnc6
    "Expected Form: N        " = sum(denom_form_10 == 1, na.rm = TRUE),
    "Missing MNH06: n (%)        " = paste0(
      sum(is.na(M06_TYPE_VISIT_10) & denom_form_10 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M06_TYPE_VISIT_10) & denom_form_10 == 1, na.rm = TRUE)/sum(denom_form_10 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing MNH08: n (%)        " = paste0(
      sum(is.na(M08_TYPE_VISIT_10) & denom_form_10 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M08_TYPE_VISIT_10) & denom_form_10 == 1, na.rm = TRUE)/sum(denom_form_10 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    #pnc26
    "Expected Form: N         " = sum(denom_form_11 == 1, na.rm = TRUE),
    "Missing MNH06: n (%)         " = paste0(
      sum(is.na(M06_TYPE_VISIT_11) & denom_form_11 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M06_TYPE_VISIT_11) & denom_form_11 == 1, na.rm = TRUE)/sum(denom_form_11 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing MNH08: n (%)         " = paste0(
      sum(is.na(M08_TYPE_VISIT_11) & denom_form_11 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE), # "India-CMC",
      " (", 
      format(round(sum(is.na(M08_TYPE_VISIT_11) & denom_form_11 == 1 & SITE %in% c("Ghana",  "Zambia"), na.rm = TRUE)/
                     sum(denom_form_11 == 1 & SITE %in% c("Ghana",  "Zambia"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    #pnc52
    "Expected Form: N          " = sum(denom_form_12 == 1, na.rm = TRUE),
    "Missing MNH06: n (%)          " = paste0(
      sum(is.na(M06_TYPE_VISIT_12) & denom_form_12 == 1, na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M06_TYPE_VISIT_12) & denom_form_12 == 1, na.rm = TRUE)/sum(denom_form_12 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing MNH08: n (%)          " = paste0(
      sum(is.na(M08_TYPE_VISIT_12) & denom_form_12 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M08_TYPE_VISIT_12) & denom_form_12 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)/
                     sum(denom_form_12 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    #total 
  ) %>% 
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  add_column(
    .after = 6,
    "Total" = df_lab %>% 
      summarise(
        #en
    "Expected Form: N" = n(),
    "Missing MNH06: n (%)" = paste0(
      sum(is.na(M06_TYPE_VISIT_1), na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M06_TYPE_VISIT_1), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing MNH08: n (%)" = paste0(
      sum(is.na(M08_TYPE_VISIT_1), na.rm = TRUE), 
      " (", 
      format(round(sum(is.na(M08_TYPE_VISIT_1), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
      ")"),
        #anc20
        "Expected Form: N " = sum(denom_form_2 == 1, na.rm = TRUE),
        "Missing MNH06: n (%) " = paste0(
          sum(is.na(M06_TYPE_VISIT_2) & denom_form_2 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M06_TYPE_VISIT_2) & denom_form_2 == 1, na.rm = TRUE)/sum(denom_form_2 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing MNH08: n (%) " = paste0(
          sum(is.na(M08_TYPE_VISIT_2) & denom_form_2 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M08_TYPE_VISIT_2) & denom_form_2 == 1, na.rm = TRUE)/sum(denom_form_2 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #anc28
        "Expected Form: N  " = sum(denom_form_3 == 1, na.rm = TRUE),
        "Missing MNH06: n (%)  " = paste0(
          sum(is.na(M06_TYPE_VISIT_3) & denom_form_3 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M06_TYPE_VISIT_3) & denom_form_3 == 1, na.rm = TRUE)/sum(denom_form_3 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing MNH08: n (%)  " = paste0(
          sum(is.na(M08_TYPE_VISIT_3) & denom_form_3 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M08_TYPE_VISIT_3) & denom_form_3 == 1, na.rm = TRUE)/sum(denom_form_3 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #anc32
        "Expected Form: N   " = sum(denom_form_4 == 1, na.rm = TRUE),
        "Missing MNH06: n (%)   " = paste0(
          sum(is.na(M06_TYPE_VISIT_4) & denom_form_4 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M06_TYPE_VISIT_4) & denom_form_4 == 1, na.rm = TRUE)/sum(denom_form_4 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing MNH08: n (%)   " = paste0(
          sum(is.na(M08_TYPE_VISIT_4) & denom_form_4 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M08_TYPE_VISIT_4) & denom_form_4 == 1, na.rm = TRUE)/sum(denom_form_4 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #anc36
        "Expected Form: N    " = sum(denom_form_5 == 1, na.rm = TRUE),
        "Missing MNH06: n (%)    " = paste0(
          sum(is.na(M06_TYPE_VISIT_5) & denom_form_5 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M06_TYPE_VISIT_5) & denom_form_5 == 1, na.rm = TRUE)/sum(denom_form_5 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing MNH08: n (%)    " = paste0(
          sum(is.na(M08_TYPE_VISIT_5) & denom_form_5 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M08_TYPE_VISIT_5) & denom_form_5 == 1, na.rm = TRUE)/sum(denom_form_5 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #pnc0
        "Expected Form: N     " = sum(denom_form_7 == 1, na.rm = TRUE),
        "Missing MNH06: n (%)     " = paste0(
          sum(is.na(M06_TYPE_VISIT_7) & denom_form_7 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M06_TYPE_VISIT_7) & denom_form_7 == 1, na.rm = TRUE)/sum(denom_form_7 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing MNH08: n (%)     " = paste0(
          sum(is.na(M08_TYPE_VISIT_7) & denom_form_7 == 1 & SITE %in% c("Ghana", "India-CMC", "Zambia"), na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M08_TYPE_VISIT_7) & denom_form_7 == 1 & SITE %in% c("Ghana", "India-CMC", "Zambia"), na.rm = TRUE)/
                         sum(denom_form_7 == 1 & SITE %in% c("Ghana", "India-CMC", "Zambia"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #pnc1
        "Expected Form: N      " = sum(denom_form_8 == 1, na.rm = TRUE),
        "Missing MNH06: n (%)      " = paste0(
          sum(is.na(M06_TYPE_VISIT_8) & denom_form_8 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M06_TYPE_VISIT_8) & denom_form_8 == 1, na.rm = TRUE)/sum(denom_form_8 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing MNH08: n (%)      " = paste0(
          sum(is.na(M08_TYPE_VISIT_8) & denom_form_8 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M08_TYPE_VISIT_8) & denom_form_8 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)/
                         sum(denom_form_8 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #pnc4
        "Expected Form: N       " = sum(denom_form_9 == 1, na.rm = TRUE),
        "Missing MNH06: n (%)       " = paste0(
          sum(is.na(M06_TYPE_VISIT_9) & denom_form_9 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M06_TYPE_VISIT_9) & denom_form_9 == 1, na.rm = TRUE)/sum(denom_form_9 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing MNH08: n (%)       " = paste0(
          sum(is.na(M08_TYPE_VISIT_9) & denom_form_9 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M08_TYPE_VISIT_9) & denom_form_9 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)/
                         sum(denom_form_9 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #pnc6
        "Expected Form: N        " = sum(denom_form_10 == 1, na.rm = TRUE),
        "Missing MNH06: n (%)        " = paste0(
          sum(is.na(M06_TYPE_VISIT_10) & denom_form_10 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M06_TYPE_VISIT_10) & denom_form_10 == 1, na.rm = TRUE)/sum(denom_form_10 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing MNH08: n (%)        " = paste0(
          sum(is.na(M08_TYPE_VISIT_10) & denom_form_10 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M08_TYPE_VISIT_10) & denom_form_10 == 1, na.rm = TRUE)/sum(denom_form_10 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #pnc26
        "Expected Form: N         " = sum(denom_form_11 == 1, na.rm = TRUE),
        "Missing MNH06: n (%)         " = paste0(
          sum(is.na(M06_TYPE_VISIT_11) & denom_form_11 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M06_TYPE_VISIT_11) & denom_form_11 == 1, na.rm = TRUE)/sum(denom_form_11 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing MNH08: n (%)         " = paste0(
          sum(is.na(M08_TYPE_VISIT_11) & denom_form_11 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M08_TYPE_VISIT_11) & denom_form_11 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)/
                         sum(denom_form_11 == 1 & SITE %in% c("Ghana",  "Zambia"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #pnc52
        "Expected Form: N          " = sum(denom_form_12 == 1, na.rm = TRUE),
        "Missing MNH06: n (%)          " = paste0(
          sum(is.na(M06_TYPE_VISIT_12) & denom_form_12 == 1, na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M06_TYPE_VISIT_12) & denom_form_12 == 1, na.rm = TRUE)/sum(denom_form_12 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing MNH08: n (%)          " = paste0(
          sum(is.na(M08_TYPE_VISIT_12) & denom_form_12 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE), 
          " (", 
          format(round(sum(is.na(M08_TYPE_VISIT_12) & denom_form_12 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)/
                         sum(denom_form_12 == 1 & SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
      ) %>% 
      t() %>% unlist()
  ) %>% 
  #replace denomintor is 0 cells with space
  mutate_all(funs(str_replace(., "(NaN)", "-"))) 

#tests not expected at visit
matrix1[c(18), c("India-SAS", "Kenya", "Pakistan")] = "n/a"
matrix1[c(21,24,33), c("India-CMC", "India-SAS", "Kenya", "Pakistan")] = "n/a"
matrix1[c(30), c("India-CMC","India-SAS", "Kenya", "Pakistan")] = "n/a"

tb1_1 <- tb_theme2(matrix1 %>% slice(1:15)) %>% 
  tab_header(
    title = paste0("Table 1. Form missingness by site")
  ) %>%
  tab_stubhead(label = "Part I. ANC visits") %>%
  tab_row_group(
    label = "Enrollment",
    rows = 1:3
  ) %>%
  tab_row_group(
    label = "ANC20",
    rows = 4:6
  ) %>%
  tab_row_group(
    label = "ANC28",
    rows = 7:9
  ) %>%
  tab_row_group(
    label = "ANC32",
    rows = 10:12
  ) %>%
  tab_row_group(
    label = "ANC36",
    rows = 13:15
  ) %>%
  row_group_order(groups = c("Enrollment",
                             "ANC20",
                             "ANC28",
                             "ANC32",
                             "ANC36")) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_row_groups(groups = everything())
  ) %>%
  tab_footnote(
    footnote = c("Denominator for missing forms: Participants with form MNH06 or MNH08 or pass the late window and not close out within visit window. We expect MNH06 and MNH08 at enrollment once participants are enrolled.")
  ) %>%
  gtsave(paste0("results/missing_form_1.png"), expand = 10)
  
tb1_2 <- tb_theme2(matrix1 %>% slice(16:33)) %>% 
  tab_header(
    title = paste0("Table 1. Form missingness by site")
  ) %>%
  tab_stubhead(label = "Part II. PNC visits") %>%
  tab_row_group(
    label = "PNC0",
    rows = 1:3
  ) %>%
  tab_row_group(
    label = "PNC1",
    rows = 4:6
  ) %>%
  tab_row_group(
    label = "PNC4",
    rows = 7:9
  ) %>%
  tab_row_group(
    label = "PNC6",
    rows = 10:12
  ) %>%
  tab_row_group(
    label = "PNC26",
    rows = 13:15
  ) %>%
  tab_row_group(
    label = "PNC52",
    rows = 16:18
  ) %>%
  row_group_order(groups = c("PNC0",
                             "PNC1",
                             "PNC4",
                             "PNC6",
                             "PNC26",
                             "PNC52")) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_row_groups(groups = everything())
  ) %>%
  tab_footnote(
    footnote = c("Denominator for missing forms: Participants with form MNH06 or MNH08 or pass the late window and not close out within visit window")
  ) %>%
  tab_footnote(
    footnote = c("Note: n/a indicates forms are not expected at the visit. Total number excluded sites with n/a")
  ) %>%
  gtsave(paste0("results/missing_form_2.png"), expand = 10)
  
```  

```{r define matrix function}


missing_fun <- function(num, visit) {
 #*******************table 2.1 ********************
  matrix2_1 <- df_lab %>%
    filter(eval(parse(text = paste0("denom_lab_06_", num, " == 1")))) %>%
    group_by(SITE) %>%
    summarise(
      "Expected Lab Results from MNH06: N" = n(),
      "Missing POC Malaria: n (%)*" = paste0(
        sum(eval(parse(text = paste0("is.na(M06_MALARIA_POC_LBORRES_", num, ") "))) & SITE %in% c("Ghana", "Kenya", "Zambia")),
        " (",
        format(round(sum(eval(parse(text = paste0("is.na(M06_MALARIA_POC_LBORRES_", num, ") "))) & SITE %in% c("Ghana", "Kenya", "Zambia"))/sum(SITE %in% c("Ghana", "Kenya", "Zambia"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      "Missing POC HBV: n (%)*" = paste0(
        sum(eval(parse(text = paste0("is.na(M06_HBV_POC_LBORRES_", num, ") ")))),
        " (",
        format(round(sum(eval(parse(text = paste0("is.na(M06_HBV_POC_LBORRES_", num, ") "))))/n()*100, 2), nsmall = 0, digits = 2),
        ")"),
      "Missing POC HCV: n (%)*" = paste0(
        sum(eval(parse(text = paste0("is.na(M06_HCV_POC_LBORRES_", num, ") ")))),
        " (",
        format(round(sum(eval(parse(text = paste0("is.na(M06_HCV_POC_LBORRES_", num, ") "))))/n()*100, 2), nsmall = 0, digits = 2),
        ")"),
      "Expected HIV Results: N" = (sum(denom_hiv == 1, na.rm = TRUE)),
      "Missing POC HIV: n (%)**" = paste0(
        sum(eval(parse(text = paste0("is.na(M06_HIV_POC_LBORRES_", num, ") "))) & denom_hiv == 1, na.rm = TRUE),
        " (",
        format(round(sum(eval(parse(text = paste0("is.na(M06_HIV_POC_LBORRES_", num, ") ")))& denom_hiv == 1, na.rm = TRUE)/sum(denom_hiv == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
      #total
    ) %>%
    t() %>% as.data.frame() %>%
    `colnames<-`(c(.[1,])) %>%
    slice(-1) %>%
    add_column(
      .after = 6,
      "Total" = df_lab %>%
        filter(eval(parse(text = paste0("denom_lab_06_", num, " == 1")))) %>%
        summarise(
          "Expected Lab Results from MNH06: N" = n(),
          #En
      "Missing POC Malaria: n (%)*" = paste0(
        sum(eval(parse(text = paste0("is.na(M06_MALARIA_POC_LBORRES_", num, ") "))) & SITE %in% c("Ghana", "Kenya", "Zambia")),
        " (",
        format(round(sum(eval(parse(text = paste0("is.na(M06_MALARIA_POC_LBORRES_", num, ") "))) & SITE %in% c("Ghana", "Kenya", "Zambia"))/sum(SITE %in% c("Ghana", "Kenya", "Zambia"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
          #En
          "Missing POC HBV: n (%)*" = paste0(
            sum(eval(parse(text = paste0("is.na(M06_HBV_POC_LBORRES_", num, ") ")))),
            " (",
            format(round(sum(eval(parse(text = paste0("is.na(M06_HBV_POC_LBORRES_", num, ") "))))/n()*100, 2), nsmall = 0, digits = 2),
            ")"),
          #En
          "Missing POC HCV: n (%)*" = paste0(
            sum(eval(parse(text = paste0("is.na(M06_HCV_POC_LBORRES_", num, ") ")))),
            " (",
            format(round(sum(eval(parse(text = paste0("is.na(M06_HCV_POC_LBORRES_", num, ") "))))/n()*100, 2), nsmall = 0, digits = 2),
            ")"),
          "Expected HIV Results: N" = (sum(denom_hiv == 1, na.rm = TRUE)),
          "Missing POC HIV: n (%)**" = paste0(
        sum(eval(parse(text = paste0("is.na(M06_HIV_POC_LBORRES_", num, ") "))) & denom_hiv == 1, na.rm = TRUE),
        " (",
        format(round(sum(eval(parse(text = paste0("is.na(M06_HIV_POC_LBORRES_", num, ") ")))& denom_hiv == 1, na.rm = TRUE)/sum(denom_hiv == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
        ) %>%
        t() %>% unlist()
    ) %>%
    mutate_all(funs(str_replace(., "(NaN)", "-")))

#Pakistan stopped Malaria test, replace missing value with n/a
  matrix2_1[c(2), c("India-CMC", "India-SAS", "Pakistan")] = "n/a"

tb2_1 <- tb_theme2(matrix2_1) %>%
  # table title
 tab_header(
      title = paste0("Table 2. MNH06 lab result missingness by site - ", visit)
    ) %>%
    # stubhead label
  tab_stubhead(label = "Part I. Point-of-Care Lab Tests") %>%
  tab_row_group(
      label = "Missing POC lab results",
      rows = 1:4
    ) %>%
    tab_row_group(
      label = "Missing POC HIV results",
      rows = 5:6
    ) %>%
    row_group_order(groups = c("Missing POC lab results",
                               "Missing POC HIV results"
    )) %>%
    tab_footnote(
      footnote = c("*Denominator: Participants with complete MNH06 in person or by phone")
    ) %>%
      tab_footnote(
      footnote = c("**Denominator: Same denominator as above except known HIV +ve as documented by MOH doesn't expect POC HIV results in Kenya")
    ) %>%
    tab_footnote(
      footnote = c("Note: Pakistan stopped Malaria test on 2024-05-01. Total number excluded Pakistan.")
    ) %>%
    tab_footnote(
      footnote = c("Note: CMC stopped Malaria test on 2024-06-13. Total number excluded CMC.")
    ) %>%
    tab_footnote(
      footnote = c("Note: SAS stopped Malaria test on 2024-05-31. Total number excluded SAS.")
    ) %>%
    gtsave(paste0("results/missing_m06_", visit, "_1.png"), expand = 10)

#******************table 2.2 *****************
 if (num == 1) {
    matrix2_2 <- df_lab %>%
      group_by(SITE) %>%
      summarise(
        "Expected POC HB from MNH06: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing POC HB: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected CBC HB from MNH08: N" = sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing CBC HB: n (%)**" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected HB from MNH06 and MNH08: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing HB: n (%)***" = paste0(
          sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
          summarise(
            "Expected POC HB from MNH06: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing POC HB: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected CBC HB from MNH08: N" = sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing CBC HB: n (%)**" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected HB from MNH06 and MNH08: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing HB: n (%)***" = paste0(
              sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))
    
    tb2_2 <- tb_theme2(matrix2_2) %>%
      # table title
      tab_header(
        title = paste0("Table 2. Hemoglobin missingness by site - ", visit)
      ) %>%
      # stubhead label
      tab_stubhead(label = "Part II. Hemoglobin results (POC & CBC)") %>%
      tab_row_group(
        label = "Missing POC HB Test Results in MNH06",
        rows = 1:2
      ) %>%
      tab_row_group(
        label = "Missing CBC HB Test Results in MNH08",
        rows = 3:4
      ) %>%
      tab_row_group(
        label = "Missing HB Test Results in MNH06 and MNH08",
        rows = 5:6
      ) %>%
      row_group_order(groups = c("Missing POC HB Test Results in MNH06",
                                 "Missing CBC HB Test Results in MNH08"
      )) %>%
      tab_footnote(
        footnote = c("*Denominator: Participants with complete MNH06 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("**Denominator: Participants with complete MNH08 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("***Denominator: Participants with both complete MNH06 and MNH08 in person or by phone ")
      ) %>%
      tab_source_note(
        source_note = "Note: Grey fonts indicate test not done/required by site. Please check if it's truly not required."
      ) %>%
      tab_style(
        style = list(
          cell_text(color = "red") 
        ),
        locations = cells_source_notes()
      ) %>% 
      tab_style(
        style = list(
          cell_text(color = "grey") 
        ),
        locations = list(
          cells_body(columns = c("Ghana", "India-CMC", "India-SAS", "Zambia", "Total"),
                     rows = c(1,2)))) %>% 
      gtsave(paste0("results/missing_m06_", visit, "_2.png"), expand = 10)
  }
  
  if (num %in% c(2,3,5)) {
    matrix2_2 <- df_lab %>%
      group_by(SITE) %>%
      summarise(
        "Expected POC HB from MNH06: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE),
        "Missing POC HB: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected CBC HB from MNH08: N" = sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE),
        "Missing CBC HB: n (%)**" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE)/
                         sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected HB from MNH06 and MNH08: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing HB: n (%)***" = paste0(
          sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
          summarise(
            "Expected POC HB from MNH06: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing POC HB: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
        "Expected CBC HB from MNH08: N" = sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE),
        "Missing CBC HB: n (%)**" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE)/
                         sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
            "Expected HB from MNH06 and MNH08: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing HB: n (%)***" = paste0(
              sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))

    tb2_2 <- tb_theme2(matrix2_2) %>%
      # table title
      tab_header(
        title = paste0("Table 2. Hemoglobin missingness by site - ", visit)
      ) %>%
      # stubhead label
      tab_stubhead(label = "Part II. Hemoglobin results (POC & CBC)") %>%
      tab_row_group(
        label = "Missing POC HB Test Results in MNH06",
        rows = 1:2
      ) %>%
      tab_row_group(
        label = "Missing CBC HB Test Results in MNH08",
        rows = 3:4
      ) %>%
      tab_row_group(
        label = "Missing HB Test Results in MNH06 and MNH08",
        rows = 5:6
      ) %>%
      row_group_order(groups = c("Missing POC HB Test Results in MNH06",
                                 "Missing CBC HB Test Results in MNH08"
      )) %>%
      tab_footnote(
        footnote = c("*Denominator: Participants with complete MNH06 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("**Denominator: Participants with complete MNH08 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("***Denominator: Participants with both complete MNH06 and MNH08 in person or by phone ")
      ) %>%
      tab_footnote(
        footnote = c("Pakistan note: CBC test stopped from April 2024.")
      ) %>%
      tab_footnote(
        footnote = c("Kenya note: CBC collected for ReMAPP only.")
      ) %>%
      tab_source_note(
        source_note = "Note: Grey fonts indicate test not done/required by site. Please check if it's truly not required."
      ) %>%
      tab_style(
        style = list(
          cell_text(color = "red")
        ),
        locations = cells_source_notes()
      ) %>%
      tab_style(
        style = list(
          cell_text(color = "grey")
        ),
        locations = list(
          cells_body(columns = c("Ghana", "India-CMC", "India-SAS", "Zambia", "Total"),
                     rows = c(1,2)), 
                    cells_body(columns = c("Pakistan", "Total"),
                     rows = c(3,4))
        ))  %>%
      gtsave(paste0("results/missing_m06_", visit, "_2.png"), expand = 10)
  }

  if (num == 4) {
    matrix2_2 <- df_lab %>%
      group_by(SITE) %>%
      summarise(
        "Expected POC HB from MNH06: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing POC HB: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected CBC HB from MNH08: N" = sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing CBC HB: n (%)**" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected HB from MNH06 and MNH08: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing HB: n (%)***" = paste0(
          sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
          summarise(
            "Expected POC HB from MNH06: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing POC HB: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected CBC HB from MNH08: N" = sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing CBC HB: n (%)**" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected HB from MNH06 and MNH08: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing HB: n (%)***" = paste0(
              sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))
    
    tb2_2 <- tb_theme2(matrix2_2) %>%
      # table title
      tab_header(
        title = paste0("Table 2. Hemoglobin missingness by site - ", visit)
      ) %>%
      # stubhead label
      tab_stubhead(label = "Part II. Hemoglobin results (POC & CBC)") %>%
      tab_row_group(
        label = "Missing POC HB Test Results in MNH06",
        rows = 1:2
      ) %>%
      tab_row_group(
        label = "Missing CBC HB Test Results in MNH08",
        rows = 3:4
      ) %>%
      tab_row_group(
        label = "Missing HB Test Results in MNH06 and MNH08",
        rows = 5:6
      ) %>%
      row_group_order(groups = c("Missing POC HB Test Results in MNH06",
                                 "Missing CBC HB Test Results in MNH08"
      )) %>%
      tab_footnote(
        footnote = c("*Denominator: Participants with complete MNH06 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("**Denominator: Participants with complete MNH08 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("***Denominator: Participants with both complete MNH06 and MNH08 in person or by phone ")
      ) %>%
      tab_source_note(
        source_note = "Note: Grey fonts indicate test not done/required by site. Please check if it's truly not required."
      ) %>%
      tab_style(
        style = list(
          cell_text(color = "red") 
        ),
        locations = cells_source_notes()
      ) %>% 
      tab_style(
        style = list(
          cell_text(color = "grey") 
        ),
        locations = list(
          cells_body(columns = c("Ghana", "India-CMC", "Total"),
                     rows = c(1,2)), 
          cells_body(columns = c("India-SAS", "Kenya", "Zambia", "Total"),
                     rows = c(3,4))
        ))  %>% 
      gtsave(paste0("results/missing_m06_", visit, "_2.png"), expand = 10)
  }
  
  if (num == 7) {
    matrix2_2 <- df_lab %>%
      group_by(SITE) %>%
      summarise(
        "Expected POC HB from MNH06: N" = sum((SITE != "Kenya" | (SITE == "Kenya" & M06_DIAG_VSDAT_7 >= "2024-03-01")) & denom_lab_06_7 == 1, na.rm = TRUE),
        #all visits except IPC
        "Missing POC HB: n (%)*" = paste0(
          sum(is.na(M06_HB_POC_LBORRES_7) & denom_lab_06_7 == 1 & (SITE != "Kenya" | (SITE == "Kenya" & M06_DIAG_VSDAT_7 >= "2024-03-01")) , na.rm = TRUE),
          " (",
          format(round(sum(is.na(M06_HB_POC_LBORRES_7) & denom_lab_06_7 == 1 & (SITE != "Kenya" | (SITE == "Kenya" & M06_DIAG_VSDAT_7 >= "2024-03-01")) , na.rm = TRUE)/
                         sum((SITE != "Kenya" | (SITE == "Kenya" & M06_DIAG_VSDAT_7 >= "2024-03-01")) & denom_lab_06_7 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected CBC HB from MNH08: N" = sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing CBC HB: n (%)**" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected HB from MNH06 and MNH08: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing HB: n (%)***" = paste0(
          sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE)/
                         sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
          summarise(
            "Expected POC HB from MNH06: N" = sum((SITE != "Kenya" | (SITE == "Kenya" & M06_DIAG_VSDAT_7 >= "2024-03-01")) & denom_lab_06_7 == 1, na.rm = TRUE),
            #all visits except IPC
            "Missing POC HB: n (%)*" = paste0(
              sum(is.na(M06_HB_POC_LBORRES_7) & denom_lab_06_7 == 1 & (SITE != "Kenya" | (SITE == "Kenya" & M06_DIAG_VSDAT_7 >= "2024-03-01")) , na.rm = TRUE),
              " (",
              format(round(sum(is.na(M06_HB_POC_LBORRES_7) & denom_lab_06_7 == 1 & (SITE != "Kenya" | (SITE == "Kenya" & M06_DIAG_VSDAT_7 >= "2024-03-01")) , na.rm = TRUE)/
                             sum((SITE != "Kenya" | (SITE == "Kenya" & M06_DIAG_VSDAT_7 >= "2024-03-01")) & denom_lab_06_7 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
                     ")"),
            "Expected CBC HB from MNH08: N" = sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing CBC HB: n (%)**" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected HB from MNH06 and MNH08: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing HB: n (%)***" = paste0(
              sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))
    
    tb2_2 <- tb_theme2(matrix2_2) %>%
      # table title
      tab_header(
        title = paste0("Table 2. Hemoglobin missingness by site - ", visit)
      ) %>%
      # stubhead label
      tab_stubhead(label = "Part II. Hemoglobin results (POC & CBC)") %>%
      tab_row_group(
        label = "Missing POC HB Test Results in MNH06",
        rows = 1:2
      ) %>%
      tab_row_group(
        label = "Missing CBC HB Test Results in MNH08",
        rows = 3:4
      ) %>%
      tab_row_group(
        label = "Missing HB Test Results in MNH06 and MNH08",
        rows = 5:6
      ) %>%
      row_group_order(groups = c("Missing POC HB Test Results in MNH06",
                                 "Missing CBC HB Test Results in MNH08"
      )) %>%
      tab_footnote(
        footnote = c("*Denominator: Participants with complete MNH06 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("**Denominator: Participants with complete MNH08 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("***Denominator: Participants with both complete MNH06 and MNH08 in person or by phone")
      ) %>% 
      tab_footnote(
        footnote = c("Note: Showing missingess on/after the date v5.2 protocol of October 2023 was fully implemented (2024-03-01) for Kenya")
      ) %>%
      tab_source_note(
        source_note = "Note: Grey fonts indicate test not done/required by site. Please check if it's truly not required."
      ) %>%
      tab_style(
        style = list(
          cell_text(color = "red") 
        ),
        locations = cells_source_notes()
      ) %>% 
      tab_style(
        style = list(
          cell_text(color = "grey") 
        ),
        locations = list(
          cells_body(columns = c("Ghana","India-CMC","Total"),
                     rows = c(1,2)), 
          cells_body(columns = c("India-SAS", "Kenya", "Pakistan", "Zambia", "Total"),
                     rows = c(3,4))
        ))  %>% 
      gtsave(paste0("results/missing_m06_", visit, "_2.png"), expand = 10)
  }
  
  if (num %in% c(8,9,12)) {
    matrix2_2 <- df_lab %>%
      group_by(SITE) %>%
      summarise(
        "Expected POC HB from MNH06: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing POC HB: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected CBC HB from MNH08: N" = sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing CBC HB: n (%)**" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected HB from MNH06 and MNH08: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing HB: n (%)***" = paste0(
          sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
          summarise(
            "Expected POC HB from MNH06: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing POC HB: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected CBC HB from MNH08: N" = sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing CBC HB: n (%)**" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected HB from MNH06 and MNH08: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing HB: n (%)***" = paste0(
              sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))
    
    tb2_2 <- tb_theme2(matrix2_2) %>%
      # table title
      tab_header(
        title = paste0("Table 2. Hemoglobin missingness by site - ", visit)
      ) %>%
      # stubhead label
      tab_stubhead(label = "Part II. Hemoglobin results (POC & CBC)") %>%
      tab_row_group(
        label = "Missing POC HB Test Results in MNH06",
        rows = 1:2
      ) %>%
      tab_row_group(
        label = "Missing CBC HB Test Results in MNH08",
        rows = 3:4
      ) %>%
      tab_row_group(
        label = "Missing HB Test Results in MNH06 and MNH08",
        rows = 5:6
      ) %>%
      row_group_order(groups = c("Missing POC HB Test Results in MNH06",
                                 "Missing CBC HB Test Results in MNH08"
      )) %>%
      tab_footnote(
        footnote = c("*Denominator: Participants with complete MNH06 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("**Denominator: Participants with complete MNH08 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("***Denominator: Participants with both complete MNH06 and MNH08 in person or by phone ")
      ) %>%
      tab_source_note(
        source_note = "Note: Grey fonts indicate test not done/required by site. Please check if it's truly not required."
      ) %>%
      tab_style(
        style = list(
          cell_text(color = "red") 
        ),
        locations = cells_source_notes()
      ) %>% 
      tab_style(
        style = list(
          cell_text(color = "grey") 
        ),
        locations = list(
          cells_body(columns = c("Ghana", "Total"),
                     rows = c(1,2)), 
          cells_body(columns = c("India-CMC", "India-SAS", "Kenya", "Pakistan", "Zambia", "Total"),
                     rows = c(3,4))
        ))  %>% 
      gtsave(paste0("results/missing_m06_", visit, "_2.png"), expand = 10)
  }

  if (num == 10) {
    matrix2_2 <- df_lab %>%
      group_by(SITE) %>%
      summarise(
        "Expected POC HB from MNH06: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing POC HB: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected CBC HB from MNH08: N" = sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE),
        "Missing CBC HB: n (%)**" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE)/
                         sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected HB from MNH06 and MNH08: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing HB: n (%)***" = paste0(
          sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
          summarise(
            "Expected POC HB from MNH06: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing POC HB: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
        "Expected CBC HB from MNH08: N" = sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE),
        "Missing CBC HB: n (%)**" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE)/
                         sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
            "Expected HB from MNH06 and MNH08: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing HB: n (%)***" = paste0(
              sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))
    
    tb2_2 <- tb_theme2(matrix2_2) %>%
      # table title
      tab_header(
        title = paste0("Table 2. Hemoglobin missingness by site - ", visit)
      ) %>%
      # stubhead label
      tab_stubhead(label = "Part II. Hemoglobin results (POC & CBC)") %>%
      tab_row_group(
        label = "Missing POC HB Test Results in MNH06",
        rows = 1:2
      ) %>%
      tab_row_group(
        label = "Missing CBC HB Test Results in MNH08",
        rows = 3:4
      ) %>%
      tab_row_group(
        label = "Missing HB Test Results in MNH06 and MNH08",
        rows = 5:6
      ) %>%
      row_group_order(groups = c("Missing POC HB Test Results in MNH06",
                                 "Missing CBC HB Test Results in MNH08"
      )) %>%
      tab_footnote(
        footnote = c("*Denominator: Participants with complete MNH06 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("**Denominator: Participants with complete MNH08 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("***Denominator: Participants with both complete MNH06 and MNH08 in person or by phone ")
      ) %>%
      tab_footnote(
        footnote = c("Kenya note: CBC collected for ReMAPP only. Only expect CBC when SCRN_OBSSTDAT >= 2023-04-03.")
      ) %>%
      tab_source_note(
        source_note = "Note: Grey fonts indicate test not done/required by site. Please check if it's truly not required."
      ) %>%
      tab_style(
        style = list(
          cell_text(color = "red") 
        ),
        locations = cells_source_notes()
      ) %>% 
      tab_style(
        style = list(
          cell_text(color = "grey") 
        ),
        locations = list(
          cells_body(columns = c("Ghana", "India-CMC", "Total"),
                     rows = c(1,2))
        ))  %>% 
      gtsave(paste0("results/missing_m06_", visit, "_2.png"), expand = 10)
  }
  
  if (num == 11) {
    matrix2_2 <- df_lab %>%
      group_by(SITE) %>%
      summarise(
        "Expected POC HB from MNH06: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing POC HB: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected CBC HB from MNH08: N" = sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing CBC HB: n (%)**" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected HB from MNH06 and MNH08: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE),
        #all visits except IPC
        "Missing HB: n (%)***" = paste0(
          sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
          summarise(
            "Expected POC HB from MNH06: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing POC HB: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & denom_lab_06_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected CBC HB from MNH08: N" = sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing CBC HB: n (%)**" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HB_LBORRES_", num, ") & denom_lab_08_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected HB from MNH06 and MNH08: N" = sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE),
            #all visits except IPC
            "Missing HB: n (%)***" = paste0(
              sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M06_HB_POC_LBORRES_", num, ") & is.na(M08_CBC_HB_LBORRES_", num, ") & (denom_lab_06_", num, " == 1 & denom_lab_08_", num, " == 1)"))), na.rm = TRUE)/sum(eval(parse(text = paste0("denom_lab_06_", num, " == 1 & denom_lab_08_", num, "== 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))
    
    tb2_2 <- tb_theme2(matrix2_2) %>%
      # table title
      tab_header(
        title = paste0("Table 2. Hemoglobin missingness by site - ", visit)
      ) %>%
      # stubhead label
      tab_stubhead(label = "Part II. Hemoglobin results (POC & CBC)") %>%
      tab_row_group(
        label = "Missing POC HB Test Results in MNH06",
        rows = 1:2
      ) %>%
      tab_row_group(
        label = "Missing CBC HB Test Results in MNH08",
        rows = 3:4
      ) %>%
      tab_row_group(
        label = "Missing HB Test Results in MNH06 and MNH08",
        rows = 5:6
      ) %>%
      row_group_order(groups = c("Missing POC HB Test Results in MNH06",
                                 "Missing CBC HB Test Results in MNH08"
      )) %>%
      tab_footnote(
        footnote = c("*Denominator: Participants with complete MNH06 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("**Denominator: Participants with complete MNH08 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("***Denominator: Participants with both complete MNH06 and MNH08 in person or by phone ")
      ) %>%
      tab_source_note(
        source_note = "Note: Grey fonts indicate test not done/required by site. Please check if it's truly not required."
      ) %>%
      tab_style(
        style = list(
          cell_text(color = "red") 
        ),
        locations = cells_source_notes()
      ) %>% 
      tab_style(
        style = list(
          cell_text(color = "grey") 
        ),
        locations = list(
          cells_body(columns = c("Ghana", "Total"),
                     rows = c(1,2)), 
          cells_body(columns = c("India-CMC", "India-SAS", "Pakistan", "Zambia", "Total"),
                     rows = c(3,4))
        ))  %>% 
      gtsave(paste0("results/missing_m06_", visit, "_2.png"), expand = 10)
  }

 #******************table 2.3 *****************
 #use unscheduled ANC data
load(paste0(path_to_data, "mnh06.RData"))
load(paste0(path_to_data, "mnh08.RData"))
load(paste0(path_to_data, "MAT_ENROLL.RData"))

 # load("derived_data/mnh06.rda")
 # load("derived_data/mnh08.rda")
 # load("derived_data/MAT_ENROLL.rda")
 
 #extract test results from unscheduled ANC test
 poc_13 <- mnh06 %>% 
   filter(M06_TYPE_VISIT == 13 & M06_BGLUC_POC_MMOLL_LBORRES >= 0 & M06_BGLUC_POC_MMOLL_LBORRES < 55) %>% 
   select(SITE, MOMID, PREGID, M06_BGLUC_POC_MMOLL_LBORRES, M06_DIAG_VSDAT) %>% 
   left_join(MAT_ENROLL %>% select(SITE, MOMID, PREGID, PREG_START_DATE)) %>% 
   mutate(ga_wks = as.numeric(ymd(M06_DIAG_VSDAT) - ymd(PREG_START_DATE))/7) %>% 
   filter(ga_wks >= 26) %>%
   group_by(SITE, MOMID, PREGID) %>% 
   mutate(n = n()) %>% 
   filter(n == 1 | row_number() == 1) %>%  # Keep one row per group if n > 1
   ungroup() %>%
   select(SITE, MOMID, PREGID, M06_BGLUC_POC_MMOLL_LBORRES, M06_DIAG_VSDAT)
 
  pretest_13 <- mnh08 %>% 
   filter(M08_TYPE_VISIT == 13 & M08_BGLUC_PRETEST_MMOLL_LBORRES >= 0 & M08_BGLUC_PRETEST_MMOLL_LBORRES < 55) %>% 
   select(SITE, MOMID, PREGID, M08_BGLUC_PRETEST_MMOLL_LBORRES, M08_LBSTDAT) %>% 
   left_join(MAT_ENROLL %>% select(SITE, MOMID, PREGID, PREG_START_DATE)) %>% 
   mutate(ga_wks = as.numeric(ymd(M08_LBSTDAT) - ymd(PREG_START_DATE))/7) %>% 
   filter(ga_wks >= 26) %>% 
   group_by(SITE, MOMID, PREGID) %>% 
   mutate(n = n()) %>% 
   filter(n == 1 | row_number() == 1) %>%  # Keep one row per group if n > 1
   ungroup() %>%
   select(SITE, MOMID, PREGID, M08_BGLUC_PRETEST_MMOLL_LBORRES)
  
  h1_13 <- mnh08 %>% 
   filter(M08_TYPE_VISIT == 13 & M08_BGLUC_ORAL_1HR_MMOLL_LBORRES >= 0 & M08_BGLUC_ORAL_1HR_MMOLL_LBORRES < 55) %>% 
   select(SITE, MOMID, PREGID, M08_BGLUC_ORAL_1HR_MMOLL_LBORRES, M08_LBSTDAT) %>% 
   left_join(MAT_ENROLL %>% select(SITE, MOMID, PREGID, PREG_START_DATE)) %>% 
   mutate(ga_wks = as.numeric(ymd(M08_LBSTDAT) - ymd(PREG_START_DATE))/7) %>% 
   filter(ga_wks >= 26) %>% 
   group_by(SITE, MOMID, PREGID) %>% 
   mutate(n = n()) %>% 
   filter(n == 1 | row_number() == 1) %>%  # Keep one row per group if n > 1
   ungroup() %>%
   select(SITE, MOMID, PREGID, M08_BGLUC_ORAL_1HR_MMOLL_LBORRES)
    
  h2_13 <- mnh08 %>% 
   filter(M08_TYPE_VISIT == 13 & M08_BGLUC_ORAL_2HR_MMOLL_LBORRES >= 0 & M08_BGLUC_ORAL_2HR_MMOLL_LBORRES < 55) %>% 
   select(SITE, MOMID, PREGID, M08_BGLUC_ORAL_2HR_MMOLL_LBORRES, M08_LBSTDAT) %>% 
   left_join(MAT_ENROLL %>% select(SITE, MOMID, PREGID, PREG_START_DATE)) %>% 
   mutate(ga_wks = as.numeric(ymd(M08_LBSTDAT) - ymd(PREG_START_DATE))/7) %>% 
   filter(ga_wks >= 26) %>% 
   group_by(SITE, MOMID, PREGID) %>% 
   mutate(n = n()) %>% 
   filter(n == 1 | row_number() == 1) %>%  # Keep one row per group if n > 1
   ungroup() %>%
   select(SITE, MOMID, PREGID, M08_BGLUC_ORAL_2HR_MMOLL_LBORRES)

 #including all later visit for ogtt
 df_ogtt <- df_lab %>%
    filter((denom_lab_08_3 == 1 | denom_lab_06_3 == 1) & (denom_glucose == 1)) %>%
    select(SITE, MOMID, PREGID, denom_lab_06_3, denom_lab_08_3,
           num_range("M06_BGLUC_POC_MMOLL_LBORRES_", 3:5),
           num_range("M08_BGLUC_PRETEST_MMOLL_LBORRES_", 3:5),
           num_range("M08_BGLUC_ORAL_1HR_MMOLL_LBORRES_", 3:5),
           num_range("M08_BGLUC_ORAL_2HR_MMOLL_LBORRES_", 3:5),
           num_range("M06_DIAG_VSDAT_", 3:5)
           ) %>% 
   left_join(poc_13) %>% 
   left_join(pretest_13) %>% 
   left_join(h1_13) %>% 
   left_join(h2_13) 
   
  
  poc_glucose_cols <- names(df_ogtt)[grep("^M06_BGLUC_POC_MMOLL_LBORRES", names(df_ogtt))]
  fast_glucose_cols <- names(df_ogtt)[grep("^M08_BGLUC_PRETEST_MMOLL_LBORRES", names(df_ogtt))]
  h1_glucose_cols <- names(df_ogtt)[grep("^M08_BGLUC_ORAL_1HR_MMOLL_LBORRES", names(df_ogtt))]
  h2_glucose_cols <- names(df_ogtt)[grep("^M08_BGLUC_ORAL_2HR_MMOLL_LBORRES", names(df_ogtt))]
  poc_glucose_date_cols <- names(df_ogtt)[grep("^M06_DIAG_VSDAT", names(df_ogtt))]

  #Ghana test break date  
df_ogtt <- df_ogtt %>% 
  rowwise() %>% 
  mutate(denom_poc_glucose_gh = case_when(
    SITE != "Ghana" ~ 1,
    if_any(poc_glucose_date_cols, ~.x >= "2023-05-12" & .x <= "2023-10-19") ~ 1,  
    if_any(poc_glucose_date_cols, ~.x >= "2024-04-08") ~ 1,
    TRUE ~ 0
  )) %>% 
  ungroup()
    
    matrix2_3 <- df_ogtt %>%
      group_by(SITE) %>%
      summarise(
        "Expected POC Blood Glucose Results from MNH06: N" = sum(denom_lab_06_3 == 1 & !(SITE %in% c("India-CMC", "India-SAS", "Pakistan")) & denom_poc_glucose_gh == 1, na.rm = TRUE),
        #Glucose (ANC-28)
        "Missing POC Blood Glucose: n (%)*" = paste0(
          sum(if_all(poc_glucose_cols, is.na) & denom_lab_06_3 == 1 & !(SITE %in% c("India-CMC", "India-SAS", "Pakistan")) & denom_poc_glucose_gh == 1, na.rm = TRUE),
          " (",
          format(round(sum(if_all(poc_glucose_cols, is.na) & denom_lab_06_3 == 1 & !(SITE %in% c("India-CMC", "India-SAS", "Pakistan")) & denom_poc_glucose_gh == 1, na.rm = TRUE)/sum(denom_lab_06_3 == 1 & !(SITE %in% c("India-CMC", "India-SAS", "Pakistan")) & denom_poc_glucose_gh == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #Glucose (ANC-28)
        "Expected Fasting Glucose Results from MNH08: N" = sum(denom_lab_08_3 == 1, na.rm = TRUE),
        "Missing Fasting Glucose: n (%)**" = paste0(
          sum(if_all(fast_glucose_cols, is.na) & denom_lab_08_3 == 1, na.rm = TRUE),
          " (",
          format(round(sum(if_all(fast_glucose_cols, is.na) & denom_lab_08_3 == 1, na.rm = TRUE)/sum(denom_lab_08_3 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected Oral Glucose-tolerance (1-hour) Results from MNH08: N" = sum(denom_lab_08_3 == 1 & SITE != "India-SAS", na.rm = TRUE),
        #Glucose (ANC-28)
        "Missing Oral Glucose-tolerance (1-hour): n (%)**" = paste0(
          sum(if_all(h1_glucose_cols, is.na) & denom_lab_08_3 == 1 & SITE != "India-SAS", na.rm = TRUE),
          " (",
          format(round(sum(if_all(h1_glucose_cols, is.na) & denom_lab_08_3 == 1 & SITE != "India-SAS", na.rm = TRUE)/sum(denom_lab_08_3 == 1 & SITE != "India-SAS", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #Glucose (ANC-28)
        "Expected Oral Glucose-tolerance (2-hour) Results from MNH08: N" = sum(denom_lab_08_3 == 1, na.rm = TRUE),
        "Missing Oral Glucose-tolerance (2-hour): n (%)**" = paste0(
          sum(if_all(h2_glucose_cols, is.na) & denom_lab_08_3 == 1, na.rm = TRUE),
          " (",
          format(round(sum(if_all(h2_glucose_cols, is.na) & denom_lab_08_3 == 1, na.rm = TRUE)/sum(denom_lab_08_3 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_ogtt %>%
          summarise(
        "Expected POC Blood Glucose Results from MNH06: N" = sum(denom_lab_06_3 == 1 & !(SITE %in% c("India-CMC", "India-SAS", "Pakistan")) & denom_poc_glucose_gh == 1, na.rm = TRUE),
        #Glucose (ANC-28)
        "Missing POC Blood Glucose: n (%)*" = paste0(
          sum(if_all(poc_glucose_cols, is.na) & denom_lab_06_3 == 1 & !(SITE %in% c("India-CMC", "India-SAS", "Pakistan")) & denom_poc_glucose_gh == 1, na.rm = TRUE),
          " (",
          format(round(sum(if_all(poc_glucose_cols, is.na) & denom_lab_06_3 == 1 & !(SITE %in% c("India-CMC", "India-SAS", "Pakistan")) & denom_poc_glucose_gh == 1, na.rm = TRUE)/sum(denom_lab_06_3 == 1 & !(SITE %in% c("India-CMC", "India-SAS", "Pakistan")) & denom_poc_glucose_gh == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
            #Glucose (ANC-28)
            "Expected Fasting Glucose Results from MNH08: N" = sum(denom_lab_08_3 == 1, na.rm = TRUE),
            "Missing Fasting Glucose: n (%)**" = paste0(
              sum(if_all(fast_glucose_cols, is.na) & denom_lab_08_3 == 1, na.rm = TRUE),
              " (",
              format(round(sum(if_all(fast_glucose_cols, is.na) & denom_lab_08_3 == 1, na.rm = TRUE)/sum(denom_lab_08_3 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected Oral Glucose-tolerance (1-hour) Results from MNH08: N" = sum(denom_lab_08_3 == 1 & SITE != "India-SAS", na.rm = TRUE),
            #Glucose (ANC-28)
            "Missing Oral Glucose-tolerance (1-hour): n (%)**" = paste0(
              sum(if_all(h1_glucose_cols, is.na) & denom_lab_08_3 == 1 & SITE != "India-SAS", na.rm = TRUE),
              " (",
              format(round(sum(if_all(h1_glucose_cols, is.na) & denom_lab_08_3 == 1 & SITE != "India-SAS", na.rm = TRUE)/sum(denom_lab_08_3 == 1 & SITE != "India-SAS", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            #Glucose (ANC-28)
            "Expected Oral Glucose-tolerance (2-hour) Results from MNH08: N" = sum(denom_lab_08_3 == 1, na.rm = TRUE),
            "Missing Oral Glucose-tolerance (2-hour): n (%)**" = paste0(
              sum(if_all(h2_glucose_cols, is.na) & denom_lab_08_3 == 1, na.rm = TRUE),
              " (",
              format(round(sum(if_all(h2_glucose_cols, is.na) & denom_lab_08_3 == 1, na.rm = TRUE)/sum(denom_lab_08_3 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))
    
    #SAS not performing 1 hour timepoint, in their SOP from the start
    matrix2_3[c(5,6), c("India-SAS")] = "n/a"
    #Pakistan: No POC blood glucose performed
    matrix2_3[c(1,2), c("India-CMC", "India-SAS", "Pakistan")] = "n/a"
    
    tb2_3 <- tb_theme2(matrix2_3) %>%
      # table title
      tab_header(
        title = paste0("Table 2. Blood glucose missingness by site - ", visit)
      ) %>%
      # stubhead label
      tab_stubhead(label = "Part III. Blood Glucose Results (POC & OGTT)") %>%
      tab_row_group(
        label = "Missing POC Blood Glucose Results",
        rows = 1:2
      ) %>%
      tab_row_group(
        label = "Missing fasting Oral Glucose Tolerance Results",
        rows = 3:4
      ) %>%
      tab_row_group(
        label = "Missing Oral Glucose-tolerance (1-hour) Results",
        rows = 5:6
      ) %>%
      tab_row_group(
        label = "Missing Oral Glucose-tolerance (2-hour) Results",
        rows = 7:8
      ) %>%
      row_group_order(groups = c("Missing POC Blood Glucose Results",
                                 "Missing fasting Oral Glucose Tolerance Results",
                                 "Missing Oral Glucose-tolerance (1-hour) Results",
                                 "Missing Oral Glucose-tolerance (2-hour) Results"
      )) %>%
      tab_footnote(
        footnote = c("*Denominator: Participants with complete MNH06 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("**Denominator: Participants with complete MNH08 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("Note: POC blood glucose is not performed at CMC, SAS and Pakistan. Expected lab results from MNH06 and total number excluded CMC, SAS and Pakistan")
      ) %>%
      tab_footnote(
        footnote = c("Note: 1 Hour Oral Glucose-tolerance is not performed at India-SAS. Total number excluded India-SAS.")
      ) %>%
      tab_footnote(
        footnote = c("Note: Test completed at ANC32 or ANC36 or unscheduled visit on/after 26 gestational weeks are also included.")
      ) %>%
      tab_footnote(
        footnote = c("Ghana note: Poc glucose test between 2023-10-20 and 2024-04-08. Denominator removed this period.")
      ) %>%
      gtsave(paste0("results/missing_m06_", visit, "_3.png"), expand = 10)
    
#******************table 2.4*****************
 if (num == 1) {
    matrix2_4 <- df_lab %>%
      group_by(SITE) %>%
      summarise(
        "Expected Lab Results from MNH06: N" = sum(denom_lab_06_1 == 1, na.rm = TRUE),
        "Missing POC Syphilis: n (%)*" = paste0(
          sum(is.na(M06_SYPH_POC_LBORRES_1) & denom_lab_06_1 == 1, na.rm = TRUE),
          " (",
          format(round(sum(is.na(M06_SYPH_POC_LBORRES_1) & denom_lab_06_1 == 1, na.rm = TRUE)/
                         sum(denom_lab_06_1 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #complete syphilis titers if RDT is positive
        "Expected Syphilis Titers Lab Test from MNH08: N" = sum(M06_SYPH_POC_LBORRES_1 == 1 &
                                                                  denom_lab_08_1 == 1 &
                                                                  denom_syphilis_enroll == 1, na.rm = TRUE),
        "Missing Syphilis Titers Lab Test: n (%)**" = paste0(
          sum(is.na(M08_SYPH_TITER_LBORRES_1) & M06_SYPH_POC_LBORRES_1 == 1 &
                denom_lab_08_1 == 1 & denom_syphilis_enroll == 1, na.rm = TRUE),
          " (",
          format(round(sum(is.na(M08_SYPH_TITER_LBORRES_1) & M06_SYPH_POC_LBORRES_1 == 1 &
                             denom_lab_08_1 == 1 & denom_syphilis_enroll == 1, na.rm = TRUE)/
                         sum(M06_SYPH_POC_LBORRES_1 == 1 & denom_lab_08_1 == 1 &
                               denom_syphilis_enroll == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected Syphilis Titers Highest Positive Dilution Results from MNH08: N" = sum(M06_SYPH_POC_LBORRES_1 == 1 &
                                                                                           M08_SYPH_TITER_LBORRES_1 == 1 &
                                                                                           denom_lab_08_1 == 1 &
                                                                                           denom_syphilis_enroll == 1, na.rm = TRUE),
        #M08_SYPH_TITER_LBORRES_4 positive
        "Missing Syphilis Titers Highest Positive Dilution Results: n (%)***" = paste0(
          sum(is.na(M08_SYPH_TITER_RATIO_LBORRES_1) & M06_SYPH_POC_LBORRES_1 == 1 &
                M08_SYPH_TITER_LBORRES_1 == 1 & denom_lab_08_1 == 1 & denom_syphilis_enroll == 1, na.rm = TRUE),
          " (",
          format(round(sum(is.na(M08_SYPH_TITER_RATIO_LBORRES_1) & M06_SYPH_POC_LBORRES_1 == 1 &
                             M08_SYPH_TITER_LBORRES_1 == 1 & denom_lab_08_1 == 1 & denom_syphilis_enroll == 1, na.rm = TRUE)/
                         sum(M06_SYPH_POC_LBORRES_1 == 1 & M08_SYPH_TITER_LBORRES_1 == 1 &
                               denom_lab_08_1 == 1 & denom_syphilis_enroll == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
          summarise(
            "Expected Lab Results from MNH06: N" = sum(denom_lab_06_1 == 1, na.rm = TRUE),
            "Missing POC Syphilis: n (%)*" = paste0(
              sum(is.na(M06_SYPH_POC_LBORRES_1) & denom_lab_06_1 == 1, na.rm = TRUE),
              " (",
              format(round(sum(is.na(M06_SYPH_POC_LBORRES_1) & denom_lab_06_1 == 1, na.rm = TRUE)/
                             sum(denom_lab_06_1 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            #complete syphilis titers if RDT is positive
            "Expected Syphilis Titers Lab Test from MNH08: N" = sum(M06_SYPH_POC_LBORRES_1 == 1 &
                                                                      denom_lab_08_1 == 1 &
                                                                      denom_syphilis_enroll == 1, na.rm = TRUE),
            "Missing Syphilis Titers Lab Test: n (%)**" = paste0(
              sum(is.na(M08_SYPH_TITER_LBORRES_1) & M06_SYPH_POC_LBORRES_1 == 1 &
                    denom_lab_08_1 == 1 & denom_syphilis_enroll == 1, na.rm = TRUE),
              " (",
              format(round(sum(is.na(M08_SYPH_TITER_LBORRES_1) & M06_SYPH_POC_LBORRES_1 == 1 &
                                 denom_lab_08_1 == 1 & denom_syphilis_enroll == 1, na.rm = TRUE)/
                             sum(M06_SYPH_POC_LBORRES_1 == 1 & denom_lab_08_1 == 1 &
                                   denom_syphilis_enroll == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected Syphilis Titers Highest Positive Dilution Results from MNH08: N" = sum(M06_SYPH_POC_LBORRES_1 == 1 &
                                                                                               M08_SYPH_TITER_LBORRES_1 == 1 &
                                                                                               denom_lab_08_1 == 1 &
                                                                                               denom_syphilis_enroll == 1, na.rm = TRUE),
            #M08_SYPH_TITER_LBORRES_4 positive
            "Missing Syphilis Titers Highest Positive Dilution Results: n (%)***" = paste0(
              sum(is.na(M08_SYPH_TITER_RATIO_LBORRES_1) & M06_SYPH_POC_LBORRES_1 == 1 &
                    M08_SYPH_TITER_LBORRES_1 == 1 & denom_lab_08_1 == 1 & denom_syphilis_enroll == 1, na.rm = TRUE),
              " (",
              format(round(sum(is.na(M08_SYPH_TITER_RATIO_LBORRES_1) & M06_SYPH_POC_LBORRES_1 == 1 &
                                 M08_SYPH_TITER_LBORRES_1 == 1 & denom_lab_08_1 == 1 & denom_syphilis_enroll == 1, na.rm = TRUE)/
                             sum(M06_SYPH_POC_LBORRES_1 == 1 & M08_SYPH_TITER_LBORRES_1 == 1 &
                                   denom_lab_08_1 == 1 & denom_syphilis_enroll == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))
    
    tb2_4 <- tb_theme2(matrix2_4) %>%
      # table title
      tab_header(
        title = paste0("Table 2. Syphilis lab test missingness by site - ", visit)
      ) %>%
      # stubhead label
      tab_stubhead(label = "Part IV. Syphilis Test Results") %>%
      tab_footnote(
        footnote = c("*Denominator: Participants with complete MNH06 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("**Denominator: Participants with a positive treponemal RDT, for whom the site has initiated a Syphilis titer test, and who have completed MNH08 either in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("***Denominator: Participants with positive non-treponemal antibody titer. This denominator will likely differ from the denominator used for “Expected Syphilis Titers Lab Test” as participants may have a positive RDT and then a negative non-treponemal antibody titer lab test")
      ) %>%
      tab_footnote(
        footnote = c("Note: Syphilis titer test start date for enrollment are: 
                     Ghana: 2024-04-09; CMC: 2023-07-18; SAS: 2024-03-11; Kenya: 2024-03-06; Pakistan: 2024-04-05; Zambia: 2023-11-09")
      ) %>%
      gtsave(paste0("results/missing_m06_", visit, "_4.png"), expand = 10)
  }

 if (num == 4) {
    matrix2_4 <- df_lab %>%
      group_by(SITE) %>%
      summarise(
        "Expected Lab Results from MNH06: N" = sum(M06_SYPH_POC_LBORRES_1 == 0 & 
                                                     ((denom_lab_06_4 == 1 & SITE != "Zambia") | 
                                                        (denom_lab_06_3 == 1 & SITE == "Zambia")), na.rm = TRUE),
        "Missing POC Syphilis: n (%)*" = paste0(
          sum(((is.na(M06_SYPH_POC_LBORRES_4) & SITE != "Zambia" & denom_lab_06_4 == 1) | 
                 (is.na(M06_SYPH_POC_LBORRES_3) & SITE == "Zambia" & denom_lab_06_3== 1)) & 
                 M06_SYPH_POC_LBORRES_1 == 0, na.rm = TRUE),
          " (",
          format(round(sum(((is.na(M06_SYPH_POC_LBORRES_4) & SITE != "Zambia" & denom_lab_06_4 == 1) | 
                              (is.na(M06_SYPH_POC_LBORRES_3) & SITE == "Zambia" & denom_lab_06_3== 1)) & 
                             M06_SYPH_POC_LBORRES_1 == 0, na.rm = TRUE)/
                         sum(M06_SYPH_POC_LBORRES_1 == 0 & 
                               ((denom_lab_06_4 == 1 & SITE != "Zambia") | 
                                  (denom_lab_06_3 == 1 & SITE == "Zambia")), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #complete syphilis titers if RDT is positive
        "Expected Syphilis Titers Lab Test from MNH08: N" = sum((M06_SYPH_POC_LBORRES_1 == 1 | 
                                                                   (M06_SYPH_POC_LBORRES_4 == 1 & SITE != "Zambia" & denom_lab_08_4 == 1) |
                                                                   (M06_SYPH_POC_LBORRES_3 == 1 & SITE == "Zambia" & denom_lab_08_3 == 1)) & 
                                                                  denom_syphilis_anc32 == 1, na.rm = TRUE),
        "Missing Syphilis Titers Lab Test: n (%)**" = paste0(
          sum(((is.na(M08_SYPH_TITER_LBORRES_4) & (M06_SYPH_POC_LBORRES_1 == 1 | M06_SYPH_POC_LBORRES_4 == 1) & SITE != "Zambia" & denom_lab_08_4 == 1) |
               (is.na(M08_SYPH_TITER_LBORRES_3) & (M06_SYPH_POC_LBORRES_1 == 1 | M06_SYPH_POC_LBORRES_3 == 1) & SITE == "Zambia" & denom_lab_08_3 == 1)) &
                denom_syphilis_anc32 == 1, na.rm = TRUE),
          " (",
          format(round(
            sum(((is.na(M08_SYPH_TITER_LBORRES_4) & (M06_SYPH_POC_LBORRES_1 == 1 | M06_SYPH_POC_LBORRES_4 == 1) & SITE != "Zambia" & denom_lab_08_4 == 1) |
                              (is.na(M08_SYPH_TITER_LBORRES_3) & (M06_SYPH_POC_LBORRES_1 == 1 | M06_SYPH_POC_LBORRES_3 == 1) & SITE == "Zambia" & denom_lab_08_3 == 1)) &
                             denom_syphilis_anc32 == 1, na.rm = TRUE)/
              sum((M06_SYPH_POC_LBORRES_1 == 1 | 
                     (M06_SYPH_POC_LBORRES_4 == 1 & SITE != "Zambia" & denom_lab_08_4 == 1) |
                     (M06_SYPH_POC_LBORRES_3 == 1 & SITE == "Zambia" & denom_lab_08_3 == 1)) & 
                    denom_syphilis_anc32 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected Syphilis Titers Highest Positive Dilution Results from MNH08: N" = sum(
          ((M08_SYPH_TITER_LBORRES_4 == 1 & SITE != "Zambia" & denom_lab_08_4 == 1) |
             (M08_SYPH_TITER_LBORRES_3 == 1 & SITE == "Zambia" & denom_lab_08_3 == 1)) &
                  denom_syphilis_anc32 == 1, na.rm = TRUE),
        #M08_SYPH_TITER_LBORRES_4 positive
        "Missing Syphilis Titers Highest Positive Dilution Results: n (%)***" = paste0(
          sum(((is.na(M08_SYPH_TITER_RATIO_LBORRES_4) & M08_SYPH_TITER_LBORRES_4 == 1 & SITE != "Zambia" & denom_lab_08_4 == 1) |
                 (is.na(M08_SYPH_TITER_RATIO_LBORRES_3) & M08_SYPH_TITER_LBORRES_3 == 1 & SITE == "Zambia" & denom_lab_08_3 == 1)) & 
                denom_syphilis_anc32 == 1, na.rm = TRUE),
          " (",
          format(round(sum(((is.na(M08_SYPH_TITER_RATIO_LBORRES_4) & M08_SYPH_TITER_LBORRES_4 == 1 & SITE != "Zambia" & denom_lab_08_4 == 1) |
                              (is.na(M08_SYPH_TITER_RATIO_LBORRES_3) & M08_SYPH_TITER_LBORRES_3 == 1 & SITE == "Zambia" & denom_lab_08_3 == 1)) & 
                             denom_syphilis_anc32 == 1, na.rm = TRUE)/
                         sum(((M08_SYPH_TITER_LBORRES_4 == 1 & SITE != "Zambia" & denom_lab_08_4 == 1) |
                              (M08_SYPH_TITER_LBORRES_3 == 1 & SITE == "Zambia" & denom_lab_08_3 == 1)) &
                             denom_syphilis_anc32 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
          summarise(
            "Expected Lab Results from MNH06: N" = sum(M06_SYPH_POC_LBORRES_1 == 0 & 
                                                         ((denom_lab_06_4 == 1 & SITE != "Zambia") | 
                                                            (denom_lab_06_3 == 1 & SITE == "Zambia")), na.rm = TRUE),
            "Missing POC Syphilis: n (%)*" = paste0(
              sum(((is.na(M06_SYPH_POC_LBORRES_4) & SITE != "Zambia" & denom_lab_06_4 == 1) | 
                     (is.na(M06_SYPH_POC_LBORRES_3) & SITE == "Zambia" & denom_lab_06_3== 1)) & 
                    M06_SYPH_POC_LBORRES_1 == 0, na.rm = TRUE),
              " (",
              format(round(sum(((is.na(M06_SYPH_POC_LBORRES_4) & SITE != "Zambia" & denom_lab_06_4 == 1) | 
                                  (is.na(M06_SYPH_POC_LBORRES_3) & SITE == "Zambia" & denom_lab_06_3== 1)) & 
                                 M06_SYPH_POC_LBORRES_1 == 0, na.rm = TRUE)/
                             sum(M06_SYPH_POC_LBORRES_1 == 0 & 
                                   ((denom_lab_06_4 == 1 & SITE != "Zambia") | 
                                      (denom_lab_06_3 == 1 & SITE == "Zambia")), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            #complete syphilis titers if RDT is positive
            "Expected Syphilis Titers Lab Test from MNH08: N" = sum((M06_SYPH_POC_LBORRES_1 == 1 | 
                                                                       (M06_SYPH_POC_LBORRES_4 == 1 & SITE != "Zambia" & denom_lab_08_4 == 1) |
                                                                       (M06_SYPH_POC_LBORRES_3 == 1 & SITE == "Zambia" & denom_lab_08_3 == 1)) & 
                                                                      denom_syphilis_anc32 == 1, na.rm = TRUE),
            "Missing Syphilis Titers Lab Test: n (%)**" = paste0(
              sum(((is.na(M08_SYPH_TITER_LBORRES_4) & (M06_SYPH_POC_LBORRES_1 == 1 | M06_SYPH_POC_LBORRES_4 == 1) & SITE != "Zambia" & denom_lab_08_4 == 1) |
                     (is.na(M08_SYPH_TITER_LBORRES_3) & (M06_SYPH_POC_LBORRES_1 == 1 | M06_SYPH_POC_LBORRES_3 == 1) & SITE == "Zambia" & denom_lab_08_3 == 1)) &
                    denom_syphilis_anc32 == 1, na.rm = TRUE),
              " (",
              format(round(
                sum(((is.na(M08_SYPH_TITER_LBORRES_4) & (M06_SYPH_POC_LBORRES_1 == 1 | M06_SYPH_POC_LBORRES_4 == 1) & SITE != "Zambia" & denom_lab_08_4 == 1) |
                       (is.na(M08_SYPH_TITER_LBORRES_3) & (M06_SYPH_POC_LBORRES_1 == 1 | M06_SYPH_POC_LBORRES_3 == 1) & SITE == "Zambia" & denom_lab_08_3 == 1)) &
                      denom_syphilis_anc32 == 1, na.rm = TRUE)/
                  sum((M06_SYPH_POC_LBORRES_1 == 1 | 
                         (M06_SYPH_POC_LBORRES_4 == 1 & SITE != "Zambia" & denom_lab_08_4 == 1) |
                         (M06_SYPH_POC_LBORRES_3 == 1 & SITE == "Zambia" & denom_lab_08_3 == 1)) & 
                        denom_syphilis_anc32 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected Syphilis Titers Highest Positive Dilution Results from MNH08: N" = sum(
              ((M08_SYPH_TITER_LBORRES_4 == 1 & SITE != "Zambia" & denom_lab_08_4 == 1) |
                 (M08_SYPH_TITER_LBORRES_3 == 1 & SITE == "Zambia" & denom_lab_08_3 == 1)) &
                denom_syphilis_anc32 == 1, na.rm = TRUE),
            #M08_SYPH_TITER_LBORRES_4 positive
            "Missing Syphilis Titers Highest Positive Dilution Results: n (%)***" = paste0(
              sum(((is.na(M08_SYPH_TITER_RATIO_LBORRES_4) & M08_SYPH_TITER_LBORRES_4 == 1 & SITE != "Zambia" & denom_lab_08_4 == 1) |
                     (is.na(M08_SYPH_TITER_RATIO_LBORRES_3) & M08_SYPH_TITER_LBORRES_3 == 1 & SITE == "Zambia" & denom_lab_08_3 == 1)) & 
                    denom_syphilis_anc32 == 1, na.rm = TRUE),
              " (",
              format(round(sum(((is.na(M08_SYPH_TITER_RATIO_LBORRES_4) & M08_SYPH_TITER_LBORRES_4 == 1 & SITE != "Zambia" & denom_lab_08_4 == 1) |
                                  (is.na(M08_SYPH_TITER_RATIO_LBORRES_3) & M08_SYPH_TITER_LBORRES_3 == 1 & SITE == "Zambia" & denom_lab_08_3 == 1)) & 
                                 denom_syphilis_anc32 == 1, na.rm = TRUE)/
                             sum(((M08_SYPH_TITER_LBORRES_4 == 1 & SITE != "Zambia" & denom_lab_08_4 == 1) |
                                    (M08_SYPH_TITER_LBORRES_3 == 1 & SITE == "Zambia" & denom_lab_08_3 == 1)) &
                                   denom_syphilis_anc32 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))
    
    tb2_4 <- tb_theme2(matrix2_4) %>%
      # table title
      tab_header(
        title = paste0("Table 2. Syphilis lab test missingness by site - ", visit)
      ) %>%
      # stubhead label
      tab_stubhead(label = "Part IV. Syphilis Test Results") %>%
      tab_footnote(
        footnote = c("*Denominator: Participants with negative treponemal RDT at enrollment and complete MNH06 in person or by phone at ANC32 visit")
      ) %>%
      tab_footnote(
        footnote = c("**Denominator: Participants with a positive treponemal RDT at enrollment or at ANC32 visit, for whom the site has initiated a Syphilis titer test for ANC32 visit, and who have completed MNH08 either in person or by phone.")
      ) %>%
      tab_footnote(
        footnote = c("***Denominator: Participants with positive non-treponemal antibody titer. This denominator will likely differ from the denominator used for “Expected Syphilis Titers Lab Test” as participants may have a positive RDT and then a negative non-treponemal antibody titer lab test")
      ) %>%
      tab_footnote(
        footnote = c("Note: Syphilis titer test start date for ANC32 are: 
                     Ghana: 2024-04-09; CMC: 2023-07-18; SAS: 2024-07-29; Kenya: 2024-03-06; Pakistan: 2024-10-24; Zambia: 2023-11-09")
      ) %>%
      tab_footnote(
        footnote = c("Note: Zambia is performing syphilis test on ANC28 instead of ANC32")
      ) %>%
      gtsave(paste0("results/missing_m06_", visit, "_4.png"), expand = 10)
  }


#******************table 3.1*****************
if (num == 1) {
    matrix3_1 <- df_lab %>%
    filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
  group_by(SITE) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),
"Missing Blood Group: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_BLD_GRP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_BLD_GRP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing RH Factor: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_RH_FACTOR_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_RH_FACTOR_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#total
  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .after = 6,
    "Total" = df_lab %>%
  filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),
"Missing Blood Group: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_BLD_GRP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_BLD_GRP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing RH Factor: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_RH_FACTOR_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_RH_FACTOR_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
  ) %>%
      t() %>% unlist()
  ) %>%
    mutate_all(funs(str_replace(., "(NaN)", "-")))

tb3_1 <- tb_theme2(matrix3_1) %>%
  # table title
  tab_header(
    title = paste0("Table 3. MNH08 lab result missingness by site - Enrollment")
  ) %>%
  # stubhead label
  tab_stubhead(label = "Part I. Blood Typing Results") %>%
    tab_row_group(
    label = "Missing Blood Typing Results",
    rows = 2:3
  ) %>%
  row_group_order(groups = c(NA,
                             "Missing Blood Typing Results"
  )) %>%
  tab_footnote(
    footnote = c("*Denominator: Participants with complete MNH08 in person or by phone")
  ) %>%
  gtsave(paste0("results/missing_m08_", visit, "_1.png"), expand = 10)
}

 #*******************table 3.2********************
  if(num %in% c(1)) {
    matrix3_2 <- df_lab %>%
      filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
      group_by(SITE) %>%
      summarise(
        "Expected Lab Results from MNH08: N" = n(),
        #En, ANC20, ANC28, ANC36, PNC6 for all below
        "Missing Hematocrit (HCT): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing White Blood Cells (WBC): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Neutrophils (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Neutrophils (full cell count) : n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE) *100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Lymphocyte (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Lymphocyte (full cell count): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Erythrocyte Count: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Mean Cell Volume (MCV): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Mean Cell Hemoglobin (MCH): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Mean Corpuscular Hemoglobin Concentration (MCHC): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Platelets count: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Monocyte (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Monocyte (full cell count): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
          "Missing Eosinophils (%): n (%)*" = paste0(
            sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE), #  & SITE != "Pakistan"
          " (",
             format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
            ")"),
    
          "Missing Eosinophils (full cell count): n (%)*" = paste0(
            sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))) , na.rm = TRUE),
            " (",
           format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
            ")"),
        "Missing Red Cell Width (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Platelet Distribution Width (PDW): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum( eval(parse(text = paste0("pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Plateletcrit (PCT) (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum(!SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
          filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
          summarise(
            "Expected Lab Results from MNH08: N" = n(),
            "Missing Hematocrit (HCT): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing White Blood Cells (WBC): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Neutrophils (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Neutrophils (full cell count) : n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE) *100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Lymphocyte (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Lymphocyte (full cell count): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Erythrocyte Count: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Mean Cell Volume (MCV): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Mean Cell Hemoglobin (MCH): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Mean Corpuscular Hemoglobin Concentration (MCHC): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Platelets count: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Monocyte (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Monocyte (full cell count): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          "Missing Eosinophils (%): n (%)*" = paste0(
            sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE), #  & SITE != "Pakistan"
          " (",
             format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
            ")"),
    
          "Missing Eosinophils (full cell count): n (%)*" = paste0(
            sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))) , na.rm = TRUE),
            " (",
           format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
            ")"),
            "Missing Red Cell Width (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
    "Missing Platelet Distribution Width (PDW): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum( eval(parse(text = paste0("pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Plateletcrit (PCT) (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum(!SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))

    #neutrophils full cell count, lymphocytes full cell count, Monocyte (full cell count), eosinophils full cell count, plateletcrit, platelet distribution width are not performed at Pakistan
    matrix3_2[c(5,7,14,18,19), c("Pakistan")] = "n/a"
    matrix3_2[c(18,19), c("India-SAS")] = "n/a"

tb3_2 <- tb_theme2(matrix3_2) %>%
  # table title
  tab_header(
    title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
  ) %>%
  # stubhead label
  tab_stubhead(label = "Part II. CBC Results") %>%
  tab_row_group(
    label = "Missing CBC Results",
    rows = 2:19
  ) %>%
  row_group_order(groups = c(NA,
                             "Missing CBC Results"
  )) %>%
  tab_footnote(
    footnote = c("*Denominator: Participants with complete MNH08 in person or by phone")
  ) %>%
      tab_footnote(
    footnote = c("Note: Neutrophils full cell count, lymphocytes full cell count, monocyte full cell count, plateletcrit, platelet distribution width are not performed at Pakistan. Total number excluded Pakistan.")
  ) %>%
    tab_footnote(
    footnote = c("Note: Plateletcrit, platelet distribution width are not performed at India-SAS. Total number excluded India-SAS.")
  ) %>%
    tab_footnote(
    footnote = c("Note: Kenya started platelet distribution width (PDW) testing after 2023-03-29.")
  ) %>%
  tab_options(table.width = pct(100)) %>%
  #revise column width
  cols_width(1 ~ px(225)) %>%
  gtsave(paste0("results/missing_m08_", visit, "_2.png"), expand = 10)
}

 if(num %in% c(2)) {
    matrix3_2 <- df_lab %>%
      # filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & SITE != "Pakistan") %>%
        filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (!SITE %in% c("Pakistan", "Kenya", "Ghana", "India-SAS") | 
                                                                              (SITE == "Kenya" & denom_remapp == 1) | 
                                                                              (SITE == "Pakistan" & denom_remapp==1) |
                                                                              (SITE == "Ghana" & denom_remapp==1)|
                                                                              (SITE == "India-SAS" & denom_post_enrll_cbc==1)
                                                                              )) %>%
      group_by(SITE) %>%
      summarise(
        "Expected Lab Results from MNH08: N" = n(),
        #En, ANC20, ANC28, ANC36, PNC6 for all below
        "Missing Hematocrit (HCT): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing White Blood Cells (WBC): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Neutrophils (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Neutrophils (full cell count) : n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE) *100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Lymphocyte (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Lymphocyte (full cell count): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Erythrocyte Count: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Mean Cell Volume (MCV): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Mean Cell Hemoglobin (MCH): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Mean Corpuscular Hemoglobin Concentration (MCHC): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Platelets count: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Monocyte (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Monocyte (full cell count): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Eosinophils (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE), #  & SITE != "Pakistan"
          " (",
            format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
          # format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          # ")"),
        # "Missing Eosinophils (full cell count): n (%)*" = paste0(
        #   sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
        #   " (",
        #   format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        #   ")"),
          "Missing Eosinophils (full cell count): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))) , na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Red Cell Width (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        
        "Missing Platelet Distribution Width (PDW): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum( eval(parse(text = paste0("pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
        "Missing Plateletcrit (PCT) (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum(!SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
        filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (!SITE %in% c("Pakistan", "Kenya", "Ghana", "India-SAS") | 
                                                                              (SITE == "Kenya" & denom_remapp == 1) | 
                                                                              (SITE == "Pakistan" & denom_remapp==1) |
                                                                              (SITE == "Ghana" & denom_remapp==1)|
                                                                              (SITE == "India-SAS" & denom_post_enrll_cbc==1)
                                                                              )) %>%
          summarise(
            "Expected Lab Results from MNH08: N" = n(),
            "Missing Hematocrit (HCT): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing White Blood Cells (WBC): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Neutrophils (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Neutrophils (full cell count) : n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE) *100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Lymphocyte (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Lymphocyte (full cell count): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Erythrocyte Count: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Mean Cell Volume (MCV): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Mean Cell Hemoglobin (MCH): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Mean Corpuscular Hemoglobin Concentration (MCHC): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Platelets count: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Monocyte (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Monocyte (full cell count): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
             "Missing Eosinophils (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE), #  & SITE != "Pakistan"
              " (",
                format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
    
              "Missing Eosinophils (full cell count): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))) , na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Red Cell Width (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
              "Missing Platelet Distribution Width (PDW): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum( eval(parse(text = paste0("pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Plateletcrit (PCT) (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum(!SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))

    #neutrophils full cell count, lymphocytes full cell count, Monocyte (full cell count), eosinophils full cell count, plateletcrit, platelet distribution width are not performed at Pakistan
    # matrix3_2[, c("Pakistan")] = "n/a"
    matrix3_2[c(5,7,14,18,19), c("Pakistan")] = "n/a" ## 15/16 removed
    matrix3_2[c(18,19), c("India-SAS")] = "n/a"
    matrix3_2 <- matrix3_2 %>% relocate(Pakistan, .after = Kenya)

  tb3_2 <- tb_theme2(matrix3_2) %>%
  # table title
  tab_header(
    title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
  ) %>%
  # stubhead label
  tab_stubhead(label = "Part II. CBC Results") %>%
  tab_row_group(
    label = "Missing CBC Results",
    rows = 2:19
  ) %>%
  row_group_order(groups = c(NA,
                             "Missing CBC Results"
  )) %>%
  tab_footnote(
    footnote = c("*Denominator: Participants with complete MNH08 in person or by phone")
  ) %>%
      tab_footnote(
    footnote = c("Pakistan note: Neutrophils full cell count, lymphocytes full cell count, monocyte full cell count,  plateletcrit, platelet distribution width are not performed. Remaining CBC testing stopped from 2024-04-05") ## eosinophils %, eosinophils full cell count,
  ) %>%
     tab_footnote(
    footnote = c("Ghana note: CBC testing stopped from 2024-10-29.")
  ) %>%
    tab_footnote(
    footnote = c("SAS Note: Plateletcrit, platelet distribution width are not performed at India-SAS. Post-enrollment CBC testing started on 2024-07-22.")
  ) %>%
    tab_footnote(
    footnote = c("Kenya Note: started platelet distribution width (PDW) testing after 2023-03-29.")
  ) %>%
  tab_options(table.width = pct(100)) %>%
  #revise column width
  cols_width(1 ~ px(225)) %>%
  gtsave(paste0("results/missing_m08_", visit, "_2.png"), expand = 10)
 }
    
#CBC for Kenya only for ReMAPP
  if(num %in% c(3,10)) {
    matrix3_2 <- df_lab %>%
        filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (!SITE %in% c("Pakistan", "Kenya", "Ghana", "India-SAS") | 
                                                                              (SITE == "Kenya" & denom_remapp == 1) | 
                                                                              (SITE == "Pakistan" & denom_remapp==1) |
                                                                              (SITE == "Ghana" & denom_remapp==1)|
                                                                              (SITE == "India-SAS" & denom_post_enrll_cbc==1)
                                                                              )) %>%
      group_by(SITE) %>%
      summarise(
        "Expected Lab Results from MNH08: N" = n(),
        #En, ANC20, ANC28, ANC36, PNC6 for all below
        "Missing Hematocrit (HCT): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing White Blood Cells (WBC): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Neutrophils (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Neutrophils (full cell count) : n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE) *100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Lymphocyte (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Lymphocyte (full cell count): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Erythrocyte Count: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Mean Cell Volume (MCV): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Mean Cell Hemoglobin (MCH): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Mean Corpuscular Hemoglobin Concentration (MCHC): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Platelets count: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Monocyte (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Monocyte (full cell count): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
          "Missing Eosinophils (%): n (%)*" = paste0(
            sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE), #  & SITE != "Pakistan"
          " (",
             format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
            ")"),
    
          "Missing Eosinophils (full cell count): n (%)*" = paste0(
            sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))) , na.rm = TRUE),
            " (",
           format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
            ")"),
        "Missing Red Cell Width (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
            "Missing Platelet Distribution Width (PDW): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum( eval(parse(text = paste0("pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
        "Missing Plateletcrit (PCT) (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum(!SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
        filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (!SITE %in% c("Pakistan", "Kenya", "Ghana", "India-SAS") | 
                                                                              (SITE == "Kenya" & denom_remapp == 1) | 
                                                                              (SITE == "Pakistan" & denom_remapp==1) |
                                                                              (SITE == "Ghana" & denom_remapp==1)|
                                                                              (SITE == "India-SAS" & denom_post_enrll_cbc==1)
                                                                              )) %>%
          summarise(
            "Expected Lab Results from MNH08: N" = n(),
            "Missing Hematocrit (HCT): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing White Blood Cells (WBC): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Neutrophils (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Neutrophils (full cell count) : n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE) *100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Lymphocyte (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Lymphocyte (full cell count): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Erythrocyte Count: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Mean Cell Volume (MCV): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Mean Cell Hemoglobin (MCH): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Mean Corpuscular Hemoglobin Concentration (MCHC): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Platelets count: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Monocyte (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Monocyte (full cell count): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          "Missing Eosinophils (%): n (%)*" = paste0(
            sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE), #  & SITE != "Pakistan"
          " (",
             format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
            ")"),
    
          "Missing Eosinophils (full cell count): n (%)*" = paste0(
            sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))) , na.rm = TRUE),
            " (",
           format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
            ")"),
            "Missing Red Cell Width (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
          ## new code >>
              "Missing Platelet Distribution Width (PDW): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum( eval(parse(text = paste0("pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Plateletcrit (PCT) (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum(!SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))

    #neutrophils full cell count, lymphocytes full cell count, Monocyte (full cell count), eosinophils full cell count, plateletcrit, platelet distribution width are not performed at Pakistan
    matrix3_2[c(5,7,14,18,19), c("Pakistan")] = "n/a"
    matrix3_2[c(18,19), c("India-SAS")] = "n/a"
    
  tb3_2 <- tb_theme2(matrix3_2) %>%
  # table title
  tab_header(
    title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
  ) %>%
  # stubhead label
  tab_stubhead(label = "Part II. CBC Results") %>%
  tab_row_group(
    label = "Missing CBC Results",
    rows = 2:19
  ) %>%
  row_group_order(groups = c(NA,
                             "Missing CBC Results"
  )) %>%
  tab_footnote(
    footnote = c("*Denominator: Participants with complete MNH08 in person or by phone")
  ) %>%
    tab_footnote(
    footnote = c("SAS Note: Plateletcrit, platelet distribution width are not performed at India-SAS. Post-enrollment CBC testing started on 2024-07-22.")
  ) %>%
    tab_footnote(
    footnote = c("Ghana note: CBC testing stopped from 2024-10-29.")
  ) %>%
    tab_footnote(
    footnote = c("Kenya note: CBC collected for ReMAPP only. Only expect CBC when SCRN_OBSSTDAT >= 2023-04-03.")
  ) %>%
  tab_footnote(
    footnote = c("Pakistan note: Neutrophils full cell count, lymphocytes full cell count, monocyte full cell count, plateletcrit, platelet distribution width are not performed. Remaining CBC testing stopped from 2024-04-05")
  ) %>%

  tab_options(table.width = pct(100)) %>%
  #revise column width
  cols_width(1 ~ px(225)) %>%
  gtsave(paste0("results/missing_m08_", visit, "_2.png"), expand = 10)
  }

       #CBC for Kenya only for ReMAPP
  if(num %in% c(5)) {
    matrix3_2 <- df_lab %>%
        filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (!SITE %in% c("Pakistan", "Kenya", "Ghana", "India-SAS") | 
                                                                              (SITE == "Kenya" & denom_remapp == 1) | 
                                                                              (SITE == "Pakistan" & denom_remapp==1) |
                                                                              (SITE == "Ghana" & denom_remapp==1)|
                                                                              (SITE == "India-SAS" & denom_post_enrll_cbc==1)
                                                                              )) %>%
      group_by(SITE) %>%
      summarise(
        "Expected Lab Results from MNH08: N" = n(),
        #En, ANC20, ANC28, ANC36, PNC6 for all below
        "Missing Hematocrit (HCT): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing White Blood Cells (WBC): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Neutrophils (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Neutrophils (full cell count) : n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE) *100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Lymphocyte (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Lymphocyte (full cell count): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Erythrocyte Count: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Mean Cell Volume (MCV): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Mean Cell Hemoglobin (MCH): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Mean Corpuscular Hemoglobin Concentration (MCHC): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Platelets count: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Monocyte (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Monocyte (full cell count): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
          "Missing Eosinophils (%): n (%)*" = paste0(
            sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE), #  & SITE != "Pakistan"
          " (",
             format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
            ")"),
    
          "Missing Eosinophils (full cell count): n (%)*" = paste0(
            sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))) , na.rm = TRUE),
            " (",
           format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
            ")"),
        "Missing Red Cell Width (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        ## new code >>
            "Missing Platelet Distribution Width (PDW): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum( eval(parse(text = paste0("pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
        "Missing Plateletcrit (PCT) (%): n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum(!SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
        # filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (SITE != "Kenya" | (SITE == "Kenya" & denom_remapp == 1)) & SITE != "Pakistan") %>%
        filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & (!SITE %in% c("Pakistan", "Kenya", "Ghana", "India-SAS") | 
                                                                              (SITE == "Kenya" & denom_remapp == 1) | 
                                                                              (SITE == "Pakistan" & denom_remapp==1) |
                                                                              (SITE == "Ghana" & denom_remapp==1)|
                                                                              (SITE == "India-SAS" & denom_post_enrll_cbc==1)
                                                                              )) %>%
          summarise(
            "Expected Lab Results from MNH08: N" = n(),
            "Missing Hematocrit (HCT): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_HCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing White Blood Cells (WBC): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_WBC_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Neutrophils (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Neutrophils (full cell count) : n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_NEU_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE) *100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Lymphocyte (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Lymphocyte (full cell count): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_LYMPH_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Erythrocyte Count: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_ERYTH_MM_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Mean Cell Volume (MCV): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCV_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Mean Cell Hemoglobin (MCH): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCH_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Mean Corpuscular Hemoglobin Concentration (MCHC): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MCHC_GDL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Platelets count: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PLATE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Monocyte (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Monocyte (full cell count): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_MONO_FCC_LBORRES_", num, ")"))) & SITE != "Pakistan", na.rm = TRUE)/sum(SITE != "Pakistan", na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          "Missing Eosinophils (%): n (%)*" = paste0(
            sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE), #  & SITE != "Pakistan"
          " (",
             format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_PCT_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
            ")"),
    
          "Missing Eosinophils (full cell count): n (%)*" = paste0(
            sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))) , na.rm = TRUE),
            " (",
           format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_EOS_FCC_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
            ")"),
            "Missing Red Cell Width (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_RDW_PCT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
          ## new code >>
            "Missing Platelet Distribution Width (PDW): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PDW_CT_LBORRES_", num, ")","&", "pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum( eval(parse(text = paste0("pdw_denom_lab_08_", num, " == 1"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing Plateletcrit (PCT) (%): n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_CBC_PCT_PCT_LBORRES_", num, ")"))) & !SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)/sum(!SITE %in% c("Pakistan", "India-SAS"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))

    #neutrophils full cell count, lymphocytes full cell count, Monocyte (full cell count), eosinophils full cell count, plateletcrit, platelet distribution width are not performed at Pakistan
    matrix3_2[c(18,19), c("India-SAS")] = "n/a"
    matrix3_2[c(5,7,14,18,19), c("Pakistan")] = "n/a"

  tb3_2 <- tb_theme2(matrix3_2) %>%
  # table title
  tab_header(
    title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
  ) %>%
  # stubhead label
  tab_stubhead(label = "Part II. CBC Results") %>%
  tab_row_group(
    label = "Missing CBC Results",
    rows = 2:19
  ) %>%
  row_group_order(groups = c(NA,
                             "Missing CBC Results"
  )) %>%
  tab_footnote(
    footnote = c("*Denominator: Participants with complete MNH08 in person or by phone")
  ) %>%
  tab_footnote(
        footnote = c("Pakistan note: Neutrophils full cell count, lymphocytes full cell count, monocyte full cell count, plateletcrit, platelet distribution width are not performed. Remaing CBC testing stopped from 2024-04-05.")
  ) %>%
    tab_footnote(
    footnote = c("SAS Note: Plateletcrit, platelet distribution width are not performed at India-SAS. Post-enrollment CBC testing started on 2024-07-22.")
  ) %>%
    tab_footnote(
    footnote = c("Ghana note: CBC testing stopped from 2024-10-29.")
  ) %>%
    tab_footnote(
    footnote = c("Kenya note: CBC collected for ReMAPP only. Only expect CBC when SCRN_OBSSTDAT >= 2023-04-03.")
  ) %>%
  tab_options(table.width = pct(100)) %>%
  #revise column width
  cols_width(1 ~ px(225)) %>%
  gtsave(paste0("results/missing_m08_", visit, "_2.png"), expand = 10)
  }
    
 #*****************table 3.3****************
 if(num %in% c(1)) {
   matrix3_3 <- df_lab %>%
    filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
  group_by(SITE) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),
#kidney and liver function test: En, anc32
"Missing AST/SGOT: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_AST_UL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_AST_UL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing ALT/SGPT: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_ALT_UL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_ALT_UL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Alkaline Phosphatase (ALP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_ALP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_ALP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Total Bilirubin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TBILIRUBIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TBILIRUBIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Direct Bilirubin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_DBILIRUBIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_DBILIRUBIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Total Protein: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TPROTEIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TPROTEIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Albumin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_ALBUMIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_ALBUMIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Gamma GT: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_GAMMAGT_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_GAMMAGT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Indirect Bilirubin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_IBILIRUBIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_IBILIRUBIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),

"Missing BUN: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_BUN_MMOLL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_BUN_MMOLL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Serum Creatinine: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CREAT_UMOLL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CREAT_UMOLL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Sodium: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_SODIUM_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_SODIUM_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Potassium: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_POTASSIUM_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_POTASSIUM_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Chloride: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CHLORIDE_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CHLORIDE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Phosphorus: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_PHOSPHORUS_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_PHOSPHORUS_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Calcium: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CALCIUM_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CALCIUM_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),

 "Missing Carbon Dioxide: n (%)*" = paste0(sum(eval(parse(text = paste0("is.na(M08_CARB_DIOX_LBORRES_", num, ")", "&", "co2_denom_lab_08_", num, " == 1"))), na.rm = TRUE),
     " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CARB_DIOX_LBORRES_", num, ")", "&", "co2_denom_lab_08_", num, " == 1"))), na.rm = TRUE)/sum( eval(parse(text = paste0("co2_denom_lab_08_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),

"Missing Magnesium: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_MAGNESIUM_LBORRES_", num, ")"))) & SITE %in% c("Ghana", "Zambia")),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_MAGNESIUM_LBORRES_", num, ")"))) & SITE %in% c("Ghana", "Zambia"))/sum(SITE %in% c("Ghana", "Zambia"))*100, 2), nsmall = 0, digits = 2),
  ")"),
#total
  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .after = 6,
    "Total" = df_lab %>%
    filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),
"Missing AST/SGOT: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_AST_UL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_AST_UL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing ALT/SGPT: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_ALT_UL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_ALT_UL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Alkaline Phosphatase (ALP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_ALP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_ALP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Total Bilirubin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TBILIRUBIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TBILIRUBIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Direct Bilirubin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_DBILIRUBIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_DBILIRUBIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Total Protein: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TPROTEIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TPROTEIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Albumin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_ALBUMIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_ALBUMIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Gamma GT: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_GAMMAGT_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_GAMMAGT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Indirect Bilirubin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_IBILIRUBIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_IBILIRUBIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing BUN: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_BUN_MMOLL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_BUN_MMOLL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Serum Creatinine: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CREAT_UMOLL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CREAT_UMOLL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Sodium: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_SODIUM_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_SODIUM_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Potassium: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_POTASSIUM_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_POTASSIUM_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Chloride: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CHLORIDE_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CHLORIDE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Phosphorus: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_PHOSPHORUS_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_PHOSPHORUS_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Calcium: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CALCIUM_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CALCIUM_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),

     "Missing Carbon Dioxide: n (%)*" = paste0(sum(eval(parse(text = paste0("is.na(M08_CARB_DIOX_LBORRES_", num, ")", "&", "co2_denom_lab_08_", num, " == 1"))), na.rm = TRUE),
                " (",
      format(round(sum(eval(parse(text = paste0("is.na(M08_CARB_DIOX_LBORRES_", num, ")", "&", "co2_denom_lab_08_", num, " == 1"))), na.rm = TRUE)/sum( eval(parse(text = paste0("co2_denom_lab_08_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
        ")"),
"Missing Magnesium: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_MAGNESIUM_LBORRES_", num, ")"))) & SITE %in% c("Ghana", "Zambia")),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_MAGNESIUM_LBORRES_", num, ")"))) & SITE %in% c("Ghana", "Zambia"))/sum(SITE %in% c("Ghana", "Zambia"))*100, 2), nsmall = 0, digits = 2),
  ")"),
  ) %>%
      t() %>% unlist()
  ) %>%
    mutate_all(funs(str_replace(., "(NaN)", "-")))

#Magnesium is optional. Not perfomred at India-CMC, India-SAS and Kenya. Pakistan stopped performing on 2023-11-17.
matrix3_3[19, c("India-CMC", "India-SAS", "Kenya", "Pakistan")] = "n/a"

tb3_3 <- tb_theme2(matrix3_3) %>%
  # table title
  tab_header(
    title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
  ) %>%
  # stubhead label
  tab_stubhead(label = "Part III. Liver and Kidney Function Test Results") %>%
  tab_row_group(
    label = "Missing Liver Function Test (LFT) Results",
    rows = 2:10
  ) %>%
  tab_row_group(
    label = "Missing Kidney (Renal) Function Test Results",
    rows = 11:19
  ) %>%
  row_group_order(groups = c(NA,
                             "Missing Liver Function Test (LFT) Results",
                             "Missing Kidney (Renal) Function Test Results"
  )) %>%
  tab_footnote(
    footnote = c("*Denominator: Participants with complete MNH08 in person or by phone")
  ) %>% 
    tab_footnote(
    footnote = c("Note: Magnesium is optional. Not perfomred at India-CMC, India-SAS and Kenya. Pakistan stopped performing on 2023-11-17. Total number only included Ghana and Zambia")
  ) %>%
    tab_footnote(
    footnote = c("Kenya Note: started carbon dioxide testing on 2023-04-01.")
  ) %>%
    tab_footnote(
    footnote = c("SAS Note: started carbon dioxide testing on 2024-07-13.")
  ) %>%
  gtsave(paste0("results/missing_m08_", visit, "_3.png"), expand = 10)
 }

 if(num %in% c(4)) {
   matrix3_3 <- df_lab %>%
    # filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>% #  & SITE != "India-CMC"
    filter(denom_kft_lft_fxn_anc32==1) %>% 
  group_by(SITE) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),

#kidney and liver function test: En, anc32
"Missing AST/SGOT: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_AST_UL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_AST_UL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing ALT/SGPT: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_ALT_UL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_ALT_UL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Alkaline Phosphatase (ALP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_ALP_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_ALP_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Total Bilirubin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TBILIRUBIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TBILIRUBIN_LBORRES_", num, ")"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Direct Bilirubin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_DBILIRUBIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_DBILIRUBIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Total Protein: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TPROTEIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TPROTEIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Albumin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_ALBUMIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_ALBUMIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Gamma GT: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_GAMMAGT_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_GAMMAGT_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Indirect Bilirubin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_IBILIRUBIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_IBILIRUBIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),

## KIDNEY FUNCTION TEST 
"Missing BUN: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_BUN_MMOLL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_BUN_MMOLL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Serum Creatinine: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CREAT_UMOLL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CREAT_UMOLL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Sodium: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_SODIUM_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_SODIUM_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Potassium: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_POTASSIUM_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_POTASSIUM_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Chloride: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CHLORIDE_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CHLORIDE_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Phosphorus: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_PHOSPHORUS_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_PHOSPHORUS_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Calcium: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CALCIUM_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CALCIUM_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),

"Missing Carbon Dioxide: n (%)*" = paste0(sum(eval(parse(text = paste0("is.na(M08_CARB_DIOX_LBORRES_", num, ")", "&", "co2_denom_lab_08_", num, " == 1", "& denom_kft_lft_fxn_anc32 == 1"))), na.rm = TRUE),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CARB_DIOX_LBORRES_", num, ")", "&", "co2_denom_lab_08_", num, " == 1", "& denom_kft_lft_fxn_anc32 == 1"))), na.rm = TRUE)/sum( eval(parse(text = paste0("co2_denom_lab_08_", num, " == 1", "& denom_kft_lft_fxn_anc32 == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
    ")"),
    "Missing Magnesium: n (%)*" = paste0(
      sum(eval(parse(text = paste0("is.na(M08_MAGNESIUM_LBORRES_", num, ")")))& denom_kft_lft_fxn_anc32==1 & SITE %in% c("Ghana", "Zambia")),
      " (",
      format(round(sum(eval(parse(text = paste0("is.na(M08_MAGNESIUM_LBORRES_",num, ")"))) &
                         denom_kft_lft_fxn_anc32==1 & SITE %in% c("Ghana", "Zambia"))/sum(SITE %in% c("Ghana", "Zambia") &denom_kft_lft_fxn_anc32==1, na.rm =TRUE )*100, 2), nsmall = 0, digits = 2),
      ")")
#total
  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .after = 6,
    "Total" = df_lab %>%
    # filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))) & SITE != "India-CMC") %>%
  filter(denom_kft_lft_fxn_anc32==1) %>% 
  summarise(
"Expected Lab Results from MNH08: N" = n(),

#kidney and liver function test: En, anc32
"Missing AST/SGOT: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_AST_UL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_AST_UL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing ALT/SGPT: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_ALT_UL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_ALT_UL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Alkaline Phosphatase (ALP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_ALP_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_ALP_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Total Bilirubin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TBILIRUBIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TBILIRUBIN_LBORRES_", num, ")"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Direct Bilirubin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_DBILIRUBIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_DBILIRUBIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Total Protein: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TPROTEIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TPROTEIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Albumin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_ALBUMIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_ALBUMIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Gamma GT: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_GAMMAGT_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_GAMMAGT_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Indirect Bilirubin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_IBILIRUBIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_IBILIRUBIN_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),

## KIDNEY FUNCTION TEST 
"Missing BUN: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_BUN_MMOLL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_BUN_MMOLL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Serum Creatinine: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CREAT_UMOLL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CREAT_UMOLL_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Sodium: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_SODIUM_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_SODIUM_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Potassium: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_POTASSIUM_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_POTASSIUM_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Chloride: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CHLORIDE_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CHLORIDE_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Phosphorus: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_PHOSPHORUS_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_PHOSPHORUS_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Calcium: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CALCIUM_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CALCIUM_LBORRES_", num, ")", "& denom_kft_lft_fxn_anc32 == 1"))))/sum(denom_kft_lft_fxn_anc32==1, na.rm= TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),

"Missing Carbon Dioxide: n (%)*" = paste0(sum(eval(parse(text = paste0("is.na(M08_CARB_DIOX_LBORRES_", num, ")", "&", "co2_denom_lab_08_", num, " == 1", "& denom_kft_lft_fxn_anc32 == 1"))), na.rm = TRUE),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CARB_DIOX_LBORRES_", num, ")", "&", "co2_denom_lab_08_", num, " == 1", "& denom_kft_lft_fxn_anc32 == 1"))), na.rm = TRUE)/sum( eval(parse(text = paste0("co2_denom_lab_08_", num, " == 1", "& denom_kft_lft_fxn_anc32 == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
    ")"),
    "Missing Magnesium: n (%)*" = paste0(
      sum(eval(parse(text = paste0("is.na(M08_MAGNESIUM_LBORRES_", num, ")")))& denom_kft_lft_fxn_anc32==1 & SITE %in% c("Ghana", "Zambia")),
      " (",
      format(round(sum(eval(parse(text = paste0("is.na(M08_MAGNESIUM_LBORRES_",num, ")"))) &
                         denom_kft_lft_fxn_anc32==1 & SITE %in% c("Ghana", "Zambia"))/sum(SITE %in% c("Ghana", "Zambia") &denom_kft_lft_fxn_anc32==1, na.rm =TRUE )*100, 2), nsmall = 0, digits = 2),
      ")")
  ) %>%
      t() %>% unlist()
  ) %>%
    mutate_all(funs(str_replace(., "(NaN)", "-")))

#Magnesium is optional. Not perfomred at India-CMC, India-SAS and Kenya. Pakistan stopped performing on 2023-11-17.
matrix3_3[19, c("India-CMC", "India-SAS", "Kenya", "Pakistan")] = "n/a"

tb3_3 <- tb_theme2(matrix3_3) %>%
  # table title
  tab_header(
    title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
  ) %>%
  # stubhead label
  tab_stubhead(label = "Part III. Liver and Kidney Function Test Results") %>%
  tab_row_group(
    label = "Missing Liver Function Test (LFT) Results",
    rows = 2:10
  ) %>%
  tab_row_group(
    label = "Missing Kidney (Renal) Function Test Results",
    rows = 11:19
  ) %>%
  row_group_order(groups = c(NA,
                             "Missing Liver Function Test (LFT) Results",
                             "Missing Kidney (Renal) Function Test Results"
  )) %>%
  tab_footnote(
    footnote = c("*Denominator: Participants with complete MNH08 in person or by phone")
  ) %>%
    tab_footnote(
    footnote = c("Note: Magnesium is optional. Not perfomred at India-CMC, India-SAS and Kenya. Pakistan stopped performing on 2023-11-17. Total number only included Ghana and Zambia")
  ) %>%
  # tab_footnote(
  #   footnote = c("Note: CMC stopped Liver and kidney function tests on 2024-10-14 for ANC32 visit. Total number excluded CMC")
  # ) %>%
  tab_footnote(
    footnote = c("Note: Kidney and Liver function testing stopped on 2024-10-01 (Ghana); 2024-10-16 (CMC); 2024-09-02 (SAS); 2025-01-15 (Kenya); 2024-10-03 (Pakistan); 2024-10-11 (Zambia).")
  ) %>%
  tab_footnote(
    footnote = c("Kenya Note: started carbon dioxide test on 2023-04-01.")
  ) %>%
  tab_footnote(
    footnote = c("SAS Note: started carbon dioxide testing on 2024-07-13.")
  ) %>%
  gtsave(paste0("results/missing_m08_", visit, "_3.png"), expand = 10)
 }

 #******************table 3.4 *****************
 if(num %in% c(1,4)) {
     matrix3_4 <- df_lab %>%
    filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
  group_by(SITE) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),
#Vit B12 (TC): 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Serum Vitamin B12 (Total Cobalamin): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_VITB12_COB_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_VITB12_COB_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Vit B12 (HoloTC): 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Serum Vitamin B12 (Holotranscobalamin II): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_VITB12_HOL_LBORRES_", num, ")", "& denom_holo_", num, "==1")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_VITB12_HOL_LBORRES_", num, ")", "& denom_holo_", num, "==1"))))/sum(eval(parse(text = paste0("denom_holo_", num, "==1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
#Folate (serum) 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Folate - Blood Serum: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_FOLATE_PLASMA_NMOLL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_FOLATE_PLASMA_NMOLL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Ferritin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_FERRITIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_FERRITIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Iodine (Thyroglobulin or Tg): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_IODINE_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_IODINE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Serum Transferrin Receptor (sTfR): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TRANSFERRIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TRANSFERRIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Retinol Protein Binding 4 (RBP4): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_RBP4_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_RBP4_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing C-reactive Protein (CRP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CRP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CRP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Alpha 1-acid Glycoprotein (AGP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_AGP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_AGP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Histidine-rich Protein 2 (HRP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_HRP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_HRP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#total
  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .after = 6,
    "Total" = df_lab %>%
    filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),
#Vit B12 (TC): 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Serum Vitamin B12 (Total Cobalamin): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_VITB12_COB_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_VITB12_COB_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Vit B12 (HoloTC): 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Serum Vitamin B12 (Holotranscobalamin II): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_VITB12_HOL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_VITB12_HOL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Float (serum) 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Folate - Blood Serum: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_FOLATE_PLASMA_NMOLL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_FOLATE_PLASMA_NMOLL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Ferritin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_FERRITIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_FERRITIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Iodine (Thyroglobulin or Tg): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_IODINE_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_IODINE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Serum Transferrin Receptor (sTfR): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TRANSFERRIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TRANSFERRIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Retinol Protein Binding 4 (RBP4): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_RBP4_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_RBP4_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing C-reactive Protein (CRP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CRP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CRP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Alpha 1-acid Glycoprotein (AGP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_AGP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_AGP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Histidine-rich Protein 2 (HRP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_HRP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_HRP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
  ) %>%
      t() %>% unlist()
  ) %>%
    mutate_all(funs(str_replace(., "(NaN)", "-")))

tb3_4 <- tb_theme2(matrix3_4) %>%
  # table title
  tab_header(
    title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
  ) %>%
  # stubhead label
  tab_stubhead(label = "Part IV. Micronutrient Test Results") %>%
  tab_row_group(
    label = "Missing Micronutrient Results",
    rows = 2:11
  ) %>%
  row_group_order(groups = c(NA,
                             "Missing Micronutrient Results"
  )) %>%
  tab_footnote(
    footnote = c("*Denominator: Participants with complete MNH08 in person or by phone")
  ) %>%
 tab_footnote(
    footnote = c("Note: holoTC stopped testing: 2024-09-01 (Ghana); 2024-10-15 (CMC); 2024-09-02 (SAS); 2025-01-14 (Kenya); 2024-10-03 (Pakistan); 2024-10-11 (Zambia)")
  ) %>%
  tab_footnote(
    footnote = c("Note: Vitamin B12 total cobalamin and holoTC results delay for Kenya and Zambia due to shipment to KHRC and not start with new kit for Pakistan as of 2024-11-18")
  ) %>%
  tab_footnote(
    footnote = c("Note: Folate results delay for Kenya and Pakistan due to shipment to KHRC")
  ) %>%
  tab_footnote(
    footnote = c("Pakistan note: Quansys is ongoing and plan to complete by end Jan 2025.")
  ) %>%
  gtsave(paste0("results/missing_m08_", visit, "_4.png"), expand = 10)
 }

 if(num %in% c(10)) {
  matrix3_4 <- df_lab %>%
    filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
  group_by(SITE) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),
#Vit B12 (TC): 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Serum Vitamin B12 (Total Cobalamin): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_VITB12_COB_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_VITB12_COB_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Vit B12 (HoloTC): 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Serum Vitamin B12 (Holotranscobalamin II): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_VITB12_HOL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_VITB12_HOL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Folate (serum) 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Folate - Blood Serum: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_FOLATE_PLASMA_NMOLL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_FOLATE_PLASMA_NMOLL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Ferritin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_FERRITIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_FERRITIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Iodine (Thyroglobulin or Tg): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_IODINE_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_IODINE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Serum Transferrin Receptor (sTfR): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TRANSFERRIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TRANSFERRIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Retinol Protein Binding 4 (RBP4): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_RBP4_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_RBP4_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing C-reactive Protein (CRP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CRP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CRP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Alpha 1-acid Glycoprotein (AGP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_AGP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_AGP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R3: ANC-20)
"Missing Histidine-rich Protein 2 (HRP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_HRP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_HRP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#total
  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .after = 6,
    "Total" = df_lab %>%
    filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),
#Vit B12 (TC): 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Serum Vitamin B12 (Total Cobalamin): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_VITB12_COB_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_VITB12_COB_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Vit B12 (HoloTC): 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Serum Vitamin B12 (Holotranscobalamin II): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_VITB12_HOL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_VITB12_HOL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Float (serum) 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Folate - Blood Serum: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_FOLATE_PLASMA_NMOLL_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_FOLATE_PLASMA_NMOLL_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Ferritin: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_FERRITIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_FERRITIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Iodine (Thyroglobulin or Tg): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_IODINE_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_IODINE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Serum Transferrin Receptor (sTfR): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TRANSFERRIN_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TRANSFERRIN_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Retinol Protein Binding 4 (RBP4): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_RBP4_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_RBP4_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing C-reactive Protein (CRP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CRP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CRP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Alpha 1-acid Glycoprotein (AGP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_AGP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_AGP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#Quansys 7-plex (P: En, ANC-32, PNC-6; R: ANC-20)
"Missing Histidine-rich Protein 2 (HRP): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_HRP_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_HRP_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
  ) %>%
      t() %>% unlist()
  ) %>%
    mutate_all(funs(str_replace(., "(NaN)", "-")))

tb3_4 <- tb_theme2(matrix3_4) %>%
  # table title
  tab_header(
    title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
  ) %>%
  # stubhead label
  tab_stubhead(label = "Part IV. Micronutrient Test Results") %>%
  tab_row_group(
    label = "Missing Micronutrient Results",
    rows = 2:11
  ) %>%
  row_group_order(groups = c(NA,
                             "Missing Micronutrient Results"
  )) %>%
  tab_footnote(
    footnote = c("*Denominator: Participants with complete MNH08 in person or by phone")
  ) %>%
  tab_footnote(
    footnote = c("Note: Vitamin B12 total cobalamin and holoTC results delay for Kenya and Zambia due to shipment to KHRC and not start with new kit for Pakistan as of 2024-11-18")
  ) %>%
  tab_footnote(
    footnote = c("Note: Folate results delay for Kenya and Pakistan due to shipment to KHRC")
  ) %>%
  tab_footnote(
    footnote = c("Pakistan note: Quansys is ongoing and plan to complete by end Jan 2025.")
  ) %>%
  gtsave(paste0("results/missing_m08_", visit, "_4.png"), expand = 10)
 }

  #******************table 3.5*****************
   if (num %in% c(1)) {
    matrix3_5 <- df_lab %>%
      filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1"))))  %>% #  & SITE != "India-CMC"
      group_by(SITE) %>%
      summarise(
        "Expected Lab Results from MNH08: N" = n(),
        "Missing TSH: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_THYROID_TSH_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_THYROID_TSH_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Free T4: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_THYROID_FREET4_LBORRES_", num, ")", "& (denom_t3t4_enroll == 1)")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_THYROID_FREET4_LBORRES_", num, ")", "& (denom_t3t4_enroll == 1)"))))/sum(denom_t3t4_enroll == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Missing Free T3: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_THYROID_FREET3_LBORRES_", num, ")", "& (denom_t3t4_enroll == 1)")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_THYROID_FREET3_LBORRES_", num, ")", "& (denom_t3t4_enroll == 1)"))))/sum(denom_t3t4_enroll == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
          filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>% # & SITE != "India-CMC"
          summarise(
            "Expected Lab Results from MNH08: N" = n(),
            #Thyroid function TSH, Free T3, Free T4 (P: En, ANC-32)
            "Missing TSH: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_THYROID_TSH_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_THYROID_TSH_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
        "Missing Free T4: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_THYROID_FREET4_LBORRES_", num, ")", "& (denom_t3t4_enroll == 1)")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_THYROID_FREET4_LBORRES_", num, ")", "& (denom_t3t4_enroll == 1)"))))/sum(denom_t3t4_enroll == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),

        "Missing Free T3: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_THYROID_FREET3_LBORRES_", num, ")", "& (denom_t3t4_enroll == 1)")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_THYROID_FREET3_LBORRES_", num, ")", "& (denom_t3t4_enroll == 1)"))))/sum(denom_t3t4_enroll == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))

    ## the following code will override CMC with NA -- remove now that we have official dates
    # matrix3_5[, c("India-CMC")] = "n/a"
    # matrix3_5 <- matrix3_5 %>% relocate(`India-CMC`, .after = Ghana)
        
    tb3_5 <- tb_theme2(matrix3_5) %>%
      # table title
      tab_header(
        title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
      ) %>%
      # stubhead label
      tab_stubhead(label = "Part V. Thyroid Panel Results") %>%
      tab_row_group(
        label = "Missing Thyroid Panel Results",
        rows = 2:4
      ) %>%
      row_group_order(groups = c(NA,
                                 "Missing Thyroid Panel Results"
      )) %>%
      tab_footnote(
        footnote = c("*Denominator: Participants with complete MNH08 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("Note: thyroid testing stopped on 2024-09-01 (Ghana); 2024-10-17 (CMC); 2024-01-14 (Kenya); 2024-10-03 (Pakistan); 2014-10-11 (Zambia); ongoing (SAS).")
      ) %>%
      gtsave(paste0("results/missing_m08_", visit, "_5.png"), expand = 10)
  }

  if (num %in% c(4)) {
    matrix3_5 <- df_lab %>%
      filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
      group_by(SITE) %>%
      summarise(
        "Expected TSH Results from MNH08: N" = n(),
        "Missing TSH: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_THYROID_TSH_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_THYROID_TSH_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected Free T4, Free T3 Results from MNH08: N" = sum(denom_t3t4_anc32 == 1, na.rm = TRUE),
        "Missing Free T4: n (%)*" = paste0(
          sum(is.na(M08_THYROID_FREET4_LBORRES_4) & (denom_t3t4_anc32 == 1), na.rm = TRUE),
          " (",
          format(round(sum(is.na(M08_THYROID_FREET4_LBORRES_4) & (denom_t3t4_anc32 == 1), na.rm = TRUE)/
                         sum(denom_t3t4_anc32 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Free T3: n (%)*" = paste0(
          sum(is.na(M08_THYROID_FREET3_LBORRES_4) & (denom_t3t4_anc32 == 1), na.rm = TRUE),
          " (",
          format(round(sum(is.na(M08_THYROID_FREET3_LBORRES_4) & (denom_t3t4_anc32 == 1), na.rm = TRUE)/
                         sum(denom_t3t4_anc32 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
          filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
          summarise(
            "Expected TSH Results from MNH08: N" = n(),
            "Missing TSH: n (%)*" = paste0(
              sum(eval(parse(text = paste0("is.na(M08_THYROID_TSH_LBORRES_", num, ")")))),
              " (",
              format(round(sum(eval(parse(text = paste0("is.na(M08_THYROID_TSH_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
              ")"),
        "Expected Free T4, Free T3 Results from MNH08: N" = sum(denom_t3t4_anc32 == 1, na.rm = TRUE),
        "Missing Free T4: n (%)*" = paste0(
          sum(is.na(M08_THYROID_FREET4_LBORRES_4) & (denom_t3t4_anc32 == 1), na.rm = TRUE),
          " (",
          format(round(sum(is.na(M08_THYROID_FREET4_LBORRES_4) & (denom_t3t4_anc32 == 1), na.rm = TRUE)/
                         sum(denom_t3t4_anc32 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Free T3: n (%)*" = paste0(
          sum(is.na(M08_THYROID_FREET3_LBORRES_4) & (denom_t3t4_anc32 == 1), na.rm = TRUE),
          " (",
          format(round(sum(is.na(M08_THYROID_FREET3_LBORRES_4) & (denom_t3t4_anc32 == 1), na.rm = TRUE)/
                         sum(denom_t3t4_anc32 == 1, na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))

    tb3_5 <- tb_theme2(matrix3_5) %>%
      # table title
      tab_header(
        title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
      ) %>%
      # stubhead label
      tab_stubhead(label = "Part V. Thyroid Panel Results") %>%
      tab_row_group(
        label = "Missing TSH Results",
        rows = 1:2
      ) %>%
      tab_row_group(
        label = "Missing Free T3, Free T4 Results",
        rows = 3:5
      ) %>%
      row_group_order(groups = c("Missing TSH Results",
                                 "Missing Free T3, Free T4 Results"
      )) %>%
      tab_footnote(
        footnote = c("*Denominator: Participants with complete MNH08 in person or by phone")
      ) %>%
      tab_footnote(
        footnote = c("**Denominator: Participants who completed MNH08 either in person or by phone initially, but later only participants with abnormal TSH levels (< 0.3 mIU/L or > 4.0 mIU/L) at ANC32 after a specific date: 2024-09-01 (Ghana); 2024-10-14 (CMC); 2024-01-14 (Kenya); 2024-10-03 (Pakistan); 2014-10-11 (Zambia); ongoing (SAS).. Other sites please provide the date for change.")
      ) %>%
      gtsave(paste0("results/missing_m08_", visit, "_5.png"), expand = 10)
  }

 #******************table 3.6*****************
 if (num == 1) {
    matrix3_6 <- df_lab %>%
    filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
  group_by(SITE) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),
"Missing HbA1c: n (%)*" = paste0(
 sum(eval(parse(text = paste0("is.na(M08_HBA1C_LBORRES_", num, ")"))) & SITE %in% c("Ghana", "Zambia")),
 " (",
 format(round(sum(eval(parse(text = paste0("is.na(M08_HBA1C_LBORRES_", num, ")"))) & SITE %in% c("Ghana", "Zambia"))/sum(SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
 ")"),
"Missing HbA1c (%): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_HBA1C_PRCNT_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_HBA1C_PRCNT_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#total
  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .after = 6,
    "Total" = df_lab %>%
    filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),
#Hemoglobin A1c (P: En)
"Missing HbA1c: n (%)*" = paste0(
 sum(eval(parse(text = paste0("is.na(M08_HBA1C_LBORRES_", num, ")"))) & SITE %in% c("Ghana", "Zambia")),
 " (",
 format(round(sum(eval(parse(text = paste0("is.na(M08_HBA1C_LBORRES_", num, ")"))) & SITE %in% c("Ghana", "Zambia"))/sum(SITE %in% c("Ghana", "Zambia"), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
 ")"),
#Hemoglobin A1c (P: En)
"Missing HbA1c (%): n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_HBA1C_PRCNT_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_HBA1C_PRCNT_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
  ) %>%
      t() %>% unlist()
  ) %>%
    mutate_all(funs(str_replace(., "(NaN)", "-")))

    matrix3_6[2, c("India-CMC", "India-SAS", "Kenya", "Pakistan")] = "n/a"

tb3_6 <- tb_theme2(matrix3_6) %>%
  # table title
  tab_header(
    title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
  ) %>%
  # stubhead label
  tab_stubhead(label = "Part VI. Hemoglobin A1c (HbA1c) Test Results") %>%
  tab_row_group(
    label = "Missing Hemoglobin A1c (HbA1c) Results",
    rows = 2:3
  ) %>%
  row_group_order(groups = c(NA,
                             "Missing Hemoglobin A1c (HbA1c) Results"
  )) %>%
  tab_footnote(
    footnote = c("*Denominator: Participants with complete MNH08 in person or by phone")
  ) %>%
  tab_footnote(
    footnote = c("Note: India-CMC, India-SAS, Kenya and Pakistan only report %, no Discrete value expected. Total number excluded India-CMC, India-SAS, Kenya and Pakistan.")
  ) %>%
  gtsave(paste0("results/missing_m08_", visit, "_6.png"), expand = 10)
 }

 #*****************table 3.7******************
#CMC catch up RBC tests in all visits, put a value 1 for enrollment visits for test result if test performed at any visits to count missingness. Note 1 here is not real value 1, it means has a value/tested.
df_rbc_cmc <- df_lab %>% 
  filter(SITE == "India-CMC") %>% 
  select(SITE, MOMID, PREGID, denom_rbc_disorder, starts_with("M08_RBC_SICKLE_LBORRES_"), starts_with("M08_RBC_THALA")) %>% 
  mutate(
    M08_RBC_SICKLE_LBORRES_1 = ifelse(apply(select(., starts_with("M08_RBC_SICKLE_LBORRES_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    #RBC_THALA_LBORRES_1 here is using the first record during all visits. 1 means value 1 because we need it as a skip logic. Note: as long as we have a record of thala, we don't coun't missing no matter the selected value of RBC_THALA_LBORRES
    M08_RBC_THALA_LBORRES_1 = apply(select(., starts_with("M08_RBC_THALA_LBORRES_")), 1, 
                function(x) {
                  # Iterate over the values of the row to find the first valid value (0 or 1)
                  first_valid <- x[which(x %in% c(0, 1))[1]]
                  if (!is.na(first_valid)) {
                    return(first_valid)  # Return the first valid value (0 or 1)
                  } else {
                    return(NA_real_)  # If no valid value is found, return NA
                  }
                }),
    M08_RBC_THALA_1_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_1_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_2_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_2_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_3_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_3_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_4_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_4_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_5_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_5_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_6_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_6_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_7_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_7_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_8_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_8_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_9_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_9_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_10_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_10_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_11_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_11_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_12_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_12_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_13_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_13_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_14_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_14_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_15_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_15_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_16_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_16_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_17_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_17_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_18_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_18_")), 1, function(x) any(x %in% c(0, 1))), 1, NA), 
    M08_RBC_THALA_19_1 = ifelse(apply(select(., starts_with("M08_RBC_THALA_19_")), 1, function(x) any(x %in% c(0, 1))), 1, NA)
  ) %>% 
 select(SITE, MOMID, PREGID, denom_rbc_disorder, ends_with("_1"))

#remove CMC data
df_rbc_nocmc <- df_lab %>%
  filter(SITE != "India-CMC") 

#merge in CMC data
df_rbc <- df_rbc_nocmc %>% 
  bind_rows(df_rbc_cmc)

if (num == 1) {
matrix3_7 <- df_rbc %>%
  #Include data for ReMAPP aim 1 and 2 only
  filter(denom_rbc_disorder == 1) %>%
  group_by(SITE) %>%
  summarise(
    "Expected RBC Disorder Test Results from MNH08: N" = n(),
    #En
    "Missing Sickle Cell Disease: n (%)*" = paste0(
      sum(eval(parse(text = paste0("is.na(M08_RBC_SICKLE_LBORRES_", num, ")")))),
      " (",
      format(round(sum(eval(parse(text = paste0("is.na(M08_RBC_SICKLE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
      ")"),
    #En
    "Missing Hemoglobinopathies & Thalassemias: (%)" = paste0(
      sum(eval(parse(text = paste0("is.na(M08_RBC_THALA_LBORRES_", num, ")")))),
      " (",
      format(round(sum(eval(parse(text = paste0("is.na(M08_RBC_THALA_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Expected Hemoglobinopathies & Thalassemias Results from MNH08: N" = sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE),
    #M08_RBC_THALA_LBORRES_# == 1 for all below
    "Missing SS: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_1_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_1_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing SC: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_2_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_2_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing SE: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_3_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_3_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing CC: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_4_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_4_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing SD-Punjab: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_5_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_5_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing Sβthal: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_6_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_6_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing Eβthal: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_7_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_7_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing Cβthal: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_8_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_8_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing CD-PunjabED-punjab: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_9_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_9_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing D-D-Punjab: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_10_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_10_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing D-Punjabβthal: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_11_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_11_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing Thalassemia Major: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_12_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_12_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing Thalassemia Intermedia: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_13_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_13_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing Alpha Thalassemia: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_14_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_14_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing F: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_15_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_15_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing SA: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_16_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_16_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing Thalassemia Minor/Trait: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_17_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_17_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing Thalassemia AC: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_18_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_18_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    "Missing Other Hemoglobinopathy or Thalassemia: n (%)**" = paste0(
      sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_19_", num, ")"))), na.rm = TRUE),
      " (",
      format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_19_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    #total
  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .after = 6,
    "Total" = df_rbc %>%
      filter(denom_rbc_disorder == 1) %>%
      summarise(
        "Expected RBC Disorder Test Results from MNH08: N" = n(),
        #En
        "Missing Sickle Cell Disease: n (%)*" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_RBC_SICKLE_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_RBC_SICKLE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        #En
        "Missing Hemoglobinopathies & Thalassemias: (%)" = paste0(
          sum(eval(parse(text = paste0("is.na(M08_RBC_THALA_LBORRES_", num, ")")))),
          " (",
          format(round(sum(eval(parse(text = paste0("is.na(M08_RBC_THALA_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected Hemoglobinopathies & Thalassemias Results from MNH08: N" = sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE),
        #M08_RBC_THALA_LBORRES_# == 1 for all below
        "Missing SS: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_1_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_1_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing SC: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_2_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_2_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing SE: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_3_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_3_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing CC: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_4_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_4_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing SD-Punjab: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_5_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_5_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Sβthal: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_6_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_6_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Eβthal: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_7_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_7_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Cβthal: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_8_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_8_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing CD-PunjabED-punjab: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_9_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_9_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing D-D-Punjab: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_10_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_10_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing D-Punjabβthal: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_11_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_11_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Thalassemia Major: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_12_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_12_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Thalassemia Intermedia: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_13_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_13_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Alpha Thalassemia: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_14_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_14_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing F: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_15_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_15_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing SA: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_16_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_16_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Thalassemia Minor/Trait: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_17_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_17_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Thalassemia AC: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_18_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_18_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing Other Hemoglobinopathy or Thalassemia: n (%)**" = paste0(
          sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_19_", num, ")"))), na.rm = TRUE),
          " (",
          format(round(sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1 & is.na(M08_RBC_THALA_19_", num, ")"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_RBC_THALA_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
          ")"),
      ) %>%
      t() %>% unlist()
  ) %>%
  mutate_all(funs(str_replace(., "(NaN)", "-")))

tb3_7 <- tb_theme2(matrix3_7) %>%
  # table title
  tab_header(
    title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
  ) %>%
  # stubhead label
  tab_stubhead(label = "Part VII. Red Blood Cell (RBC) Disorder Test Results") %>%
  tab_row_group(
    label = "Missing Red Blood Cell (RBC) Disorder Test Results",
    rows = 1:3
  ) %>%
    tab_row_group(
    label = "Missing Hemoglobinopathies & Thalassemias Specified Results",
    rows = 4:23
  ) %>%
  row_group_order(groups = c("Missing Red Blood Cell (RBC) Disorder Test Results",
                             "Missing Hemoglobinopathies & Thalassemias Specified Results"
  )) %>%
  tab_footnote(
    footnote = c("*Denominator: ReMAPP participants with complete MNH08 in person or by phone")
  ) %>%
    tab_footnote(
    footnote = c("**Denominator: ReMAPP participants with positive hemoglobinopathies & thalassemias results")
  ) %>%
    tab_footnote(
    footnote = c("Note: RBC disorder test are for ReMAPP primary cohort exclusively. All sits are using screen date start at/after ReMAPP launch date, except Pakistan is using lab test between REMAPP launch date and test end date.")
  ) %>%
    tab_footnote(
    footnote = c("Zambia note: Thalassemias, sickle cell results delayed due to shipment to KHRC for testing")
  ) %>%
    tab_footnote(
    footnote = c("CMC note: Tests performed at any visit are included to account for the catch-up tests.")
  ) %>%
  tab_source_note(
    source_note = c("Note: Included data with SCRN_OBSSTDAT at/after: 2022-12-28 (Ghana); 2023-06-20(CMC); 2023-12-12(SAS); 2023-04-03(Kenya); 2022-12-15(Zambia); LBSTDAT between: 2022-09-22 (Pakistan). Each site please double check dates variable used and the exact dates.")
  ) %>%
  tab_source_note(
    source_note = c("Note: Testing stopped: 2024-10-29(Ghana); 2024-04-05(Pakistan).")
  ) %>%
  tab_style(
        style = list(
          cell_text(color = "red") 
        ),
        locations = cells_source_notes()
      ) %>% 
  #column width (main table part)
  tab_options(table.width = pct(100)) %>%
  #revise column width (first column)
  cols_width(1 ~ px(268)) %>%
  gtsave(paste0("results/missing_m08_", visit, "_7.png"), expand = 10)
 }

 #******************table 3.8******************
 if (num %in% c(1,2,3,4,5)) {
     matrix3_8 <- df_lab %>%
    filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
  group_by(SITE) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),
#Urinalysis(UA_PROT_LBORRES + UA_LEUK_LBORRES + UA_NITRITE_LBORRES) (P: E+A20+A28+A32+A36)
"Missing Protein: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_UA_PROT_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_UA_PROT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Leukocytes: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_UA_LEUK_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_UA_LEUK_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Nitrites: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_UA_NITRITE_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_UA_NITRITE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#total
  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .after = 6,
    "Total" = df_lab %>%
    filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),
"Missing Protein: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_UA_PROT_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_UA_PROT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Leukocytes: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_UA_LEUK_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_UA_LEUK_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Nitrites: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_UA_NITRITE_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_UA_NITRITE_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
  ) %>%
      t() %>% unlist()
  ) %>%
    mutate_all(funs(str_replace(., "(NaN)", "-")))

 tb3_8 <- tb_theme2(matrix3_8) %>%
 # table title
 tab_header(
   title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
 ) %>%
 # stubhead label
 tab_stubhead(label = "Part VIII. Urinalysis Test Results") %>%
  tab_row_group(
    label = "Missing Urinalysis Test Results",
    rows = 2:4
  ) %>%
  row_group_order(groups = c(NA,
                             "Missing Urinalysis Test Results"
  )) %>%
  tab_footnote(
    footnote = c("*Denominator: Participants with complete MNH08 in person or by phone")
  ) %>%
  #column width (main table part)
  tab_options(table.width = pct(100)) %>%
  #revise column width (first column)
  cols_width(1 ~ px(268)) %>%
  gtsave(paste0("results/missing_m08_", visit, "_8.png"), expand = 10)
 }

#******************table 3.9*****************
if (num %in% c(1,4)) {
  matrix3_9 <- df_lab %>%
    filter(eval(parse(text = paste0("(M04_TB_CETERM_1_", num, "== 1 |
                                    M04_TB_CETERM_2_", num, "== 1 |
                                    M04_TB_CETERM_3_", num, "== 1 |
                                    M04_TB_CETERM_4_", num, "== 1) &
                                    denom_lab_08_", num, " == 1")))) %>%
  group_by(SITE) %>%
  summarise(
"Expected Gene Xpert/MTB-RIF Culture: N" = n(),
"Missing Gene Xpert/MTB-RIF Culture: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TB_CNFRM_LBORRES_", num, ")"))), na.rm = TRUE),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TB_CNFRM_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Expected Backup Gene Xpert/MTB-RIF Culture: N" = paste0(
  sum(eval(parse(text = paste0("M08_TB_CNFRM_LBORRES_", num, " == 1"))), na.rm = TRUE)),
"Missing Backup Gene Xpert/MTB-RIF Culture: n (%)**" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TB_BACKUP_LBORRES_", num, ") & M08_TB_CNFRM_LBORRES_", num, " == 1"))), na.rm = TRUE),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TB_BACKUP_LBORRES_", num, ") & M08_TB_CNFRM_LBORRES_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_TB_CNFRM_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
#total
  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .after = 6,
    "Total" = df_lab %>%
          filter(eval(parse(text = paste0("(M04_TB_CETERM_1_", num, "== 1 |
                                    M04_TB_CETERM_2_", num, "== 1 |
                                    M04_TB_CETERM_3_", num, "== 1 |
                                    M04_TB_CETERM_4_", num, "== 1) &
                                    denom_lab_08_", num, " == 1")))) %>%
  summarise(
"Expected Gene Xpert/MTB-RIF Culture: N" = n(),
"Missing Gene Xpert/MTB-RIF Culture: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TB_CNFRM_LBORRES_", num, ")"))), na.rm = TRUE),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TB_CNFRM_LBORRES_", num, ")"))), na.rm = TRUE)/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Expected Backup Gene Xpert/MTB-RIF Culture: N" = paste0(
  sum(eval(parse(text = paste0("M08_TB_CNFRM_LBORRES_", num, " == 1"))), na.rm = TRUE)),
"Missing Backup Gene Xpert/MTB-RIF Culture: n (%)**" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_TB_BACKUP_LBORRES_", num, ") & M08_TB_CNFRM_LBORRES_", num, " == 1"))), na.rm = TRUE),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_TB_BACKUP_LBORRES_", num, ") & M08_TB_CNFRM_LBORRES_", num, " == 1"))), na.rm = TRUE)/sum(eval(parse(text = paste0("M08_TB_CNFRM_LBORRES_", num, " == 1"))), na.rm = TRUE)*100, 2), nsmall = 0, digits = 2),
  ")"),
  ) %>%
      t() %>% unlist()
  ) %>%
    mutate_all(funs(str_replace(., "(NaN)", "-")))

tb3_9 <- tb_theme2(matrix3_9) %>%
  # table title
  tab_header(
    title = paste0("Table 3. MNH08 tuberculosis (TB) test results missingness by site - ", visit)
  ) %>%
  # stubhead label
  tab_stubhead(label = "Part IX. Tuberculosis (TB) Test Results") %>%
  tab_footnote(
    footnote = c("*Denominator: Participants with positive symptom screen on W4SS at visit and with complete MNH08 in person or by phone")
  ) %>%
    tab_footnote(
    footnote = c("**Denominator: Participants with positive Gene Xpert/MTB-RIF Culture results at visit")
  ) %>%
  gtsave(paste0("results/missing_m08_", visit, "_9.png"), expand = 10)
}


#******************table 3.10*****************
if (num %in% c(1,4)) {
     matrix3_10 <- df_lab %>%
    filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
  group_by(SITE) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),
#EN, ANC32
"Missing Chlamydia: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CTNG_CT_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CTNG_CT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Gonorrhea: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CTNG_NG_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CTNG_NG_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
#total
  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .after = 6,
    "Total" = df_lab %>%
    filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
  summarise(
"Expected Lab Results from MNH08: N" = n(),
#EN, ANC32
"Missing Chlamydia: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CTNG_CT_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CTNG_CT_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
"Missing Gonorrhea: n (%)*" = paste0(
  sum(eval(parse(text = paste0("is.na(M08_CTNG_NG_LBORRES_", num, ")")))),
  " (",
  format(round(sum(eval(parse(text = paste0("is.na(M08_CTNG_NG_LBORRES_", num, ")"))))/n()*100, 2), nsmall = 0, digits = 2),
  ")"),
  ) %>%
      t() %>% unlist()
  ) %>%
    mutate_all(funs(str_replace(., "(NaN)", "-")))

tb3_10 <- tb_theme2(matrix3_10) %>%
 # table title
 tab_header(
   title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
 ) %>%
 # stubhead label
 tab_stubhead(label = "Part X. Chlamydia and Gonorrhea Test Results") %>%
  tab_row_group(
    label = "Missing Chlamydia and Gonorrhea Test Results",
    rows = 2:3
  ) %>%
  row_group_order(groups = c(NA,
                             "Missing Chlamydia and Gonorrhea Test Results"
  )) %>%
  tab_footnote(
    footnote = c("*Denominator: Participants with complete MNH08 in person or by phone")
  ) %>%
  tab_footnote(
    footnote = c("Note: We do not expect CT/NG test results at this time for most sites, as the testing plans are to batch test in 2025.")
  ) %>%
  gtsave(paste0("results/missing_m08_", visit, "_10.png"), expand = 10)
 }

#******************table 3.11*****************
 if (num %in% c(1)) {
    matrix3_11 <- df_lab %>%
      filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
      group_by(SITE) %>%
      summarise(
        "Expected Zika-Dengue-Chikungunya (ZCD) IgM/IgG Test Results from MNH08: N" = min(sum(denom_zcd == 1, na.rm = TRUE), 1000),
        #EN, ANC32, PNC6
        "Missing ZIKV IgM Test Results: n (%)*" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
            ),
          " (",
          format(round(
            min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
            ) / 
              min(sum(denom_zcd == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing ZIKV IgG Test Results : n (%)*" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)),
          " (",
          format(round(
            min(
              max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
              sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              )/
              min(sum(denom_zcd == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing DENV IgM Test Results: n (%)*" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
              sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
            ),
          " (",
          format(round(
            min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                           sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
            )/
              min(sum(denom_zcd == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing DENV IgG Test Results: n (%)*" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
            ),
          " (",
          format(round(
            min(
              max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
              sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              )/
              min(sum(denom_zcd == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing CHKV IgM Test Results: n (%)*" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)),
          " (",
          format(round(
            min(
              max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
              sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              )/
              min(sum(denom_zcd == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing CHKV IgG Test Results: n (%)*" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
            ),
          " (",
          format(round(
            min(
              max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
              sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              )/
              min(sum(denom_zcd == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected Leptospirosis IgM Test Results from MNH08: N" = min(sum(denom_lept_igm == 1, na.rm = TRUE), 1000),
        "Missing Leptospirosis IgM Test Results: n (%)**" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)),
          " (",
          format(round(
            min(max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)
                )/min(sum(denom_zcd == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected Leptospirosis IgG Test Results from MNH08: N" = min(sum(denom_lept_igg == 1, na.rm = TRUE), 1000),
        "Missing Leptospirosis IgG Test Results: n (%)***" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_LEPT_IGG_LBORRES_", num, ") & denom_lept_igg == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_LEPT_IGG_LBORRES_", num, ") & denom_lept_igg == 1"))), na.rm = TRUE)),
          " (",
          format(round(
            min(
              max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_LEPT_IGG_LBORRES_", num, ") & denom_lept_igg == 1"))), na.rm = TRUE)), 
              sum(eval(parse(text = paste0("is.na(M08_LEPT_IGG_LBORRES_", num, ") & denom_lept_igg == 1"))), na.rm = TRUE)
              )/min(sum(denom_lept_igg == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected Hepatitis E IgM/IgG Test Results from MNH08: N" = min(sum(denom_hev == 1, na.rm = TRUE), 1000),
        "Missing HEV IgM Test Results: n (%)****" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE), 
            sum(eval(parse(text = paste0("is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE),
          " (",
          format(round(
            min(
              max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE), 
              sum(eval(parse(text = paste0("is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1"))), na.rm = TRUE)
              )/min(sum(denom_hev == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing HEV IgG Test Results: n (%)****" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_HEV_IGG_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE), 
            sum(eval(parse(text = paste0("is.na(M08_HEV_IGG_LBORRES_", num, ") & denom_hev == 1"))), na.rm = TRUE)
            ),
          " (",
          format(round(
            min(
              max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_HEV_IGG_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE), 
              sum(eval(parse(text = paste0("is.na(M08_HEV_IGG_LBORRES_", num, ") & denom_hev == 1"))), na.rm = TRUE)
              )/min(sum(denom_hev == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
          filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
          summarise(
            "Expected Zika-Dengue-Chikungunya (ZCD) IgM/IgG Test Results from MNH08: N" = min(sum(denom_zcd == 1, na.rm = TRUE), 6000),
            # "Expected Lab Results from MNH08: N" = n(),
            #EN, ANC32, PNC6
            "Missing ZIKV IgM Test Results: n (%)*" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              ),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                  sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
                ) / 
                  min(sum(denom_zcd == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing ZIKV IgG Test Results : n (%)*" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                  sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
                )/
                  min(sum(denom_zcd == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing DENV IgM Test Results: n (%)*" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              ),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                  sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
                )/
                  min(sum(denom_zcd == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing DENV IgG Test Results: n (%)*" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              ),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                  sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
                )/
                  min(sum(denom_zcd == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing CHKV IgM Test Results: n (%)*" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                  sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
                )/
                  min(sum(denom_zcd == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing CHKV IgG Test Results: n (%)*" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              ),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                  sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
                )/
                  min(sum(denom_zcd == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected Leptospirosis IgM Test Results from MNH08: N" = min(sum(denom_lept_igm == 1, na.rm = TRUE), 6000),
            "Missing Leptospirosis IgM Test Results: n (%)**" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)),
              " (",
              format(round(
                min(max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)), 
                    sum(eval(parse(text = paste0("is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)
                )/min(sum(denom_zcd == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected Leptospirosis IgG Test Results from MNH08: N" = min(sum(denom_lept_igg == 1, na.rm = TRUE), 6000),
            "Missing Leptospirosis IgG Test Results: n (%)***" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_LEPT_IGG_LBORRES_", num, ") & denom_lept_igg == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_LEPT_IGG_LBORRES_", num, ") & denom_lept_igg == 1"))), na.rm = TRUE)),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_LEPT_IGG_LBORRES_", num, ") & denom_lept_igg == 1"))), na.rm = TRUE)), 
                  sum(eval(parse(text = paste0("is.na(M08_LEPT_IGG_LBORRES_", num, ") & denom_lept_igg == 1"))), na.rm = TRUE)
                )/min(sum(denom_lept_igg == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected Hepatitis E IgM/IgG Test Results from MNH08: N" = min(sum(denom_hev == 1, na.rm = TRUE), 6000),
            "Missing HEV IgM Test Results: n (%)****" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE), 
                sum(eval(parse(text = paste0("is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE), 
                  sum(eval(parse(text = paste0("is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1"))), na.rm = TRUE)
                )/min(sum(denom_hev == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing HEV IgG Test Results: n (%)****" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_HEV_IGG_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE), 
                sum(eval(parse(text = paste0("is.na(M08_HEV_IGG_LBORRES_", num, ") & denom_hev == 1"))), na.rm = TRUE)
              ),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_HEV_IGG_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE), 
                  sum(eval(parse(text = paste0("is.na(M08_HEV_IGG_LBORRES_", num, ") & denom_hev == 1"))), na.rm = TRUE)
                )/min(sum(denom_hev == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))
    
    tb3_11 <- tb_theme2(matrix3_11) %>%
      # table title
      tab_header(
        title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
      ) %>%
      # stubhead label
      tab_stubhead(label = "Part XI. ZCD,Leptospirosis and HEV IgM/IgG Test Results") %>%
      tab_row_group(
        label = "Missing Zika-Dengue-Chikungunya (ZCD) IgM/IgG Test Results",
        rows = 1:7
      ) %>%
      tab_row_group(
        label = "Missing Leptospirosis IgM Test Results",
        rows = 8:9
      ) %>%
      tab_row_group(
        label = "Missing Leptospirosis IgG Test Results",
        rows = 10:11
      ) %>%
      tab_row_group(
        label = "Missing Hepatitis E IgM/IgG Test Results",
        rows = 12:14
      ) %>%
      row_group_order(groups = c("Missing Zika-Dengue-Chikungunya (ZCD) IgM/IgG Test Results",
                                 "Missing Leptospirosis IgM Test Results",
                                 "Missing Leptospirosis IgG Test Results",
                                 "Missing Hepatitis E IgM/IgG Test Results"
      )) %>%
      tab_footnote(
        footnote = c("*Denominator: Participants with testing date (ZCD_LBTSTDAT) on/after test start date at enrollment and with complete MNH08 in person or by phone.")
      ) %>%
      tab_footnote(
        footnote = c("**Denominator: Participants with testing date (LEPT_IGM_LBTSTDAT) on/after test start date at enrollment and with complete MNH08 in person or by phone.")
      ) %>%
      tab_footnote(
        footnote = c("***Denominator: Participants with testing date (LEPT_IGG_LBTSTDAT) on/after test start date at enrollment and with complete MNH08 in person or by phone.")
      ) %>%
      tab_footnote(
        footnote = c("****Denominator: Participants with testing date (HEV_LBTSTDAT) on/after test start date at enrollment and with complete MNH08 in person or by phone.")
      ) %>%
      tab_footnote(
        footnote = c("Note: We only expect 1000 participants per site. There will be no miss if the goal is reached")
      ) %>%
      tab_footnote(
        footnote = c("Note: ZCD test start dates are: Ghana: 2024-04-09; CMC: 2024-03-06; SAS: 2024-03-12; Kenya: 2024-03-06; Pakistan: 2024-04-08; Zambia: 2023-11-09")
      ) %>%
      tab_footnote(
        footnote = c("Note: HEV test start dates are: Ghana: 2024-04-09; CMC: 2024-03-06; SAS: 2024-03-12; Kenya: 2024-03-06; Pakistan: 2024-04-08; Zambia: 2023-11-09")
      ) %>%
      tab_footnote(
        footnote = c("SAS Note: ZCD/HEV/Lepto testing ended on 2025-02-01")
      ) %>%
      gtsave(paste0("results/missing_m08_", visit, "_11.png"), expand = 10)
  }

#******************table 3.13 (3.11 for anc32 & pnc6 removing hev)*****************
 if (num %in% c(4,10)) {
    matrix3_13 <- df_lab %>%
      filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
      group_by(SITE) %>%
      summarise(
        "Expected Zika-Dengue-Chikungunya (ZCD) IgM/IgG Test Results from MNH08: N" = min(sum(denom_zcd == 1, na.rm = TRUE), 1000),
        #EN, ANC32, PNC6
        "Missing ZIKV IgM Test Results: n (%)*" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
            ),
          " (",
          format(round(
            min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
            ) / 
              min(sum(denom_zcd == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing ZIKV IgG Test Results : n (%)*" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)),
          " (",
          format(round(
            min(
              max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
              sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              )/
              min(sum(denom_zcd == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing DENV IgM Test Results: n (%)*" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
              sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
            ),
          " (",
          format(round(
            min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                           sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
            )/
              min(sum(denom_zcd == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing DENV IgG Test Results: n (%)*" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
            ),
          " (",
          format(round(
            min(
              max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
              sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              )/
              min(sum(denom_zcd == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing CHKV IgM Test Results: n (%)*" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)),
          " (",
          format(round(
            min(
              max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
              sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              )/
              min(sum(denom_zcd == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Missing CHKV IgG Test Results: n (%)*" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
            ),
          " (",
          format(round(
            min(
              max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
              sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              )/
              min(sum(denom_zcd == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected Leptospirosis IgM Test Results from MNH08: N" = min(sum(denom_lept_igm == 1, na.rm = TRUE), 1000),
        "Missing Leptospirosis IgM Test Results: n (%)**" = paste0(
          min(
            max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)), 
            sum(eval(parse(text = paste0("is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)),
          " (",
          format(round(
            min(max(0, 1000-sum(eval(parse(text = paste0("!is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)
                )/min(sum(denom_zcd == 1, na.rm = TRUE), 1000)*100, 2), nsmall = 0, digits = 2),
          ")"),
        "Expected Hepatitis E IgM/IgG Test Results from MNH08: N" = min(sum(denom_hev == 1, na.rm = TRUE), 6000),
            "Missing HEV IgM Test Results: n (%)***" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE), 
                sum(eval(parse(text = paste0("is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE), 
                  sum(eval(parse(text = paste0("is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1"))), na.rm = TRUE)
                )/min(sum(denom_hev == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")")

        #total
      ) %>%
      t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>%
      slice(-1) %>%
      add_column(
        .after = 6,
        "Total" = df_lab %>%
          filter(eval(parse(text = paste0("denom_lab_08_", num, " == 1")))) %>%
          summarise(
            "Expected Zika-Dengue-Chikungunya (ZCD) IgM/IgG Test Results from MNH08: N" = min(sum(denom_zcd == 1, na.rm = TRUE), 6000),
            # "Expected Lab Results from MNH08: N" = n(),
            #EN, ANC32, PNC6
            "Missing ZIKV IgM Test Results: n (%)*" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              ),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                  sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
                ) / 
                  min(sum(denom_zcd == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing ZIKV IgG Test Results : n (%)*" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                  sum(eval(parse(text = paste0("is.na(M08_ZCD_ZIKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
                )/
                  min(sum(denom_zcd == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing DENV IgM Test Results: n (%)*" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              ),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                  sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
                )/
                  min(sum(denom_zcd == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing DENV IgG Test Results: n (%)*" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              ),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                  sum(eval(parse(text = paste0("is.na(M08_ZCD_DENIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
                )/
                  min(sum(denom_zcd == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing CHKV IgM Test Results: n (%)*" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                  sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGM_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
                )/
                  min(sum(denom_zcd == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Missing CHKV IgG Test Results: n (%)*" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
              ),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)), 
                  sum(eval(parse(text = paste0("is.na(M08_ZCD_CHKIGG_LBORRES_", num, ") & denom_zcd == 1"))), na.rm = TRUE)
                )/
                  min(sum(denom_zcd == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
            "Expected Leptospirosis IgM Test Results from MNH08: N" = min(sum(denom_lept_igm == 1, na.rm = TRUE), 6000),
            "Missing Leptospirosis IgM Test Results: n (%)**" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)), 
                sum(eval(parse(text = paste0("is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)),
              " (",
              format(round(
                min(max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)), 
                    sum(eval(parse(text = paste0("is.na(M08_LEPT_IGM_LBORRES_", num, ") & denom_lept_igm == 1"))), na.rm = TRUE)
                )/min(sum(denom_zcd == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")"),
          "Expected Hepatitis E IgM Test Results from MNH08: N" = min(sum(denom_hev == 1, na.rm = TRUE), 6000),
            "Missing HEV IgM Test Results: n (%)***" = paste0(
              min(
                max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE), 
                sum(eval(parse(text = paste0("is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE),
              " (",
              format(round(
                min(
                  max(0, 6000-sum(eval(parse(text = paste0("!is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1")))), na.rm = TRUE), 
                  sum(eval(parse(text = paste0("is.na(M08_HEV_IGM_LBORRES_", num, ") & denom_hev == 1"))), na.rm = TRUE)
                )/min(sum(denom_hev == 1, na.rm = TRUE), 6000)*100, 2), nsmall = 0, digits = 2),
              ")")
          ) %>%
          t() %>% unlist()
      ) %>%
      mutate_all(funs(str_replace(., "(NaN)", "-")))
    
    tb3_13 <- tb_theme2(matrix3_13) %>%
      # table title
      tab_header(
        title = paste0("Table 3. MNH08 lab result missingness by site - ", visit)
      ) %>%
      # stubhead label
      tab_stubhead(label = "Part XI. ZCD, and Leptospirosis IgM/IgG Test Results") %>%
      tab_row_group(
        label = "Missing Zika-Dengue-Chikungunya (ZCD) IgM/IgG Test Results",
        rows = 1:7
      ) %>%
      tab_row_group(
        label = "Missing Leptospirosis IgM Test Results",
        rows = 8:9
      ) %>%
      tab_row_group(
        label = "Missing Hepatitis E IgM Test Results",
        rows = 10:11
      ) %>%
      row_group_order(groups = c("Missing Zika-Dengue-Chikungunya (ZCD) IgM/IgG Test Results",
                                 "Missing Leptospirosis IgM Test Results",
                                 "Missing Hepatitis E IgM Test Results"
      )) %>%

      tab_footnote(
        footnote = c("*Denominator: Participants with testing date (ZCD_LBTSTDAT) on/after test start date at enrollment and with complete MNH08 in person or by phone.")
      ) %>%
      tab_footnote(
        footnote = c("**Denominator: Participants with testing date (LEPT_IGM_LBTSTDAT) on/after test start date at enrollment and with complete MNH08 in person or by phone.")
      ) %>%
      tab_footnote(
        footnote = c("***Denominator: Participants with testing date (HEV_LBTSTDAT) on/after test start date at enrollment and with complete MNH08 in person or by phone.")
      ) %>%
      tab_footnote(
        footnote = c("Note: We only expect 1000 participants per site. There will be no miss if the goal is reached")
      ) %>%
      tab_footnote(
        footnote = c("Note: ZCD test start dates are: Ghana: 2024-04-09; CMC: 2024-03-06; SAS: 2024-03-12; Kenya: 2024-03-06; Pakistan: 2024-04-08; Zambia: 2023-11-09")
      ) %>%
      tab_footnote(
        footnote = c("Note: HEV test start dates are: Ghana: 2024-04-09; CMC: 2024-03-06; SAS: 2024-03-12; Kenya: 2024-03-06; Pakistan: 2024-04-08; Zambia: 2023-11-09")
      ) %>%
      tab_footnote(
        footnote = c("SAS Note: ZCD/HEV/Lepto testing ended on 2025-02-01")
      ) %>%
      gtsave(paste0("results/missing_m08_", visit, "_13.png"), expand = 10)
  }

#*****************table 3.12******************
g6pd <- mnh08 %>% 
  filter(M08_TYPE_VISIT %in% c(13,14) & M08_RBC_G6PD_LBORRES >= 0 & M08_RBC_G6PD_LBORRES < 55) %>% 
  select(SITE, MOMID, PREGID, M08_TYPE_VISIT, M08_RBC_G6PD_LBORRES) %>% 
  group_by(SITE, MOMID, PREGID, M08_TYPE_VISIT) %>% 
  mutate(n = n()) %>% 
  filter(n == 1 | row_number() == 1) %>%  # Keep one row per group if n > 1
  ungroup() %>%
  pivot_wider(names_from = M08_RBC_G6PD_LBORRES, values_from = M08_TYPE_VISIT)

df_g6pd_77na <- df_lab %>%
       #Include data for ReMAPP only, may use RBC_G6PD_LBTSTDAT instead
  filter(denom_remapp == 1) %>%
  left_join(g6pd) %>% 
  select(SITE, MOMID, PREGID, num_range("M08_RBC_G6PD_LBORRES_", 1:14)) %>% 
  mutate(across(everything(), ~ ifelse(. == 77, NA, .)))

#select the columns to calculate missingness
var_columns <- names(df_g6pd_77na)[grep("^M08_RBC_", names(df_g6pd_77na))]
  
matrix3_12 <- df_g6pd_77na %>%
  group_by(SITE) %>%
  summarise(
"Expected RBC Disorder Test Results from MNH08: N" = n(),
#En
"Missing Glucose-6-Phosphate Dehydrogenase (G6PD): n (%)*" = paste0(sum(if_all(var_columns, is.na)),
     " (",
     format(round(sum(if_all(var_columns, is.na))/n()*100, 2), nsmall = 0, digits = 2),
             ")"),
  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  add_column(
    .after = 6,
    "Total" = df_g6pd_77na %>%
  summarise(
"Expected G6PD Test Results from MNH08: N" = n(),
#En
"Missing Glucose-6-Phosphate Dehydrogenase (G6PD): n (%)*" = paste0(sum(if_all(var_columns, is.na)),
     " (",
     format(round(sum(if_all(var_columns, is.na))/n()*100, 2), nsmall = 0, digits = 2),
             ")"),
  ) %>%
      t() %>% unlist()
  ) %>%
    mutate_all(funs(str_replace(., "(NaN)", "-")))

tb3_12 <- tb_theme2(matrix3_12) %>%
  # table title
  tab_header(
    title = paste0("Table 3. MNH08 lab result missingness by site - All visits")
  ) %>%
  # stubhead label
  tab_stubhead(label = "Part XII. G6PD Test Results") %>%
  tab_footnote(
    footnote = c("*Denominator: ReMAPP participants (after ReMAPP start date and before ReMAPP end date) with complete MNH08 in person or by phone")
  ) %>%
    tab_footnote(
    footnote = c("Note: Current missingness is showing if missing at all time points, including PNC and unschedule visits")
  ) %>%
    tab_footnote(
    footnote = c("Note: G6PD is for ReMAPP primary cohort exclusively. ")
  ) %>%
  tab_source_note(
    source_note = c("Note: Included data with SCRN_OBSSTDAT at/after: 2022-12-28 (Ghana); 2023-06-20(CMC); 2023-12-12(SAS); 2023-04-03(Kenya); 2022-12-15(Zambia); LBSTDAT between: 2022-09-22 (Pakistan). Each site please double check dates variable used and the exact dates.")
  ) %>%
  tab_source_note(
    source_note = c("Note: Testing stopped: 2024-10-29(Ghana); 2024-04-05(Pakistan).")
  ) %>%
  tab_style(
        style = list(
          cell_text(color = "red") 
        ),
        locations = cells_source_notes()
      ) %>% 
  #column width (main table part)
  tab_options(table.width = pct(100)) %>%
  gtsave(paste0("results/missing_m08_", visit, "_12.png"), expand = 10)

#*******************knit**********************
#knit --> fig21 means table2 part1
fig21_path <- paste0("results/missing_m06_", visit,"_1.png")
fig22_path <- paste0("results/missing_m06_", visit,"_2.png")
fig23_path <- paste0("results/missing_m06_", visit,"_3.png")
fig24_path <- paste0("results/missing_m06_", visit,"_4.png")
fig31_path <- paste0("results/missing_m08_", visit, "_1.png")
fig32_path <- paste0("results/missing_m08_", visit, "_2.png")
fig33_path <- paste0("results/missing_m08_", visit, "_3.png")
fig34_path <- paste0("results/missing_m08_", visit, "_4.png")
fig35_path <- paste0("results/missing_m08_", visit, "_5.png")
fig36_path <- paste0("results/missing_m08_", visit, "_6.png")
fig37_path <- paste0("results/missing_m08_", visit, "_7.png")
fig38_path <- paste0("results/missing_m08_", visit, "_8.png")
fig39_path <- paste0("results/missing_m08_", visit, "_9.png")
fig310_path <- paste0("results/missing_m08_", visit, "_10.png")
fig311_path <- paste0("results/missing_m08_", visit, "_11.png")
fig312_path <- paste0("results/missing_m08_", visit, "_12.png")
fig313_path <- paste0("results/missing_m08_", visit, "_13.png")

#knit basd on visit window
#enrollment
if (num == 1) {knit<- knitr::include_graphics(c(fig21_path, fig22_path, fig24_path, fig31_path, fig32_path, fig33_path, fig34_path, fig35_path,
                                                fig36_path, fig37_path, fig38_path, fig39_path, fig310_path, fig311_path, fig312_path))}
#AnC20
else if (num == 2) {knit<- knitr::include_graphics(c(fig22_path, fig32_path, fig38_path))}
#ANC28
else if (num == 3) {knit<- knitr::include_graphics(c(fig22_path, fig23_path, fig32_path, fig38_path))}
#ANC32
else if (num == 4) {knit<- knitr::include_graphics(c(fig22_path, fig24_path, fig33_path, fig34_path, fig35_path,
                          fig38_path, fig39_path, fig310_path, fig313_path))} # fig311_path
#ANC36
else if (num == 5) {knit<- knitr::include_graphics(c(fig22_path, fig32_path, fig38_path))}
#PNC0
else if (num == 7) {knit<- knitr::include_graphics(c(fig22_path))}
#PNC1
else if (num == 8) {knit<- knitr::include_graphics(c(fig22_path))}
#PNC4
else if (num == 9) {knit<- knitr::include_graphics(c(fig22_path))}
#PNC6
else if (num == 10) {knit<- knitr::include_graphics(c(fig22_path, fig32_path, fig34_path, fig313_path))}  # fig311_path
#PNC26
else if (num == 11) {knit<- knitr::include_graphics(c(fig22_path))}
#PNC52
else if (num == 12) {knit<- knitr::include_graphics(c(fig22_path))}

}

```


\newpage

# Form missingness 

```{r, out.width="100%"}
 
  knitr::include_graphics("results/missing_form_1.png")

  knitr::include_graphics("results/missing_form_2.png")
```


For data collected as part of PRISMA Protocol Versions ≤1.8, MNH08 is expected at PNC-6 only. However, there are instances of MNH08 being completed at other PNC visits to record additional CBC collections and/or G6PD catch-up at sites.
Following the implementation of PRISMA Protocol V.1.9 at sites, MNH08 is additionally expected at PNC-52 for women who tested positive for gestational diabetes during ANC.

\newpage
# Lab results missingness

## Missingness at enrollment

```{r enroll visit}
#table
tb_enroll <- missing_fun(1, "Enrollment")
tb_enroll

```
## Missingness at ANC-20 visit
```{r}
#table
tb_anc20 <- missing_fun(2, "ANC20")
tb_anc20

```

## Missingness at ANC-28 visit
```{r}
#table
tb_anc28 <- missing_fun(3, "ANC28")
tb_anc28

```

## Missingness at ANC-32 visit
```{r}
#table
tb_anc32 <- missing_fun(4, "ANC32")
tb_anc32

```

## Missingness at ANC-36 visit
```{r}
#table
tb_anc36 <- missing_fun(5, "ANC36")
tb_anc36

```

## Missingness at IPC visit

* No lab required at delivery

## Missingness at PNC-0 visit
```{r}
#table
tb_pnc0 <- missing_fun(7, "PNC0")
tb_pnc0

```

## Missingness at PNC-1 visit
```{r}
#table
tb_pnc1 <- missing_fun(8, "PNC1")
tb_pnc1

```

## Missingness at PNC-4 visit
```{r missing pnc4}
#table
tb_pnc4 <- missing_fun(9, "PNC4")
tb_pnc4

```

## Missingness at PNC-6 visit
```{r missing pnc6}
#table
tb_pnc6 <- missing_fun(10, "PNC6")
tb_pnc6

```

## Missingness at PNC-26 visit
```{r missing pnc26}
#table
tb_pnc26 <- missing_fun(11, "PNC26")
tb_pnc26

```

## Missingness at PNC-52 visit
```{r}
#table
tb_pnc52 <- missing_fun(12, "PNC52")
tb_pnc52

```

