---
title: "<span style='font-size: 18px'> <span style='text-align: center'> Maternal-Outcomes-Report"
output:
  pdf_document:
    toc: no
    toc_depth: 6
    latex_engine: xelatex
    keep_tex: false
include-in-header:
- \usepackage{booktabs,longtable}
knit: (function(inputFile, encoding) { 
      rmarkdown::render(inputFile,
                    encoding=encoding, 
                    output_file= paste( './Output/' , Sys.Date(), '-Maternal-Outcomes-Report.pdf', sep='')) })
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%") 
knitr::opts_chunk$set(out.width = "100%", fig.align = "center")
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
#*****************************************************************************
#* PRISMA Maternal Outcomes -- TABLES 
#* Drafted: Stacie Loisate
#* Last updated: November 2025, Erin Oakley, Savannah O'Malley & Stacie Loisate
#*****************************************************************************
library(knitr)
library(tidyverse)
library(reshape2)
library(lubridate)
library(kableExtra)
library(naniar)
library(RColorBrewer)
library(gt) ## for table gen
library(webshot2) ## for table gen
library(haven)
library(dplyr)
library("rmarkdown")
library(readxl)


# set path to save 
# Stacie's path:
# path_to_data <- "D:/Users/stacie.loisate/Documents/import/2024-09-20/"
# path_to_save <- "D:/Users/stacie.loisate/Documents/PRISMA-Analysis-Stacie/Maternal-Outcomes/output/"

# Erin's path: 
# path_to_data <- "Z:/Outcome Data/2025-01-10/" 
# path_to_save <- "D:/Users/emoakley/Documents/Maternal Outcome Report/output/"


datadate <- "2025-10-31"
today <- Sys.Date()
format(today, "%Y-%B-%d")

#Savannah's paths
path_to_data <- paste0("D:/Users/savannah.omalley/Documents/Maternal Outcomes/Maternal Outcomes Report/data/", datadate, "/" )
path_to_save <- paste0("D:/Users/savannah.omalley/Documents/Maternal Outcomes/Maternal Outcomes Report/Output/", datadate, "/")

# Check if the path_to_save directory exists
if (!dir.exists(path_to_save)) {
  # If it doesn't exist, create it
  dir.create(path_to_save)
  message(paste("Directory created:", path_to_save))
} else {
  message(paste("Directory already exists:", path_to_save))
}

#remapp.moms <- read_dta(paste0(path_to_data, "MAT_ENROLL.dta")) %>% 
#  rename_all(toupper) %>% select(SITE, MOMID, PREGID, REMAPP_ENROLL) %>%
#  filter(REMAPP_ENROLL == 1)


#remind.moms <- read_excel(paste0("Z:/ReMAPP_Aim3_IDs/ReMIND-InfantIDs/remind-infantids_2025-05-21.xlsx")) %>% 
#  rename_all(toupper) %>% select(SITE, MOMID, PREGID, REMIND_ENROLLMENT_STATUS) %>%
#  filter(REMIND_ENROLLMENT_STATUS == 1)


mortality <- read_dta(paste0(path_to_data, "MAT_MORTALITY.dta")) %>% 
  rename_all(toupper) 
  #filter(PREGID %in% remind.moms$PREGID)
hemorrhage <- read.csv(paste0(path_to_data, "MAT_HEMORRHAGE.csv")) %>% rename_all(toupper)
  #filter(PREGID %in% remind.moms$PREGID)
depression <- read_dta(paste0(path_to_data, "MAT_DEPR.dta")) %>% rename_all(toupper) %>% filter(SITE != "")
  #filter(PREGID %in% remind.moms$PREGID)
anemia <- read_dta(paste0(path_to_data, "MAT_ANEMIA.dta"))  %>% rename_all(toupper) %>% filter(SITE != "") 
#%>% filter(PREGID %in% remind.moms$PREGID)
preterm_indication <- read_dta(paste0(path_to_data, "MAT_PRETERM.dta"))  %>% rename_all(toupper) %>% filter(SITE != "") 
  #filter(PREGID %in% remind.moms$PREGID)
labor <- read_dta(paste0(path_to_data, "MAT_LABOR.dta"))  %>% rename_all(toupper) %>% filter(SITE != "")
  #filter(PREGID %in% remind.moms$PREGID)
rupture <- read_dta(paste0(path_to_data, "MAT_UTERINERUP.dta"))  %>% rename_all(toupper) %>% filter(SITE != "")
  #filter(PREGID %in% remind.moms$PREGID)
gdm <- read_dta(paste0(path_to_data, "MAT_GDM.dta"))  %>% rename_all(toupper) %>% filter(SITE != "") 
  #filter(PREGID %in% remind.moms$PREGID)
MAT_INFECTION <- read.csv(paste0(path_to_data, "MAT_INFECTION", ".csv"))
  #filter(PREGID %in% remind.moms$PREGID)
near_miss <- read_dta(paste0(path_to_data, "MAT_NEAR_MISS.dta")) %>% rename_all(toupper)%>% filter(SITE != "")
  #filter(PREGID %in% remind.moms$PREGID)
thy<- read_dta(paste0(path_to_data, "MAT_THYR.dta"))  %>% rename_all(toupper) %>% filter(SITE != "") 
  #filter(PREGID %in% remind.moms$PREGID)
end <- read_dta(paste0(path_to_data, "MAT_ENDPOINTS.dta"))  %>% rename_all(toupper) %>% filter(SITE != "") 
enroll <- read_dta(paste0(path_to_data, "MAT_ENROLL.dta"))  %>% rename_all(toupper) %>% filter(SITE != "") 
hdp <- read_dta(paste0(path_to_data, "MAT_HDP.dta"))  %>% rename_all(toupper) %>% filter(SITE != "")
  #filter(PREGID %in% remind.moms$PREGID)
highbp <- read_dta(paste0(path_to_data, "MAT_POSTPARTUM_HIGHBP.dta"))  %>% rename_all(toupper) %>% filter(SITE != "")
  #filter(PREGID %in% remind.moms$PREGID)
placenta<- read_dta(paste0(path_to_data, "MAT_PLACENTA_PREVIA.dta"))  %>% rename_all(toupper) %>% filter(SITE != "")
  #filter(PREGID %in% remind.moms$PREGID)

tb_theme1 <- function(matrix){
  tb <- matrix %>%
    gt(
      rownames_to_stub = TRUE
    ) %>%
    opt_align_table_header(align = "left") %>%
    tab_spanner(
      label = "Sites"
    ) %>%
    opt_stylize(style = 6, color = 'gray') %>%
    tab_style(
      style = list(
        cell_fill(color = "#800c0c"),
        cell_text(weight = "bold"),
        cell_text(v_align = "middle"),
        cell_text(color = "white", size = px(18))
      ),
      locations = list(
        cells_title()
      )
    ) %>%
    tab_style(
      style = list(
        cell_fill(color = "#fad5d2"), # #f0b7b3,#f7cbc8, 
        cell_text(color = "black", size = px(18)),
        cell_text(v_align = "middle")
      ),
      locations = list(
        cells_stubhead(),
        cells_column_spanners(),
        cells_column_labels()
      )
    ) %>%
    tab_style(
      style = list(
        cell_fill(color = "#F0F0F0"),
        cell_text(v_align = "middle", size = px(18))
      ),
      locations = list(
        cells_stub()
      )
    ) %>%
    tab_style(
      style = list(
        cell_text(align = "center", size = px(18))
      ),
      locations = list(
        cells_column_labels(columns = everything())
      )
    ) %>%
    tab_style(
      style = list(
        cell_text(align = "center", size = px(18))
      ),
      locations = list(
        cells_body(columns = everything())
      )
    ) %>%
    fmt_markdown(columns = everything()) %>%
    tab_options(table.width = pct(100), table.align = "center") %>%
    cols_width(1 ~ px(240))
  
}
 

# Function to extract and format legend horizontally
g_legend <- function(p) {
  tmp <- ggplot_gtable(ggplot_build(p))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend_gtable <- tmp$grobs[[leg]]
  
  # Arrange legend components horizontally
  legend_gtable$widths <- unit(rep(1, ncol(legend_gtable)), "null")
  legend_gtable$grobs <- legend_gtable$grobs[order(legend_gtable$layout$l)]
  
  return(legend_gtable)
}

```

**Report issued on:** `r (paste0(today))`

**Data from:** `r (paste0(datadate))`

\setcounter{tocdepth}{6}
\tableofcontents

## Summary

### Table I. Summary of maternal outcomes
```{r}

infection1 <- left_join(MAT_INFECTION,enroll)
anemia1<-left_join(anemia,end)
preterm_indication1<-left_join(preterm_indication,end)
rupture1<-left_join(rupture,end)


# Infection Outcomes:

summary_tab1 <- infection1  %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## HIV
    "HIV ever during pregnancy" = paste0(
      format(sum(HIV_POSITIVE_EVER_PREG == 1 & ENROLL ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HIV_POSITIVE_EVER_PREG == 1 & ENROLL ==1, na.rm = TRUE)/sum(ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    # Syphilis
    "Syphilis ever during pregnancy" = paste0(
      format(sum(SYPH_POSITIVE_EVER_PREG == 1 & ENROLL ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(SYPH_POSITIVE_EVER_PREG == 1 & ENROLL ==1, na.rm = TRUE)/sum(ENROLL ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    ## Malaria
    "Malaria ever during pregnancy" = paste0(
      format(sum(MAL_POSITIVE_EVER_PREG == 1 & MAL_RDT_PERF_EVER_PREG==1 & ENROLL ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAL_POSITIVE_EVER_PREG == 1 & MAL_RDT_PERF_EVER_PREG==1 & ENROLL ==1, na.rm = TRUE)/sum(ENROLL ==1 & MAL_RDT_PERF_EVER_PREG == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
        
    "TB Dx+ or GeneXpert+ ever during pregnancy" = paste0(
      format(sum(TB_POSITIVE_EVER_PREG == 1 & ENROLL ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(TB_POSITIVE_EVER_PREG == 1 & ENROLL == 1, na.rm = TRUE)/sum(ENROLL ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    # Hepatitis B
    "Hep B ever during pregnancy" = paste0(
      format(sum(HBV_POSITIVE_EVER_PREG == 1 & HBV_RDT_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HBV_POSITIVE_EVER_PREG == 1 & HBV_RDT_PERF_EVER_PREG==1, na.rm = TRUE)/sum(HBV_RDT_PERF_EVER_PREG == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")") ,

    "Hep C ever during pregnancy" = paste0(
      format(sum(HCV_POSITIVE_EVER_PREG == 1 & HCV_RDT_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HCV_POSITIVE_EVER_PREG == 1 & HCV_RDT_PERF_EVER_PREG==1, na.rm = TRUE)/sum(HCV_RDT_PERF_EVER_PREG == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Hep E ever during pregnancy" = paste0(
      format(sum(HEV_POSITIVE_EVER_PREG ==1 & (HEV_IGM_PERF_EVER_PREG==1 | HEV_IGG_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEV_POSITIVE_EVER_PREG ==1 & (HEV_IGM_PERF_EVER_PREG==1 | HEV_IGG_PERF_EVER_PREG==1), na.rm = TRUE)/sum(HEV_IGM_PERF_EVER_PREG==1 | HEV_IGG_PERF_EVER_PREG==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Zika ever during pregnancy (IgM+ or incident IgG+)" = paste0(
      format(sum(ZIK_POSITIVE_EVER_PREG ==1 & (ZIK_IGM_PERF_EVER_PREG==1 | ZIK_IGG_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ZIK_POSITIVE_EVER_PREG ==1 & (ZIK_IGM_PERF_EVER_PREG==1 | ZIK_IGG_PERF_EVER_PREG==1), na.rm = TRUE)/sum(ZIK_IGM_PERF_EVER_PREG ==1| ZIK_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Dengue ever during pregnancy (IgM+ or incident IgG+)" = paste0(
      format(sum(DEN_POSITIVE_EVER_PREG ==1 & (DEN_IGM_PERF_EVER_PREG==1 | DEN_IGG_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEN_POSITIVE_EVER_PREG ==1 & (DEN_IGM_PERF_EVER_PREG==1 | DEN_IGG_PERF_EVER_PREG==1), na.rm = TRUE)/sum(DEN_IGM_PERF_EVER_PREG ==1| DEN_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Chikungunya ever during pregnancy (IgM+ or incident IgG+)" = paste0(
      format(sum(CHK_POSITIVE_EVER_PREG==1 & (CHK_IGM_PERF_EVER_PREG==1 | CHK_IGG_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(CHK_POSITIVE_EVER_PREG==1 & (CHK_IGM_PERF_EVER_PREG==1 | CHK_IGG_PERF_EVER_PREG==1), na.rm = TRUE)/sum(CHK_IGM_PERF_EVER_PREG ==1| CHK_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Leptospirosis ever during pregnancy (IgM+ or incident IgG+)" = paste0(
      format(sum(LEPT_IGM_POSITIVE_EVER_PREG ==1 & (LEPT_IGG_PERF_EVER_PREG == 1 | LEPT_IGM_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(LEPT_IGM_POSITIVE_EVER_PREG ==1 & (LEPT_IGG_PERF_EVER_PREG == 1 | LEPT_IGM_PERF_EVER_PREG==1), na.rm = TRUE)/sum(LEPT_IGM_PERF_EVER_PREG ==1 | LEPT_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

   ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
        add_column(
      .before = 1,
    "Total" = infection1 %>%
        plyr::summarise(
    "HIV ever during pregnancy" = paste0(
      format(sum(HIV_POSITIVE_EVER_PREG == 1 & ENROLL ==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Syphilis ever during pregnancy" = paste0(
      format(sum(SYPH_POSITIVE_EVER_PREG == 1 & ENROLL ==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Malaria ever during pregnancy" = paste0(
      format(sum(MAL_POSITIVE_EVER_PREG == 1 & MAL_RDT_PERF_EVER_PREG==1 & ENROLL ==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "TB Dx+ or GeneXpert+ ever during pregnancy" = paste0(
      format(sum(TB_POSITIVE_EVER_PREG == 1 & ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Hep B ever during pregnancy" = paste0(
      format(sum(HBV_POSITIVE_EVER_PREG == 1 & HBV_RDT_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Hep C ever during pregnancy" = paste0(
      format(sum(HCV_POSITIVE_EVER_PREG == 1 & HCV_RDT_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2)),
        
    "Hep E ever during pregnancy" = paste0(
      format(sum(HEV_POSITIVE_EVER_PREG ==1 & (HEV_IGM_PERF_EVER_PREG==1 | HEV_IGG_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2)),
        
    "Zika ever during pregnancy (IgM+ or incident IgG+)" = paste0(
      format(sum(ZIK_POSITIVE_EVER_PREG ==1 & (ZIK_IGM_PERF_EVER_PREG==1 | ZIK_IGG_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2)),

    "Dengue ever during pregnancy (IgM+ or incident IgG+)" = paste0(
      format(sum(DEN_POSITIVE_EVER_PREG ==1 & (DEN_IGM_PERF_EVER_PREG==1 | DEN_IGG_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2)),
        
    "Chikungunya ever during pregnancy (IgM+ or incident IgG+)" = paste0(
      format(sum(CHK_POSITIVE_EVER_PREG==1 & (CHK_IGM_PERF_EVER_PREG==1 | CHK_IGG_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2)),
        
    "Leptospirosis ever during pregnancy (IgM+ or incident IgG+)" = paste0(
      format(sum(LEPT_IGM_POSITIVE_EVER_PREG ==1 & (LEPT_IGG_PERF_EVER_PREG == 1 | LEPT_IGM_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2))
  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
        )



  # Mid-pregnancy outcomes:

  summary_tab2 <- gdm %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## GDM
    "Gestational diabetes (by any test)" = paste0(
      format(sum(DIAB_GEST_ANY==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_GEST_ANY_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_ANY==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_GEST_ANY_MISS==0, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_GEST_ANY_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
        add_column(
      .before = 1,
    "Total" = gdm %>%
        plyr::summarise(

    "Gestational diabetes (by any test)" = paste0(
      format(sum(DIAB_GEST_ANY==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_GEST_ANY_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2))

  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
        )


  summary_tab3 <- anemia1 %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## Ever anemia
     "Any anemia during pregnancy (ever)" = paste0(
      format(sum((ANEMIA_ANC == 1 | ANEMIA_ANC == 2 | ANEMIA_ANC == 3) & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum((ANEMIA_ANC == 1 | ANEMIA_ANC == 2 | ANEMIA_ANC == 3) & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE)/sum(PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Moderate/severe anemia during pregnancy (ever)" = paste0(
      format(sum((ANEMIA_ANC == 2 | ANEMIA_ANC == 3) & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum((ANEMIA_ANC == 2 | ANEMIA_ANC == 3) & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE)/sum(PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

   )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
        add_column(
      .before = 1,
    "Total" = anemia1 %>%
        plyr::summarise(

    "Any anemia during pregnancy (ever)" = paste0(
      format(sum((ANEMIA_ANC == 1 | ANEMIA_ANC == 2 | ANEMIA_ANC == 3) & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2)),

   "Moderate/severe anemia during pregnancy (ever)" = paste0(
      format(sum((ANEMIA_ANC == 2 | ANEMIA_ANC == 3) & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2))

  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
        )


  summary_tab4 <- depression %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## Ever depression
     "Depressive symptoms during pregnancy (ever)" = paste0(
      format(sum(DEPR_STND_ANC_EVER_NUM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_STND_ANC_EVER_NUM==1 , na.rm = TRUE)/sum(DEPR_ANC_EVER_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

   )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
        add_column(
      .before = 1,
    "Total" = depression %>%
        plyr::summarise(


    "Depression during pregnancy (ever)" = paste0(
      format(sum(DEPR_STND_ANC_EVER_NUM==1, na.rm = TRUE), nsmall = 0, digits = 2))

  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
        )

  summary_tab5 <- thy %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## Ever thryoid dysfunction
    "Thyroid dysfunction during pregnancy (ever)" = paste0(
      format(sum(THYR_EVER==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_EVER==1 , na.rm = TRUE)/sum(THYR_EVER_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

      )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
        add_column(
      .before = 1,
    "Total" = thy %>%
        plyr::summarise(

    "Thyroid dysfunction during pregnancy (ever)" = paste0(
      format(sum(THYR_EVER==1, na.rm = TRUE), nsmall = 0, digits = 2))

  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
        )


  # Pregnancy endpoint outcomes:

  summary_tab6 <- preterm_indication1 %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## PPROM
     "PPROM" = paste0(
      format(sum(PPROM_OCCUR == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PPROM_OCCUR == 1, na.rm = TRUE)/sum(PREG_END==1 & PPROM_OCCUR_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

  ## Preterm delivery
    "Preterm delivery (20 to <37 weeks)" = paste0(
      format(sum(MAT_PRETERM_ANY == 1 & PREG_END_DELIV==1 & MAT_PRETERM_PROV_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_ANY == 1 & PREG_END_DELIV==1 & MAT_PRETERM_PROV_MISS==0, na.rm = TRUE)/sum(PREG_END_DELIV==1 & MAT_PRETERM_PROV_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

   )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
        add_column(
      .before = 1,
    "Total" = preterm_indication1 %>%
        plyr::summarise(

    "PPROM" = paste0(
      format(sum(PPROM_OCCUR == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Preterm delivery (20 to <37 weeks)" = paste0(
      format(sum(MAT_PRETERM_ANY == 1 & PREG_END_DELIV==1 & MAT_PRETERM_PROV_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2))

  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
        )


  summary_tab7 <- hemorrhage %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## Antepartum hemorrhage
    "Antepartum hemorrhage" = paste0(
      format(sum(HEM_APH == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEM_APH == 1, na.rm = TRUE)/sum(HEM_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    ## Postpartum hemorrhage
    "Postpartum hemorrhage" = paste0(
      format(sum(HEM_PPH == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEM_PPH == 1, na.rm = TRUE)/sum(HEM_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
        add_column(
      .before = 1,
    "Total" = hemorrhage %>%
        plyr::summarise(

    "Antepartum hemorrhage" = paste0(
      format(sum(HEM_APH == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Postpartum hemorrhage" = paste0(
      format(sum(HEM_PPH == 1, na.rm = TRUE), nsmall = 0, digits = 2))

  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
        )



  summary_tab8 <- rupture1 %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## Uterine rupture
     "Uterine rupture" = paste0(
      format(sum(PREG_END==1 & MAT_UTER_RUP_MISS==0 & MAT_UTER_RUP==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END==1 & MAT_UTER_RUP_MISS==0 & MAT_UTER_RUP==1, na.rm = TRUE)/sum(PREG_END==1 & MAT_UTER_RUP_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
        add_column(
      .before = 1,
    "Total" = rupture1 %>%
        plyr::summarise(

    "Uterine rupture" = paste0(
      format(sum(PREG_END==1 & MAT_UTER_RUP_MISS==0 & MAT_UTER_RUP==1, na.rm = TRUE), nsmall = 0, digits = 2))

  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
        )


  summary_tab9 <- hdp %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## Gestational hypertension
     "Gestational hypertension" = paste0(
      format(sum(HDP_DENOM==1  & HDP_GROUP ==2, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HDP_DENOM==1  & HDP_GROUP ==2, na.rm = TRUE)/sum(HDP_DENOM==1  & HDP_GROUP >= 0 & HDP_GROUP <=5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

  ## Preeclampsia
    "Preeclampsia (all categories)^a^" = paste0(
      format(sum(HDP_DENOM==1  & (HDP_GROUP ==3 | HDP_GROUP ==4 | HDP_GROUP ==5), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HDP_DENOM==1  & (HDP_GROUP ==3 | HDP_GROUP ==4 | HDP_GROUP ==5), na.rm = TRUE)/sum(HDP_DENOM==1  & HDP_GROUP >= 0 & HDP_GROUP <=5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

 )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
        add_column(
      .before = 1,
    "Total" = hdp %>%
        plyr::summarise(

    "Gestational hypertension" = paste0(
      format(sum(HDP_DENOM==1  & HDP_GROUP ==2, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Preeclampsia (all categories)^a^" = paste0(
      format(sum(HDP_DENOM==1  & (HDP_GROUP ==3 | HDP_GROUP ==4 | HDP_GROUP ==5), na.rm = TRUE), nsmall = 0, digits = 2))

  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
        )


  summary_tab9b <- labor %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## Prolonged labor
     "Prolonged labor^b^" = paste0(
      format(sum(PREG_END_DELIV==1 & PRO_LABOR_MISS==0 & PRO_LABOR==1 & PRO_LABOR_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END_DELIV==1 & PRO_LABOR_MISS==0 & PRO_LABOR==1 & PRO_LABOR_DENOM==1, na.rm = TRUE)/sum(PREG_END_DELIV==1 & PRO_LABOR_MISS==0 & PRO_LABOR_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  )  %>%
    
     mutate(

            `Prolonged labor^b^` =
              case_when(SITE %in% c("Ghana" , "India-CMC") ~ "--",
                      TRUE ~ `Prolonged labor^b^`),
           

          ) %>%
    
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
        add_column(
      .before = 1,
    "Total" = labor %>%
        plyr::summarise(

    "Prolonged labor^b^" = paste0(
      format(sum(PREG_END_DELIV==1 & PRO_LABOR_MISS==0 & PRO_LABOR==1 & PRO_LABOR_DENOM==1 & SITE %in% c("India-SAS","Kenya","Pakistan","Zambia"), na.rm = TRUE), nsmall = 0, digits = 2))

  ) %>%
    
    
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
        )


#Postpartum outcomes:
  summary_tab10 <- near_miss %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## Near-Miss
     "Maternal Near-Miss" = paste0(
      format(sum(MAT_MNM_CRIT == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_MNM_CRIT == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
        add_column(
      .before = 1,
    "Total" = near_miss %>%
        plyr::summarise(

    "Maternal Near-Miss" = paste0(
      format(sum(MAT_MNM_CRIT == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2))

  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
        )


  summary_tab11 <- anemia %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## Anemia
     "Any postpartum anemia (6-14 weeks)" = paste0(
      format(sum((ANEMIA_PNC6 == 1 | ANEMIA_PNC6 == 2 | ANEMIA_PNC6 == 3) & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum((ANEMIA_PNC6 == 1 | ANEMIA_PNC6 == 2 | ANEMIA_PNC6 == 3) & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE)/sum(ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Moderate/severe postpartum anemia (6-14 weeks)" = paste0(
      format(sum((ANEMIA_PNC6 == 2 | ANEMIA_PNC6 == 3) & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum((ANEMIA_PNC6 == 2 | ANEMIA_PNC6 == 3) & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE)/sum(ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
        add_column(
      .before = 1,
    "Total" = anemia1 %>%
        plyr::summarise(

    "Any postpartum anemia (6-14 weeks)" = paste0(
      format(sum((ANEMIA_PNC6 == 1 | ANEMIA_PNC6 == 2 | ANEMIA_PNC6 == 3) & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Moderate/severe postpartum anemia (6-14 weeks)" = paste0(
      format(sum((ANEMIA_PNC6 == 2 | ANEMIA_PNC6 == 3) & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2))

  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
        )

  summary_tab12 <- depression %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## Depression
      "Depressive symptoms, postpartum (6-14 weeks)" = paste0(
       format(sum(DEPR_STND_PNC6_NUM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_STND_PNC6_NUM==1, na.rm = TRUE)/sum(DEPR_PNC6_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
        add_column(
      .before = 1,
    "Total" = depression %>%
        plyr::summarise(

   "Depressive symptoms, postpartum (6-14 weeks)" = paste0(
       format(sum(DEPR_STND_PNC6_NUM==1, na.rm = TRUE), nsmall = 0, digits = 2))

  ) %>%
        t() %>%
        as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
        )



 summary_tab <- rbind(summary_tab1)

 summary_tab_2 <- rbind(summary_tab2,summary_tab3,summary_tab4,
                      summary_tab5, summary_tab6,summary_tab7,summary_tab8,
                      summary_tab9,summary_tab9b)
 
  summary_tab_3 <- rbind(
                      summary_tab10,summary_tab11,summary_tab12)



```

```{r}
# replace NA with 0s (this likely means there is not yet data)
summary_tab[is.na(summary_tab)] <- paste0("0 (0)")
summary_tab_2[is.na(summary_tab_2)] <- paste0("0 (0)")
summary_tab_3[is.na(summary_tab_3)] <- paste0("0 (0)")

# Fix NAs in string variables for summary table (Ghana, India-CMC):
summary_tab_2$Ghana<-ifelse(summary_tab_2$Ghana=="0 (NaN)",
                           "0 (0)",summary_tab_2$Ghana)
summary_tab_2$'India-CMC'<-ifelse(summary_tab_2$'India-CMC'=="0 (NaN)",
                           "0 (0)",summary_tab_2$'India-CMC')


summary_tab_output <- tb_theme1(summary_tab) %>%
  tab_header(
    title = md("**Table I**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Infection ever during pregnancy</span>"),
        rows = 1:11
    ) %>%
 
 row_group_order(groups = c( "<span style='font-size: 18px'>Infection ever during pregnancy</span>")) %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note </sup> See outcome-specific section for denominators.</span>")
 )



summary_tab_output2 <- tb_theme1(summary_tab_2) %>%
  tab_header(
    title = md("**Table I, continued**")) %>%
   tab_row_group(
    label = html("<span style='font-size: 18px'>Mid-pregnancy outcomes</span>"),
        rows = 1:13
    ) %>%
 
 row_group_order(groups = c("<span style='font-size: 18px'>Mid-pregnancy outcomes</span>")) %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note </sup> See outcome-specific section for denominators.</span>")
 ) %>%
   tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> This summary preeclampsia outcome includes all sub-categories of the condition, including preeclampsia without severe features, preeclampsia superimposed on chronic hypertension, and preeclampsia with severe features.</span>")
 ) %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Note that this outcome is not available for Ghana and India-CMC sites due to data collection differences.</span>")
 )  





summary_tab_output3 <- tb_theme1(summary_tab_3) %>%
  tab_header(
    title = md("**Table I, continued part 2**")) %>%
  
  tab_row_group(
    label = html("<span style='font-size: 18px'>Postpartum outcomes</span>"),
        rows = 1:4
  ) %>%
 row_group_order(groups = c("<span style='font-size: 18px'>Postpartum outcomes</span>")
                            ) %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note </sup> See outcome-specific section for denominators.</span>")
 )

```

```{r, out.width = '100%'}

gtsave(summary_tab_output, file = "summary_tab_output.png", path = path_to_save, expand=10)
knitr::include_graphics(paste0(path_to_save, "summary_tab_output.png"))

```

```{r, out.width = '100%'}

gtsave(summary_tab_output2, file = "summary_tab_output2.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "summary_tab_output2.png"))

```


```{r, out.width = '100%'}

gtsave(summary_tab_output3, file = "summary_tab_output3.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "summary_tab_output3.png"))

```

\newpage

## 1. Maternal mortality

**Definitions:**

-   Maternal mortality: Death from any cause **related to or aggravated by pregnancy or its management** (excluding accidental or incidental causes) during pregnancy and childbirth or within 42 days of termination of pregnancy, irrespective of the duration and site of the pregnancy.

-   Late maternal mortality:  Death from any cause **related to or aggravated by pregnancy or its management** (excluding accidental or incidental causes), irrespective of the duration and site of the pregnancy, from 42 days postpartum up to one year.

-   Pregnancy-related death: death **from any cause** during pregnancy and childbirth or within 42 days of termination of pregnancy, irrespective of the duration and site of the pregnancy.

-   Late pregnancy-related death: death from any cause, irrespective of the duration and site of the pregnancy, from 42 days postpartum up to one year.

-   Any death: any death that occurs at any point during the study, from any cause.

*NOTE: cause of death data is based on MNH37.*


**Denominator:** Number of pregnancy endpoints. 

**To be included as "non-missing" for this outcome, a participant must have:**

**1.** Completed closeout form [MNH23] reporting that the woman died (varname [form]: `CLOSE_DSDECOD`==3 [MNH23]), AND/OR

**2.** Form indicates that maternal status is reported as died (varname [form]: `MAT_VITAL_MNHxx`==2 [MNH04, MNH10, MNH12]), AND/OR

**3.** Form indicates that visit not completed because the woman died (varname [form]: `MAT_VITAL_MNHxx`==8 [MNH04, MNH10, MNH12]).

**4.** Form indicates non default value for maternal death date.

**5.** *For maternal and late maternal mortality:*  Cause of death is not due to accidental or incidental causes but is due to pregnancy or management of pregnancy [MNH37].

**Common causes for a participant to be marked as "Missing":**

**-** Cause of death is missing: analysis of verbal autopsy data [MNH37] is forthcoming.


### Table 1. Maternal mortality
```{r}

# ## without percents
 mortality_tab <- mortality %>%
   rowwise() %>%
   group_by(SITE) %>%
   summarise(


         "Women with a pregnancy end point, n" = paste0(
       format(sum(PREG_END == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Any death,n (per 100,000)^a^" = paste0(
      format(sum(MAT_DEATH==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_DEATH==1, na.rm = TRUE)/sum(PREG_END==1, na.rm = TRUE)*100000, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing date of death, n^b^" = paste0(
       format(sum(MAT_DEATH_MISSDATE == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Any death, n^c^" = paste0(
       format(sum(MAT_DEATH_42 == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Obstetric cause, n^d^" = paste0(
       format(sum(MAT_MORTALITY == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Non-obstetric, n" = paste0(
       format(sum(MAT_MORTALITY == 2, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Unknown/unclear, n^e^" = paste0(
       format(sum(MAT_MORTALITY == 3, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Cause of death missing, n^f^" = paste0(
       format(sum(MAT_MORTALITY == 55, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Any death, n^g^" = paste0(
       format(sum(MAT_DEATH_42 == 2, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Obstetric cause, n^h^" = paste0(
       format(sum(MAT_MORTALITY_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

      "Non-obstetric, n  " = paste0(
       format(sum(MAT_MORTALITY_LATE == 2, na.rm = TRUE), nsmall = 0, digits = 2)),

      "Unknown/unclear, n ^e^ " = paste0(
       format(sum(MAT_MORTALITY_LATE == 3, na.rm = TRUE), nsmall = 0, digits = 2)),

      "Cause of death missing, n  ^f^" = paste0(
       format(sum(MAT_MORTALITY_LATE == 55, na.rm = TRUE), nsmall = 0, digits = 2))

   ) %>%
   t() %>% as.data.frame() %>%
   `colnames<-`(c(.[1,])) %>%
   slice(-1)  %>%
   add_column(
      .before = 1,
    "Total" = mortality %>%
      summarise(


         "Women with a pregnancy end point, n" = paste0(
       format(sum(PREG_END == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Any death,n (per 100,000)^a^" = paste0(
      format(sum(MAT_DEATH==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_DEATH==1, na.rm = TRUE)/sum(PREG_END==1, na.rm = TRUE)*100000, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing date of death, n^b^" = paste0(
       format(sum(MAT_DEATH_MISSDATE == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Any death, n^c^" = paste0(
       format(sum(MAT_DEATH_42 == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Obstetric cause, n^d^" = paste0(
       format(sum(MAT_MORTALITY == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Non-obstetric, n" = paste0(
       format(sum(MAT_MORTALITY == 2, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Unknown/unclear, n^e^" = paste0(
       format(sum(MAT_MORTALITY == 3, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Cause of death missing, n^f^" = paste0(
       format(sum(MAT_MORTALITY == 55, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Any death, n^g^" = paste0(
       format(sum(MAT_DEATH_42 == 2, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Obstetric cause, n^h^" = paste0(
       format(sum(MAT_MORTALITY_LATE == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

      "Non-obstetric, n  " = paste0(
       format(sum(MAT_MORTALITY_LATE == 2, na.rm = TRUE), nsmall = 0, digits = 2)),

      "Unknown/unclear, n ^e^ " = paste0(
       format(sum(MAT_MORTALITY_LATE == 3, na.rm = TRUE), nsmall = 0, digits = 2)),

      "Cause of death missing, n  ^f^" = paste0(
       format(sum(MAT_MORTALITY_LATE == 55, na.rm = TRUE), nsmall = 0, digits = 2))

   ) %>%
        t() %>% as.data.frame() %>%
        `colnames<-`(c(.[1,])) %>% unlist()
    )
   #mutate_all(funs(str_replace(., "NaN", "0"))) %>%
   #mutate_all(funs(str_replace(., "NA", "0")))



```

```{r}
# replace NA with 0s (this likely means there is not yet data)
  mortality_tab[is.na(mortality_tab)] <- paste0("0")

 mortality_output <- tb_theme1(mortality_tab) %>%
   tab_header(
     title = md("**Table 1**")) %>%
   tab_row_group(
     label = html("<span style='font-size: 18px'>Deaths occurring at any point during PRISMA</span>"),
     rows = 1:3
   ) %>%
    tab_row_group(
     label = html("<span style='font-size: 18px'>Deaths occurring during pregnancy up to 42 days postpartum</span>"),
     rows = 4:8
   ) %>%
      tab_row_group(
     label = html("<span style='font-size: 18px'>Deaths occurring 43-365 days postpartum</span>"),
     rows = 9:13
   ) %>%
 row_group_order(groups = c("<span style='font-size: 18px'>Deaths occurring at any point during PRISMA</span>",
                   "<span style='font-size: 18px'>Deaths occurring during pregnancy up to 42 days postpartum</span>",
                   "<span style='font-size: 18px'>Deaths occurring 43-365 days postpartum</span>"
                  )) %>%



    # bold rows any death, pregnancy related deaths
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                "Any death,n (per 100,000)^a^",
                "Any death, n^c^",
                "Any death, n^g^"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Any death,n (per 100,000)^a^",
                 "Any death, n^c^",
                 "Any death, n^g^"))) %>%
  tab_footnote(
     footnote = html("<span style='font-size: 18px'><sup>a</sup> Any death includes deaths occurring at any time and for any reason, including accidental/incidental causes. Per 100,000 pregnancy endpoints.</span>")
  ) %>%
  tab_footnote(
     footnote = html("<span style='font-size: 18px'><sup>b</sup>Date of death missing. Date of death has been estimated as the midpoint between when the woman was last seen alive and when her death was reported. This estimated death date is used to categorize the death as either pregnancy-related death (during pregnancy up to 42 days postpartum) or late pregnancy related death (43-365 days postpartum).</span>")
  ) %>%
  tab_footnote(
     footnote = html("<span style='font-size: 18px'><sup>c</sup>Pregnancy-related deaths are those occuring during pregnancy and up to 42 days postpartum, for any reason.</span>")
  ) %>%
   tab_footnote(
     footnote = html("<span style='font-size: 18px'><sup>d</sup>Maternal mortality: death during pregnancy and up to 42 days postpartum, due to causes related to pregnancy or its management.</span>")
  )  %>%
 tab_footnote(
     footnote = html("<span style='font-size: 18px'><sup>e</sup>Cause of death unknown: InterVA has been conducted but reported cause was inconclusive, ie 'Indeterminate' or 'Unknown' or unclear if the cause is related to pregnancy.</span>")
  )  %>%
    tab_footnote(
     footnote = html("<span style='font-size: 18px'><sup>f</sup>Cause of death missing: InterVA not yet completed</span>")
  )  %>%
  tab_footnote(
     footnote = html("<span style='font-size: 18px'><sup>g</sup>Late pregnancy-related deaths are those occuring 42-365 days postpartum, for any reason.</span>")
  )  %>%

  tab_footnote(
     footnote = html("<span style='font-size: 18px'><sup>h</sup>Late maternal mortality: deaths occurring 43-365 days postpartum, due to causes related to pregnancy or its management.</span>")
  )

```

```{r, out.width = '100%'}
gtsave(mortality_output, file = "mortality_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "mortality_output.png"))
```


\newpage

## 2. Maternal anemia

### 2a. Maternal anemia any time in pregnancy

**Definition:** Low hemoglobin levels in pregnancy, as based on results from complete blood count (CBC) measures or point-of-care (POC) hemoglobin tests. Anemia level is based on the lowest recorded hemoglobin measure in pregnancy, adjusted for smoking status and elevation as applicable. Levels of anemia in pregnancy are defined as:

*First/third trimester:*

-   no anemia (>=11 g/dL);

-   mild anemia (>=10 & <11 g/dL);

-   moderate anemia (>=7 & <10 g/dL);

-   severe anemia (< 7 g/dL)

*Second trimester:*

-   no anemia (>=10.5 g/dL);

-   mild anemia (>=9.5 & <10.5 g/dL);

-   moderate anemia (>=7 & <9.5 g/dL);

-   severe anemia (< 7 g/dL)


The outcome prioritizes CBC tests where possible, as this is the gold standard measure for hemoglobin. We consider the results of POC tests only in instances where there is no concurrent CBC test within 7 days (before or after) of the POC measure.

**Denominator:** All participants with completed pregnancies including:

-   Confirmed enrollment in form MNH02.

-   Confirmed pregnancy end in MNH09 (or MNH04/MNH19 in cases of pregnancy loss).

**Missingness:** Participants may be considered missing for this outcome if:

-   No valid results (CBC or POC) are provided in the lab forms

-   No lab/POC forms (MNH08 or MNH06) dated in pregnancy

-   Missing gestational age at enrollment information (varname: `US_GA_WKS_AGE_FTS1-4`,`US_GA_DAYS_AGE_FTS1-4`, `GA_LMP_WEEKS_SCORRES`, `US_OHOSTDAT`)

\newpage

#### Table 2a. Maternal anemia in pregnancy
```{r}

anemia<-left_join(anemia,end)

anemia_tab <- anemia %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

    #Data Completeness:

    "Expected denominator (completed pregnancies)" = paste0(
      format(sum(PREG_END==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "No valid test results" = paste0(
      format(sum(ANEMIA_ANC_MISS == 1 & PREG_END==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_ANC_MISS == 1 & PREG_END==1, na.rm = TRUE)/sum(PREG_END==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "No lab/POC forms (MNH06 or MNH08)" = paste0(
      format(sum(ANEMIA_ANC_MISS ==2 & PREG_END==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_ANC_MISS ==2 & PREG_END==1, na.rm = TRUE)/sum(PREG_END==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing gestational age information" = paste0(
      format(sum(ANEMIA_ANC_MISS ==3 & PREG_END==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_ANC_MISS ==3 & PREG_END==1, na.rm = TRUE)/sum(PREG_END==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    #Denominator (for non-missing)

    "Denominator (non-missing)" = paste0(
      format(sum(ANEMIA_ANC_MISS ==0 & PREG_END==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    #Values:

    "No anemia" = paste0(
      format(sum(ANEMIA_ANC == 0 & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_ANC == 0 & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE)/sum(PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Mild anemia" = paste0(
      format(sum(ANEMIA_ANC == 1 & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_ANC == 1 & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE)/sum(PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Moderate anemia" = paste0(
      format(sum(ANEMIA_ANC == 2 & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_ANC == 2 & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE)/sum(PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Severe anemia" = paste0(
      format(sum(ANEMIA_ANC == 3 & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_ANC == 3 & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE)/sum(PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    #Test type for lowest HB test:

    "CBC Test" = paste0(
      format(sum(HB_LOW_ANC_TEST=="CBC" & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HB_LOW_ANC_TEST=="CBC" & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE)/sum(PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "POC Test" = paste0(
      format(sum(HB_LOW_ANC_TEST=="POC" & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HB_LOW_ANC_TEST=="POC" & PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm = TRUE)/sum(PREG_END==1 & ANEMIA_ANC_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))


```

```{r}
# replace NA with 0s (this likely means there is not yet data)
anemia_tab[is.na(anemia_tab)] <- paste0("0 (0)")

anemia_output <- tb_theme1(anemia_tab) %>%
  tab_header(
    title = md("**Table 2a**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>"),
    rows = 1:11
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Anemia prevalence (lowest Hb measure)</span>"),
    rows = 5:11
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Test type (for lowest Hb measure)</span>"),
    rows = 10:11
  ) %>%
 row_group_order(groups = c("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>",
                   "<span style='font-size: 18px'>Anemia prevalence (lowest Hb measure)</span>",
                  "<span style='font-size: 18px'>Test type (for lowest Hb measure)</span>"
                  )) %>%

  # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (completed pregnancies)",
                 "Expected denominator (completed pregnancies)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (completed pregnancies)",
                 "Expected denominator (completed pregnancies)"))) %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> The expected denominator for this outcome is all completed pregnancies; this includes all pregnancies where an endpoint has been recorded in MNH09 (labor and delivery) OR MNH04 (pregnancy loss reported during ANC visit) OR MNH19 (pregnancy loss reported during hospitalization) OR if a maternal death is reported prior to delivery. </span>"))  %>%

   tab_footnote(
   footnote = html("<span style='font-size: 18px'><sup>Note:</sup> This table presents anemia diagnosis based on measured hemoglobin levels. For each observation, we rely on CBC measures of hemoglobin or POC measures of hemoglobin that are not within 7 days of a CBC test. For each participant, this table presents the worst anemia status observed during the window of interest.</span>")
 )
```

```{r, out.width = '100%'}

gtsave(anemia_output, file = "anemia_output.png", path = path_to_save, expand=10)
knitr::include_graphics(paste0(path_to_save, "anemia_output.png"))

```

\newpage

### 2b. Maternal anemia in pregnancy by trimester

**Definition:** Low hemoglobin levels in each trimester of pregnancy, as based on results from complete blood count (CBC) measures or point-of-care (POC) hemoglobin tests. Anemia level is based on the lowest recorded hemoglobin measure in pregnancy, adjusted for smoking status and elevation as applicable. Levels of anemia in pregnancy are defined as:

*First/third trimester:*

-   no anemia (>=11 g/dL);

-   mild anemia (>=10 & <11 g/dL);

-   moderate anemia (>=7 & <10 g/dL);

-   severe anemia (< 7 g/dL)

*Second trimester:*

-   no anemia (>=10.5 g/dL);

-   mild anemia (>=9.5 & <10.5 g/dL);

-   moderate anemia (>=7 & <9.5 g/dL);

-   severe anemia (< 7 g/dL)

The outcome prioritizes CBC tests where possible, as this is the gold standard measure for hemoglobin. We consider the results of POC tests only in instances where there is no concurrent CBC test within 7 days (before or after) of the POC measure.

**Denominator:** All participants that completed the trimester of interest including:

-   Confirmed enrollment in form MNH02.

-   Valid gestational age information provided at enrollment visit in MNH01 including: (varname: `US_GA_WKS_AGE_FTS1-4`,`US_GA_DAYS_AGE_FTS1-4`, `GA_LMP_WEEKS_SCORRES`, `US_OHOSTDAT`).

-   The participant has progressed in the study and completed the trimester of interest.

-   For Trimester 1, participant was recruited during the first trimester (prior to 14 weeks gestation based on Best Obstetric Estimate of gestational age at enrollment).

-   For each trimester, the participant is excluded if their pregnancy ends before the trimester of interest.

***Note:** This table contains pregnancies that are not yet completed; therefore, the denominator for each outcome varies by the trimester window of interest. *

**Missingness:** Participants may be considered missing for this outcome if:

-   No valid results (CBC or POC) are provided in the lab forms for the trimester of interest

-   No lab/POC forms (MNH08 or MNH06) dated in pregnancy

\newpage

#### Table 2b. Maternal anemia prevalence by trimester of pregnancy
```{r}
## this is a long table; will need to split into 3 separate tables (anemia_tab_b1 & anemia_tab_b2 & anemia_tab_b3)

## first set of anemia tables:

anemia_tab_tri1 <- anemia %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## trimester 1


    #Data Completeness:

       #Denominator:

    "Expected denominator (completed trimester 1 & recruited at <14 weeks GA)" = paste0(
      format(sum(ANEMIA_T1_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "No valid test results in trimester 1" = paste0(
      format(sum(ANEMIA_T1_MISS == 1 & ANEMIA_T1_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T1_MISS == 1 & ANEMIA_T1_DENOM==1, na.rm = TRUE)/sum(ANEMIA_T1_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "No lab/POC forms (MNH06 or MNH08) in trimester 1" = paste0(
      format(sum(ANEMIA_T1_MISS ==2 & ANEMIA_T1_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T1_MISS ==2 & ANEMIA_T1_DENOM==1, na.rm = TRUE)/sum(ANEMIA_T1_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    #Denominator (for non-missing)

    "Denominator (non-missing)" = paste0(
      format(sum(ANEMIA_T1_MISS ==0 & ANEMIA_T1_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    #Values:

    "No anemia (>=11 g/dL)" = paste0(
      format(sum(ANEMIA_T1 == 0 & ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T1 == 0 & ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Mild anemia (>=10 & <11 g/dL)" = paste0(
      format(sum(ANEMIA_T1 == 1 & ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T1 == 1 & ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Moderate anemia (>=7 & <10 g/dL)" = paste0(
      format(sum(ANEMIA_T1 == 2 & ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T1 == 2 & ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Severe anemia (<7 g/dL)" = paste0(
      format(sum(ANEMIA_T1 == 3 & ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T1 == 3 & ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    #Test type for lowest HB test:

    "CBC Test" = paste0(
      format(sum(HB_LOW_T1_TEST=="CBC" & ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HB_LOW_T1_TEST=="CBC" & ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "POC Test" = paste0(
      format(sum(HB_LOW_T1_TEST=="POC" & ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HB_LOW_T1_TEST=="POC" & ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T1_DENOM==1 & ANEMIA_T1_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))


anemia_tab_tri2 <- anemia %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(
#T2

     #Denominator:

    "Expected denominator (continued pregnancy & completed trimester 2)" = paste0(
      format(sum(ANEMIA_T2_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    #Data Completeness:

    "No valid test results in trimester 2" = paste0(
      format(sum(ANEMIA_T2_MISS == 1 & ANEMIA_T2_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T2_MISS == 1 & ANEMIA_T2_DENOM==1, na.rm = TRUE)/sum(ANEMIA_T2_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "No lab/POC forms (MNH06 or MNH08) in trimester 2" = paste0(
      format(sum(ANEMIA_T2_MISS ==2 & ANEMIA_T2_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T2_MISS ==2 & ANEMIA_T2_DENOM==1, na.rm = TRUE)/sum(ANEMIA_T2_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    #Denominator (for non-missing)

    "Denominator (non-missing)" = paste0(
      format(sum(ANEMIA_T2_MISS ==0 & ANEMIA_T2_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    #Values:

    "No anemia (>=10.5 g/dL)" = paste0(
      format(sum(ANEMIA_T2 == 0 & ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T2 == 0 & ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Mild anemia (>=9.5 & <10.5 g/dL)" = paste0(
      format(sum(ANEMIA_T2 == 1 & ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T2 == 1 & ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Moderate anemia (>=7 & <9.5 g/dL)" = paste0(
      format(sum(ANEMIA_T2 == 2 & ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T2 == 2 & ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Severe anemia (<7 g/dL)" = paste0(
      format(sum(ANEMIA_T2 == 3 & ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T2 == 3 & ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    #Test type for lowest HB test:

    "CBC Test" = paste0(
      format(sum(HB_LOW_T2_TEST=="CBC" & ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HB_LOW_T2_TEST=="CBC" & ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "POC Test" = paste0(
      format(sum(HB_LOW_T2_TEST=="POC" & ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HB_LOW_T2_TEST=="POC" & ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T2_DENOM==1 & ANEMIA_T2_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))


#T3

anemia_tab_tri3 <- anemia %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

     #Denominator:

    "Expected denominator (continued pregnancy into trimester 3)" = paste0(
      format(sum(ANEMIA_T3_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    #Data Completeness:

    "No valid test results in trimester 3" = paste0(
      format(sum(ANEMIA_T3_MISS == 1 & ANEMIA_T3_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T3_MISS == 1 & ANEMIA_T3_DENOM==1, na.rm = TRUE)/sum(ANEMIA_T3_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "No lab/POC forms (MNH06 or MNH08) in trimester 3" = paste0(
      format(sum(ANEMIA_T3_MISS ==2 & ANEMIA_T3_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T3_MISS ==2 & ANEMIA_T3_DENOM==1, na.rm = TRUE)/sum(ANEMIA_T3_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    #Denominator (for non-missing)

    "Denominator (non-missing)" = paste0(
      format(sum(ANEMIA_T3_MISS ==0 & ANEMIA_T3_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    #Values:

    "No anemia (>=11 g/dL)" = paste0(
      format(sum(ANEMIA_T3 == 0 & ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T3 == 0 & ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Mild anemia (>=10 & <11 g/dL)" = paste0(
      format(sum(ANEMIA_T3 == 1 & ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T3 == 1 & ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Moderate anemia (>=7 & <10 g/dL)" = paste0(
      format(sum(ANEMIA_T3 == 2 & ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T3 == 2 & ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Severe anemia (<7 g/dL)" = paste0(
      format(sum(ANEMIA_T3 == 3 & ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_T3 == 3 & ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    #Test type for lowest HB test:

    "CBC Test" = paste0(
      format(sum(HB_LOW_T3_TEST=="CBC" & ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HB_LOW_T3_TEST=="CBC" & ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "POC Test" = paste0(
      format(sum(HB_LOW_T3_TEST=="POC" & ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HB_LOW_T3_TEST=="POC" & ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm = TRUE)/sum(ANEMIA_T3_DENOM==1 & ANEMIA_T3_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))




```

```{r}
# replace NA with 0s (this likely means there is not yet data)
anemia_tab_tri1[is.na(anemia_tab_tri1)] <- paste0("0 (0)")
anemia_tab_tri2[is.na(anemia_tab_tri2)] <- paste0("0 (0)")
anemia_tab_tri3[is.na(anemia_tab_tri3)] <- paste0("0 (0)")

# TRIMESTER 1
anemia_tab_tri1_output <- tb_theme1(anemia_tab_tri1) %>%
  tab_header(
    title = md("**Table 2b**")) %>%
tab_spanner(
    label = html("<span style='font-size: 18px'>Trimester 1 (<14 weeks)</span>"),
    columns = 1:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness</span>"),
    rows = 1:10
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Anemia prevalence (lowest Hb measure)</span>"),
    rows = 4:10
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Test type (for lowest Hb measure)</span>"),
    rows = 9:10
  ) %>%

  # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (completed trimester 1 & recruited at <14 weeks GA)",
                 "Expected denominator (completed trimester 1 & recruited at <14 weeks GA)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (completed trimester 1 & recruited at <14 weeks GA)",
                 "Expected denominator (completed trimester 1 & recruited at <14 weeks GA)"))) %>%

 row_group_order(groups = c( "<span style='font-size: 18px'>Data completeness</span>",
                            "<span style='font-size: 18px'>Anemia prevalence (lowest Hb measure)</span>",
                            "<span style='font-size: 18px'>Test type (for lowest Hb measure)</span>"))

# TRIMESTER 2
anemia_tab_tri2_output <- tb_theme1(anemia_tab_tri2) %>%
  tab_header(
    title = md("**Table 2b continued**")) %>%
tab_spanner(
    label = html("<span style='font-size: 18px'>Trimester 2 (14-27 weeks)</span>"),
    columns = 1:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness</span>"),
    rows = 1:10
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Anemia prevalence (lowest Hb measure)</span>"),
    rows = 4:10
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Test type (for lowest Hb measure)</span>"),
    rows = 9:10
  ) %>%

  # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (continued pregnancy & completed trimester 2)",
                 "Expected denominator (continued pregnancy & completed trimester 2)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (continued pregnancy & completed trimester 2)",
                 "Expected denominator (continued pregnancy & completed trimester 2)"))) %>%


 row_group_order(groups = c("<span style='font-size: 18px'>Data completeness</span>",
                            "<span style='font-size: 18px'>Anemia prevalence (lowest Hb measure)</span>",
                            "<span style='font-size: 18px'>Test type (for lowest Hb measure)</span>"))

# TRIMESTER 3
anemia_tab_tri3_output <- tb_theme1(anemia_tab_tri3) %>%
  tab_header(
    title = md("**Table 2b continued**")) %>%
tab_spanner(
    label = html("<span style='font-size: 18px'>Trimester 3 (>= 28 weeks)</span>"),
    columns = 1:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness</span>"),
    rows = 1:10
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Anemia prevalence (lowest Hb measure)</span>"),
    rows = 4:10
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Test type (for lowest Hb measure)</span>"),
    rows = 9:10
  ) %>%


    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (continued pregnancy into trimester 3)",
                 "Expected denominator (continued pregnancy into trimester 3)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (continued pregnancy into trimester 3)",
                 "Expected denominator (continued pregnancy into trimester 3)"))) %>%

 row_group_order(groups = c("<span style='font-size: 18px'>Data completeness</span>",
                            "<span style='font-size: 18px'>Anemia prevalence (lowest Hb measure)</span>",
                            "<span style='font-size: 18px'>Test type (for lowest Hb measure)</span>")) %>%


  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note</sup>**This table presents anemia diagnosis based on measured hemoglobin levels. For each observation, we rely on CBC measures of hemoglobin or POC measures of hemoglobin that are not within 7 days of a CBC test. For each participant, this table presents the worst anemia status observed during the trimester of interest if multiple tests are provided. For trimesters 1 and 2, participants whose pregnancy ends before the end of the trimester of interest (and no tests are recorded in that trimester) are excluded. For trimester 3, participants whose pregnancy ends before 28 weeks gestation are excluded. </span>")
 )

```

```{r, out.width = '100%'}

gtsave(anemia_tab_tri1_output, file = "anemia_tab_tri1_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "anemia_tab_tri1_output.png"))

```

\newpage


```{r, out.width = '100%'}

gtsave(anemia_tab_tri2_output, file = "anemia_tab_tri2_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "anemia_tab_tri2_output.png"))

```

```{r, out.width = '100%'}

gtsave(anemia_tab_tri3_output, file = "anemia_tab_tri3_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "anemia_tab_tri3_output.png"))

```

\newpage

#### Figure 1. Anemia status by trimester

```{r, out.width = '100%', fig.align='center'}

knitr::include_graphics(paste0(path_to_data, "anemia_fig.png"))

```

\newpage


### 2c. Maternal anemia in the postpartum period

**Definition:** Low hemoglobin levels in the postpartum period, as based on results from complete blood count (CBC) measures or point-of-care (POC) hemoglobin tests. Anemia level is based on the lowest recorded hemoglobin measure in the postpartum time period of interest, adjusted for smoking status and elevation as applicable. Levels of anemia in the postpartum period are defined as: no anemia (>=12 g/dL); mild anemia (>=11 & <12 g/dL); moderate anemia (>=8 & <11 g/dL); severe anemia (< 8 g/dL).

**Denominator:** All participants with completed pregnancies including:

-   Confirmed enrollment in form MNH02.

-   Confirmed pregnancy end date in MNH09 or MNH04 or MNH19.

-   The participant has completed the postpartum window of interest based on the pregnancy end date reported in MNH09 and the date of the most recent data upload to Synapse.

***Note:** This table contains participants still progressing through postpartum follow-up; therefore, the denominator for each outcome varies by the postpartum window of interest.*

\newpage

#### Table 2c. Maternal anemia prevalence postpartum
```{r}

anemia_pph6_tab <- anemia %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  ## pnc6

     #Denominator:

    "Expected denominator (PNC6 window completed, >14 weeks postpartum)" = paste0(
      format(sum(ANEMIA_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    #Data Completeness:

    "No valid test results in PNC6 window" = paste0(
      format(sum(ANEMIA_PNC6_MISS == 1 & ANEMIA_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_PNC6_MISS == 1 & ANEMIA_PNC6_DENOM==1, na.rm = TRUE)/sum(ANEMIA_PNC6_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "No lab/POC forms (MNH06 or MNH08) in PNC6 window" = paste0(
      format(sum(ANEMIA_PNC6_MISS ==2 & ANEMIA_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_PNC6_MISS ==2 & ANEMIA_PNC6_DENOM==1, na.rm = TRUE)/sum(ANEMIA_PNC6_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    #Denominator (for non-missing)

    "Denominator (non-missing)" = paste0(
      format(sum(ANEMIA_PNC6_MISS ==0 & ANEMIA_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    #Values:

    "No anemia (>=12 g/dL)" = paste0(
      format(sum(ANEMIA_PNC6 == 0 & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_PNC6 == 0 & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE)/sum(ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Mild anemia (>=11 & <12 g/dL)" = paste0(
      format(sum(ANEMIA_PNC6 == 1 & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_PNC6 == 1 & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE)/sum(ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Moderate anemia (>=8 & <11 g/dL)" = paste0(
      format(sum(ANEMIA_PNC6 == 2 & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_PNC6 == 2 & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE)/sum(ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Severe anemia (<8 g/dL)" = paste0(
      format(sum(ANEMIA_PNC6 == 3 & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_PNC6 == 3 & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE)/sum(ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    #Test type for lowest HB test:

    "CBC Test" = paste0(
      format(sum(HB_LOW_PNC6_TEST=="CBC" & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HB_LOW_PNC6_TEST=="CBC" & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE)/sum(ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "POC Test" = paste0(
      format(sum(HB_LOW_PNC6_TEST=="POC" & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HB_LOW_PNC6_TEST=="POC" & ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm = TRUE)/sum(ANEMIA_PNC6_DENOM==1 & ANEMIA_PNC6_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))


  ## pnc26

anemia_pph26_tab <- anemia %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

     #Denominator:

    "Expected denominator (PNC26 window completed, >39 weeks postpartum)" = paste0(
      format(sum(ANEMIA_PNC26_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    #Data Completeness:

    "No valid test results in PNC26 window" = paste0(
      format(sum(ANEMIA_PNC26_MISS == 1 & ANEMIA_PNC26_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_PNC26_MISS == 1 & ANEMIA_PNC26_DENOM==1, na.rm = TRUE)/sum(ANEMIA_PNC26_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "No lab/POC forms (MNH06 or MNH08) in PNC26 window" = paste0(
      format(sum(ANEMIA_PNC26_MISS ==2 & ANEMIA_PNC26_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_PNC26_MISS ==2 & ANEMIA_PNC26_DENOM==1, na.rm = TRUE)/sum(ANEMIA_PNC26_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    #Denominator (for non-missing)

    "Denominator (non-missing)" = paste0(
      format(sum(ANEMIA_PNC26_MISS ==0 & ANEMIA_PNC26_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    #Values:

    "No anemia (>=12 g/dL)" = paste0(
      format(sum(ANEMIA_PNC26 == 0 & ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_PNC26 == 0 & ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm = TRUE)/sum(ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Mild anemia (>=11 & <12 g/dL)" = paste0(
      format(sum(ANEMIA_PNC26 == 1 & ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_PNC26 == 1 & ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm = TRUE)/sum(ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Moderate anemia (>=8 & <11 g/dL)" = paste0(
      format(sum(ANEMIA_PNC26 == 2 & ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_PNC26 == 2 & ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm = TRUE)/sum(ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Severe anemia (<8 g/dL)" = paste0(
      format(sum(ANEMIA_PNC26 == 3 & ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANEMIA_PNC26 == 3 & ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm = TRUE)/sum(ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    #Test type for lowest HB test:

    "CBC Test" = paste0(
      format(sum(HB_LOW_PNC26_TEST=="CBC" & ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HB_LOW_PNC26_TEST=="CBC" & ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm = TRUE)/sum(ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "POC Test" = paste0(
      format(sum(HB_LOW_PNC26_TEST=="POC" & ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HB_LOW_PNC26_TEST=="POC" & ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm = TRUE)/sum(ANEMIA_PNC26_DENOM==1 & ANEMIA_PNC26_MISS ==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))


```

```{r}
# replace NA with 0s (this likely means there is not yet data)
anemia_pph6_tab[is.na(anemia_pph6_tab)] <- paste0("0 (0)")
anemia_pph26_tab[is.na(anemia_pph26_tab)] <- paste0("0 (0)")



anemia_pph6_output <- tb_theme1(anemia_pph6_tab) %>%
  tab_header(
    title = md("**Table 2c**")) %>%
  tab_spanner(
    label = html("<span style='font-size: 18px'>6-14 weeks postpartum</span>"),
    columns = 1:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness at PNC6<sup>a</sup></span>"),
        rows = 1:10
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Anemia prevalence at PNC6 (lowest Hb measure)</span>"),
    rows = 4:10
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Test type (for lowest Hb measure)</span>"),
    rows = 9:10
  ) %>%


    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (PNC6 window completed, >14 weeks postpartum)",
                 "Expected denominator (PNC6 window completed, >14 weeks postpartum)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (PNC6 window completed, >14 weeks postpartum)",
                 "Expected denominator (PNC6 window completed, >14 weeks postpartum)"))) %>%

 row_group_order(groups = c("<span style='font-size: 18px'>Data completeness at PNC6<sup>a</sup></span>",
                            "<span style='font-size: 18px'>Anemia prevalence at PNC6 (lowest Hb measure)</span>",
                     "<span style='font-size: 18px'>Test type (for lowest Hb measure)</span>")) %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> This outcome is based on tests collected during the PNC-6 visit window (6-14 weeks postpartum); the data completeness denominator includes any participant with a valid lab test during this window, as well as participants without lab data who have progressed in the study through the PNC-6 window.</span>")) %>%

tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note</sup> This table presents anemia diagnosis based on measured hemoglobin levels. For each observation, we rely on CBC measures of hemoglobin or POC measures of hemoglobin that are not within 7 days of a CBC test. For each participant, this table presents the worst anemia status observed during the postpartum window of interest if multiple tests are provided.</span>"))


# PNC26 (making a separate table for more space, given longer lines)

anemia_pph26_output <- tb_theme1(anemia_pph26_tab) %>%
  tab_header(
    title = md("**Table 2c continued**")) %>%
  tab_spanner(
    label = html("<span style='font-size: 18px'>26-39 weeks postpartum</span>"),
    columns = 1:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness at PNC26<sup>a</sup></span>"),
        rows = 1:10
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Anemia prevalence at PNC26 (lowest Hb measure)</span>"),
    rows = 4:10
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Test type (for lowest Hb measure)</span>"),
    rows = 9:10
  ) %>%


    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (PNC26 window completed, >39 weeks postpartum)",
                 "Expected denominator (PNC26 window completed, >39 weeks postpartum)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (PNC26 window completed, >39 weeks postpartum)",
                 "Expected denominator (PNC26 window completed, >39 weeks postpartum)"))) %>%

 row_group_order(groups = c("<span style='font-size: 18px'>Data completeness at PNC26<sup>a</sup></span>",
                            "<span style='font-size: 18px'>Anemia prevalence at PNC26 (lowest Hb measure)</span>",
                     "<span style='font-size: 18px'>Test type (for lowest Hb measure)</span>")) %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> This outcome is based on tests collected during the PNC-26 visit window (26-39 weeks postpartum); the data completeness denominator includes any participant with a valid lab test during this window, as well as participants without lab data who have progressed in the study through the PNC-26 window. Note that participants who had an early pregnancy loss (<20 weeks GA) are excluded from this PNC-26 measure per study follow-up protocol. </span>")) %>%

tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note</sup> This table presents anemia diagnosis based on measured hemoglobin levels. For each observation, we rely on CBC measures of hemoglobin or POC measures of hemoglobin that are not within 7 days of a CBC test. For each participant, this table presents the worst anemia status observed during the postpartum window of interest if multiple tests are provided.</span>"))

```

```{r, out.width = '100%'}

gtsave(anemia_pph6_output, file = "anemia_pph6_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "anemia_pph6_output.png"))

```

\newpage


```{r, out.width = '100%'}

gtsave(anemia_pph26_output, file = "anemia_pph26_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "anemia_pph26_output.png"))

```



\newpage


## 3. Preterm delivery classification

### 3a. Preterm delivery

**Definition:** Preterm delivery prior to 37 completed weeks of gestation at birth, excluding pregnancy losses prior to 20 weeks gestation.

**Denominator:** All participants with recorded delivery (including livebirth OR stillbirth) after 20 weeks with:

-   Valid gestational age information provided at enrollment visit in MNH01 including: (varname [form]: `US_GA_WKS_AGE_FTS1-4` [MNH01], `US_GA_DAYS_AGE_FTS1-4` [MNH01], `GA_LMP_WEEKS_SCORRES` [MNH01], `US_OHOSTDAT` [MNH01])

-   MNH09 form filled and date of delivery for first fetus/infant provided (varname [form]: `DELIV_DSSTDAT_INF1` [MNH09]).

***Note:** Gestational age information collected in MNH01 is used to generate best obstetric estimates for EDD. These constructed variables are then used to calculate GA at time of birth.*

### 3b. Provider-initiated preterm delivery

**Definition:** Provider-initiated early delivery via induction of labor, artificial rupture of membranes, or cesarean delivery prior to (or without) spontaneous labor or spontaneous rupture of membranes.

**Denominator:** All preterm deliveries as defined above.

### 3c. Spontaneous preterm delivery

**Definition:** Preterm delivery occurring spontaneously, with spontaneous onset of labor and/or spontaneous rupture of membranes initiating the delivery.

**Denominator:** All preterm deliveries as defined above.

**To be included as "non-missing" for this outcome, a participant must have:**

*For all outcomes:*

**1.** Reported gestational age by either LMP or Ultrasound (varnames [form]: `US_GA_WKS_AGE_FTS1-4` [MNH01], `US_GA_DAYS_AGE_FTS1-4` [MNH01], `GA_LMP_WEEKS_SCORRES` [MNH01]).

**2.** Valid enrollment ultrasound visit date (varname [form]: `US_OHOSTDAT` [MNH01]).

**3.** Valid date of birth for first fetus/infant in the pregnancy (varname [form]: `DELIV_DSSTDAT_INF1` [MNH09]).

*For 3b. Provider-initiated preterm & 3c. Spontaneous preterm:*

**4.** Valid responses for variables on labor including:

a.  if the woman experienced labor (varname [form]: `LABOR_MHOCCUR` [MNH09]);

b.  date and time of labor onset if she experienced labor (`LABOR_MHSTDAT` [MNH09], `LABOR_MHSTTIM` [MNH09]);

c.  if labor was induced (varname [form]: `INDUCED_PROCCUR` [MNH09])

**5.** Valid responses for variables on type of membrane rupture including:

a.  type of membrane rupture (varname [form]: `MEMBRANE_RUPT_MHTERM` [MNH09]);

b.  date and time of membrane rupture (if occurred) (varnames [form]: `MEMBRANE_RUPT_MHSTDAT` [MH09], `MEMBRANE_RUPT_MHSTTIM` [MH09])

**6.** Delivery mode for all fetuses/infants (varname: `DELIV_PRROUTE_INF1-4`, MNH09])


### Table 3a. Preterm delivery & preterm classification
```{r}

preterm_indication<-left_join(preterm_indication,end)

preterm_tab <- preterm_indication %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

     "Expected denominator (total completed pregnancies)" = paste0(
      format(sum(PREG_END== 1, na.rm = TRUE), nsmall = 0, digits = 2)),

     "Excluded: pregnancy losses <20 weeks GA or induced abortion" = paste0(
      format(sum(PREG_END== 1 & PREG_END_DELIV==0 & (PREG_LOSS==1 | PREG_LOSS_INDUCED==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & PREG_END_DELIV==0 & (PREG_LOSS==1 | PREG_LOSS_INDUCED==1), na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Excluded: maternal deaths prior to delivery" = paste0(
      format(sum(PREG_END== 1 & PREG_END_DELIV==0 & PREG_LOSS_DEATH==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & PREG_END_DELIV==0 & PREG_LOSS_DEATH==1, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing: Gestational age information unavailable [MNH01]" = paste0(
      format(sum(MAT_PRETERM_PROV_MISS== 1 & PREG_END== 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_MISS== 1 & PREG_END== 1, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing: Date of pregnancy endpoint not available [MNH09/MNH04/MNH19]" = paste0(
      format(sum(MAT_PRETERM_PROV_MISS==2 & PREG_END== 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_MISS==2 & PREG_END== 1, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing: information on labor onset or rupture of membranes [MNH09]" = paste0(
      format(sum(MAT_PRETERM_PROV_MISS== 5 & PREG_END== 1 & PREG_END_DELIV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_MISS== 5 & PREG_END== 1 & PREG_END_DELIV==1, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Denominator (non-missing)" = paste0(
      format(sum(PREG_END_DELIV==1 & MAT_PRETERM_PROV_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Preterm delivery (20 to <37 weeks)" = paste0(
      format(sum(MAT_PRETERM_ANY == 1 & PREG_END_DELIV==1 & MAT_PRETERM_PROV_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_ANY == 1 & PREG_END_DELIV==1 & MAT_PRETERM_PROV_MISS==0, na.rm = TRUE)/sum(PREG_END_DELIV==1 & MAT_PRETERM_PROV_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Term delivery (>=37 weeks)" = paste0(
      format(sum(MAT_PRETERM_ANY== 0 & PREG_END_DELIV==1 & MAT_PRETERM_PROV_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_ANY== 0 & PREG_END_DELIV==1 & MAT_PRETERM_PROV_MISS==0, na.rm = TRUE)/sum(PREG_END_DELIV==1 & MAT_PRETERM_PROV_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Provider-initiated preterm" = paste0(
      format(sum(MAT_PRETERM_PROV ==1 & MAT_PRETERM_ANY==1 & MAT_PRETERM_PROV_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV==1 & MAT_PRETERM_ANY==1 & MAT_PRETERM_PROV_MISS==0, na.rm = TRUE)/sum(MAT_PRETERM_ANY==1 & MAT_PRETERM_PROV_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Spontaneous preterm" = paste0(
      format(sum(MAT_PRETERM_PROV ==0 & MAT_PRETERM_ANY==1 & MAT_PRETERM_PROV_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV ==0 & MAT_PRETERM_ANY==1 & MAT_PRETERM_PROV_MISS==0, na.rm = TRUE)/sum(MAT_PRETERM_ANY==1 & MAT_PRETERM_PROV_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
preterm_tab[is.na(preterm_tab)] <- paste0("0 (0)")

preterm_tab_output <- tb_theme1(preterm_tab) %>%
  tab_header(
    title = md("**Table 3a**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness<sup>a</sup></span>"),
        rows = 1:6
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Preterm delivery</span>"),
    rows = 7:11
  ) %>%
 tab_row_group(
    label = html("<span style='font-size: 18px'>Preterm classification (among all preterm deliveries)</span>"),
        rows = 10:11
    ) %>%

    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%

 row_group_order(groups = c("<span style='font-size: 18px'>Data completeness<sup>a</sup></span>",
                            "<span style='font-size: 18px'>Preterm delivery</span>",
                            "<span style='font-size: 18px'>Preterm classification (among all preterm deliveries)</span>"))  %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> The expected denominator for this outcome is all completed pregnancies; this includes all pregnancies where an endpoint has been recorded in MNH09 (labor and delivery) OR MNH04 (pregnancy loss reported during ANC visit) OR MNH19 (pregnancy loss reported during hospitalization) OR if a maternal death is reported prior to delivery. </span>"))

```

```{r, out.width = '100%'}

gtsave(preterm_tab_output, file = "preterm_tab_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "preterm_tab_output.png"))

```

### Table 3b. Indication for provider-initiated preterm delivery
```{r}

prov_preterm_tab <- preterm_indication %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

    "Denominator" = paste0(
      format(sum(MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Diabetes(chronic or gestational)" = paste0(
      format(sum(MAT_PRETERM_PROV_IND==8 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND==8 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Cardiac disease" = paste0(
      format(sum(MAT_PRETERM_PROV_IND==9 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND==9 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Hypertension (chronic or gestational)" = paste0(
      format(sum(MAT_PRETERM_PROV_IND== 7 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND== 7 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Preeclampsia/ eclampsia" = paste0(
      format(sum(MAT_PRETERM_PROV_IND == 32 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND == 32 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Herpes" = paste0(
      format(sum(MAT_PRETERM_PROV_IND== 34 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND== 34 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "PMTCT" = paste0(
      format(sum(MAT_PRETERM_PROV_IND==35 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND==35 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Previous cesarean" = paste0(
      format(sum(MAT_PRETERM_PROV_IND ==22 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND==22 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Prior stillbirth" = paste0(
      format(sum(MAT_PRETERM_PROV_IND ==3 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND ==3 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    # Pregnancy & fetal conditions

    "Non-reassuring fetal heart rate " = paste0(
      format(sum(MAT_PRETERM_PROV_IND ==2 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND ==2 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Oligohydramnios" = paste0(
      format(sum(MAT_PRETERM_PROV_IND== 5 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND== 5 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "IUGR" = paste0(
      format(sum(MAT_PRETERM_PROV_IND==6 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND==6 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Macrosomia" = paste0(
      format(sum(MAT_PRETERM_PROV_IND== 4 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND== 4 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Post-term^*^" = paste0(
      format(sum(MAT_PRETERM_PROV_IND == 1 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND == 1 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Fetal anomaly" = paste0(
      format(sum(MAT_PRETERM_PROV_IND== 33 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND== 33 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Abruption/bleeding" = paste0(
      format(sum(MAT_PRETERM_PROV_IND==26 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND==26 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Cord prolapse" = paste0(
      format(sum(MAT_PRETERM_PROV_IND ==28 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND==28 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Breech presentation" = paste0(
      format(sum(MAT_PRETERM_PROV_IND ==29 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND ==29 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Rupture of membranes^*^" = paste0(
      format(sum(MAT_PRETERM_PROV_IND ==11 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND ==11 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    ## elective
    "Elective induction" = paste0(
      format(sum(MAT_PRETERM_PROV_IND== 10 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND== 10 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Elective cesarean" = paste0(
      format(sum(MAT_PRETERM_PROV_IND==36 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND==36 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

  ## other
    "Other indication" = paste0(
      format(sum(MAT_PRETERM_PROV_IND ==88 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND==88 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Multiple indications" = paste0(
      format(sum(MAT_PRETERM_PROV_IND ==89 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND ==89 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

  ## missing information

    "No indication provided" = paste0(
      format(sum(MAT_PRETERM_PROV_IND ==555 & MAT_PRETERM_PROV==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_PROV_IND ==555 & MAT_PRETERM_PROV==1, na.rm = TRUE)/sum(MAT_PRETERM_PROV==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
prov_preterm_tab[is.na(prov_preterm_tab)] <- paste0("0 (0)")

## table is too long - split into 2
prov_preterm_tab1 <- prov_preterm_tab[1:19,]
prov_preterm_tab2 <- prov_preterm_tab[20:24,]

prov_preterm_tab_output1 <- tb_theme1(prov_preterm_tab1) %>%
  tab_header(
    title = md("**Table 3b**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Provider-initiated preterm</span>"),
        rows = 1:1
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Maternal conditions & pregnancy history</span>"),
        rows = 2:9
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Pregnancy & fetal conditions</span>"),
    rows = 10:19
  ) %>%
 row_group_order(groups = c( "<span style='font-size: 18px'>Provider-initiated preterm</span>",
                            "<span style='font-size: 18px'>Maternal conditions & pregnancy history</span>",
                            "<span style='font-size: 18px'>Pregnancy & fetal conditions</span>")) %>%

 # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator",
                 "Denominator"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator",
                 "Denominator"))) %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'>* Outcomes indicated with an asterisk (*) are inconsistent with provider-initiated delivery and require further review.</span>")
 )

prov_preterm_tab_output2 <- tb_theme1(prov_preterm_tab2) %>%
  tab_header(
    title = md("**Table 3b continued**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Elective</span>"),
        rows = 1:2
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Other</span>"),
    rows = 3:4
  ) %>%
tab_row_group(
    label = html("<span style='font-size: 18px'>Missing information</span>"),
    rows = 5:5
  ) %>%


 row_group_order(groups = c( "<span style='font-size: 18px'>Elective</span>",
                            "<span style='font-size: 18px'>Other</span>",
                            "<span style='font-size: 18px'>Missing information</span>")) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note:</sup> The indications presented in this table are drawn from form MNH09, from the variable `INDUCED_PRINDC` for provider-initiated deliveries where labor was induced OR from the variable `CES_PRINDC_INF1` for pregnancies where cesarean delivery occurred without prior labor or rupture of membranes.</span>")
 )

```

```{r, out.width = '100%'}

gtsave(prov_preterm_tab_output1, file = "prov_preterm_tab_output1.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "prov_preterm_tab_output1.png"))

```

\newpage

```{r, out.width = '100%'}

gtsave(prov_preterm_tab_output2, file = "prov_preterm_tab_output2.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "prov_preterm_tab_output2.png"))

```

### Table 3c. Indication for spontaneous preterm delivery
```{r}

spon_preterm_tab <- preterm_indication %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

   "Denominator (spontaneous preterm)" = paste0(
      format(sum(MAT_PRETERM_SPON==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Preterm labor" = paste0(
      format(sum(MAT_PRETERM_SPON_IND==1 & MAT_PRETERM_SPON==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_SPON_IND==1 & MAT_PRETERM_SPON==1, na.rm = TRUE)/sum(MAT_PRETERM_SPON==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "PPROM" = paste0(
      format(sum(MAT_PRETERM_SPON_IND==2 & MAT_PRETERM_SPON==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_SPON_IND==2 & MAT_PRETERM_SPON==1, na.rm = TRUE)/sum(MAT_PRETERM_SPON==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Unknown order of events" = paste0(
      format(sum(MAT_PRETERM_SPON_IND== 55 & MAT_PRETERM_SPON==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_PRETERM_SPON_IND== 55 & MAT_PRETERM_SPON==1, na.rm = TRUE)/sum(MAT_PRETERM_SPON==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
spon_preterm_tab[is.na(spon_preterm_tab)] <- paste0("0 (0)")

spon_preterm_tab_output <- tb_theme1(spon_preterm_tab) %>%
  tab_header(
    title = md("**Table 3c**")) %>%

 # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (spontaneous preterm)",
                 "Denominator (spontaneous preterm)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (spontaneous preterm)",
                 "Denominator (spontaneous preterm)")))

```

```{r, out.width = '100%'}

gtsave(spon_preterm_tab_output, file = "spon_preterm_tab_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "spon_preterm_tab_output.png"))

```



\newpage

## 4. Preterm premature rupture of membranes (PPROM)

**Definition:** Spontaneous rupture of membranes occurs prior to 37 weeks GA and before onset of labor OR clinical diagnosis of PPROM during hospitalization.

**Denominator:** All completed pregnancies with:

-   Valid gestational age information provided at enrollment visit in MNH01 including: (varnames [form]: `US_GA_WKS_AGE_FTS1-4` [MNH01], `US_GA_DAYS_AGE_FTS1-4` [MNH01], `GA_LMP_WEEKS_SCORRES` [MNH01], `US_OHOSTDAT` [MNH01]).

And either:

-   MNH09 form filled and date/time of rupture of membranes and onset of labor provided, if applicable (varnames [form]: `MEMBRANE_RUPT_MHSTDAT` [MNH09], `MEMBRANE_RUPT_MHSTTIM` [MNH09], `LABOR_MHSTDAT` [MNH09], `LABOR_MHSTTIM` [MNH09])

or:

-   MNH19 form filled with information on date of hospitalization and clinical diagnosis of PROM (varnames [form]: `OHOSTDAT` [MNH19], `MAT_EST_OHOSTDAT` [MNH19], `LD_COMPL_MHTERM_1` [MNH19])

***Note:** Gestational age information collected in MNH01 is used to generate best obstetric estimates for GA and EDD. These constructed variables are then used to calculate GA at time of rupture of membranes.*

**To be included as "non-missing" for this outcome, a participant must have:**

**1.** Reported gestational age by either LMP or Ultrasound (varnames [form]: `US_GA_WKS_AGE_FTS1-4` [MNH01], `US_GA_DAYS_AGE_FTS1-4` [MNH01], `GA_LMP_WEEKS_SCORRES` [MNH01]).

**2.** Valid enrollment ultrasound visit date (varname [form]: `US_OHOSTDAT` [MNH01]).

And either:

**3.** Valid responses for variables on labor and type of membrane rupture including:

a.  if the woman experienced labor (varname [form]: `LABOR_MHOCCUR` [MNH09]); and

b.  date and time of labor onset if she experienced labor (varname [form]: `LABOR_MHSTDAT` [MNH09], `LABOR_MHSTTIM` [MNH09]).

c.  type of membrane rupture (varname [form]: `MEMBRANE_RUPT_MHTERM` [MNH09]); and

d.  date and time of membrane rupture (if occurred) (varname [form]: `MEMBRANE_RUPT_MHSTDAT` [MNH09], `MEMBRANE_RUPT_MHSTTIM` [MH09])

or:


**4.** Information on clinical diagnosis of PROM at <37 weeks gestation in MNH19 form


### Table 4. Preterm premature rupture of membranes (PPROM)
```{r}

pprom_tab <- preterm_indication %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

    #Denominator for data completeness:

    "Expected denominator (total completed pregnancies)" = paste0(
      format(sum(PREG_END== 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Missing information on type of rupture of membranes (spontaneous or artificial) [MNH09]" = paste0(
      format(sum(PPROM_OCCUR_MISS==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PPROM_OCCUR_MISS==1, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing information on timing of spontaneous rupture of membranes [MNH09]" = paste0(
      format(sum(PPROM_OCCUR_MISS==2, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PPROM_OCCUR_MISS== 2, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing information on labor [MNH09]" = paste0(
      format(sum(PPROM_OCCUR_MISS == 3, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PPROM_OCCUR_MISS == 3, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Missing information for pregnancy loss at <20 weeks [no MNH09]" = paste0(
      format(sum(PPROM_OCCUR_MISS == 4, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PPROM_OCCUR_MISS == 4, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Excluded: induced abortion" = paste0(
      format(sum(PPROM_OCCUR_MISS == 5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PPROM_OCCUR_MISS == 5, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Denominator (non-missing)" = paste0(
      format(sum(PREG_END==1 & PPROM_OCCUR_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2)),

     "PPROM" = paste0(
      format(sum(PPROM_OCCUR == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PPROM_OCCUR == 1, na.rm = TRUE)/sum(PREG_END==1 & PPROM_OCCUR_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "No PPROM" = paste0(
      format(sum(PPROM_OCCUR==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PPROM_OCCUR==0, na.rm = TRUE)/sum(PREG_END==1 & PPROM_OCCUR_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
pprom_tab[is.na(pprom_tab)] <- paste0("0 (0)")

pprom_tab_output <- tb_theme1(pprom_tab) %>%
  tab_header(
    title = md("**Table 4**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>"),
        rows = 1:6
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>PPROM prevalence</span>"),
    rows = 7:9
  ) %>%

    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%



 row_group_order(groups = c("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>",
                            "<span style='font-size: 18px'>PPROM prevalence</span>"))   %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> The expected denominator for this outcome is all completed pregnancies; this includes all pregnancies where an endpoint has been recorded in MNH09 (labor and delivery) OR MNH04 (pregnancy loss reported during ANC visit) OR MNH19 (pregnancy loss reported during hospitalization) OR if a maternal death is reported prior to delivery. The denominator excludes induced abortions. </span>"))

```

```{r, out.width = '100%'}

gtsave(pprom_tab_output, file = "pprom_tab_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "pprom_tab_output.png"))

```


\newpage

## 5. Perinatal depression

**Definition:** Screening for *possible* major depression using Edinburgh Postnatal Depression Scale (EPDS) using a standard cutoff across sites (score $\geq$ 11) (Table 5b) or site-specific cutoff (Table 5c).

**To be included as "non-missing" for this outcome, a participant must have:**

**1.** Visit was completed either in person or by telephone.

**2.** Visit type recorded as enrollment, ANC-20, ANC-32, ANC-36, or PNC-6.

*NOTE: we are not considering if non-scheduled routine visit is indicated*

**3.** Valid responses are calculated from EPDS variables (varname [form]: `EPDS0101`  `EPDS0110` [MNH25])

**Common causes of missingness by visit type:**

**-** Form was filled but visit not completed (varname [form]: `MAT_VISIT_MNHXX` [MNH25] > 2).

**-** Visit was completed but unable to calculate depression score (variables `EPDS0101`  `EPDS0110` [MNH25] unable to calculate because all relevant variables are reported as 77, Not applicable).

\newpage

### Table 5a. Data completeness (MNH25)
```{r}
## to update denominators as needed!!
depression_complete_tab <- depression %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

    ## ANC20
    "Expected denominator^a^" = paste0(
      format(sum(DEPR_MISS_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Visit not completed^b^, n (%)" = paste0(
      format(sum(DEPR_MISS_ANC20== -2, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_MISS_ANC20== -2, na.rm = TRUE)/sum(DEPR_MISS_ANC20_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Visit completed but no summary score, n (%)" = paste0(
      format(sum(DEPR_MISS_ANC20==-1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_MISS_ANC20==-1, na.rm = TRUE)/sum(DEPR_MISS_ANC20_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Observed denominator^c^" = paste0(
      format(sum(DEPR_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    ## ANC32
    "Expected denominator^a^ " = paste0(
      format(sum(DEPR_MISS_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Visit not completed^b^, n (%) " = paste0(
      format(sum(DEPR_MISS_ANC32== -2, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_MISS_ANC32== -2, na.rm = TRUE)/sum(DEPR_MISS_ANC32_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Visit completed but no summary score, n (%) " = paste0(
      format(sum(DEPR_MISS_ANC32==-1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_MISS_ANC32==-1, na.rm = TRUE)/sum(DEPR_MISS_ANC32_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Observed denominator^c^ " = paste0(
      format(sum(DEPR_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    ## PNC6
    "Expected denominator^a^  " = paste0(
      format(sum(DEPR_MISS_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Visit not completed^b^, n (%)  " = paste0(
      format(sum(DEPR_MISS_PNC6==-2, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_MISS_PNC6== -2, na.rm = TRUE)/sum(DEPR_MISS_PNC6_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Visit completed but no summary score, n (%)  " = paste0(
      format(sum(DEPR_MISS_PNC6==-1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_MISS_PNC6==-1, na.rm = TRUE)/sum(DEPR_MISS_PNC6_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Observed denominator^c^  " = paste0(
      format(sum(DEPR_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2))

    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
depression_complete_tab[is.na(depression_complete_tab)] <- paste0("0 (0)")

depression_complete_output <- tb_theme1(depression_complete_tab) %>%
  tab_header(
    title = md("**Table 5a**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data Completeness at ANC-20</span>"),
        rows = 1:4
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data Completeness at ANC-32</span>"),
        rows = 5:8
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data Completeness at PNC-6</span>"),
        rows = 9:12
    ) %>%
 row_group_order(groups = c( "<span style='font-size: 18px'>Data Completeness at ANC-20</span>",
                            "<span style='font-size: 18px'>Data Completeness at ANC-32</span>",
                            "<span style='font-size: 18px'>Data Completeness at PNC-6</span>")) %>%

tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Expected denominator are those who have passed the window, have closed out after the window or have not closed out; or they have data for this visit.</span>")
 )  %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Visit not completed indicates that either the MNH25 form was filled out for that visit type, but the visit was not completed (MAT_VISIT >=3) or the observation was expected and there is no form for that participant.</span>")
 )  %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup>Non-missing.</span>")
 )

```

```{r, out.width = '100%'}
gtsave(depression_complete_output, file = "depression_complete_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "depression_complete_output.png"))
```

\newpage

### 5b. Suspected maternal depression


**Definition:** Screening for possible major depression using Edinburgh Postnatal Depression Scale (EPDS) using a standard or site-specific cutoff:

**Numerator:** Valid depression score $\geq$ threshold (calculated from variables `EPDS0101`  `EPDS0110` [MNH25]) AND visit type = i (`TYPE_VISIT` [MNH25]).

**Denominator:** MNH25 with a valid depression score (calculated from variables `EPDS0101`  `EPDS0110` [MNH25]) AND visit type = i (`TYPE_VISIT` [MNH25]).

**Cutoff scores for depressive symptoms:**


|Site | Threshold|
|---- | ---------|
|Standard| 11 |
|Ghana| 11 |
|India-CMC| 8 |
|India-SAS| 10 |
|Kenya| 13 |
|Pakistan| 14 |
|Zambia| 10 |


\newpage
#### Table 5b. Suspected maternal depression, using standard cutoff score
```{r}
## to update denominators as needed!!

depression_standard_tab <- depression %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

    ##Ever
     "Denominator, n" = paste0(
      format(sum(DEPR_EVER_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Depressive symptoms ever, n (%)^a^" = paste0(
      format(sum(DEPR_STND_EVER_NUM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_STND_EVER_NUM==1, na.rm = TRUE)/sum(DEPR_EVER_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    ##Ever ANC
    "Denominator, n " = paste0(
      format(sum(DEPR_ANC_EVER_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Depressive symptoms, ANC ever, n (%)^b^" = paste0(
      format(sum(DEPR_STND_ANC_EVER_NUM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_STND_ANC_EVER_NUM==1 , na.rm = TRUE)/sum(DEPR_ANC_EVER_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    ##ANC20
    "Denominator, n  " = paste0(
      format(sum(DEPR_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Depressive symptoms, ANC-20, n (%)^c^" = paste0(
      format(sum(DEPR_STND_ANC20_NUM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_STND_ANC20_NUM==1, na.rm = TRUE)/sum(DEPR_ANC20_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

  ##ANC32
    "Denominator, n   " = paste0(
      format(sum(DEPR_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Depressive symptoms, ANC-32, n (%)^d^" = paste0(
      format(sum(DEPR_STND_ANC32_NUM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_STND_ANC32_NUM==1, na.rm = TRUE)/sum(DEPR_ANC32_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    ##PNC6
     "Denominator, n    " = paste0(
      format(sum(DEPR_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Depressive symptoms, PNC-6, n (%)" = paste0(
      format(sum(DEPR_STND_PNC6_NUM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_STND_PNC6_NUM==1, na.rm = TRUE)/sum(DEPR_PNC6_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),




    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
depression_standard_tab[is.na(depression_standard_tab)] <- paste0("0 (0)")

depression_standard_output <- tb_theme1(depression_standard_tab) %>%
  tab_header(
    title = md("**Table 5b**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Depressive symptoms, ever</span>"),
        rows = 1:2
    ) %>%
   tab_row_group(
    label = html("<span style='font-size: 18px'>Depressive symptoms, ANC ever</span>"),
        rows = 3:4
    ) %>%
   tab_row_group(
    label = html("<span style='font-size: 18px'>Depressive symptoms, ANC-20</span>"),
        rows = 5:6
    ) %>%
   tab_row_group(
    label = html("<span style='font-size: 18px'>Depressive symptoms, ANC-32</span>"),
        rows = 7:8
    ) %>%
   tab_row_group(
    label = html("<span style='font-size: 18px'>Depressive symptoms, PNC-6</span>"),
        rows = 9:10
    ) %>%


 row_group_order(groups = c( "<span style='font-size: 18px'>Depressive symptoms, ever</span>",
                             "<span style='font-size: 18px'>Depressive symptoms, ANC ever</span>",
                             "<span style='font-size: 18px'>Depressive symptoms, ANC-20</span>",
                             "<span style='font-size: 18px'>Depressive symptoms, ANC-32</span>",
                             "<span style='font-size: 18px'>Depressive symptoms, PNC-6</span>"
                ) ) %>%
tab_style(
      style = list(
        cell_text(indent = px(0))
        ),
      locations = cells_stub(rows = c('Depressive symptoms ever, n (%)^a^',
                 "Depressive symptoms, ANC ever, n (%)^b^",
                 "Depressive symptoms, ANC-20, n (%)^c^",
                 "Depressive symptoms, ANC-32, n (%)^d^",
                 "Depressive symptoms, PNC-6, n (%)"))
) %>%
  tab_style(
      style = list(
        cell_text(indent = px(0))
        ),
      locations = cells_stub(rows = c('Denominator, n',
                 "Denominator, n ",
                 "Denominator, n  ",
                 "Denominator, n   ",
                 "Denominator, n    "))
      ) %>%

  # bold denominator rows - 1st column
tab_style(
  style = list(
    cell_text(weight = "bold")
  ),
  locations = cells_stub(rows = c(
    'Denominator, n',
                 "Denominator, n ",
                 "Denominator, n  ",
                 "Denominator, n   ",
                 "Denominator, n    "))) %>%

# bold denominator rows - body
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = c(
     'Denominator, n',
                 "Denominator, n ",
                 "Denominator, n  ",
                 "Denominator, n   ",
                 "Denominator, n    "))) %>%


tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> EPDS score at or above 11, ever (among any woman who has at least one EPDS assessment).</span>")
 )  %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> ANC, ever (among any woman who has at least one EPDS assessment at enrollment, ANC-20, ANC-32, or ANC-36).</span>")
 )  %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> ANC-20 includes depression assessments conducted at enrollment and ANC20 visit per protocol.</span>")
 )  %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> ANC-32 includes depression assessments conducted at ANC-32 and ANC-36 per protocol.</span>")
 )

```

```{r, out.width = '100%'}

gtsave(depression_standard_output, file = "depression_standard_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "depression_standard_output.png"))

```

\newpage
#### Table 5c. Maternal Depression, using site-specific cutoff score
```{r}
depression_site_tab <- depression %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(


    "Denominator, n" = paste0(
      format(sum(DEPR_EVER_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Depressive symptoms ever, n (%)^a^" = paste0(
      format(sum(DEPR_SITE_EVER_NUM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_SITE_EVER_NUM==1, na.rm = TRUE)/sum(DEPR_EVER_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Denominator, n " = paste0(
      format(sum(DEPR_ANC_EVER_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Depressive symptoms, ANC ever, n (%)^b^" = paste0(
      format(sum(DEPR_SITE_ANC_EVER_NUM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_SITE_ANC_EVER_NUM==1 , na.rm = TRUE)/sum(DEPR_ANC_EVER_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),


    "Denominator, n  " = paste0(
      format(sum(DEPR_ANC20_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Depressive symptoms, ANC-20, n (%)^c^" = paste0(
      format(sum(DEPR_SITE_ANC20_NUM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_SITE_ANC20_NUM==1, na.rm = TRUE)/sum(DEPR_ANC20_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

 #ANC32
     "Denominator, n   " = paste0(
      format(sum(DEPR_ANC32_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Depressive symptoms, ANC-32, n (%)^d^" = paste0(
      format(sum(DEPR_SITE_ANC32_NUM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_SITE_ANC32_NUM==1, na.rm = TRUE)/sum(DEPR_ANC32_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),


 #PNC6
  "Denominator, n    " = paste0(
      format(sum(DEPR_PNC6_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Depressive symptoms, PNC-6, n (%)" = paste0(
      format(sum(DEPR_SITE_PNC6_NUM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEPR_SITE_PNC6_NUM==1, na.rm = TRUE)/sum(DEPR_PNC6_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
depression_site_tab[is.na(depression_site_tab)] <- paste0("0 (0)")

depression_site_output <- tb_theme1(depression_site_tab) %>%
  tab_header(
    title = md("**Table 5c**")) %>%
   tab_row_group(
    label = html("<span style='font-size: 18px'>Depressive symptoms, ever</span>"),
        rows = 1:2
    ) %>%
   tab_row_group(
    label = html("<span style='font-size: 18px'>Depressive symptoms, ANC ever</span>"),
        rows = 3:4
    ) %>%
   tab_row_group(
    label = html("<span style='font-size: 18px'>Depressive symptoms, ANC-20</span>"),
        rows = 5:6
    ) %>%
   tab_row_group(
    label = html("<span style='font-size: 18px'>Depressive symptoms, ANC-32</span>"),
        rows = 7:8
    ) %>%
   tab_row_group(
    label = html("<span style='font-size: 18px'>Depressive symptoms, PNC-6</span>"),
        rows = 9:10
    ) %>%


 row_group_order(groups = c( "<span style='font-size: 18px'>Depressive symptoms, ever</span>",
                             "<span style='font-size: 18px'>Depressive symptoms, ANC ever</span>",
                             "<span style='font-size: 18px'>Depressive symptoms, ANC-20</span>",
                             "<span style='font-size: 18px'>Depressive symptoms, ANC-32</span>",
                             "<span style='font-size: 18px'>Depressive symptoms, PNC-6</span>"
                ) ) %>%
tab_style(
      style = list(
        cell_text(indent = px(0))
        ),
      locations = cells_stub(rows = c('Depressive symptoms ever, n (%)^a^',
                 "Depressive symptoms, ANC ever, n (%)^b^",
                 "Depressive symptoms, ANC-20, n (%)^c^",
                 "Depressive symptoms, ANC-32, n (%)^d^",
                 "Depressive symptoms, PNC-6, n (%)"))
) %>%
  tab_style(
      style = list(
        cell_text(indent = px(0))
        ),
      locations = cells_stub(rows = c('Denominator, n',
                 "Denominator, n ",
                 "Denominator, n  ",
                 "Denominator, n   ",
                 "Denominator, n    "))
      ) %>%


  # bold denominator rows - 1st column
tab_style(
  style = list(
    cell_text(weight = "bold")
  ),
  locations = cells_stub(rows = c(
   'Denominator, n',
                 "Denominator, n ",
                 "Denominator, n  ",
                 "Denominator, n   ",
                 "Denominator, n    "))) %>%

# bold denominator rows - body
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = c(
     'Denominator, n',
                 "Denominator, n ",
                 "Denominator, n  ",
                 "Denominator, n   ",
                 "Denominator, n    "))) %>%


tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> EPDS score at or above the cutoff score for that site, ever (among any woman who has at least one EPDS assessment).</span>")
 )  %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> ANC, ever (among any woman who has at least one assessment at enrollment, ANC-20, ANC-32, or ANC-36).</span>")
 )  %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> ANC-20 includes depression assessments conducted at enrollment and ANC20 visit per protocol.</span>")
 )  %>%
tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> ANC-32 includes depression assessments conducted at ANC-32 and ANC-36 per protocol.</span>")
 )

```

```{r, out.width = '100%'}

gtsave(depression_site_output, file = "depression_site_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "depression_site_output.png"))

```

\newpage

#### Figure 2. Depressive symptoms at ANC-20
```{r, out.width = '100%', fig.align='center'}

dep_anc20 <- ggplot(depression, aes(x = DEPR_SCORE_ANC20, fill = ..x..)) +
                geom_histogram(alpha=1, position="identity", binwidth = 1) +
                facet_grid(rows = vars(SITE), scales = "free_y") +
                scale_x_continuous(breaks=seq(0,30,1), limits = c(-1,30))+
                ggtitle(paste0("Maternal Depression at ANC-20"))  +
                labs(caption = "Vertical line indicates cutoff for depression using standard cutoff") +
                xlab("") +
                ylab("Frequency") +
                theme_bw() +
                theme(strip.background=element_rect(fill="white"),
                      legend.position="right",
                      legend.title = element_blank(),
                      panel.grid.minor = element_blank(),
                      # strip.text = element_text(size = 6.5),
                      plot.title = element_text(colour = "black", hjust = 0,  size = 10, face = "bold"),
                      plot.margin = margin(t = 20, r = 10, b = 10, l = 10),
                    plot.caption = element_text(hjust = 0, size = 10, margin = margin(t = 10), vjust = 0)) +
                    # axis.text = element_text(size = 8)) +
                      # axis.title = element_text(size = 9),
                      # legend.text = element_text(size = 6),
                      # legend.key.size = unit(0.236,"cm"),
                      # plot.margin = unit(c(0,0,0,0), "pt"),
                      # axis.ticks.x = element_blank()
                geom_vline(aes(xintercept = 11), color = "red",size=0.15) +
                scale_fill_gradientn(colours = c("green", "yellow", "blue3", "darkblue"),
                                     values = c(0, 11/30, (11/30+1)/2, 1))

ggsave(paste0("dep_anc20", ".pdf"), path = path_to_data,
       width = 8, height = 6)

knitr::include_graphics(paste0(path_to_data, "dep_anc20.pdf"))

```

\newpage

#### Figure 3. Depressive symptoms at ANC-32
```{r, out.width = '100%', fig.align='center'}

dep_anc32<- ggplot(depression, aes(x = DEPR_SCORE_ANC32, fill = ..x..)) +
              geom_histogram(alpha=1, position="identity", binwidth = 1) +
              facet_grid(rows = vars(SITE), scales = "free_y") +
              scale_x_continuous(breaks=seq(0,30,1), limits = c(-1,30))+
              ggtitle(paste0("Maternal Depression at ANC-32"))  +
              labs(caption = "Vertical line indicates cutoff for depression using standard cutoff") +
              xlab("") +
              ylab("Frequency") +
              theme_bw() +
              theme(strip.background=element_rect(fill="white"),
                    legend.position="right",
                    legend.title = element_blank(),
                    panel.grid.minor = element_blank(),
                    # strip.text = element_text(size = 6.5),
                    plot.title = element_text(colour = "black", hjust = 0,  size = 10, face = "bold"),
                    plot.margin = margin(t = 20, r = 10, b = 10, l = 10),
                    plot.caption = element_text(hjust = 0, size = 10, margin = margin(t = 10), vjust = 0)) +
                    # axis.text = element_text(size = 8)) +
                    # axis.text = element_text(size = 8),
                    # axis.title = element_text(size = 9),
                    # legend.text = element_text(size = 6),
                    # legend.key.size = unit(0.236,"cm"),
                    # plot.margin = unit(c(0,0,0,0), "pt"),
                    # axis.ticks.x = element_blank()
              geom_vline(aes(xintercept = 11), color = "red",size=0.15) +
              scale_fill_gradientn(colours = c("green", "yellow", "blue3", "darkblue"),
                                   values = c(0, 11/30, (11/30+1)/2, 1))

ggsave(paste0("dep_anc32", ".pdf"), path = path_to_data,
       width = 8, height = 6)

knitr::include_graphics(paste0(path_to_data, "dep_anc32.pdf"))
```

\newpage

#### Figure 4. Depressive symptoms at PNC-6
```{r, out.width = '100%', fig.align='center'}

dep_pnc6 <- ggplot(depression, aes(x = DEPR_SCORE_PNC6, fill = ..x..)) +
              geom_histogram(alpha=1, position="identity", binwidth = 1) +
              facet_grid(rows = vars(SITE), scales = "free_y") +
              scale_x_continuous(breaks=seq(0,30,1), limits = c(-1,30))+
              ggtitle(paste0("Maternal Depression at PNC-6"))  +
              labs(caption = "Vertical line indicates cutoff for depression using standard cutoff") +
              xlab("") +
              ylab("Frequency") +
              theme_bw() +
              theme(strip.background=element_rect(fill="white"),
                    legend.position="right",
                    legend.title = element_blank(),
                    panel.grid.minor = element_blank(),
                    # strip.text = element_text(size = 6.5),
                    plot.title = element_text(colour = "black", hjust = 0,  size = 10, face = "bold"),
                    plot.margin = margin(t = 20, r = 10, b = 10, l = 10),
                    plot.caption = element_text(hjust = 0, size = 10, margin = margin(t = 10), vjust = 0)) +
                    # axis.text = element_text(size = 8)) +
                    # axis.text = element_text(size = 8),
                    # axis.title = element_text(size = 9),
                    # legend.text = element_text(size = 6),
                    # legend.key.size = unit(0.236,"cm"),
                    # plot.margin = unit(c(0,0,0,0), "pt"),
                    # axis.ticks.x = element_blank()
              geom_vline(aes(xintercept = 11), color = "red",size=0.15) +
              scale_fill_gradientn(colours = c("green", "yellow", "blue3", "darkblue"),
                                   values = c(0, 11/30, (11/30+1)/2, 1))

ggsave(paste0("dep_pnc6", ".pdf"), path = path_to_data,
       width = 8, height = 6)

knitr::include_graphics(paste0(path_to_data, "dep_pnc6.pdf"))
```


\newpage

## 6. Hemorrhage

**Definition:** Received at least one procedure for postpartum hemorrhage or excessive bleeding (>=500mL) from or into the genital track, either during pregnancy, prior to delivery, or following the birth of a baby. *Severe hemorrhage* defined as received at least one procedure for postpartum hemorrhage or excessive bleeding (>=1000mL) from or into the genital track, either during pregnancy, prior to delivery, or following the birth of a baby.

**Denominator:** All participants with a reported birth outcome.

&nbsp;

**To be included as "non-Missing" for this outcome, a participant must have:**

**1.** *For Antepartum hemorrhage:* At least one MNH04 form filled out.

**2.** *For Postpartum hemorrhage:* Valid MNH09 form filled out.


### Table 6. Hemorrhage
```{r}


Hemorrhage_tab <- hemorrhage %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(
    
    ## hemorrhage outcome
    "Denominator" = paste0(
      format(sum(HEM_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Antepartum hemorrhage" = paste0(
      format(sum(HEM_APH == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEM_APH == 1, na.rm = TRUE)/sum(HEM_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Postpartum hemorrhage^b^" = paste0(
      format(sum(HEM_PPH == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEM_PPH == 1, na.rm = TRUE)/sum(HEM_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    ## hemorrhage subcategories:
    "Est blood loss >= 500mL^c^" = paste0(
      format(sum(RSN_EST_BLOOD_LOSS_IPC >= 500 | RSN_EST_BLOOD_LOSS_HOSP_ANC >= 500, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_EST_BLOOD_LOSS_IPC >= 500 | RSN_EST_BLOOD_LOSS_HOSP_ANC >= 500, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Procedure/blood transfusion^c^" = paste0(
      format(sum(HEM_PPH ==1 & (RSN_PPH_PROC_IPC_BALLOON==1 | RSN_PPH_PROC_IPC_SURG==1 | RSN_PPH_PROC_IPC_BRACE==1|
                   RSN_PPH_PROC_IPC_VESSEL==1 | RSN_PPH_PROC_IPC_HYSTER==1| RSN_BLOOD_TRANS_IPC==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum((RSN_PPH_PROC_IPC_BALLOON==1 |RSN_PPH_PROC_IPC_SURG==1 |RSN_PPH_PROC_IPC_BRACE==1|
                         RSN_PPH_PROC_IPC_VESSEL==1|RSN_PPH_PROC_IPC_HYSTER==1 | RSN_BLOOD_TRANS_IPC==1) & HEM_PPH ==1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Severe postpartum hemorrhage" = paste0(
      format(sum(HEM_PPH_SEV == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEM_PPH_SEV == 1, na.rm = TRUE)/sum(HEM_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    ## severe subcategories:
    "Est blood loss >= 1000mL^c^" = paste0(
      format(sum(HEM_PPH == 1 & (RSN_EST_BLOOD_LOSS_IPC >= 1000 | RSN_EST_BLOOD_LOSS_PNC >= 1000 | RSN_EST_BLOOD_LOSS_HOSP_PNC >= 1000), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEM_PPH ==1 & (RSN_EST_BLOOD_LOSS_IPC >= 1000 | RSN_EST_BLOOD_LOSS_PNC >= 1000 | RSN_EST_BLOOD_LOSS_HOSP_PNC >= 1000), na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
     
    "Procedure/blood transfusion^c^ " = paste0(
      format(sum(HEM_PPH_SEV==1 & (RSN_PPH_PROC_IPC_BALLOON==1 |RSN_PPH_PROC_IPC_SURG==1 |RSN_PPH_PROC_IPC_BRACE==1|
                                     RSN_PPH_PROC_IPC_VESSEL==1|RSN_PPH_PROC_IPC_HYSTER==1| RSN_BLOOD_TRANS_IPC==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEM_PPH_SEV==1 & (RSN_PPH_PROC_IPC_BALLOON==1 |RSN_PPH_PROC_IPC_SURG==1 |RSN_PPH_PROC_IPC_BRACE==1|
                                           RSN_PPH_PROC_IPC_VESSEL==1|RSN_PPH_PROC_IPC_HYSTER==1| RSN_BLOOD_TRANS_IPC==1), na.rm = TRUE)/sum(HEM_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
        
    "Any hemorrhage at any time point" = paste0(
      format(sum(HEM_APH == 1 | HEM_PPH==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEM_APH == 1 | HEM_PPH==1, na.rm = TRUE)/sum(HEM_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    
    ## Methods of blood loss measurements
    "Denominator " = paste0(
      format(sum(HEM_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Calibrated delivery drapes" = paste0(
      format(sum(BLOOD_LOSS_METHOD_IPC == 1 , na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(BLOOD_LOSS_METHOD_IPC == 1 , na.rm = TRUE)/sum(HEM_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Noncalibrated delivery drapes" = paste0(
      format(sum(BLOOD_LOSS_METHOD_IPC == 2 , na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(BLOOD_LOSS_METHOD_IPC == 2 , na.rm = TRUE)/sum(HEM_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Visual estimation" = paste0(
      format(sum(BLOOD_LOSS_METHOD_IPC == 3 , na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(BLOOD_LOSS_METHOD_IPC == 3 , na.rm = TRUE)/sum(HEM_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Gravimetric technique (weight of blood-soaked materials)" = paste0(
      format(sum(BLOOD_LOSS_METHOD_IPC == 4 , na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(BLOOD_LOSS_METHOD_IPC == 4 , na.rm = TRUE)/sum(HEM_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Method unknown" = paste0(
      format(sum(BLOOD_LOSS_METHOD_IPC ==99, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(BLOOD_LOSS_METHOD_IPC ==99, na.rm = TRUE)/sum(HEM_DENOM==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    ## procedures for PPH (among participants with PPH)
    
    "Denominator  " = paste0(
      format(sum(HEM_PPH == 1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Balloon/condom tamponade" = paste0(
      format(sum(RSN_PPH_PROC_IPC_BALLOON == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_PPH_PROC_IPC_BALLOON == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Surgical interventions" = paste0(
      format(sum(RSN_PPH_PROC_IPC_SURG == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_PPH_PROC_IPC_SURG == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Brace sutures" = paste0(
      format(sum(RSN_PPH_PROC_IPC_BRACE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_PPH_PROC_IPC_BRACE == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Vessel ligation" = paste0(
      format(sum(RSN_PPH_PROC_IPC_VESSEL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_PPH_PROC_IPC_VESSEL == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Hysterectomy" = paste0(
      format(sum(RSN_PPH_PROC_IPC_HYSTER == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_PPH_PROC_IPC_HYSTER == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    # "Other" = paste0(
    #   format(sum(PPH_IPC_OTHER == 1, na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum(PPH_IPC_OTHER == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    #   ")"),
    
    "Blood transfusion" = paste0(
      format(sum(RSN_BLOOD_TRANS_IPC == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_BLOOD_TRANS_IPC == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    ## Medications given to prevent/treat PPH (among all participants with an pph)
    "Denominator   " = paste0(
      format(sum(HEM_PPH == 1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Oxytocin" = paste0(
      format(sum(RSN_PPH_MED_OCY == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_PPH_MED_OCY == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Misoprostol" = paste0(
      format(sum(RSN_PPH_MED_MISO == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_PPH_MED_MISO == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Tranexaminic acid" = paste0(
      format(sum(RSN_PPH_MED_TRANEX == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_PPH_MED_TRANEX == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Carbetocin" = paste0(
      format(sum(RSN_PPH_MED_CARBET == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_PPH_MED_CARBET == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Methylergonovine" = paste0(
      format(sum(RSN_PPH_MED_METHYL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_PPH_MED_METHYL == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Carboprost (PGF2-alpha)" = paste0(
      format(sum(RSN_PPH_MED_CARBOP == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_PPH_MED_CARBOP == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Other " = paste0(
      format(sum(RSN_PPH_MED_OTHER == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_PPH_MED_OTHER == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "No medications given" = paste0(
      format(sum(RSN_PPH_MED_NONE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(RSN_PPH_MED_NONE == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
    
    # "Don't know" = paste0(
    #   format(sum(PPH_MED_DONTKNOW == 1, na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum(PPH_MED_DONTKNOW == 1, na.rm = TRUE)/sum(HEM_PPH==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    #   ")")
    
  ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))
```

```{r}
Hemorrhage_tab[is.na(Hemorrhage_tab)] <- paste0("0 (0)")

## the table is too long -- split into 2
Hemorrhage_tab1 <- Hemorrhage_tab[1:15,]
Hemorrhage_tab2 <- Hemorrhage_tab[16:31,]

hemorrhage_output1 <- tb_theme1(Hemorrhage_tab1) %>%
  tab_header(
    title = md("**Table 6**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Hemorrhage <sup>a</sup></span>"),
    rows = 1:9
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Methods of blood loss measurements <sup>a</sup></span>"),
    rows = 10:15
  ) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Hemorrhage <sup>a</sup></span>",
                             "<span style='font-size: 18px'>Methods of blood loss measurements <sup>a</sup></span>")) %>%
  ## indent severe categories
  tab_style(
    style = list(
      cell_text(indent = px(30), size = 24)
    ),
    locations = cells_stub(rows = c(
      "Est blood loss >= 500mL^c^",
      "Procedure/blood transfusion^c^",
      
      "Est blood loss >= 1000mL^c^",
      "Procedure/blood transfusion^c^ "
    ))
  ) %>% 
  # bold denominator rows
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = c(
      "Denominator",
      "Denominator "))) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_stub(rows = c(
      "Denominator",
      "Denominator "))) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Denominator is all participants with a reported birth outcome.</span>")
  ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Estimate blood loss >=500Ml or procedure/blood transfusion will not add up to equal the total number of PPH cases. Participants who report PPH via checkbox at L&D or following delivery are also included, but are not pulled out in a separate row in the table).</span>")
  ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> Denominator is participants with reported postpartum hemorrhage.</span>")
  ) 

hemorrhage_output2 <- tb_theme1(Hemorrhage_tab2) %>%
  tab_header(
    title = md("**Table 6 continued**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Procedures for postpartum hemorrhage among women with PPH <sup>d</sup></span>"),
    rows = 1:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Medications given to prevent/treat postpartum hemorrhage <sup>d</sup></span>"),
    rows = 8:16
  ) %>%
  
  row_group_order(groups = c("<span style='font-size: 18px'>Procedures for postpartum hemorrhage among women with PPH <sup>d</sup></span>",
                             "<span style='font-size: 18px'>Medications given to prevent/treat postpartum hemorrhage <sup>d</sup></span>")) %>%
  # bold denominator rows
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = c(
      "Denominator  ",
      "Denominator   "))) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_stub(rows = c(
      "Denominator  ",
      "Denominator   "))) %>%
  
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> Denominator is all participants with postpartum hemorrhage.</span>")
  )

```

```{r, out.width = '100%'}

gtsave(hemorrhage_output1, file = "hemorrhage_output1.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "hemorrhage_output1.png"))

```

```{r, out.width = '100%'}

gtsave(hemorrhage_output2, file = "hemorrhage_output2.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "hemorrhage_output2.png"))
```

### Figure 5. Estimated blood loss during labor and delivery
```{r, out.width = '100%', fig.align='center'}

hemorrhage_figs <- hemorrhage %>%
  select(SITE, MOMID, PREGID, RSN_EST_BLOOD_LOSS_IPC,HEM_PPH, HEM_PPH_SEV) %>%
  filter(RSN_EST_BLOOD_LOSS_IPC > 0) %>%
  mutate(CUTOFF = case_when(RSN_EST_BLOOD_LOSS_IPC >= 1000~ "Severe Hemorrhage(>=1000mL)",
                            RSN_EST_BLOOD_LOSS_IPC >= 500 & RSN_EST_BLOOD_LOSS_IPC < 1000~ "Hemorrhage (>=500mL)",
                            TRUE ~ "No hemorrhage (<500mL)"))

# Define the order of legend labels
hemorrhage_figs$CUTOFF <- factor(hemorrhage_figs$CUTOFF, levels = c("No hemorrhage (<500mL)","Hemorrhage (>=500mL)",
                                                                    "Severe Hemorrhage(>=1000mL)"))
ggplot() +
                    geom_histogram(data = hemorrhage_figs, aes(x = RSN_EST_BLOOD_LOSS_IPC, fill = CUTOFF),  color = "gray", binwidth = 50) +
                    scale_fill_manual(values = c("darkgreen", "darkorange","darkred"), name = "") +
                    facet_grid(rows = vars(SITE), scales = "free_y") +
                    xlab("Estimated blood loss (mL)") +
                    ylab("Frequency") +
                    scale_x_continuous(breaks = seq(0,2000,250), limits = c(0, 2000)) +
                    geom_vline(xintercept = 500, linetype = "dashed") +
                    geom_vline(xintercept = 1000, linetype = "dashed") +
                    theme_bw() +
                    theme(strip.background=element_rect(fill="white"),
                          axis.text.x = element_text(vjust = 1, hjust=0.5),
                          legend.position="bottom",
                          legend.title = element_blank(),
                          panel.grid.minor = element_blank())

```


\newpage

## 7. Maternal infection

**Definitions**

-   *Positive at enrollment:* Among participants with a test performed (RDT, serology, GeneXpert.) at enrollment, prevalence of infection. For HIV, reported diagnosis of infection will be included.

-   *Incident infection during pregnancy:* Among participants with a test performed ever during pregnancy, percent incident infection (excluding enrollment). Incident infection indicated if infection status at enrollment was negative or unknown.

-   *Positive ever during pregnancy:* Among participants with a test performed ever during pregnancy, percent infection positive ever during pregnancy. Includes infection positive results at enrollment and incident cases during pregnancy.

### Table 7a. STIs

```{r}

## reorder to be output vars and then missing vars
sti_enroll_tab <- infection1 %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(
    
    "N with enrollment visit" = paste0(
      format(sum(ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "HIV at enrollment (RDT+ or Dx+) ^a^" = paste0(
      format(sum(HIV_POSITIVE_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HIV_POSITIVE_ENROLL == 1, na.rm = TRUE)/sum(ENROLL ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "N with HIV RDT ever during pregnancy" = paste0(
      format(sum(HIV_RDT_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Incident HIV RDT+ during pregnancy ^b^" = paste0( ## kenya Dx is NOT included here 
      format(sum(HIV_POSITIVE_INCIDENT == 1 & HIV_RDT_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HIV_POSITIVE_INCIDENT == 1 & HIV_RDT_PERF_EVER_PREG==1, na.rm = TRUE)/sum(HIV_RDT_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "HIV ever during pregnancy (RDT+ or Dx+ (Dx+ at baseline only)) ^b^" = paste0(
      format(sum(HIV_POSITIVE_EVER_PREG == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HIV_POSITIVE_EVER_PREG == 1, na.rm = TRUE)/sum(ENROLL ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
  # Syphilis
  
    "Syphilis at enrollment (RDT+ only OR RDT+/Dx+ [kenya Dx+ only included at baseline]) ^a^ ^c^" = paste0(
      format(sum(SYPH_POSITIVE_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(SYPH_POSITIVE_ENROLL == 1, na.rm = TRUE)/sum(ENROLL ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
  
    "N with syphilis RDT ever during pregnancy" = paste0(
      format(sum(SYPH_RDT_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Incident syphilis during pregnancy ^b^" = paste0( ## kenya Dx is NOT included here 
      format(sum(SYPH_POSITIVE_INCIDENT == 1 & SYPH_RDT_PERF_ENROLL==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(SYPH_POSITIVE_INCIDENT == 1 & SYPH_RDT_PERF_ENROLL==1, na.rm = TRUE)/sum(SYPH_RDT_PERF_ENROLL ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
  
      "Syphilis during pregancy with unknown baseline status ^b^" = paste0( ## kenya Dx is NOT included here 
      format(sum(SYPH_POSITIVE_UNKNOWN_BASELINE == 1 & SYPH_RDT_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(SYPH_POSITIVE_UNKNOWN_BASELINE == 1 & SYPH_RDT_PERF_EVER_PREG ==1, na.rm = TRUE)/sum(SYPH_RDT_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Syphilis ever during pregnancy (RDT+ only OR RDT+/Dx+ [kenya Dx+ only included at baseline]) ^b^ ^c^" = paste0(
      format(sum(SYPH_POSITIVE_EVER_PREG == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(SYPH_POSITIVE_EVER_PREG == 1, na.rm = TRUE)/sum(ENROLL ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

  ## VAGINAL SWAB TESTING
  
    "N with vaginal swab and test performed at enrollment" = paste0(
      format(sum(CT_TEST_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Chlamydia at enrollment ^d^" = paste0(
      format(sum(CT_TEST_POSITIVE_ENROLL == 1 & CT_TEST_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(CT_TEST_POSITIVE_ENROLL == 1 & CT_TEST_PERF_ENROLL == 1, na.rm = TRUE)/sum(CT_TEST_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Gonorrhea at enrollment ^d^" = paste0(
      format(sum(NG_TEST_POSITIVE_ENROLL == 1 & NG_TEST_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(NG_TEST_POSITIVE_ENROLL == 1 & NG_TEST_PERF_ENROLL == 1, na.rm = TRUE)/sum(NG_TEST_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "N with vaginal swab ever during pregnancy" = paste0(
      format(sum(CT_TEST_PERF_EVER_PREG == 1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Incident Chlamydia ^b^" = paste0(
      format(sum(CT_TEST_POSITIVE_INCIDENT == 1 & CT_TEST_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(CT_TEST_POSITIVE_INCIDENT == 1 & CT_TEST_PERF_EVER_PREG ==1, na.rm = TRUE)/sum(CT_TEST_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
  
    "Incident Gonorrhea ^b^" = paste0(
      format(sum(NG_TEST_POSITIVE_INCIDENT == 1 & NG_TEST_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(NG_TEST_POSITIVE_INCIDENT == 1 & NG_TEST_PERF_EVER_PREG ==1, na.rm = TRUE)/sum(NG_TEST_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
  
    "Chlamydia during pregancy with unknown baseline status ^b^" = paste0( 
      format(sum(CT_TEST_POSITIVE_UNKNOWN_BASELINE == 1 & CT_TEST_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(CT_TEST_POSITIVE_UNKNOWN_BASELINE == 1 & CT_TEST_PERF_EVER_PREG ==1, na.rm = TRUE)/sum(CT_TEST_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
  
    "Gonorrhea during pregancy with unknown baseline status ^b^" = paste0( 
      format(sum(NG_TEST_POSITIVE_UNKNOWN_BASELINE == 1 & NG_TEST_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(NG_TEST_POSITIVE_UNKNOWN_BASELINE == 1 & NG_TEST_PERF_EVER_PREG ==1, na.rm = TRUE)/sum(NG_TEST_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
  
    "Chlamydia ever during pregnancy ^b^" = paste0(
      format(sum(CT_TEST_POSITIVE_EVER_PREG == 1 & CT_TEST_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(CT_TEST_POSITIVE_EVER_PREG == 1 & CT_TEST_PERF_EVER_PREG==1, na.rm = TRUE)/sum(CT_TEST_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
  
    "Gonorrhea ever during pregnancy ^b^" = paste0(
      format(sum(NG_TEST_POSITIVE_EVER_PREG == 1 & NG_TEST_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(NG_TEST_POSITIVE_EVER_PREG == 1 & NG_TEST_PERF_EVER_PREG==1, na.rm = TRUE)/sum(NG_TEST_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  mutate_all(funs(str_replace(., "NaN", "0")))


```

```{r}
# replace NA with 0s (this likely means there is not yet data)
sti_enroll_tab[is.na(sti_enroll_tab)] <- paste0("0 (0)")

## the table is too long -- split into 2
sti_enroll_tab1 <- sti_enroll_tab[1:10,]
sti_enroll_tab2 <- sti_enroll_tab[11:20,]

## first half of table
sti_enroll_output1 <- tb_theme1(sti_enroll_tab1) %>%
  tab_header(
    title = md("**Table 7a**")) %>%

  tab_row_group(
    label = html("<span style='font-size: 18px'>HIV, n (%)</span>"),
    rows = 2:5
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Syphilis, n (%)</span>"),
    rows = 6:10
  ) %>%
  # tab_row_group(
  #   label = html("<span style='font-size: 18px'>CT/NG Vaginal Swabs, n (%)</span>"),
  #   rows = 10:17
  # ) %>%
  row_group_order(groups = c(NA,
                            "<span style='font-size: 18px'>HIV, n (%)</span>",
                            "<span style='font-size: 18px'>Syphilis, n (%)</span>"
                            )) %>%
  # bold denominator rows
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                  "N with enrollment visit"))) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                  "N with enrollment visit"))) %>%
      # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "N with HIV RDT ever during pregnancy",
                 "N with syphilis RDT ever during pregnancy"
                 
                 ))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "N with HIV RDT ever during pregnancy",
                 "N with syphilis RDT ever during pregnancy"))) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Denominator is total participants enrolled.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Denominator is total participants with at test performed ever during pregnancy.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> Syphilis indicated RDT+ only or RDT+ and Dx+. Syphilis reported only by Dx+ indicated for Kenya at enrollment.</span>") 
 )  


## first half of table
sti_enroll_output2 <- tb_theme1(sti_enroll_tab2) %>%
  tab_header(
    title = md("**Table 7a continued**")) %>%

  tab_row_group(
    label = html("<span style='font-size: 18px'>CT/NG Vaginal Swabs, n (%)</span>"),
    rows = 1:10
  ) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>CT/NG Vaginal Swabs, n (%)</span>"
                            )) %>%
  # bold denominator rows
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "N with vaginal swab and test performed at enrollment",
                 "N with vaginal swab ever during pregnancy"
                 ))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "N with vaginal swab and test performed at enrollment",
                 "N with vaginal swab ever during pregnancy"))) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Denominator is total participants with at test performed ever during pregnancy.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> Denominator is total participants with a test performed at enrollment.</span>")
 )


```

```{r, out.width = '100%'}

gtsave(sti_enroll_output1, file = "sti_enroll_output1.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "sti_enroll_output1.png"))

```

```{r, out.width = '100%'}

gtsave(sti_enroll_output2, file = "sti_enroll_output2.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "sti_enroll_output2.png"))

```

### Table 7b. Malaria

```{r}

mal_table <- infection1 %>% 
  # mutate(ENROLL=1) %>% 
  rowwise() %>% 
  group_by(SITE) %>% 
  summarise(
    
    "N with Malaria RDT at enrollment" = paste0(
      format(sum(MAL_RDT_PERF_ENROLL ==1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Malaria positive at enrollment ^a^" = paste0(
      format(sum(MAL_POSITIVE_ENROLL == 1 & MAL_RDT_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAL_POSITIVE_ENROLL == 1 & MAL_RDT_PERF_ENROLL == 1, na.rm = TRUE)/sum(ENROLL ==1 & MAL_RDT_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "N with Malaria RDT ever during pregnancy" = paste0(
      format(sum(MAL_RDT_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Incident Malaria during pregnancy ^b^" = paste0(
      format(sum(MAL_POSITIVE_INCIDENT == 1 & MAL_RDT_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAL_POSITIVE_INCIDENT == 1 & MAL_RDT_PERF_EVER_PREG==1, na.rm = TRUE)/sum(MAL_RDT_PERF_EVER_PREG==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Re-infection with Malaria during pregnancy ^c^" = paste0(
      format(sum(MAL_POSITIVE_REINFECT == 1 & MAL_POSITIVE_EVER_PREG==1,na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAL_POSITIVE_REINFECT == 1 & MAL_POSITIVE_EVER_PREG==1, na.rm = TRUE)/sum(MAL_POSITIVE_EVER_PREG==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Malaria during pregancy with unknown baseline status ^b^" = paste0( ## kenya Dx is NOT included here 
      format(sum(MAL_POSITIVE_UNKNOWN_BASELINE == 1 & MAL_RDT_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAL_POSITIVE_UNKNOWN_BASELINE == 1 & MAL_RDT_PERF_EVER_PREG ==1, na.rm = TRUE)/sum(MAL_RDT_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Malaria RDT+ ever during pregnancy ^b^" = paste0(
      format(sum(MAL_POSITIVE_EVER_PREG == 1 & MAL_RDT_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAL_POSITIVE_EVER_PREG == 1 & MAL_RDT_PERF_EVER_PREG==1, na.rm = TRUE)/sum(MAL_RDT_PERF_EVER_PREG==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  ) %>%
  t() %>% as.data.frame() %>% 
  `colnames<-`(c(.[1,])) %>% 
  slice(-1) %>% 
  mutate_all(funs(str_replace(., "NaN", "0"))) 

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
mal_table[is.na(mal_table)] <- paste0("0 (0)")

malaria_tab_output <- tb_theme1(mal_table) %>%
  tab_header(
    title = md("**Table 7b**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Malaria, n (%)</span>"),
    rows = 1:7
  ) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Malaria, n (%)</span>"
                           )) %>%
    # bold denominator rows
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                  "N with Malaria RDT at enrollment",
                  "N with Malaria RDT ever during pregnancy"))) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                  "N with Malaria RDT at enrollment",
                  "N with Malaria RDT ever during pregnancy"))) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Denominator is total participants with a malaria RDT performed at enrollment.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Denominator is total participants with a malaria RDT performed ever during pregnancy.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> Re-infection with malaria defined as two positive RDT+ results with at least one negative RDT result inbetween. If a participant is positive at enrollment AND re-infected during pregnancy, they will only be counted once in the `Malaria RDT+ ever during pregnancy` row. Denominator is total participants with a malaria RDT performed ever during pregnancy.</span>")
 )

```

```{r, out.width = '100%'}

gtsave(malaria_tab_output, file = "malaria_tab_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "malaria_tab_output.png"))

```

### Table 7c. Hepatitis

```{r}

hepatitis_tab <- infection1 %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

    "N with HBV RDT performed at enrollment" = paste0(
      format(sum(HBV_RDT_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Hep B RDT+ at enrollment ^a^" = paste0(
      format(sum(HBV_POSITIVE_ENROLL == 1 & HBV_RDT_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HBV_POSITIVE_ENROLL == 1 & HBV_RDT_PERF_ENROLL == 1, na.rm = TRUE)/sum(HBV_RDT_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "N with HBV RDT performed ever during pregnancy" = paste0(
      format(sum(HBV_RDT_PERF_EVER_PREG == 1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Incident Hep B during pregnancy ^b^" = paste0(
      format(sum(HBV_POSITIVE_INCIDENT == 1 & HBV_RDT_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HBV_POSITIVE_INCIDENT == 1 & HBV_RDT_PERF_EVER_PREG==1, na.rm = TRUE)/sum(HBV_RDT_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Hep B RDT+ ever during pregnancy ^b^" = paste0(
      format(sum(HBV_POSITIVE_EVER_PREG == 1 & HBV_RDT_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HBV_POSITIVE_EVER_PREG == 1 & HBV_RDT_PERF_EVER_PREG==1, na.rm = TRUE)/sum(HBV_RDT_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

  # Hepatitis C
  
    "N with HCV RDT performed at enrollment" = paste0(
      format(sum(HCV_RDT_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Hep C RDT+ at enrollment ^a^" = paste0(
      format(sum(HCV_POSITIVE_ENROLL == 1 & HCV_RDT_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HCV_POSITIVE_ENROLL == 1 & HCV_RDT_PERF_ENROLL == 1, na.rm = TRUE)/sum(HCV_RDT_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "N with HCV RDT performed ever during pregnancy" = paste0(
      format(sum(HCV_RDT_PERF_EVER_PREG == 1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Incident Hep C during pregnancy ^b^" = paste0(
      format(sum(HCV_POSITIVE_INCIDENT == 1 & HCV_RDT_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HCV_POSITIVE_INCIDENT == 1 & HCV_RDT_PERF_EVER_PREG==1, na.rm = TRUE)/sum(HCV_RDT_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Hep C RDT+ ever during pregnancy ^b^" = paste0(
      format(sum(HCV_POSITIVE_EVER_PREG == 1 & HCV_RDT_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HCV_POSITIVE_EVER_PREG == 1 & HCV_RDT_PERF_EVER_PREG==1, na.rm = TRUE)/sum(HCV_RDT_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
  
    # Hepatitis E
  
    "N with HEV test at enrollment" = paste0(
      format(sum(HEV_IGM_PERF_ENROLL==1 | HEV_IGG_PERF_ENROLL==1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    # "Hep E History (IgG+) @ Baseline" = paste0(
    #   format(sum(HEV_IGG_POSITIVE_ENROLL == 1 & HEV_IGG_PERF_ENROLL == 1 &  HEV_IGM_POSITIVE_ENROLL ==0, na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum(HEV_IGG_POSITIVE_ENROLL == 1 & HEV_IGG_PERF_ENROLL == 1 & HEV_IGM_POSITIVE_ENROLL ==0, na.rm = TRUE)/sum(HEV_IGG_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    #   ")"),
    
    "Hep E IgM+ at enrollment ^a^" = paste0(
      format(sum(HEV_IGM_POSITIVE_ENROLL == 1 & HEV_IGM_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEV_IGM_POSITIVE_ENROLL == 1 & HEV_IGM_PERF_ENROLL == 1, na.rm = TRUE)/sum(HEV_IGM_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "N with HEV test ever during pregnancy" = paste0(
      format(sum(HEV_IGM_PERF_EVER_PREG==1 | HEV_IGG_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Incident Hep E IgM+ during pregnancy ^b^" = paste0(
      format(sum(HEV_IGM_INCIDENT == 1 & HEV_IGM_PERF_EVER_PREG == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEV_IGM_INCIDENT == 1 & HEV_IGM_PERF_EVER_PREG == 1, na.rm = TRUE)/sum(HEV_IGM_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Incident Hep E IgG+ during pregnancy ^b^" = paste0(
      format(sum(HEV_IGG_INCIDENT==1 & HEV_IGG_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEV_IGG_INCIDENT==1 & HEV_IGG_PERF_EVER_PREG==1, na.rm = TRUE)/sum(HEV_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
  
    "Hep E IgM+ during pregancy with unknown baseline status ^b^" = paste0( 
      format(sum(HEV_IGM_UNKNOWN_BASELINE==1 & HEV_IGM_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEV_IGM_UNKNOWN_BASELINE==1 & HEV_IGM_PERF_EVER_PREG==1, na.rm = TRUE)/sum(HEV_IGM_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Hep E ever during pregnancy (IgM+ or incident IgG+) ^c^" = paste0(
      format(sum(HEV_POSITIVE_EVER_PREG ==1 & (HEV_IGM_PERF_EVER_PREG==1 | HEV_IGG_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEV_POSITIVE_EVER_PREG ==1 & (HEV_IGM_PERF_EVER_PREG==1 | HEV_IGG_PERF_EVER_PREG==1), na.rm = TRUE)/sum(HEV_IGM_PERF_EVER_PREG ==1| HEV_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  mutate_all(funs(str_replace(., "NaN", "0")))



```

```{r}
# replace NA with 0s (this likely means there is not yet data)
hepatitis_tab[is.na(hepatitis_tab)] <- paste0("0 (0)")


## the table is too long -- split into 2
hepatitis_tab1 <- hepatitis_tab[1:10,]
hepatitis_tab2 <- hepatitis_tab[11:17,]


hepatitis_tab_output1 <- tb_theme1(hepatitis_tab1) %>%
  tab_header(
    title = md("**Table 7c**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Hep B, n (%)</span>"),
    rows = 1:5
  ) %>%

  tab_row_group(
    label = html("<span style='font-size: 18px'>Hep C, n (%)</span>"),
    rows = 6:10
  ) %>%
# 
#  tab_row_group(
#     label = html("<span style='font-size: 18px'>Hep E, n (%)</span>"),
#     rows = 11:16
#   ) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Hep B, n (%)</span>",
                             "<span style='font-size: 18px'>Hep C, n (%)</span>"
                           )) %>%
  # bold denominator rows
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                  "N with HBV RDT performed at enrollment",
                  "N with HBV RDT performed ever during pregnancy",
                  "N with HCV RDT performed at enrollment",
                  "N with HCV RDT performed ever during pregnancy"))
      ) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                  "N with HBV RDT performed at enrollment",
                  "N with HBV RDT performed ever during pregnancy",
                  "N with HCV RDT performed at enrollment",
                  "N with HCV RDT performed ever during pregnancy"))
      ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Denominator is total participants with a test performed at enrollment.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Denominator is total particpants with a test performed ever during pregnancy.</span>")
 ) 

hepatitis_tab_output2 <- tb_theme1(hepatitis_tab2) %>%
  tab_header(
    title = md("**Table 7c continued**")) %>%
 tab_row_group(
    label = html("<span style='font-size: 18px'>Hep E, n (%)</span>"),
    rows = 1:7
  ) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Hep E, n (%)</span>"
                           )) %>%
  # bold denominator rows
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                  "N with HEV test at enrollment",
                  "N with HEV test ever during pregnancy"))) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                  "N with HEV test at enrollment",
                  "N with HEV test ever during pregnancy"))) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Denominator is total participants with a test performed at enrollment.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Denominator is total particpants with a test performed ever during pregnancy.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> Ever during pregnancy defined as: IgM+ at enrollment OR Incident IgM+ OR Incident IgG+ OR IgM+ during pregnancy with unknown enrollment status.</span>")
 ) 


```

```{r, out.width = '100%'}

gtsave(hepatitis_tab_output1, file = "hepatitis_tab_output1.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "hepatitis_tab_output1.png"))

```

\newpage 

```{r, out.width = '100%'}

gtsave(hepatitis_tab_output2, file = "hepatitis_tab_output2.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "hepatitis_tab_output2.png"))

```

\newpage

### Table 7d. TB

```{r}

tb_tab <- infection1 %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(
    
    "N with enrollment visit" = paste0(
      format(sum(ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "TB Dx+ at enrollment ^a^" = paste0(
      format(sum(TB_DX_POSITIVE_ENROLL == 1 & ENROLL ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(TB_DX_POSITIVE_ENROLL == 1 & ENROLL == 1 , na.rm = TRUE)/sum(ENROLL ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "TB GeneXpert positive at enrollment ^b^" = paste0(
      format(sum(TB_CULT_POSITIVE_ENROLL == 1 & TB_CULT_PERF_ENROLL ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(TB_CULT_POSITIVE_ENROLL == 1 & TB_CULT_PERF_ENROLL == 1, na.rm = TRUE)/sum(TB_CULT_PERF_ENROLL ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "TB Dx+ or GeneXpert positive at enrollment ^a^" = paste0(
      format(sum(TB_POSITIVE_ENROLL == 1 & ENROLL ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(TB_POSITIVE_ENROLL == 1 & ENROLL == 1, na.rm = TRUE)/sum(ENROLL ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "N with GeneXpert performed ever during pregnancy" = paste0(
      format(sum(TB_CULT_PERF_EVER_PREG == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Incident TB GeneXpert positive ^c^" = paste0( ## for TB culture we do not care what your baseline culture status was because not everyone is getting a culture 
      format(sum(TB_CULT_POSITIVE_INCIDENT == 1 & TB_CULT_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(TB_CULT_POSITIVE_INCIDENT == 1 & TB_CULT_PERF_EVER_PREG == 1, na.rm = TRUE)/sum(TB_CULT_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    # "TB GeneXpert+ during pregancy with unknown baseline status ^c^" = paste0( 
    #   format(sum(TB_CULT_UNKNOWN_BASELINE == 1 & TB_CULT_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum(TB_CULT_UNKNOWN_BASELINE == 1 & TB_CULT_PERF_EVER_PREG ==1, na.rm = TRUE)/sum(TB_CULT_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    #   ")"),
    
    "TB GeneXpert positive ever during pregnancy ^c^" = paste0(
      format(sum(TB_CULT_POSITIVE_EVER_PREG == 1 & TB_CULT_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(TB_CULT_POSITIVE_EVER_PREG == 1 & TB_CULT_PERF_EVER_PREG == 1, na.rm = TRUE)/sum(TB_CULT_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"), 
    
    
    "TB Dx+ or GeneXpert+ ever during pregnancy ^a^" = paste0(
      format(sum(TB_POSITIVE_EVER_PREG == 1 & ENROLL ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(TB_POSITIVE_EVER_PREG == 1 & ENROLL == 1, na.rm = TRUE)/sum(ENROLL ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  mutate_all(funs(str_replace(., "NaN", "0")))



```

```{r}
# replace NA with 0s (this likely means there is not yet data)
tb_tab[is.na(tb_tab)] <- paste0("0 (0)")

tb_tab_output <- tb_theme1(tb_tab) %>%
  tab_header(
    title = md("**Table 7d**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>TB, n (%)</span>"),
    rows = 2:8
  ) %>%
row_group_order(groups = c(NA,
                             "<span style='font-size: 18px'>TB, n (%)</span>"
                           )) %>%
    # bold denominator rows
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                  "N with GeneXpert performed ever during pregnancy"))) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                  "N with GeneXpert performed ever during pregnancy"))) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Denominator is total particpants enrolled.</span>")
 ) %>%
    tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Denominator is total participants with a GeneXpert performed at enrollment.</span>")
 ) %>% 
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> Denominator is total participants with a GeneXpert performed ever during pregnancy.</span>")
 ) 

```

```{r, out.width = '100%'}

gtsave(tb_tab_output, file = "tb_tab_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "tb_tab_output.png"))

```

### Table 7e. Arboviruses + Leptospirosis

```{r}

zcd_tab <- infection1 %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

  # N with enrollment visit (following HEV/ZCD/Lepto expansion)

    "N with zika test at enrollment" = paste0(
      format(sum(ZIK_IGM_PERF_ENROLL==1 | ZIK_IGG_PERF_ENROLL==1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    # "Zika History (IgG+) @ Baseline" = paste0(
    #   format(sum(ZIK_IGG_POSITIVE_ENROLL == 1 & ZIK_IGM_POSITIVE_ENROLL==0 & ZIK_IGG_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum(ZIK_IGG_POSITIVE_ENROLL == 1 & ZIK_IGM_POSITIVE_ENROLL==0 & ZIK_IGG_PERF_ENROLL == 1, na.rm = TRUE)/sum(ZIK_IGG_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    #   ")"),

    "Zika IgM+ at enrollment ^a^" = paste0(
      format(sum(ZIK_IGM_POSITIVE_ENROLL == 1 & ZIK_IGM_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ZIK_IGM_POSITIVE_ENROLL == 1 & ZIK_IGM_PERF_ENROLL == 1, na.rm = TRUE)/sum(ZIK_IGM_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "N with zika test ever during pregnancy" = paste0(
      format(sum(ZIK_IGM_PERF_EVER_PREG==1 | ZIK_IGG_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Incident zika IgM+ during pregnancy ^b^" = paste0(
      format(sum(ZIK_IGM_INCIDENT == 1 & ZIK_IGM_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ZIK_IGM_INCIDENT == 1 & ZIK_IGM_PERF_EVER_PREG ==1, na.rm = TRUE)/sum(ZIK_IGM_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Zika IgM+ during pregancy with unknown baseline status ^b^" = paste0(
      format(sum(ZIK_IGM_UNKNOWN_BASELINE == 1 & ZIK_IGM_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ZIK_IGM_UNKNOWN_BASELINE == 1 & ZIK_IGM_PERF_EVER_PREG ==1, na.rm = TRUE)/sum(ZIK_IGM_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Incident zika IgG+ during pregnancy ^b^" = paste0(
      format(sum(ZIK_IGG_INCIDENT == 1 & ZIK_IGG_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ZIK_IGG_INCIDENT == 1 & ZIK_IGG_PERF_EVER_PREG ==1, na.rm = TRUE)/sum(ZIK_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    # "Prior Dengue infection (IgG) among incident Zika IgG+ cases" = paste0(
    #   format(sum(ZIK_IGG_POSITIVE_EVER_PREG == 1 & ZIK_IGM_POSITIVE_ENROLL ==0 & ZIK_IGG_POSITIVE_ENROLL == 0 & ZIK_IGG_PERF_EVER_PREG ==1 &
    #                (DEN_IGG_POSITIVE_EVER_PREG ==1 & ZIK_IGG_WITH_DEN_IGG_PRIOR_INFECTION==1), na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum(ZIK_IGG_POSITIVE_EVER_PREG == 1 & ZIK_IGM_POSITIVE_ENROLL ==0 & ZIK_IGG_POSITIVE_ENROLL == 0 & ZIK_IGG_PERF_EVER_PREG ==1 &
    #                      (DEN_IGG_POSITIVE_EVER_PREG ==1 & ZIK_IGG_WITH_DEN_IGG_PRIOR_INFECTION==1), na.rm = TRUE)/sum(ZIK_IGG_POSITIVE_EVER_PREG == 1 & ZIK_IGM_POSITIVE_ENROLL ==0 & ZIK_IGG_POSITIVE_ENROLL == 0 & ZIK_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    #   ")"),
    
    "Zika ever during pregnancy (IgM+ or incident IgG+) ^b^" = paste0(
      format(sum(ZIK_POSITIVE_EVER_PREG ==1 & (ZIK_IGM_PERF_EVER_PREG==1 | ZIK_IGG_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ZIK_POSITIVE_EVER_PREG ==1 & (ZIK_IGM_PERF_EVER_PREG==1 | ZIK_IGG_PERF_EVER_PREG==1), na.rm = TRUE)/sum(ZIK_IGM_PERF_EVER_PREG ==1| ZIK_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Prior or same day dengue infection (IgG) among incident zika IgG+ cases ^c^" = paste0(
      format(sum(ZIK_IGG_POSITIVE_EVER_PREG == 1 & ZIK_IGM_POSITIVE_ENROLL ==0 & ZIK_IGG_POSITIVE_ENROLL == 0 & ZIK_IGG_PERF_EVER_PREG ==1 &
                   (DEN_IGG_POSITIVE_EVER_PREG ==1 & ZIK_IGG_WITH_DEN_IGG_SAME_DAY==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ZIK_IGG_POSITIVE_EVER_PREG == 1 & ZIK_IGM_POSITIVE_ENROLL ==0 & ZIK_IGG_POSITIVE_ENROLL == 0 & ZIK_IGG_PERF_EVER_PREG ==1 &
                         (DEN_IGG_POSITIVE_EVER_PREG ==1 & ZIK_IGG_WITH_DEN_IGG_SAME_DAY==1), na.rm = TRUE)/sum(ZIK_IGG_POSITIVE_EVER_PREG == 1 & ZIK_IGM_POSITIVE_ENROLL ==0 & ZIK_IGG_POSITIVE_ENROLL == 0 & ZIK_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    
    # "Zika incident IgG and IgM" = paste0(
    #   format(sum(ZIK_IGM_INCIDENT == 1  & ZIK_IGG_INCIDENT ==1, na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum(ZIK_IGM_INCIDENT == 1  & ZIK_IGG_INCIDENT ==1, na.rm = TRUE)/sum(ZIK_IGM_PERF_EVER_PREG ==1| ZIK_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    #   ")"),
    

# Dengue
    "N with dengue test at enrollment" = paste0(
      format(sum(DEN_IGM_PERF_ENROLL==1 | DEN_IGG_PERF_ENROLL==1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    # "Dengue History (IgG+) @ Baseline" = paste0(
    #   format(sum(DEN_IGG_POSITIVE_ENROLL == 1 & DEN_IGM_POSITIVE_ENROLL==0 & DEN_IGG_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum(DEN_IGG_POSITIVE_ENROLL == 1 & DEN_IGM_POSITIVE_ENROLL==0 & DEN_IGG_PERF_ENROLL == 1, na.rm = TRUE)/sum(DEN_IGG_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    #   ")"),
    
    "Dengue IgM+ at enrollment ^a^" = paste0(
      format(sum(DEN_IGM_POSITIVE_ENROLL == 1 & DEN_IGM_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEN_IGM_POSITIVE_ENROLL == 1 & DEN_IGM_PERF_ENROLL == 1, na.rm = TRUE)/sum(DEN_IGM_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "N with dengue test ever during pregnancy" = paste0(
      format(sum(DEN_IGM_PERF_EVER_PREG==1 | DEN_IGG_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Incident Dengue IgM+ during pregnancy ^b^" = paste0(
      format(sum(DEN_IGM_INCIDENT == 1 & DEN_IGM_PERF_EVER_PREG == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEN_IGM_INCIDENT == 1 & DEN_IGM_PERF_EVER_PREG== 1, na.rm = TRUE)/sum(DEN_IGM_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Dengue IgM+ during pregnancy with unknown baseline status ^b^" = paste0(
      format(sum(DEN_IGM_UNKNOWN_BASELINE == 1 & DEN_IGM_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEN_IGM_UNKNOWN_BASELINE == 1 & DEN_IGM_PERF_EVER_PREG ==1, na.rm = TRUE)/sum(DEN_IGM_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Incident dengue IgG+ during pregnancy ^b^" = paste0(
      format(sum(DEN_IGG_INCIDENT == 1 & DEN_IGG_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEN_IGG_INCIDENT == 1 & DEN_IGG_PERF_EVER_PREG==1, na.rm = TRUE)/sum(DEN_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    # "Prior Zika infection (IgG) among incident Dengue IgG+ cases" = paste0(
    #   format(sum(DEN_IGG_POSITIVE_EVER_PREG == 1 & DEN_IGM_POSITIVE_ENROLL ==0 & DEN_IGG_POSITIVE_ENROLL == 0 & DEN_IGG_PERF_EVER_PREG ==1 &
    #                (ZIK_IGG_POSITIVE_EVER_PREG ==1 & DEN_IGG_WITH_ZIK_IGG_PRIOR_INFECTION==1), na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum(DEN_IGG_POSITIVE_EVER_PREG == 1 & DEN_IGM_POSITIVE_ENROLL ==0 & DEN_IGG_POSITIVE_ENROLL == 0 & DEN_IGG_PERF_EVER_PREG ==1 &
    #                      (ZIK_IGG_POSITIVE_EVER_PREG ==1 & DEN_IGG_WITH_ZIK_IGG_PRIOR_INFECTION==1), na.rm = TRUE)/sum(DEN_IGG_POSITIVE_EVER_PREG == 1 & DEN_IGM_POSITIVE_ENROLL ==0 & DEN_IGG_POSITIVE_ENROLL == 0 & DEN_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    #   ")"),
    # 

    "Dengue ever during pregnancy (IgM+ or incident IgG+) ^b^" = paste0(
      format(sum(DEN_POSITIVE_EVER_PREG ==1 & (DEN_IGM_PERF_EVER_PREG==1 | DEN_IGG_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEN_POSITIVE_EVER_PREG ==1 & (DEN_IGM_PERF_EVER_PREG==1 | DEN_IGG_PERF_EVER_PREG==1), na.rm = TRUE)/sum(DEN_IGM_PERF_EVER_PREG ==1| DEN_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Prior or same day zika infection (IgG) among incident dengue IgG+ cases ^d^" = paste0(
      format(sum(DEN_IGG_POSITIVE_EVER_PREG == 1 & DEN_IGM_POSITIVE_ENROLL ==0 & DEN_IGG_POSITIVE_ENROLL == 0 & DEN_IGG_PERF_EVER_PREG ==1 &
                   (ZIK_IGG_POSITIVE_EVER_PREG ==1 & DEN_IGG_WITH_ZIK_IGG_SAME_DAY==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DEN_IGG_POSITIVE_EVER_PREG == 1 & DEN_IGM_POSITIVE_ENROLL ==0 & DEN_IGG_POSITIVE_ENROLL == 0 & DEN_IGG_PERF_EVER_PREG ==1 &
                         (ZIK_IGG_POSITIVE_EVER_PREG ==1 & DEN_IGG_WITH_ZIK_IGG_SAME_DAY==1), na.rm = TRUE)/sum(DEN_IGG_POSITIVE_EVER_PREG == 1 & DEN_IGM_POSITIVE_ENROLL ==0 & DEN_IGG_POSITIVE_ENROLL == 0 & DEN_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

# Chikungunya
    "N with chikungunya test at enrollment" = paste0(
      format(sum(CHK_IGM_PERF_ENROLL==1 | CHK_IGG_PERF_ENROLL==1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    # "Chikungunya History (IgG+) @ Baseline" = paste0(
    #   format(sum(CHK_IGG_POSITIVE_ENROLL == 1 & CHK_IGM_POSITIVE_ENROLL==0 & CHK_IGG_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum(CHK_IGG_POSITIVE_ENROLL == 1 & CHK_IGM_POSITIVE_ENROLL==0 & CHK_IGG_PERF_ENROLL == 1, na.rm = TRUE)/sum(CHK_IGG_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    #   ")"),
    
    "Chikungunya IgM+ at enrollment ^a^" = paste0(
      format(sum(CHK_IGM_POSITIVE_ENROLL == 1 & CHK_IGM_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(CHK_IGM_POSITIVE_ENROLL == 1 & CHK_IGM_PERF_ENROLL == 1, na.rm = TRUE)/sum(CHK_IGM_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "N with chikungunya test ever during pregnancy" = paste0(
      format(sum(CHK_IGM_PERF_EVER_PREG==1 | CHK_IGG_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Incident chikungunya IgM+ during pregnancy ^b^" = paste0(
      format(sum(CHK_IGM_INCIDENT == 1 & CHK_IGM_PERF_EVER_PREG == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(CHK_IGM_INCIDENT == 1 & CHK_IGM_PERF_EVER_PREG== 1, na.rm = TRUE)/sum(CHK_IGM_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Chikungunya IgM+ during pregnancy with unknown baseline status ^b^" = paste0(
      format(sum(CHK_IGM_UNKNOWN_BASELINE == 1 & CHK_IGM_PERF_EVER_PREG ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(CHK_IGM_UNKNOWN_BASELINE == 1 & CHK_IGM_PERF_EVER_PREG ==0, na.rm = TRUE)/sum(CHK_IGM_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Incident chikungunya IgG+ during pregnancy ^b^" = paste0(
      format(sum(CHK_IGG_INCIDENT == 1 & CHK_IGG_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(CHK_IGG_INCIDENT == 1 & CHK_IGG_PERF_EVER_PREG==1, na.rm = TRUE)/sum(CHK_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Chikungunya ever during pregnancy (IgM+ or incident IgG+) ^b^" = paste0(
      format(sum(CHK_POSITIVE_EVER_PREG==1 & (CHK_IGM_PERF_EVER_PREG==1 | CHK_IGG_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(CHK_POSITIVE_EVER_PREG==1 & (CHK_IGM_PERF_EVER_PREG==1 | CHK_IGG_PERF_EVER_PREG==1), na.rm = TRUE)/sum(CHK_IGM_PERF_EVER_PREG ==1| CHK_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

# Leptospirosis
    "N with leptospirosis test at enrollment" = paste0(
      format(sum(LEPT_IGM_PERF_ENROLL==1 | LEPT_IGG_PERF_ENROLL==1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Leptospirosis IgM+ at enrollment ^a^" = paste0(
      format(sum(LEPT_IGM_POSITIVE_ENROLL == 1 & LEPT_IGM_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(LEPT_IGM_POSITIVE_ENROLL == 1 & LEPT_IGM_PERF_ENROLL == 1, na.rm = TRUE)/sum(LEPT_IGM_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    # "Leptospirosis History (IgG+) @ Baseline" = paste0(
    #   format(sum(LEPT_IGG_POSITIVE_ENROLL == 1 & LEPT_IGM_POSITIVE_ENROLL==0 & LEPT_IGG_PERF_ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum(LEPT_IGG_POSITIVE_ENROLL == 1 & LEPT_IGM_POSITIVE_ENROLL==0 & LEPT_IGG_PERF_ENROLL == 1, na.rm = TRUE)/sum(LEPT_IGG_PERF_ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    #   ")"),
    
    "N with leptospirosis test ever during pregnancy" = paste0(
      format(sum(LEPT_IGM_PERF_EVER_PREG==1 | LEPT_IGG_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Incident leptospirosis IgM+ during pregnancy ^b^" = paste0(
      format(sum(LEPT_IGM_POSITIVE_EVER_PREG == 1 & LEPT_IGM_POSITIVE_ENROLL == 0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(LEPT_IGM_POSITIVE_EVER_PREG == 1 & LEPT_IGM_POSITIVE_ENROLL== 0, na.rm = TRUE)/sum(LEPT_IGM_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Leptospirosis IgM+ during pregnancy with unknown baseline status ^b^" = paste0(
      format(sum(LEPT_IGM_POSITIVE_EVER_PREG == 1 & LEPT_IGM_PERF_ENROLL ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(LEPT_IGM_POSITIVE_EVER_PREG == 1 & LEPT_IGM_PERF_ENROLL ==0, na.rm = TRUE)/sum(LEPT_IGM_PERF_ENROLL ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Incident leptospirosis IgG+ during pregnancy ^b^" = paste0(
      format(sum(LEPT_IGG_POSITIVE_EVER_PREG == 1 & LEPT_IGM_POSITIVE_ENROLL==0 & LEPT_IGG_POSITIVE_ENROLL == 0 & LEPT_IGG_PERF_EVER_PREG==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(LEPT_IGG_POSITIVE_EVER_PREG == 1 & LEPT_IGM_POSITIVE_ENROLL==0 & LEPT_IGG_POSITIVE_ENROLL == 0 & LEPT_IGG_PERF_EVER_PREG==1, na.rm = TRUE)/sum(LEPT_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "Leptospirosis ever during pregnancy (IgM+ or incident IgG+)" = paste0(
      format(sum(LEPT_IGM_POSITIVE_EVER_PREG ==1 & (LEPT_IGG_PERF_EVER_PREG == 1 | LEPT_IGM_PERF_EVER_PREG==1), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(LEPT_IGM_POSITIVE_EVER_PREG ==1 & (LEPT_IGG_PERF_EVER_PREG == 1 | LEPT_IGM_PERF_EVER_PREG==1), na.rm = TRUE)/sum(LEPT_IGM_PERF_EVER_PREG ==1| LEPT_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")
    
    # "Leptospirosis incident IgG and IgM" = paste0(
    #   format(sum((LEPT_IGM_POSITIVE_EVER_PREG == 1 & LEPT_IGM_POSITIVE_ENROLL == 0) & ((LEPT_IGG_POSITIVE_EVER_PREG == 1 & LEPT_IGM_POSITIVE_ENROLL==0 & LEPT_IGG_POSITIVE_ENROLL == 0 & LEPT_IGG_PERF_EVER_PREG==1)), na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum((LEPT_IGM_POSITIVE_EVER_PREG == 1 & LEPT_IGM_POSITIVE_ENROLL == 0) & ((LEPT_IGG_POSITIVE_EVER_PREG == 1 & LEPT_IGM_POSITIVE_ENROLL==0 & LEPT_IGG_POSITIVE_ENROLL == 0 & LEPT_IGG_PERF_EVER_PREG==1)), na.rm = TRUE)/sum(LEPT_IGM_PERF_EVER_PREG ==1| LEPT_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    #   ")")

    
    # "Dengue incident IgG and IgM" = paste0(
    #   format(sum((DEN_IGM_POSITIVE_EVER_PREG == 1 & DEN_IGM_POSITIVE_ENROLL == 0) & ((DEN_IGG_POSITIVE_EVER_PREG == 1 & DEN_IGM_POSITIVE_ENROLL==0 & DEN_IGG_POSITIVE_ENROLL == 0 & DEN_IGG_PERF_EVER_PREG==1)), na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum((DEN_IGM_POSITIVE_EVER_PREG == 1 & DEN_IGM_POSITIVE_ENROLL == 0) & ((DEN_IGG_POSITIVE_EVER_PREG == 1 & DEN_IGM_POSITIVE_ENROLL==0 & DEN_IGG_POSITIVE_ENROLL == 0 & DEN_IGG_PERF_EVER_PREG==1)), na.rm = TRUE)/sum(DEN_IGM_PERF_EVER_PREG ==1| DEN_IGG_PERF_EVER_PREG ==1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),


  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  mutate_all(funs(str_replace(., "NaN", "0")))



```

```{r}
# replace NA with 0s (this likely means there is not yet data)
zcd_tab[is.na(zcd_tab)] <- paste0("0 (0)")

## the table is too long -- split into 2
zcd_tab_tab1 <- zcd_tab[1:16,]
zcd_tab_tab2 <- zcd_tab[17:30,]

zcd_tab_output1 <- tb_theme1(zcd_tab_tab1) %>%
  tab_header(
    title = md("**Table 7e**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Zika, n (%)</span>"),
    rows = 1:8
  ) %>%
 tab_row_group(
    label = html("<span style='font-size: 18px'>Dengue, n (%)</span>"),
    rows = 9:16
  ) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Zika, n (%)</span>",
                             "<span style='font-size: 18px'>Dengue, n (%)</span>"
                           )) %>%
  # bold denominator rows
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                  "N with zika test at enrollment",
                  "N with zika test ever during pregnancy",
                  "N with dengue test at enrollment",
                  "N with dengue test ever during pregnancy"
                  ))) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                  "N with zika test at enrollment",
                  "N with zika test ever during pregnancy",
                  "N with dengue test at enrollment",
                  "N with dengue test ever during pregnancy"
                  ))) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Denominator is total participants with test performed at enrollment.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Denominator is total participants with a test performed ever during pregnancy.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>c</sup> Denominator is total participants with an incident zika IgG result during pregnancy.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>d</sup> Denominator is total participants with an incident dengue IgG result during pregnancy.</span>")
 )

zcd_tab_output2 <- tb_theme1(zcd_tab_tab2) %>%
  tab_header(
    title = md("**Table 7e continued**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Chikungunya, n (%)</span>"),
    rows = 1:7
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Leptospirosis, n (%)</span>"),
    rows = 8:14
  ) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Chikungunya, n (%)</span>",
                             "<span style='font-size: 18px'>Leptospirosis, n (%)</span>"
                           )) %>%
  # bold denominator rows
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                  "N with chikungunya test at enrollment",
                  "N with chikungunya test ever during pregnancy",
                  "N with leptospirosis test at enrollment",
                  "N with leptospirosis test ever during pregnancy"
                  ))) %>%
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                  "N with chikungunya test at enrollment",
                  "N with chikungunya test ever during pregnancy",
                  "N with leptospirosis test at enrollment",
                  "N with leptospirosis test ever during pregnancy"
                  ))) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Denominator is total participants with test performed at enrollment.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Denominator is total participants with a test performed ever during pregnancy.</span>")
 )

```

```{r, out.width = '100%'}

gtsave(zcd_tab_output1, file = "zcd_tab_output1.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "zcd_tab_output1.png"))

```

\newpage

```{r, out.width = '100%'}

gtsave(zcd_tab_output2, file = "zcd_tab_output2.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "zcd_tab_output2.png"))

```

\newpage

### Table 7f. All infections combined at enrollment

```{r}
infection2 <- left_join(infection1,end)
## reorder to be output vars and then missing vars
all_infection_tab <- infection2 %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

    "N with enrollment visit" = paste0(
      format(sum(ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Any infection at enrollment" = paste0(
      format(sum(ANY_INFECTION_ENROLL == 1 & ENROLL == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANY_INFECTION_ENROLL == 1 & ENROLL == 1, na.rm = TRUE)/sum(ENROLL == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    "N with pregnancy outcome" = paste0(
      format(sum(PREG_END == 1, na.rm = TRUE), nsmall = 0, digits = 2)),
    
    "Any incident infection ever during pregnancy" = paste0(
      format(sum(ANY_INFECTION_INCIDENT  == 1 & PREG_END ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANY_INFECTION_INCIDENT  == 1 & PREG_END ==1, na.rm = TRUE)/sum(PREG_END == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Any infection ever during pregnancy" = paste0(
      format(sum(ANY_INFECTION_EVER_PREG  == 1 & PREG_END ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ANY_INFECTION_EVER_PREG  == 1 & PREG_END ==1, na.rm = TRUE)/sum(PREG_END == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
all_infection_tab[is.na(all_infection_tab)] <- paste0("0 (0)")

all_infection_output <- tb_theme1(all_infection_tab) %>%
  tab_header(
    title = md("**Table 7f**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Any infection at enrollment <sup>a</sup>, n (%)</span>"),
    rows = 1:2
  ) %>%
    tab_row_group(
    label = html("<span style='font-size: 18px'>Any infection ever during pregnancy <sup>b</sup>, n (%)</span>"),
    rows = 3:5
  ) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Any infection at enrollment <sup>a</sup>, n (%)</span>",
                             "<span style='font-size: 18px'>Any infection ever during pregnancy <sup>b</sup>, n (%)</span>"
                             )) %>%
  # bold denominator rows
  # tab_style(
  #     style = list(
  #       cell_text(weight = "bold")
  #       ),
  #     locations = cells_body(rows = c(
  #                 "N with enrollment visit"))) %>%
  # tab_style(
  #     style = list(
  #       cell_text(weight = "bold")
  #       ),
  #     locations = cells_stub(rows = c(
  #                 "N with enrollment visit"))) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Denominator is total participants enrolled.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Denominator is total participants with a pregnancy outcome.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'>Note: Infections included: HIV, syphilis, chlamydia, gonorrhea (Table 7a); malaria (Table 7b); Hep B, Hep C, Hep E (Table 7c); TB (Table 7d); zika, dengue, chikungunya, and leptospirosis (Table 7e).</span>"))

```

```{r, out.width = '100%'}

gtsave(all_infection_output, file = "all_infection_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "all_infection_output.png"))

```

\newpage

## 8. Overt & Gestational Diabetes

**Definition:** Diabetes outcomes are assessed as follows:

-   *Overt diabetes* is measured by HbA1c level as assessed at enrollment. If this datapoint is missing at enrollment, we rely on HbA1c level as reported in a subsequent visit (unscheduled or ANC-20), if the result is taken at <20 weeks GA. Overt diabetes is defined as HbA1c >=6.5%. We also include participants who report a pre-existing diagnosis of overt diabetes, regardless of HbA1c measure.

-   *Gestational diabetes* is measured by three blood glucose tests as assessed at ANC-28 visit. If this datapoint is missing at ANC-28, we rely on the test result reported at subsequent visits. Gestational diabetes is defined as pretest fasting glucose >=5.1 mmol/L or oral glucose-tolerance test (OGTT) 1-hour result >=10.0 mmol/L or OGTT 2-hour result >=8.5 mmol/L. Gestational diabetes outcomes exclude any participants with Overt Diabetes at enrollment.


**Denominators:** All participants who have continued pregnancy at 28 weeks gestation and passed the ANC-28 visit window (26-30 weeks) based on the following variables:

-   Valid gestational age information provided at enrollment visit in MNH01 including: (varname: `US_GA_WKS_AGE_FTS1-4`, `US_GA_DAYS_AGE_FTS1-4`, `GA_LMP_WEEKS_SCORRES`, `US_OHOSTDAT`).

-   Confirmed enrollment in form MNH02.

-   For Gestational Diabetes, those with Overt Diabetes at/near enrollment are excluded from the denominator.

***Note:** Gestational age information collected in MNH01 is used to generate best obstetric estimates for GA, EDD, and estimated conception date. These constructed variables are then used to determine which observations have passed the ANC-28 visit window.*

***Note:** Gestational diabetes measures for India-SAS are based on the results of two tests (pre-test fasting glucose and 2-hour OGTT). The 1-hour OGTT measure is not completed in this setting.*

### Table 8a. Overt diabetes
```{r}

gdm$DIAB_OVERT_DX<-ifelse(is.na(gdm$DIAB_OVERT_DX),55,gdm$DIAB_OVERT_DX)

## reorder to be output vars and then missing vars
overt_diabetes <- gdm %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

    "Expected denominator (pregnancies continued to 28 weeks gestation)" = paste0(
      format(sum(DIAB_GEST_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Missing enrollment lab form (MNH08) or other lab at <20 weeks GA" = paste0(
      format(sum(DIAB_OVERT_MISS==2 & DIAB_GEST_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_OVERT_MISS==2 & DIAB_GEST_DENOM == 1, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing HbA1c test result in enrollment lab form (MNH08) or other lab at <20 weeks GA" = paste0(
      format(sum(DIAB_OVERT_MISS==1 & DIAB_GEST_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_OVERT_MISS==1 & DIAB_GEST_DENOM == 1, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Denominator (non-missing)" = paste0(
      format(sum(DIAB_OVERT_MISS==0 & DIAB_GEST_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "No overt diabetes (<6.5% HbA1c)" = paste0(
      format(sum(DIAB_OVERT==0 & DIAB_GEST_DENOM == 1 & (DIAB_OVERT_DX==0 | DIAB_OVERT_DX==55), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_OVERT==0 & DIAB_GEST_DENOM == 1 & (DIAB_OVERT_DX==0 | DIAB_OVERT_DX==55), na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1 & DIAB_OVERT_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Overt diabetes (>=6.5% HbA1c or previous diagnosis)" = paste0(
      format(sum((DIAB_OVERT==1 | DIAB_OVERT_DX==1) & DIAB_GEST_DENOM == 1 & DIAB_OVERT_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum((DIAB_OVERT==1 | DIAB_OVERT_DX==1) & DIAB_GEST_DENOM == 1 & DIAB_OVERT_MISS==0, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1 & DIAB_OVERT_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
overt_diabetes[is.na(overt_diabetes)] <- paste0("0 (0)")

overt_diabetes_output <- tb_theme1(overt_diabetes) %>%
  tab_header(
    title = md("**Table 8a**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>"),
    rows = 1:3
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Overt diabetes prevalence</span>"),
    rows = 4:6
  ) %>%
    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (pregnancies continued to 28 weeks gestation)",
                 "Expected denominator (pregnancies continued to 28 weeks gestation)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (pregnancies continued to 28 weeks gestation)",
                 "Expected denominator (pregnancies continued to 28 weeks gestation)"))) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>",
                             "<span style='font-size: 18px'>Overt diabetes prevalence</span>"
                             ))  %>%
   tab_footnote(
     footnote = html("<span style='font-size: 18px'><sup>a</sup> Expected denominator is total participants who had pregnancy to 28 weeks gestation (excluding pregnancies ended and withdrawals prior to 28 weeks) AND who have progressed through the ANC-28 visit window (>30 weeks gestation).</span>")
  )
```

```{r, out.width = '100%'}

gtsave(overt_diabetes_output, file = "overt_diabetes_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "overt_diabetes_output.png"))

```

### Table 8b. Gestational diabetes by pretest fasting glucose only
```{r}

## reorder to be output vars and then missing vars
pretest_fast_diabetes <- gdm %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

    "Expected denominator (pregnancies continued to 28 weeks gestation)" = paste0(
      format(sum(DIAB_GEST_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Excluded: Overt diabetes (>=6.5% HbA1c) or previous diagnosis" = paste0(
      format(sum((DIAB_OVERT==1 | DIAB_OVERT_DX==1) & DIAB_GEST_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum((DIAB_OVERT==1 | DIAB_OVERT_DX==1) & DIAB_GEST_DENOM == 1, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing ANC-28  lab form (MNH08) and no blood glucose test at other visits" = paste0(
      format(sum(DIAB_GEST_FASTING_MISS==2 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_FASTING_MISS==2 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing pretest fasting glucose test result at ANC-28 (and not provided in any other visit)" = paste0(
      format(sum(DIAB_GEST_FASTING_MISS==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_FASTING_MISS==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1& DIAB_OVERT_DX !=1, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Denominator (non-missing)" = paste0(
      format(sum(DIAB_GEST_FASTING_MISS==0 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "No gestational diabetes(<5.1 mmol/L)" = paste0(
      format(sum(DIAB_GEST_FASTING==0 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 &  DIAB_GEST_FASTING_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_FASTING==0 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_FASTING_MISS==0, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_FASTING_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Gestational diabetes (>=5.1 mmol/L)" = paste0(
      format(sum(DIAB_GEST_FASTING==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_FASTING_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_FASTING==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_FASTING_MISS==0, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_FASTING_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
pretest_fast_diabetes[is.na(pretest_fast_diabetes)] <- paste0("0 (0)")

pretest_fast_diabetes_output <- tb_theme1(pretest_fast_diabetes) %>%
  tab_header(
    title = md("**Table 8b**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>"),
    rows = 1:4
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Gestational Diabetes by pretest fasting glucose</span>"),
    rows = 5:7
  ) %>%
    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (pregnancies continued to 28 weeks gestation)",
                 "Expected denominator (pregnancies continued to 28 weeks gestation)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (pregnancies continued to 28 weeks gestation)",
                 "Expected denominator (pregnancies continued to 28 weeks gestation)"))) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>",
                             "<span style='font-size: 18px'>Gestational Diabetes by pretest fasting glucose</span>"
                             ))   %>%
   tab_footnote(
     footnote = html("<span style='font-size: 18px'><sup>a</sup> Expected denominator is total participants who had pregnancy to 28 weeks gestation (excluding pregnancies ended and withdrawals prior to 28 weeks) AND who have progressed through the ANC-28 visit window (>30 weeks gestation).</span>")
  )
```

```{r, out.width = '100%'}

gtsave(pretest_fast_diabetes_output, file = "pretest_fast_diabetes_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "pretest_fast_diabetes_output.png"))

```

### Table 8c. Gestational diabetes by 1-hr OGTT
```{r}

## reorder to be output vars and then missing vars
ogtt_diabetes <- gdm %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

    "Expected denominator (pregnancies continued to 28 weeks gestation)" = paste0(
      format(sum(DIAB_GEST_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Excluded: Overt diabetes (>=6.5% HbA1c) or previous diagnosis" = paste0(
      format(sum((DIAB_OVERT==1 | DIAB_OVERT_DX==1) & DIAB_GEST_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum((DIAB_OVERT==1 | DIAB_OVERT_DX==1) & DIAB_GEST_DENOM == 1, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing ANC-28  lab form (MNH08) and no blood glucose test at other visits" = paste0(
      format(sum(DIAB_GEST_1HR_MISS==2 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_1HR_MISS==2 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing  1-hr OGTT result at ANC-28 (and not provided in any other visit)" = paste0(
      format(sum(DIAB_GEST_1HR_MISS==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_1HR_MISS==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Denominator (non-missing)" = paste0(
      format(sum(DIAB_GEST_1HR_MISS==0 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "No gestational diabetes (<10.0 mmol/L)" = paste0(
      format(sum(DIAB_GEST_1HR==0 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_1HR_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_1HR==0 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_1HR_MISS==0, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_1HR_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Gestational diabetes (>=10.0 mmol/L)" = paste0(
      format(sum(DIAB_GEST_1HR==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_1HR_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_1HR==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_1HR_MISS==0, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_1HR_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
ogtt_diabetes[is.na(ogtt_diabetes)] <- paste0("0 (0)")

ogtt_diabetes_output <- tb_theme1(ogtt_diabetes) %>%
  tab_header(
    title = md("**Table 8c**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>"),
    rows = 1:4
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Gestational Diabetes by 1-hr OGTT <sup>b</sup></span>"),
    rows = 5:7
  ) %>%
    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (pregnancies continued to 28 weeks gestation)",
                 "Expected denominator (pregnancies continued to 28 weeks gestation)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (pregnancies continued to 28 weeks gestation)",
                 "Expected denominator (pregnancies continued to 28 weeks gestation)"))) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>",
                             "<span style='font-size: 18px'>Gestational Diabetes by 1-hr OGTT <sup>b</sup></span>"))   %>%
   tab_footnote(
     footnote = html("<span style='font-size: 18px'><sup>a</sup> Expected denominator is total participants who had pregnancy to 28 weeks gestation (excluding pregnancies ended and withdrawals prior to 28 weeks) AND who have progressed through the ANC-28 visit window (>30 weeks gestation).</span>")
  )  %>%
   tab_footnote(
     footnote = html("<span style='font-size: 18px'><sup>b</sup> Note: 1 hour OGTT measure is not conducted in India-SAS facilities.</span>")
  )
```

```{r, out.width = '100%'}

gtsave(ogtt_diabetes_output, file = "ogtt_diabetes_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "ogtt_diabetes_output.png"))

```

### Table 8d. Gestational diabetes by 2-hr OGTT
```{r}

## reorder to be output vars and then missing vars
ogtt2_diabetes <- gdm %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

   "Expected denominator (pregnancies continued to 28 weeks gestation)" = paste0(
      format(sum(DIAB_GEST_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Excluded: Overt diabetes (>=6.5% HbA1c) or previous diagnosis" = paste0(
      format(sum((DIAB_OVERT==1 | DIAB_OVERT_DX==1) & DIAB_GEST_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum((DIAB_OVERT==1 | DIAB_OVERT_DX==1) & DIAB_GEST_DENOM == 1, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing ANC-28  lab form (MNH08) and no blood glucose test at other visits" = paste0(
      format(sum(DIAB_GEST_2HR_MISS==2 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_2HR_MISS==2 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing 2-hr OGTT result at ANC-28 (and not provided in any other visit)" = paste0(
      format(sum(DIAB_GEST_2HR_MISS==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_2HR_MISS==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Denominator (non-missing)" = paste0(
      format(sum(DIAB_GEST_2HR_MISS==0 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "No gestational diabetes (<8.5 mmol/L)" = paste0(
      format(sum(DIAB_GEST_2HR==0 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_2HR_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_2HR==0 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_2HR_MISS==0, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_2HR_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Gestational diabetes (>=8.5 mmol/L)" = paste0(
      format(sum(DIAB_GEST_2HR==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_2HR_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_2HR==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_2HR_MISS==0, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_2HR_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))


```

```{r}
# replace NA with 0s (this likely means there is not yet data)
ogtt2_diabetes[is.na(ogtt2_diabetes)] <- paste0("0 (0)")

ogtt2_diabetes_output <- tb_theme1(ogtt2_diabetes) %>%
  tab_header(
    title = md("**Table 8d**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>"),
    rows = 1:4
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Gestational Diabetes by 2-hr OGTT</span>"),
    rows = 5:7
  ) %>%

    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (pregnancies continued to 28 weeks gestation)",
                 "Expected denominator (pregnancies continued to 28 weeks gestation)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (pregnancies continued to 28 weeks gestation)",
                 "Expected denominator (pregnancies continued to 28 weeks gestation)"))) %>%

  row_group_order(groups = c("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>",
                             "<span style='font-size: 18px'>Gestational Diabetes by 2-hr OGTT</span>"
                             ))   %>%
   tab_footnote(
     footnote = html("<span style='font-size: 18px'><sup>a</sup> Expected denominator is total participants who had pregnancy to 28 weeks gestation (excluding pregnancies ended and withdrawals prior to 28 weeks) AND who have progressed through the ANC-28 visit window (>30 weeks gestation).</span>")
  )
```

```{r, out.width = '100%'}

gtsave(ogtt2_diabetes_output, file = "ogtt2_diabetes_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "ogtt2_diabetes_output.png"))

```


### Table 8e. Gestational diabetes by any test
```{r}

## reorder to be output vars and then missing vars
any_test_diabetes <- gdm %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

   "Expected denominator (pregnancies continued to 28 weeks gestation)" = paste0(
      format(sum(DIAB_GEST_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Excluded: Overt diabetes (>=6.5% HbA1c) or previous diagnosis" = paste0(
      format(sum((DIAB_OVERT==1 | DIAB_OVERT_DX==1) & DIAB_GEST_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum((DIAB_OVERT==1 | DIAB_OVERT_DX==1) & DIAB_GEST_DENOM == 1, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing ANC-28  lab form (MNH08) and no blood glucose test at other visits" = paste0(
      format(sum(DIAB_GEST_ANY_MISS==2 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_ANY_MISS==2 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing test result(s) at ANC-28 (and not provided in any other visit)" = paste0(
      format(sum(DIAB_GEST_ANY_MISS==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_ANY_MISS==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Denominator (non-missing)" = paste0(
      format(sum(DIAB_GEST_ANY_MISS==0 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "No gestational diabetes (across all 3 tests)" = paste0(
      format(sum(DIAB_GEST_ANY==0 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_ANY_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_ANY==0 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_ANY_MISS==0, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_ANY_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Gestational diabetes (by any test)" = paste0(
      format(sum(DIAB_GEST_ANY==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_ANY_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(DIAB_GEST_ANY==1 & DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_ANY_MISS==0, na.rm = TRUE)/sum(DIAB_GEST_DENOM == 1 & DIAB_OVERT != 1 & DIAB_OVERT_DX !=1 & DIAB_GEST_ANY_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

  )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))



```

```{r}
# replace NA with 0s (this likely means there is not yet data)
any_test_diabetes[is.na(any_test_diabetes)] <- paste0("0 (0)")

any_test_diabetes_output <- tb_theme1(any_test_diabetes) %>%
  tab_header(
    title = md("**Table 8e**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>"),
    rows = 1:4
  ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Gestational Diabetes by any test <sup>b</sup></span>"),
    rows = 5:7
  ) %>%

    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (pregnancies continued to 28 weeks gestation)",
                 "Expected denominator (pregnancies continued to 28 weeks gestation)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (pregnancies continued to 28 weeks gestation)",
                 "Expected denominator (pregnancies continued to 28 weeks gestation)"))) %>%

  row_group_order(groups = c("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>",
                             "<span style='font-size: 18px'>Gestational Diabetes by any test <sup>b</sup></span>"))   %>%
   tab_footnote(
     footnote = html("<span style='font-size: 18px'><sup>a</sup> Expected denominator is total participants who had pregnancy to 28 weeks gestation (excluding pregnancies ended and withdrawals prior to 28 weeks) AND who have progressed through the ANC-28 visit window (>30 weeks gestation).</span>")
  )  %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup>For the final outcome (Gestational Diabetes by any test), only observations with all three (negative) blood-glucose tests are considered negative for Gestational Diabetes (two negative blood-glucose tests in India-SAS). Women with any positive test are considered positive for Gestational Diabetes regardless of whether other tests results are missing.</span>")
 )  %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note: </sup>This table presents Overt Diabetes based on HbA1c test result at enrollment or as provided in another visit at less than 20 weeks gestation. The table presents rates of Gestational Diabetes based on blood glucose tests conducted at or near 28 weeks gestation; we exclude all women with Overt Diabetes from the denominator for Gestational Diabetes, while we include women without Overt Diabetes or with missing HbA1c test results.</span>")
 )
```

```{r, out.width = '100%'}

gtsave(any_test_diabetes_output, file = "any_test_diabetes_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "any_test_diabetes_output.png"))

```

\newpage

#### Figure 6. Venn diagram of Gestational Diabetes diagnosis by test type
```{r}
library(knitr)
library(tidyverse)
library(reshape2)
library(lubridate)
library(naniar)
library(dplyr)
library(RColorBrewer)
library(ggvenn)
library(wesanderson)
gdm_vd <- subset(gdm, (DIAB_GEST_FASTING==1 | DIAB_GEST_1HR==1 | DIAB_GEST_2HR==1) & gdm$SITE!="India-SAS")
gdm_vd$DIAB_GEST_FASTING<-ifelse(gdm_vd$DIAB_GEST_FASTING==55,0,gdm_vd$DIAB_GEST_FASTING)
gdm_vd$DIAB_GEST_1HR<-ifelse(gdm_vd$DIAB_GEST_1HR==55,0,gdm_vd$DIAB_GEST_1HR)
gdm_vd$DIAB_GEST_2HR<-ifelse(gdm_vd$DIAB_GEST_2HR==55,0,gdm_vd$DIAB_GEST_2HR)
# VennDiagram - All site
GDM_pre <- gdm_vd %>% filter(DIAB_GEST_FASTING==1) %>%
  select(PREGID) %>% unlist()
GDM_1 <- gdm_vd %>% filter(DIAB_GEST_1HR==1) %>%
  select(PREGID) %>% unlist()
GDM_2 <- gdm_vd %>% filter(DIAB_GEST_2HR==1) %>%
  select(PREGID) %>% unlist()
# Package ggvenn
ggvenn(data = list(`Fasting glucose` = GDM_pre,
                   `1-hr OGTT` = GDM_1,
                   `2-hr OGTT` = GDM_2),
       fill_color = wesanderson::wes_palette("FantasticFox1", n=3),
       text_size = 3.5,
       stroke_size = 0.5,set_name_size = 5)


```

***Note:** This venn diagram presents positive test results across the three measures for all countries excluding India-SAS, where 1-hour OGTT is not conducted.*


\newpage

## 9. Maternal near-miss

**Definition of near-miss:**

1.   A woman who is pregnant, in labor, or within 42 days of the pregnancy end, *AND*

2.   Experienced the PRISMA-near-miss criteria: **organ dysfunction** [M09_ORG_FAIL_MHOCCUR_1-7,88; M12_ORG_FAIL_MHOCCUR_1-4,88; M19_ORGAN_FAIL_MHTERM_1-7, 88]; **hysterectomy** [M09_PPH_FAORRES_5; M12_BIRTH_COMPL_MHTERM_8; M19_TX_PROCCUR_5]; **blood transfusion of any volume** [M19_TX_PROCCUR_1; or transfusion to treat PPH] **and** women experienced antepartum hemorrhage, severe postpartum hemorrhage, severe anemia, or placental abruption; **preeclampsia with severe features/eclampsia** [see tables 13a-b of this report], **uterine rupture**  [constructed outcome, see table 10 of this report], **sepsis**  [to be constructed], **laparotomy other than C-section** [M19_TX_PROCCUR_2-3,5 or hysterectomy], and/or **admission to ICU** [M10_TRANSFER_OHOLOC==1; M10_TRANSFER_OHOLOC==2] *AND*

3.   Survives the experience.

**Denominator for maternal near miss:**

-   Expected denominator: all women who have passed 42 days postpartum. If pregnancy end date is not known, estimated due date is used to calculate the window.

-   Near-miss denominator: passed 42 days postpartum, MINUS:
  -   "healthy" and closed out during the window
  -   "healthy" and did not have a MNH09/MNH12/MNH19 form
  -   "healthy" and not seen 42+ days postpartum


*Note: "healthy" indicates a woman who is alive, did not experience a potentially life-threatening condition, and did not experience near-miss criteria. Under this definition, a women who e.g., closed out before 42 days postpartum but also experienced a PLTC would still be included in the denominator*


### Table 9a. Near-miss data completeness
```{r}

near_miss_taba <- near_miss %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

    "Expected denominator, n" = paste0(
      format(sum(NEARMISS_WINDOW==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Healthy^a^ & closed out during pregnancy or within 42 days of pregnancy end" = paste0(
      format(sum(NEARMISS_MISS_CLOSEOUT==1 & NEARMISS_WINDOW == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(NEARMISS_MISS_CLOSEOUT==1 & NEARMISS_WINDOW == 1, na.rm = TRUE)/sum(NEARMISS_WINDOW == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Healthy^a^ and missing because no MNH09, MNH12, or MNH19 forms" = paste0(
       format(sum(NEARMISS_MISS_FORMS ==1, na.rm = TRUE), nsmall = 0, digits = 2),
       " (",
       format(round(sum(NEARMISS_MISS_FORMS ==1, na.rm = TRUE)/sum(NEARMISS_WINDOW == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
       ")"),

     "Healthy^a^ and missing because not seen at least 42 days postpartum" = paste0(
       format(sum(NEARMISS_MISS_NOTSEEN42==1, na.rm = TRUE), nsmall = 0, digits = 2),
       " (",
       format(round(sum(NEARMISS_MISS_NOTSEEN42==1, na.rm = TRUE)/sum(NEARMISS_WINDOW == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
       ")"),

    "Near miss denominator, n" = paste0(
      format(sum(NEARMISS_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

   )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%

  add_column(
      .before = 1,
    "Total" = near_miss %>%
        summarise(

           "Expected denominator, n" = paste0(
      format(sum(NEARMISS_WINDOW==1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Healthy^a^ & closed out during pregnancy or within 42 days of pregnancy end" = paste0(
      format(sum(NEARMISS_MISS_CLOSEOUT==1 & NEARMISS_WINDOW == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(NEARMISS_MISS_CLOSEOUT==1 & NEARMISS_WINDOW == 1, na.rm = TRUE)/sum(NEARMISS_WINDOW == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Healthy^a^ and missing because no MNH09, MNH12, or MNH19 forms" = paste0(
       format(sum(NEARMISS_MISS_FORMS ==1, na.rm = TRUE), nsmall = 0, digits = 2),
       " (",
       format(round(sum(NEARMISS_MISS_FORMS ==1, na.rm = TRUE)/sum(NEARMISS_WINDOW == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
       ")"),

     "Healthy^a^ and missing because not seen at least 42 days postpartum" = paste0(
       format(sum(NEARMISS_MISS_NOTSEEN42==1, na.rm = TRUE), nsmall = 0, digits = 2),
       " (",
       format(round(sum(NEARMISS_MISS_NOTSEEN42==1, na.rm = TRUE)/sum(NEARMISS_WINDOW == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
       ")"),

    "Near miss denominator, n" = paste0(
      format(sum(NEARMISS_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

        ) %>%

        t() %>% as.data.frame() %>%
      `colnames<-`(c(.[1,])) %>% unlist()
        )

  #mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  #mutate_all(funs(str_replace(., "NA", "0")))


```

```{r}
# replace NA with 0s (this likely means there is not yet data)
near_miss_taba[is.na(near_miss_taba)] <- paste0("0 (0)")

near_miss_tab_outputa <- tb_theme1(near_miss_taba) %>%
  tab_header(
    title = md("**Table 9a**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness</span>"),
    rows = 1:4
  ) %>%

  row_group_order(groups = c("<span style='font-size: 18px'>Data completeness</span>"
                             ))  %>%
   # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator, n",
                 "Near miss denominator, n"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator, n",
                 "Near miss denominator, n"))) %>%

    

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup>Healthy indicates a women who is alive, did not experience a potentially life-threatening condition, and did not experience  near-miss criteria.</span>")
 )



```

```{r, out.width = '100%'}

gtsave(near_miss_tab_outputa, file = "near_miss_taba.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "near_miss_taba.png"))

```

\newpage


**Potentially life-threatening conditions (PLTC):**

-   **postpartum hemorrhage** [see table 6 of this report]

-   **preeclampsia** [see tables 13a-b of this report]

-   **severe hypertension** [see tables 13a-b of this report]

-   **pulmonary edema** [[M12_PULM_EDEMA_MHOCCUR, M19_DX_OTHR_MHTERM_4; **pulmonary edema in the context of HDP:** M09_PREECLAMPSIA_CEOCCUR_4, M19_PREECLAMPSIA_CEOCCUR_4, M19_HTN_MHTERM_8]

-   **preeclampsia with severe features/eclampsia** [see tables 13a-b of this report]

-   **sepsis or severe infection** [to be constructed]

-   **ruptured uterus** [see table 10 of this report]

-   **blood transfusion of any volume** [mother *needed* transfusion: M09_PPH_TRNSFSN_PROCCUR; mother *received* transfusion: M19_TX_PROCCUR_1]

-   **laparotomy other than C-section** [M19_TX_PROCCUR_2-3,5 or hysterectomy]

-   **abortion complications** [M19_EARLY_LOSS_MHTERM==6]

-   **obstructed labor** [constructed]

-   **prolonged labor** [see table 11 of this report]

-   **placenta accrete** [see table 15 of this report]

-   **placenta abruption** [see table 15 of this report]

-   **endometritis** [M10_POST_DEL_INF_CEOCCUR_1; M19_INFECTION_MHTERM_16]

-   **any hospitalization** [M19; M04_HOSP_OHOOCCUR; M12_HOSP_LAST_VISIT_OHOOCCUR]

### Table 9b. Potentially life-threatening conditions (PLTC)
```{r}

near_miss_tabb <- near_miss %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

    "Near-miss denominator, n" = paste0(
      format(sum(NEARMISS_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

 "Any potentially life-threatening condition" = paste0(
      format(sum(PLTC==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PLTC==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Post partum hemorrhage" = paste0(
      format(sum(HEM_PPH == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEM_PPH==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Pre-eclampsia without severe features " = paste0(
      format(sum(PREECLAMPSIA_NONSEV==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREECLAMPSIA_NONSEV==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Pre-clampsia with severe features/Eclampsia " = paste0(
      format(sum(PREECLAMPSIA_SEV == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREECLAMPSIA_SEV ==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Severe hypertension " = paste0(
      format(sum(HIGH_BP_SEVERE_ANY==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HIGH_BP_SEVERE_ANY==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Sepsis or severe infection *" = paste0(
      format(sum(NEARMISS_DENOM == 0 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(NEARMISS_DENOM == 0 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Endometritis" = paste0(
      format(sum(ENDOMETRITIS ==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ENDOMETRITIS ==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Suspected placenta accrete" = paste0(
      format(sum(PLACENTA_ACCRETE == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PLACENTA_ACCRETE == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Suspected placental abruption" = paste0(
      format(sum(PLACENTA_ABRUPTION == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PLACENTA_ABRUPTION == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Uterine rupture" = paste0(
      format(sum(UTERINE_RUP == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(UTERINE_RUP == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Obstructed labor" = paste0(
      format(sum(OBS_LABOR == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(OBS_LABOR == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Prolonged labor^a^" = paste0(
      format(sum(PRO_LABOR == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PRO_LABOR == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Severe abortion complications" = paste0(
      format(sum(ABORT_COMPL == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ABORT_COMPL == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Pulmonary edema" = paste0(
       format(sum(PULMONARY_EDEMA == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       " (",
       format(round(sum(PULMONARY_EDEMA == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Malaria " = paste0(
       format(sum(MALARIA == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       " (",
       format(round(sum(MALARIA == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Tuberculosis " = paste0(
       format(sum(TB == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       " (",
       format(round(sum(TB == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Severe anemia " = paste0(
       format(sum(ANEMIA_SEV_ANC==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       " (",
       format(round(sum(ANEMIA_SEV_ANC==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Mother needed (M09) and/or received (M19) blood transfusion" = paste0(
      format(sum(TRANSFUSION==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(TRANSFUSION==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Mother referred to ICU (M10)" = paste0(
      format(sum(MAT_ICU==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_ICU==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Laparotomy other than C-section (M19)" = paste0(
      format(sum(LAPAROTOMY==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(LAPAROTOMY==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Any unplanned hospitalization" = paste0(
      format(sum(HOSPITALIZED == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HOSPITALIZED == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   )  %>%
  
   mutate(

            `Prolonged labor^a^` =
              case_when(SITE %in% c("Ghana" , "India-CMC") ~ "--",
                      TRUE ~ `Prolonged labor^a^`),
           

          ) %>%
  
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%

    add_column(
      .before = 1,
      "Total" = near_miss %>%
        summarise(

    "Near-miss denominator, n" = paste0(
      format(sum(NEARMISS_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

 "Any potentially life-threatening condition" = paste0(
      format(sum(PLTC==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PLTC==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Post partum hemorrhage" = paste0(
      format(sum(HEM_PPH == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEM_PPH==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Pre-eclampsia without severe features " = paste0(
      format(sum(PREECLAMPSIA_NONSEV==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREECLAMPSIA_NONSEV==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Pre-clampsia with severe features/Eclampsia " = paste0(
      format(sum(PREECLAMPSIA_SEV == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREECLAMPSIA_SEV ==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Severe hypertension " = paste0(
      format(sum(HIGH_BP_SEVERE_ANY==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HIGH_BP_SEVERE_ANY==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Sepsis or severe infection *" = paste0(
      format(sum(NEARMISS_DENOM == 0 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(NEARMISS_DENOM == 0 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Endometritis" = paste0(
      format(sum(ENDOMETRITIS ==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ENDOMETRITIS ==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Suspected placenta accrete" = paste0(
      format(sum(PLACENTA_ACCRETE == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PLACENTA_ACCRETE == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Suspected placental abruption" = paste0(
      format(sum(PLACENTA_ABRUPTION == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PLACENTA_ABRUPTION == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Uterine rupture" = paste0(
      format(sum(UTERINE_RUP == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(UTERINE_RUP == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Obstructed labor" = paste0(
      format(sum(OBS_LABOR == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(OBS_LABOR == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Prolonged labor^a^" = paste0(
      format(sum(PRO_LABOR == 1 & NEARMISS_DENOM == 1  & SITE %in% c("India-SAS", "Kenya", "Pakistan","Zambia"), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PRO_LABOR == 1 & NEARMISS_DENOM == 1 & SITE %in% c("India-SAS", "Kenya", "Pakistan","Zambia"), na.rm = TRUE)/sum(NEARMISS_DENOM == 1 & SITE %in% c("India-SAS", "Kenya", "Pakistan","Zambia"), na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Severe abortion complications" = paste0(
      format(sum(ABORT_COMPL == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ABORT_COMPL == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Pulmonary edema" = paste0(
       format(sum(PULMONARY_EDEMA == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       " (",
       format(round(sum(PULMONARY_EDEMA == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Malaria " = paste0(
       format(sum(MALARIA == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       " (",
       format(round(sum(MALARIA == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Tuberculosis " = paste0(
       format(sum(TB == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       " (",
       format(round(sum(TB == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Severe anemia " = paste0(
       format(sum(ANEMIA_SEV_ANC==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
       " (",
       format(round(sum(ANEMIA_SEV_ANC==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Mother needed (M09) and/or received (M19) blood transfusion" = paste0(
      format(sum(TRANSFUSION==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(TRANSFUSION==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Mother referred to ICU (M10)" = paste0(
      format(sum(MAT_ICU==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_ICU==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Laparotomy other than C-section (M19)" = paste0(
      format(sum(LAPAROTOMY==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(LAPAROTOMY==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Any unplanned hospitalization" = paste0(
      format(sum(HOSPITALIZED == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HOSPITALIZED == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   ) %>%
   
   
        t() %>% as.data.frame() %>%
        `colnames<-`(c(.[1,])) %>% unlist()
    )
 # mutate_all(funs(str_replace(., "NaN", "0"))) %>%
#  mutate_all(funs(str_replace(., "NA", "0")))


```

```{r}
# replace NA with 0s (this likely means there is not yet data)
near_miss_tabb[is.na(near_miss_tabb)] <- paste0("0 (0)")

near_miss_tab_outputb <- tb_theme1(near_miss_tabb) %>%
  tab_header(
    title = md("**Table 9b**")) %>%
tab_row_group(
    label = html("<span style='font-size: 18px'>Potentially Life-Threatening Conditions (PLTC)</span>"),
    rows = 1:22
  ) %>%
    row_group_order(groups = c("<span style='font-size: 18px'>Potentially Life-Threatening Conditions (PLTC)</span>"))  %>%

     # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Near-miss denominator, n",
                 "Near-miss denominator, n"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Near-miss denominator, n",
                 "Near-miss denominator, n"))) %>%
  
    tab_style(
        style = list(
          cell_text(color = "grey") 
        ),
        locations = list(
          cells_body(columns = c("Ghana", "India-CMC", "India-SAS","Kenya","Pakistan","Zambia", "Total"),
                     rows = c(7))
        )) %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>*</sup>Sepsis and severe infection will be added to PLTC once constructed.</span>")
 ) %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup>Note that the prolonged labor outcome is not available for Ghana and India-CMC sites due to data collection differences.</span>")
 )



```

```{r, out.width = '100%'}

gtsave(near_miss_tab_outputb, file = "near_miss_tabb.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "near_miss_tabb.png"))

```

\newpage

### Table 9c. Maternal near-miss
```{r}

near_miss_tabc <- near_miss %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

    "Near-miss denominator, n" = paste0(
      format(sum(NEARMISS_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

      "Met any near-miss criteria^a^" = paste0(
      format(sum(MAT_MNM_CRIT == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_MNM_CRIT == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

  # Near-miss list:

    "Hysterectomy" = paste0(
      format(sum(HYSTERECTOMY == 1 & NEARMISS_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HYSTERECTOMY == 1 & NEARMISS_DENOM ==1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

      "Laparotomy other than C-section (M19)" = paste0(
      format(sum(LAPAROTOMY==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(LAPAROTOMY==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

      "Mother referred to ICU (M10)" = paste0(
      format(sum(MAT_ICU==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_ICU==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

      "Near-miss transfusion^b^" = paste0(
      format(sum(TRANSFUSION_NEARMISS==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(TRANSFUSION_NEARMISS==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

      "Severe PPH" = paste0(
      format(sum(HEM_PPH_SEV == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEM_PPH_SEV==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Preeclampsia with severe features/eclampsia " = paste0(
      format(sum(PREECLAMPSIA_SEV == 1 & NEARMISS_DENOM ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREECLAMPSIA_SEV==1 & NEARMISS_DENOM ==1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Uterine rupture" = paste0(
      format(sum(UTERINE_RUP == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(UTERINE_RUP == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Sepsis *" = paste0(
      format(sum(NEARMISS_DENOM ==0 & NEARMISS_DENOM ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(NEARMISS_DENOM ==0 & NEARMISS_DENOM ==1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Organ dysfunction" = paste0(
      format(sum(ORG_FAIL ==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ORG_FAIL ==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Met near-miss criteria and survived" = paste0(
      format(sum(NEARMISS ==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(NEARMISS ==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    # "Near-miss but no PLTC" = paste0(
    #   format(sum(MISS_PLTC ==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum(MISS_PLTC ==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    #   ")"),

   )  %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1) %>%
          add_column(
      .before = 1,
    "Total" = near_miss %>%
      summarise(

    "Near-miss denominator, n" = paste0(
      format(sum(NEARMISS_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2)),

      "Met any near-miss criteria^a^" = paste0(
      format(sum(MAT_MNM_CRIT == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_MNM_CRIT == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

  # Near-miss list:

    "Hysterectomy" = paste0(
      format(sum(HYSTERECTOMY == 1 & NEARMISS_DENOM==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HYSTERECTOMY == 1 & NEARMISS_DENOM ==1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

      "Laparotomy other than C-section (M19)" = paste0(
      format(sum(LAPAROTOMY==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(LAPAROTOMY==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

      "Mother referred to ICU (M10)" = paste0(
      format(sum(MAT_ICU==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_ICU==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

      "Near-miss transfusion^b^" = paste0(
      format(sum(TRANSFUSION_NEARMISS==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(TRANSFUSION_NEARMISS==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

      "Severe PPH" = paste0(
      format(sum(HEM_PPH_SEV == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HEM_PPH_SEV==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Preeclampsia with severe features/eclampsia " = paste0(
      format(sum(PREECLAMPSIA_SEV == 1 & NEARMISS_DENOM ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREECLAMPSIA_SEV==1 & NEARMISS_DENOM ==1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Uterine rupture" = paste0(
      format(sum(UTERINE_RUP == 1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(UTERINE_RUP == 1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Sepsis *" = paste0(
      format(sum(NEARMISS_DENOM ==0 & NEARMISS_DENOM ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(NEARMISS_DENOM ==0 & NEARMISS_DENOM ==1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Organ dysfunction" = paste0(
      format(sum(ORG_FAIL ==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(ORG_FAIL ==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Met near-miss criteria and survived" = paste0(
      format(sum(NEARMISS ==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(NEARMISS ==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    # "Near-miss but no PLTC" = paste0(
    #   format(sum(MISS_PLTC ==1 & NEARMISS_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2),
    #   " (",
    #   format(round(sum(MISS_PLTC ==1 & NEARMISS_DENOM == 1, na.rm = TRUE)/sum(NEARMISS_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
    #   ")"),

   ) %>%
        t() %>% as.data.frame() %>%
        `colnames<-`(c(.[1,])) %>% unlist()
    )
 # mutate_all(funs(str_replace(., "NaN", "0"))) %>%
#  mutate_all(funs(str_replace(., "NA", "0")))


```

```{r}
# replace NA with 0s (this likely means there is not yet data)
near_miss_tabc[is.na(near_miss_tabc)] <- paste0("0 (0)")

near_miss_tab_outputc <- tb_theme1(near_miss_tabc) %>%
  tab_header(
    title = md("**Table 9c**")) %>%
 tab_row_group(
    label = html("<span style='font-size: 18px'>Near-miss criteria</span>"),
    rows = 1:12
  ) %>%
 # tab_row_group(
 #    label = html("<span style='font-size: 18px'>Adjudication scenarios</span>"),
 #    rows = 13:13
 #  ) %>%
  row_group_order(groups = c("<span style='font-size: 18px'>Near-miss criteria</span>"
                             #, "<span style='font-size: 18px'>Adjudication scenarios</span>"
                             ))  %>%

  # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Near-miss denominator, n",
                 "Near-miss denominator, n"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Near-miss denominator, n",
                 "Near-miss denominator, n"))) %>%
   tab_style(
        style = list(
          cell_text(color = "grey") 
        ),
        locations = list(
          cells_body(columns = c("Ghana", "India-CMC", "India-SAS","Kenya","Pakistan","Zambia", "Total"),
                     rows = c(10))
        )) %>%

   tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup>Participants may have more than one criteria, e.g., severe post partum hemorrhage & transfusion.</span>")
    ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup>Mother needed and/or experienced transfusion AND had one of the following: severe anemia, severe postpartum hemorrhage, antepartum hemorrhage, or placental abruption.</span>")
 ) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>*</sup>These outcomes will be added to near-miss once constructed.</span>")
 )



```

```{r, out.width = '100%'}

gtsave(near_miss_tab_outputc, file = "near_miss_tabc.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "near_miss_tabc.png"))

```

**Proposed criteria for adjudication:**

-   Woman who meets near-miss criteria but did NOT have PLTC

-   Woman who died (excluding accidental/incidental causes) but did NOT have PLTC and/or did NOT meet near-miss criteria

-   Woman who has PLTC and dies but did NOT meet near-miss criteria

\newpage


## 10. Uterine Rupture

**Definition:** Uterine rupture at any time in pregnancy (drawn from Forms MNH09, MNH12, or MNH19)

**Denominator:** All completed pregnancies (at any gestational age)

### Table 10. Uterine rupture
```{r}

rupture<-left_join(rupture,end)

uter_rup_tab <- rupture %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

     "Expected denominator (total completed pregnancies)" = paste0(
      format(sum(PREG_END== 1, na.rm = TRUE), nsmall = 0, digits = 2)),

     "Missing: L&D information (MNH09)" = paste0(
      format(sum(PREG_END== 1 & MAT_UTER_RUP_MISS==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & MAT_UTER_RUP_MISS==1, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing: Missing both L&D & PNC information" = paste0(
      format(sum(MAT_UTER_RUP_MISS== 3 & PREG_END== 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(MAT_UTER_RUP_MISS== 3 & PREG_END== 1, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Missing: information for pregnancy loss reported in MNH04/MNH19" = paste0(
      format(sum(PREG_END== 1 & MAT_UTER_RUP_MISS==2, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & MAT_UTER_RUP_MISS==2, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing: information for a maternal death prior to delivery" = paste0(
      format(sum(PREG_LOSS_DEATH== 1 & (MAT_UTER_RUP==55 | MAT_UTER_RUP==77), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_LOSS_DEATH== 1 & (MAT_UTER_RUP==55 | MAT_UTER_RUP==77), na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Denominator (non-missing)" = paste0(
      format(sum(PREG_END==1 & MAT_UTER_RUP_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Uterine rupture" = paste0(
      format(sum(PREG_END==1 & MAT_UTER_RUP_MISS==0 & MAT_UTER_RUP==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END==1 & MAT_UTER_RUP_MISS==0 & MAT_UTER_RUP==1, na.rm = TRUE)/sum(PREG_END==1 & MAT_UTER_RUP_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "No uterine rupture" = paste0(
      format(sum(PREG_END==1 & MAT_UTER_RUP_MISS==0 & MAT_UTER_RUP==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END==1 & MAT_UTER_RUP_MISS==0 & MAT_UTER_RUP==0, na.rm = TRUE)/sum(PREG_END==1 & MAT_UTER_RUP_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
uter_rup_tab[is.na(uter_rup_tab)] <- paste0("0 (0)")

uter_rup_tab_output <- tb_theme1(uter_rup_tab) %>%
  tab_header(
    title = md("**Table 10**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>"),
        rows = 1:5
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Uterine rupture prevalence</span>"),
    rows = 6:8
  ) %>%
    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%
 row_group_order(groups = c("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>",
                            "<span style='font-size: 18px'>Uterine rupture prevalence</span>"))  %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> The expected denominator for this outcome is all completed pregnancies; this includes all pregnancies where an endpoint has been recorded in MNH09 (labor and delivery) OR MNH04 (pregnancy loss reported during ANC visit) OR MNH19 (pregnancy loss reported during hospitalization) OR if a maternal death is reported prior to delivery. </span>"))

```

```{r, out.width = '100%'}

gtsave(uter_rup_tab_output, file = "uter_rup_tab_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "uter_rup_tab_output.png"))

```



\newpage


## 11. Prolonged labor

**Definition:** Labor lasting >24 hours (from the time of labor onset to the time of infant birth, as reported in MNH09 form)

**Denominator:** Pregnancies ending in a livebirth or stillbirth (>=20 weeks GA) where the woman experienced labor (i.e., excluding cesarean deliveries without any labor).

**Note:** Due to data collection differences, this outcome is not available for India-CMC and Ghana sites.

### Table 11. Prolonged labor
```{r}

labor<-left_join(labor,end)

prolong_tab <- labor %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

     "Expected denominator (total completed pregnancies)" = paste0(
      format(sum(PREG_END== 1, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Excluded: Outcome not available for site <sup>b</sup>" = paste0(
      format(sum(PREG_END== 1 & (PRO_LABOR_MISS==8), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & (PRO_LABOR_MISS==8), na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Excluded: Pregnancy losses <20 weeks GA or induced abortion" = paste0(
      format(sum(PREG_END== 1 & (PRO_LABOR_MISS==4), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & (PRO_LABOR_MISS==4), na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Excluded: Maternal deaths at <20 weeks GA" = paste0(
      format(sum(PREG_END== 1 & (PRO_LABOR_MISS==5), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & (PRO_LABOR_MISS==5), na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Excluded: Pregnancies >=20 weeks that ended in cesarean delivery without labor" = paste0(
      format(sum(PREG_END== 1 & (PRO_LABOR_MISS==6), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & (PRO_LABOR_MISS==6), na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Missing: unknown if labor occurred" = paste0(
      format(sum(PREG_END== 1 & (PRO_LABOR_MISS==1 | PRO_LABOR_MISS==7), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & (PRO_LABOR_MISS==1 | PRO_LABOR_MISS==7), na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing: unknown length of labor" = paste0(
      format(sum(PREG_END== 1 & (PRO_LABOR_MISS==2), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & (PRO_LABOR_MISS==2), na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing: labor timing errors (under review)" = paste0(
      format(sum(PREG_END== 1 & PRO_LABOR_MISS==3, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & PRO_LABOR_MISS==3, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Denominator (non-missing)" = paste0(
      format(sum(PREG_END_DELIV==1 & PRO_LABOR_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Prolonged labor" = paste0(
      format(sum(PREG_END_DELIV==1 & PRO_LABOR_MISS==0 & PRO_LABOR==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END_DELIV==1 & PRO_LABOR_MISS==0 & PRO_LABOR==1, na.rm = TRUE)/sum(PREG_END_DELIV==1 & PRO_LABOR_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "No prolonged labor" = paste0(
      format(sum(PREG_END_DELIV==1 & PRO_LABOR_MISS==0 & PRO_LABOR==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END_DELIV==1 & PRO_LABOR_MISS==0 & PRO_LABOR==0, na.rm = TRUE)/sum(PREG_END_DELIV==1 & PRO_LABOR_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
prolong_tab[is.na(prolong_tab)] <- paste0("0 (0)")

prolong_tab_output <- tb_theme1(prolong_tab) %>%
  tab_header(
    title = md("**Table 11**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>"),
        rows = 1:8
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Prolonged labor prevalence</span>"),
    rows = 9:11
  ) %>%
    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%
 row_group_order(groups = c("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>",
                           "<span style='font-size: 18px'>Prolonged labor prevalence</span>"))  %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> The expected denominator for this outcome is all completed pregnancies; this includes all pregnancies where an endpoint has been recorded in MNH09 (labor and delivery) OR MNH04 (pregnancy loss reported during ANC visit) OR MNH19 (pregnancy loss reported during hospitalization) OR if a maternal death is reported prior to delivery. </span>"))  %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Due to data collection differences for cases of induced labor in India-CMC and Ghana sites, the prolonged labor outcome is not available for these sites. </span>"))

```

```{r, out.width = '100%'}

gtsave(prolong_tab_output, file = "prolong_tab_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "prolong_tab_output.png"))

```


\newpage


## 12. Thyroid Dysfunction

**Reference ranges:**


|Trimester | TSH | Free T4 |
|--------- | ----|---------|
|1st| 0.6 - 3.4 IU/mL | 0.8-1.2 ng/dL |
|2nd| 0.37 - 3.6 IU/mL | 0.6-1.0 ng/dL |
|3rd| 0.38 - 4.04 IU/mL | 0.5-0.8 ng/dL |


**Definition:**

|Classification | TSH | Free T4 |
|-------------- | ----|---------|
|Overt hyperthyroidism| low | high |
|Subclinical hyperthyroidism| low | normal |
|Overt hypothyroidism| high | low |
|Subclinical hypothyroidism| high | normal |
|Normal/Euthyroid| normal | not considered |
|Unclassified| low | low |
|Unclassified| high | high |
Table: Classifications of thyroid dysfunction.

**Expected Denominator:**   For **enrollment**, all women are expected to have thyroid testing until the stop date (Ghana: 2024-09-01; India-CMC: 2024-10-17; India-SAS: n/a; Kenya: 2025-01-14; Pakistan: 2024-10-03; Zambia: 2024-10-11).  For **ANC32**, expected participants are those who have passed the window and have not closed out or closed out after the window

**Common causes of missingness:**

-   Missing lab test date [LBSTDAT]

-   Missing TSH [THYROID_TSH_LBORRES]

-   Abnormal TSH result + missing free T4 [THYROID_FREET4_LBORRES]


### Table 12a. Thyroid Dysfunction at Enrollment
```{r}

thy_tab_enroll <- thy %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

     "Expected, T1^a^" = paste0(
      format(sum(THYR_ENROLL_EXP_T1 == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

     "Missing" = paste0(
      format(sum(THYR_ENROLL_T1 == 55 & THYR_ENROLL_EXP_T1 == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ENROLL_T1 == 55 & THYR_ENROLL_EXP_T1 == 1, na.rm = TRUE)/sum(THYR_ENROLL_EXP_T1 == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Observed, T1^b^" = paste0(
      format(sum(THYR_ENROLL_T1 < 55, na.rm = TRUE), nsmall = 0, digits = 2)),

     "Euthyroid" = paste0(
      format(sum(THYR_ENROLL_T1 == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ENROLL_T1 == 1, na.rm = TRUE)/sum(THYR_ENROLL_T1 < 55, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Overt hyperthyroidism" = paste0(
      format(sum(THYR_ENROLL_T1 == 3, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ENROLL_T1 == 3, na.rm = TRUE)/sum(THYR_ENROLL_T1 < 55, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Subclinical hyperthyroidism" = paste0(
      format(sum(THYR_ENROLL_T1 == 2, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ENROLL_T1 == 2, na.rm = TRUE)/sum(THYR_ENROLL_T1 < 55, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Overt hypothyroidism" = paste0(
      format(sum(THYR_ENROLL_T1 == 5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ENROLL_T1 == 5, na.rm = TRUE)/sum(THYR_ENROLL_T1 < 55, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Subclinical hypothyroidism" = paste0(
      format(sum(THYR_ENROLL_T1 == 4, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ENROLL_T1 == 4, na.rm = TRUE)/sum(THYR_ENROLL_T1 < 55, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Unclassified" = paste0(
      format(sum(THYR_ENROLL_T1 == 0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ENROLL_T1 == 0, na.rm = TRUE)/sum(THYR_ENROLL_T1 < 55, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),
    
    
     "Expected, T2^a^" = paste0(
      format(sum(THYR_ENROLL_EXP_T2 == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

     "Missing " = paste0(
      format(sum(THYR_ENROLL_T2 == 55 & THYR_ENROLL_EXP_T2 == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ENROLL_T2 == 55 & THYR_ENROLL_EXP_T2 == 1, na.rm = TRUE)/sum(THYR_ENROLL_EXP_T2 == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Observed, T2^b^" = paste0(
      format(sum(THYR_ENROLL_T2 < 55, na.rm = TRUE), nsmall = 0, digits = 2)),

     "Euthyroid " = paste0(
      format(sum(THYR_ENROLL_T2 == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ENROLL_T2 == 1, na.rm = TRUE)/sum(THYR_ENROLL_T2 < 55, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Overt hyperthyroidism " = paste0(
      format(sum(THYR_ENROLL_T2 == 3, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ENROLL_T2 == 3, na.rm = TRUE)/sum(THYR_ENROLL_T2 < 55, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Subclinical hyperthyroidism " = paste0(
      format(sum(THYR_ENROLL_T2 == 2, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ENROLL_T2 == 2, na.rm = TRUE)/sum(THYR_ENROLL_T2 < 55, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Overt hypothyroidism " = paste0(
      format(sum(THYR_ENROLL_T2 == 5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ENROLL_T2 == 5, na.rm = TRUE)/sum(THYR_ENROLL_T2 < 55, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Subclinical hypothyroidism " = paste0(
      format(sum(THYR_ENROLL_T2 == 4, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ENROLL_T2 == 4, na.rm = TRUE)/sum(THYR_ENROLL_T2 < 55, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Unclassified " = paste0(
      format(sum(THYR_ENROLL_T2 == 0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ENROLL_T2 == 0, na.rm = TRUE)/sum(THYR_ENROLL_T2 < 55, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
thy_tab_enroll[is.na(thy_tab_enroll)] <- paste0("0 (0)")

thy_tab_enroll_output <- tb_theme1(thy_tab_enroll) %>%
  tab_header(
    title = md("**Table 12a**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Enrollment: Trimester 1</span>"),
        rows = 1:9
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Enrollment: Trimester 2</span>"),
        rows = 10:18
    ) %>%
 row_group_order(groups = c( "<span style='font-size: 18px'>Enrollment: Trimester 1</span>",
                            "<span style='font-size: 18px'>Enrollment: Trimester 2</span>"))  %>%
  
   # bold denominator row
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Observed, T1^b^",
                 "Observed, T2^b^"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Observed, T1^b^",
                 "Observed, T2^b^"))) %>%
  
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note:</sup> Unclassified refers to categories not specified above, i.e., (high TSH + high free T4) OR (low TSH + low free T4)</span>" )) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Expected denominator are those who were enrolled during that trimester, before date enrollment thyroid testing was stopped (Ghana: 2024-09-01; India-CMC: 2024-10-17; India-SAS: n/a; Kenya: 2025-01-14; Pakistan: 2024-10-03; Zambia: 2024-10-11)</span>" )) %>%
    tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup>Observed: non-missing</span>" ))



```

```{r, out.width = '100%'}

gtsave(thy_tab_enroll_output, file = "thy_tab_enroll_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "thy_tab_enroll_output.png"))

```
\newpage

### Table 12b. Thyroid Dysfunction at ANC-32
```{r}

thy_tab32 <- thy %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

     "Expected^a^" = paste0(
      format(sum(THYR_ANC32_EXP == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

     "Missing" = paste0(
      format(sum(THYR_ANC32 == 55 & THYR_ANC32_EXP == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ANC32 == 55 & THYR_ANC32_EXP == 1, na.rm = TRUE)/sum(THYR_ANC32_EXP == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Observed^b^" = paste0(
      format(sum(THYR_ANC32_DENOM == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

     "Euthyroid at ANC32" = paste0(
      format(sum(THYR_ANC32 == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ANC32 == 1, na.rm = TRUE)/sum(THYR_ANC32_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Overt hyperthyroidism" = paste0(
      format(sum(THYR_ANC32 == 3, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ANC32 == 3, na.rm = TRUE)/sum(THYR_ANC32_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Subclinical hyperthyroidism" = paste0(
      format(sum(THYR_ANC32 == 2, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ANC32 == 2, na.rm = TRUE)/sum(THYR_ANC32_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Overt hypothyroidism" = paste0(
      format(sum(THYR_ANC32 == 5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ANC32 == 5, na.rm = TRUE)/sum(THYR_ANC32_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Subclinical hypothyroidism" = paste0(
      format(sum(THYR_ANC32 == 4, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ANC32 == 4, na.rm = TRUE)/sum(THYR_ANC32_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Unclassified" = paste0(
      format(sum(THYR_ANC32 == 0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(THYR_ANC32 == 0, na.rm = TRUE)/sum(THYR_ANC32_DENOM == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
thy_tab32[is.na(thy_tab32)] <- paste0("0 (0)")

thy_tab_output32 <- tb_theme1(thy_tab32) %>%
  tab_header(
    title = md("**Table 12b**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness</span>"),
        rows = 1:3
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Thyroid function at ANC-32</span>"),
        rows = 4:9
    ) %>%
 row_group_order(groups = c( "<span style='font-size: 18px'>Data completeness</span>",
                            "<span style='font-size: 18px'>Thyroid function at ANC-32</span>"))  %>%
  
   # bold denominator row
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Observed^b^"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Observed^b^"))) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>Note:</sup> Unclassified refers to categories not specified above, i.e., (high TSH + high free T4) OR (low TSH + low free T4)</span>" )) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Expected denominator are those who have passed the late window for ANC36</span>" ))  %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup>Observed: non-missing</span>" ))



```

```{r, out.width = '100%'}

gtsave(thy_tab_output32, file = "thy_tab_output32.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "thy_tab_output32.png"))

```

\newpage

## 13. Hypertensive disorders of pregnancy

**Denominator:** All participants with recorded delivery (including livebirth OR stillbirth) at/after 20 weeks with:

-   MNH09 form filled and date of delivery for first fetus/infant provided (varname [form]: `DELIV_DSSTDAT_INF1` [MNH09]) OR

-   MNH04 or MNH19 form filled indicating conclusion of pregnancy


**Definitions:**

-   ***Chronic hypertension*** includes any participant with a history of chronic hypertension reported at enrollment, those currently taking medication to treat hypertension upon enrollment, those with a new diagnosis of hypertension at an ANC visit at <20 weeks gestation, those with a new medication to treat hypertension at an ANC visit at <20 weeks gestation, those with one or more severe high blood pressure measures at <20 weeks gestation, and/or those with two or more high blood pressure measures recorded when the first measure occurred at <20 weeks gestation.

-   ***Gestational hypertension*** includes any participant with one or more of the following occurring at or after 20 weeks gestation, excluding those with preexisting chronic hypertension: 2 or more high blood pressure measures recorded on separate visits; 1 or more high blood pressure readings AND the participant starts a medication to treat hypertension; a clinical diagnosis of gestational hypertension at an ANC visit, a hospitalization, or labor and delivery.

-   ***Preeclampsia without severe features*** includes any participant with gestational hypertension (as described above) AND one or more new onset proteinuria measures at or after 20 weeks gestation. Note that this outcome excludes participants with positive proteinuria results at baseline (<20 weeks gestation), unless proteinuria results increase for the participant over time. This outcome also includes clinical diagnosis of preeclampsia at an ANC visit, a hospitalization, or labor and delivery.

-   ***Preeclampsia superimposed on chronic hypertension*** includes participants with preexisting, chronic hypertension (as described above) AND one or more new onset proteinuria measures at or after 20 weeks gestation. Note that this outcome excludes participants with positive proteinuria results at baseline (<20 weeks gestation), unless proteinuria results increase for the participant over time. This outcome also includes clinical diagnosis of preeclampsia at an ANC visit, a hospitalization, or labor and delivery for those with preexisting chronic hypertension at baseline.

-   ***Preeclampsia with severe features*** includes participants with any of the following scenarios: clinical diagnosis of eclampsia/seizures at an ANC visit, a hospitalization, or at labor and delivery; clinical diagnosis of HELLP syndrome at a hospitalization or at labor and delivery; clinical diagnosis of postpartum eclampsia at a PNC visit or at hospitalization; 1 or more severe high blood pressure measures or a clinical diagnosis of severe high blood pressure at or after 20 weeks gestation; a participant with gestational hypertension (as described above) AND experiences organ dysfunction at a hospitalization or at labor and delivery or postpartum; a participant with preeclampsia (including preeclampsia superimposed on chronic hypertension) AND one or more of the following severe symptoms: organ dysfunction, pulmonary edema, visual symptoms, epigastric pain, and/or severe headaches.


**To be included as "non-missing" for this outcome, a participant must have:**

**1.** Two or more recorded blood pressure measures after 20 weeks gestation (unless the participant has a clinical diagnosis of any HDP during pregnancy or labor and delivery)

**2.** Reported information on history of chronic hypertension at less than 20 weeks gestation.


### Table 13a. Hypertensive disorders of pregnancy
```{r}

hdp_tab <- hdp %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

     "Expected denominator (total completed pregnancies)" = paste0(
      format(sum(HDP_DENOM== 1, na.rm = TRUE), nsmall = 0, digits = 2)),
     "Excluded: pregnancy ended prior to 20 weeks" = paste0(
      format(sum(HDP_DENOM== 1 & HDP_GROUP_MISS==3, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HDP_DENOM== 1 & HDP_GROUP_MISS==3, na.rm = TRUE)/sum(HDP_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing: <2 BP measures at/after 20 weeks GA" = paste0(
      format(sum(HDP_GROUP_MISS==1 & HDP_DENOM== 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HDP_GROUP_MISS==1 & HDP_DENOM== 1, na.rm = TRUE)/sum(HDP_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing: Baseline HTN information at <20 weeks GA" = paste0(
      format(sum(HDP_GROUP_MISS==2 & HDP_DENOM== 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HDP_GROUP_MISS==2 & HDP_DENOM== 1, na.rm = TRUE)/sum(HDP_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Denominator (non-missing)" = paste0(
      format(sum(HDP_DENOM==1 & HDP_GROUP >= 0 & HDP_GROUP <=5, na.rm = TRUE), nsmall = 0, digits = 2)),

    "No hypertensive disorder" = paste0(
      format(sum(HDP_DENOM==1 & HDP_GROUP ==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HDP_DENOM==1 & HDP_GROUP ==0, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP >= 0 & HDP_GROUP <=5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Any hypertensive disorder of pregnancy" = paste0(
      format(sum(HDP_DENOM==1 & (HDP_GROUP ==1 | HDP_GROUP ==2 | HDP_GROUP ==3 | HDP_GROUP ==4 | HDP_GROUP ==5), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HDP_DENOM==1 & (HDP_GROUP ==1 | HDP_GROUP ==2 | HDP_GROUP ==3 | HDP_GROUP ==4 | HDP_GROUP ==5), na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP >= 0 & HDP_GROUP <=5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Chronic hypertension (<20 weeks GA)" = paste0(
      format(sum(HDP_DENOM==1 & HDP_GROUP ==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HDP_DENOM==1 & HDP_GROUP ==1, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP >= 0 & HDP_GROUP <=5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Gestational hypertension (onset >=20 weeks)" = paste0(
      format(sum(HDP_DENOM==1 & HDP_GROUP ==2, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HDP_DENOM==1 & HDP_GROUP ==2, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP >= 0 & HDP_GROUP <=5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Preeclampsia (without severe features)" = paste0(
      format(sum(HDP_DENOM==1 & HDP_GROUP ==3, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HDP_DENOM==1 & HDP_GROUP ==3, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP >= 0 & HDP_GROUP <=5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Preeclampsia superimposed on chronic hypertension" = paste0(
      format(sum(HDP_DENOM==1 & HDP_GROUP ==4, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HDP_DENOM==1 & HDP_GROUP ==4, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP >= 0 & HDP_GROUP <=5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

   "Preeclampsia with severe features" = paste0(
      format(sum(HDP_DENOM==1 & HDP_GROUP ==5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(HDP_DENOM==1 & HDP_GROUP ==5, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP >= 0 & HDP_GROUP <=5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
hdp_tab[is.na(hdp_tab)] <- paste0("0 (0)")

hdp_tab_output <- tb_theme1(hdp_tab) %>%
  tab_header(
    title = md("**Table 13a**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>"),
        rows = 1:4
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Prevalence of HDPs</span>"),
    rows = 5:12
  ) %>%
    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%

  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%

  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%

  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%

  tab_style(
      style = list(
        cell_text(indent = px(5), style = "italic")
        ),
      locations = cells_stub(rows = c('Chronic hypertension (<20 weeks GA)',
                 "Gestational hypertension (onset >=20 weeks)",
                 "Preeclampsia (without severe features)",
                 "Preeclampsia superimposed on chronic hypertension",
                 "Preeclampsia with severe features"))
      ) %>%
 row_group_order(groups = c("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>",
                            "<span style='font-size: 18px'>Prevalence of HDPs</span>")) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> The expected denominator for this outcome is all completed pregnancies; this includes all pregnancies where an endpoint has been recorded in MNH09 (labor and delivery) OR MNH04 (pregnancy loss reported during ANC visit) OR MNH19 (pregnancy loss reported during hospitalization) OR if a maternal death is reported prior to delivery. </span>"))

```

```{r, out.width = '100%'}

gtsave(hdp_tab_output, file = "hdp_tab_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "hdp_tab_output.png"))

```

### Table 13b. Preeclampsia with severe features
```{r}

hdp<-left_join(hdp,end)
hdp<-subset(hdp,HDP_DENOM==1)

hdp_tab2 <- hdp %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

    "Total cases of preeclampsia with severe features" = paste0(
      format(sum(HDP_DENOM==1 & HDP_GROUP ==5, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Eclampsia and/or seizures" = paste0(
      format(sum(PREEC_SEV_FEAT_SEIZURES==1 & HDP_GROUP ==5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREEC_SEV_FEAT_SEIZURES==1 & HDP_GROUP ==5, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP ==5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "HELLP syndrome" = paste0(
      format(sum(PREEC_SEV_FEAT_HELLP==1 & HDP_GROUP ==5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREEC_SEV_FEAT_HELLP==1 & HDP_GROUP ==5, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP ==5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Postpartum eclampsia" = paste0(
      format(sum(PREEC_SEV_FEAT_POSTP_ECLAMPSIA==1 & HDP_GROUP ==5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREEC_SEV_FEAT_POSTP_ECLAMPSIA==1 & HDP_GROUP ==5, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP ==5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Organ dysfunction" = paste0(
      format(sum(PREEC_SEV_FEAT_ORGAN==1 & HDP_GROUP ==5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREEC_SEV_FEAT_ORGAN==1 & HDP_GROUP ==5, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP ==5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),


    "Severe high blood pressure (measured)" = paste0(
      format(sum(PREEC_SEV_FEAT_SEVHIGH==1 & HDP_GROUP ==5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREEC_SEV_FEAT_SEVHIGH==1 & HDP_GROUP ==5, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP ==5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Severe high blood pressure (diagnosed)" = paste0(
      format(sum(PREEC_SEV_FEAT_SEVHYP==1 & HDP_GROUP ==5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREEC_SEV_FEAT_SEVHYP==1 & HDP_GROUP ==5, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP ==5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),


    "Pulmonary edema" = paste0(
      format(sum(PREEC_SEV_FEAT_PULMED==1 & HDP_GROUP ==5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREEC_SEV_FEAT_PULMED==1 & HDP_GROUP ==5, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP ==5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),


    "Visual symptoms" = paste0(
      format(sum(PREEC_SEV_FEAT_VISUAL==1 & HDP_GROUP ==5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREEC_SEV_FEAT_VISUAL==1 & HDP_GROUP ==5, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP ==5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Epigastric pain" = paste0(
      format(sum(PREEC_SEV_FEAT_EPIPAIN==1 & HDP_GROUP ==5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREEC_SEV_FEAT_EPIPAIN==1 & HDP_GROUP ==5, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP ==5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),


    "Severe headache" = paste0(
      format(sum(PREEC_SEV_FEAT_HEAD==1 & HDP_GROUP ==5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREEC_SEV_FEAT_HEAD==1 & HDP_GROUP ==5, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP ==5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Postpartum seizures (within 7 days of delivery)" = paste0(
      format(sum(PREEC_SEV_FEAT_POSTP_SEIZURES==1 & HDP_GROUP ==5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREEC_SEV_FEAT_POSTP_SEIZURES==1 & HDP_GROUP ==5, na.rm = TRUE)/sum(HDP_DENOM==1 & HDP_GROUP ==5, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
hdp_tab2[is.na(hdp_tab2)] <- paste0("0 (0)")

hdp_tab2_output <- tb_theme1(hdp_tab2) %>%
  tab_header(
    title = md("**Table 13b**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Preeclampsia with severe features by symptoms <sup>a</sup></span>"),
        rows = 1:12
    ) %>%
  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Total cases of preeclampsia with severe features",
                 "Total cases of preeclampsia with severe features"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Total cases of preeclampsia with severe features",
                 "Total cases of preeclampsia with severe features"))) %>%
 row_group_order(groups = c( "<span style='font-size: 18px'>Preeclampsia with severe features by symptoms <sup>a</sup></span>"))  %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> Note that participants with preeclampsia with severe features may exhibit one or more of the severe feature symptoms in this table. </span>"))

```

```{r, out.width = '100%'}

gtsave(hdp_tab2_output, file = "hdp_tab2_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "hdp_tab2_output.png"))

```



\newpage


## 14. Postpartum high blood pressure

**Definition:** New onset high blood pressure (diasolic >90 and/or systolic >140 mmHg) among postpartum participants. This outcome identifies all participants with at least one high blood pressure measure in the postpartum window of interest. This outcome excludes participants within preexisting chronic hypertension at enrollment.

**Denominator:** All participants who have finished the postpartum window of interest (PNC 6: 6-14 weeks; PNC26: 26-39 weeks; and PNC52: 52-64 weeks) and/or who have at least one blood pressure measure recorded in the window.

### Table 14a. Postpartum high blood pressure at 6-14 weeks
```{r}

highbp6_tab <- highbp %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

     "Expected denominator ^a^" = paste0(
      format(sum(POSTP_HTN_PNC6_DENOM== 1, na.rm = TRUE), nsmall = 0, digits = 2)),

     "Missing blood pressure measure" = paste0(
      format(sum(POSTP_HTN_PNC6_DENOM== 1 & POSTP_HTN_PNC6== 55, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(POSTP_HTN_PNC6_DENOM== 1 & POSTP_HTN_PNC6== 55, na.rm = TRUE)/sum(POSTP_HTN_PNC6_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Denominator (non-missing)" = paste0(
      format(sum(POSTP_HTN_PNC6== 1 | POSTP_HTN_PNC6==0, na.rm = TRUE), nsmall = 0, digits = 2)),

    "High blood pressure ^b^" = paste0(
      format(sum(POSTP_HTN_PNC6== 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(POSTP_HTN_PNC6== 1, na.rm = TRUE)/sum(POSTP_HTN_PNC6== 1 | POSTP_HTN_PNC6== 0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "No high blood pressure" = paste0(
      format(sum(POSTP_HTN_PNC6== 0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(POSTP_HTN_PNC6== 0, na.rm = TRUE)/sum(POSTP_HTN_PNC6== 1 | POSTP_HTN_PNC6== 0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
highbp6_tab[is.na(highbp6_tab)] <- paste0("0 (0)")

highbp6_tab_output <- tb_theme1(highbp6_tab) %>%
  tab_header(
    title = md("**Table 14a**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness</span>"),
        rows = 1:2
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>High blood pressure at 6-14 weeks postpartum</span>"),
    rows = 3:5
  ) %>%
    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator ^a^",
                 "Expected denominator ^a^"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator ^a^",
                 "Expected denominator ^a^"))) %>%
 row_group_order(groups = c("<span style='font-size: 18px'>Data completeness</span>",
                           "<span style='font-size: 18px'>High blood pressure at 6-14 weeks postpartum</span>"))  %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> The expected denominator is all participants whose pregnancies have ended AND who have remained in the study through the PNC-6 late visit window and/or have a valid blood pressure measure recorded during the window. The denominator excludes participants with preexisting chronic hypertension at enrollment. </span>")) %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Participants are considered to have high blood pressure based on one or more high blood pressure readings, recorded as either: the mean of three blood pressure readings taken by PRISMA staff during the PNC-6 visit window and/or any blood pressure reading(s) recorded during hospitalization in the PNC-6 visit window. </span>"))

```

```{r, out.width = '100%'}

gtsave(highbp6_tab_output, file = "highbp6_tab_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "highbp6_tab_output.png"))

```

\newpage


### Table 14b. Postpartum high blood pressure at 6 months (29-39 weeks)
```{r}

highbp26_tab <- highbp %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

     "Expected denominator ^a^" = paste0(
      format(sum(POSTP_HTN_PNC26_DENOM== 1, na.rm = TRUE), nsmall = 0, digits = 2)),

     "Missing blood pressure measure" = paste0(
      format(sum(POSTP_HTN_PNC26_DENOM== 1 & POSTP_HTN_PNC26== 55, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(POSTP_HTN_PNC26_DENOM== 1 & POSTP_HTN_PNC26== 55, na.rm = TRUE)/sum(POSTP_HTN_PNC26_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Denominator (non-missing)" = paste0(
      format(sum(POSTP_HTN_PNC26== 1 | POSTP_HTN_PNC26==0, na.rm = TRUE), nsmall = 0, digits = 2)),

    "High blood pressure ^b^" = paste0(
      format(sum(POSTP_HTN_PNC26== 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(POSTP_HTN_PNC26== 1, na.rm = TRUE)/sum(POSTP_HTN_PNC26== 1 | POSTP_HTN_PNC26== 0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "No high blood pressure" = paste0(
      format(sum(POSTP_HTN_PNC26== 0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(POSTP_HTN_PNC26== 0, na.rm = TRUE)/sum(POSTP_HTN_PNC26== 1 | POSTP_HTN_PNC26== 0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
highbp26_tab[is.na(highbp26_tab)] <- paste0("0 (0)")

highbp26_tab_output <- tb_theme1(highbp26_tab) %>%
  tab_header(
    title = md("**Table 14b**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness</span>"),
        rows = 1:2
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>High blood pressure at 26-39 weeks postpartum</span>"),
    rows = 3:5
  ) %>%
    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator ^a^",
                 "Expected denominator ^a^"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator ^a^",
                 "Expected denominator ^a^"))) %>%
 row_group_order(groups = c("<span style='font-size: 18px'>Data completeness</span>",
                           "<span style='font-size: 18px'>High blood pressure at 26-39 weeks postpartum</span>"))  %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> The expected denominator is all participants whose pregnancies have ended AND who have remained in the study through the PNC-26 late visit window and/or have a valid blood pressure measure recorded during the window. The denominator excludes participants with preexisting chronic hypertension at enrollment. </span>")) %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Participants are considered to have high blood pressure based on one or more high blood pressure readings, recorded as either: the mean of three blood pressure readings taken by PRISMA staff during the PNC-26 visit window and/or any blood pressure reading(s) recorded during hospitalization in the PNC-26 visit window. </span>"))

```

```{r, out.width = '100%'}

gtsave(highbp26_tab_output, file = "highbp26_tab_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "highbp26_tab_output.png"))

```



### Table 14c. Postpartum high blood pressure at 1 year (52-64 weeks)
```{r}

highbp52_tab <- highbp %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

     "Expected denominator ^a^" = paste0(
      format(sum(POSTP_HTN_PNC52_DENOM== 1, na.rm = TRUE), nsmall = 0, digits = 2)),

     "Missing blood pressure measure" = paste0(
      format(sum(POSTP_HTN_PNC52_DENOM== 1 & POSTP_HTN_PNC52== 55, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(POSTP_HTN_PNC52_DENOM== 1 & POSTP_HTN_PNC52== 55, na.rm = TRUE)/sum(POSTP_HTN_PNC52_DENOM== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Denominator (non-missing)" = paste0(
      format(sum(POSTP_HTN_PNC52== 1 | POSTP_HTN_PNC52==0, na.rm = TRUE), nsmall = 0, digits = 2)),

    "High blood pressure ^b^" = paste0(
      format(sum(POSTP_HTN_PNC52== 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(POSTP_HTN_PNC52== 1, na.rm = TRUE)/sum(POSTP_HTN_PNC52== 1 | POSTP_HTN_PNC52== 0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "No high blood pressure" = paste0(
      format(sum(POSTP_HTN_PNC52== 0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(POSTP_HTN_PNC52== 0, na.rm = TRUE)/sum(POSTP_HTN_PNC52== 1 | POSTP_HTN_PNC52== 0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
highbp52_tab[is.na(highbp52_tab)] <- paste0("0 (0)")

highbp52_tab_output <- tb_theme1(highbp52_tab) %>%
  tab_header(
    title = md("**Table 14c**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness</span>"),
        rows = 1:2
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>High blood pressure at 52-64 weeks postpartum</span>"),
    rows = 3:5
  ) %>%
    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator ^a^",
                 "Expected denominator ^a^"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator ^a^",
                 "Expected denominator ^a^"))) %>%
 row_group_order(groups = c("<span style='font-size: 18px'>Data completeness</span>",
                           "<span style='font-size: 18px'>High blood pressure at 52-64 weeks postpartum</span>"))  %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> The expected denominator is all participants whose pregnancies have ended AND who have remained in the study through the PNC-52 late visit window and/or have a valid blood pressure measure recorded during the window. The denominator excludes participants with preexisting chronic hypertension at enrollment. </span>")) %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> Participants are considered to have high blood pressure based on one or more high blood pressure readings, recorded as either: the mean of three blood pressure readings taken by PRISMA staff during the PNC-52 visit window and/or any blood pressure reading(s) recorded during hospitalization in the PNC-52 visit window. </span>"))

```

```{r, out.width = '100%'}

gtsave(highbp52_tab_output, file = "highbp52_tab_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "highbp52_tab_output.png"))

```

\newpage

## 15. Placental Disorders

**Placenta previa:** Placenta partially or fully covers the cervix. Placenta previa is a risk factor for maternal hemorrhage. Identified by ultrasound [`M01_PREVIA_PERES_FTS#`==3] and at labor and delivery [as an indication for C-section, `M09_CES_PRINDC_INF#_18` == 1; as a contributor to antepartum hemorrhage, `M09_APH_FAORRES_2` == 1]

**Placental abruption:** Placenta separates from the wall of the uterus before delivery. Placental abruption can cause maternal hemorrhage and disrupt supply of nutrients and oxygen to the baby. Identified at labor and delivery [as an indication for C-section, `M09_CES_PRINDC_INF#_17` == 1; as a contributor to antepartum hemorrhage, `M09_APH_FAORRES_1`==1].

**Placenta accreta:** Placenta grows too deeply into the wall of the uterus. Placenta accreta can cause the placenta from not detaching completely after delivery, and often causes maternal hemorrhage. Identified at labor and delivery [as an indication for C-section, `M09_CES_PRINDC_INF1_17`]

### Table 15. Placental disorders
```{r}

placenta_tab <- placenta %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(


     "Denominator^a^" = paste0(
      format(sum(SB_LB == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

      "Women who delivered by Cesarean" = paste0(

      format(sum(MAT_CES_ANY == 1, na.rm = TRUE), nsmall = 0, digits = 2)),

     "Observed or suspected placenta previa" = paste0(
      format(sum(PREVIA == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREVIA == 1, na.rm = TRUE)/sum(SB_LB == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Suspected placental abruption" = paste0(
      format(sum(PLACENTA_ABRUPTION == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PLACENTA_ABRUPTION == 1, na.rm = TRUE)/sum(SB_LB == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),



     "Suspected placenta accreta indicated as reason for C-section^b^" = paste0(
      format(sum(PLACENTA_ACCRETE == 1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PLACENTA_ACCRETE == 1, na.rm = TRUE)/sum(MAT_CES_ANY == 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),


    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```


```{r}
# replace NA with 0s (this likely means there is not yet data)
placenta_tab[is.na(placenta_tab)] <- paste0("0 (0)")

placenta_tab_output <- tb_theme1(placenta_tab) %>%
  tab_header(
    title = md("**Table 15**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness</span>"),
        rows = 1:2
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Placental disorders</span>"),
        rows = 3:5
    ) %>%
 row_group_order(groups = c( "<span style='font-size: 18px'>Data completeness</span>",
                            "<span style='font-size: 18px'>Placental disorders</span>"))  %>%

   tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup>Denominator is women with a pregnancy end point, minus pregnancy losses and maternal death</span>" )) %>%
  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup>Denominator is women who delivered by Cesarean</span>" ))




```

```{r, out.width = '100%'}

gtsave(placenta_tab_output, file = "placenta_tab_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "placenta_tab_output.png"))

```

\newpage


## 16. Induced Labor

**Definition:** Induced labor, including induction by artificial rupture of membranes, oxytocin, misoprostol, foley, and/or another method (as reported in MNH09 form).

**Denominator:** Pregnancies ending in a livebirth or stillbirth (>=20 weeks GA), excluding pregnancies that ended in a c-section prior to labor.

**Note:** Labor augmentation is defined as methods used to strengthen contractions that are already in progress. These include the same methods that can be used for labor induction. In India-SAS site, "induced labor" includes both induced and augmented labor. In Kenya and Zambia sites, "induced labor" may include both induced or augmented labor for some cases.

### Table 16. Induced Labor
```{r}

induced<-left_join(labor,end)

induced_tab <- induced %>%
  rowwise() %>%
  group_by(SITE) %>%
  summarise(

     "Expected denominator (total completed pregnancies)" = paste0(
      format(sum(PREG_END== 1, na.rm = TRUE), nsmall = 0, digits = 2)),

     "Excluded: Pregnancy losses <20 weeks GA or induced abortion" = paste0(
      format(sum(PREG_END== 1 & MAT_INDUCED_MISS==4 & PREG_LOSS_DEATH==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & MAT_INDUCED_MISS==4 & PREG_LOSS_DEATH==0, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Excluded: Maternal deaths at <20 weeks GA" = paste0(
      format(sum(PREG_END== 1 & MAT_INDUCED_MISS==4 & PREG_LOSS_DEATH==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & MAT_INDUCED_MISS==4 & PREG_LOSS_DEATH==1, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Excluded: Pregnancies >=20 weeks that ended in cesarean delivery without labor AND without attempted induction" = paste0(
      format(sum(PREG_END== 1 & MAT_INDUCED_MISS==5, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & MAT_INDUCED_MISS==5, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Missing: unknown if labor occurred" = paste0(
      format(sum(PREG_END== 1 & (MAT_INDUCED_MISS==1 | MAT_INDUCED_MISS==3), na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & (MAT_INDUCED_MISS==1 | MAT_INDUCED_MISS==3), na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Missing: unknown if induced" = paste0(
      format(sum(PREG_END== 1 & MAT_INDUCED_MISS==2, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END== 1 & MAT_INDUCED_MISS==2, na.rm = TRUE)/sum(PREG_END== 1, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

    "Denominator (non-missing)" = paste0(
      format(sum(PREG_END_DELIV==1 & MAT_INDUCED_MISS==0, na.rm = TRUE), nsmall = 0, digits = 2)),

    "Spontaneous labor" = paste0(
      format(sum(PREG_END_DELIV==1 & MAT_INDUCED_MISS==0 & MAT_INDUCED==0, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END_DELIV==1 & MAT_INDUCED_MISS==0 & MAT_INDUCED==0, na.rm = TRUE)/sum(PREG_END_DELIV==1 & MAT_INDUCED_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")"),

     "Induced labor" = paste0(
      format(sum(PREG_END_DELIV==1 & MAT_INDUCED_MISS==0 & MAT_INDUCED==1, na.rm = TRUE), nsmall = 0, digits = 2),
      " (",
      format(round(sum(PREG_END_DELIV==1 & MAT_INDUCED_MISS==0 & MAT_INDUCED==1, na.rm = TRUE)/sum(PREG_END_DELIV==1 & MAT_INDUCED_MISS==0, na.rm=TRUE)*100, 2), nsmall = 0, digits = 2),
      ")")

    ) %>%
  t() %>% as.data.frame() %>%
  `colnames<-`(c(.[1,])) %>%
  slice(-1)  %>%
  mutate_all(funs(str_replace(., "NaN", "0"))) %>%
  mutate_all(funs(str_replace(., "NA", "0")))

```

```{r}
# replace NA with 0s (this likely means there is not yet data)
induced_tab[is.na(induced_tab)] <- paste0("0 (0)")

induced_tab_output <- tb_theme1(induced_tab) %>%
  tab_header(
    title = md("**Table 16**")) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>"),
        rows = 1:6
    ) %>%
  tab_row_group(
    label = html("<span style='font-size: 18px'>Induced labor prevalence <sup>b</sup></span>"),
    rows = 7:9
  ) %>%
    # bold denominator rows 1
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Denominator (non-missing)",
                 "Denominator (non-missing)"))) %>%

  # bold denominator rows 2
  tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_body(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%
tab_style(
      style = list(
        cell_text(weight = "bold")
        ),
      locations = cells_stub(rows = c(
                 "Expected denominator (total completed pregnancies)",
                 "Expected denominator (total completed pregnancies)"))) %>%
 row_group_order(groups = c("<span style='font-size: 18px'>Data completeness <sup>a</sup></span>",
                           "<span style='font-size: 18px'>Induced labor prevalence <sup>b</sup></span>"))  %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>a</sup> The expected denominator for this outcome is all completed pregnancies; this includes all pregnancies where an endpoint has been recorded in MNH09 (labor and delivery) OR MNH04 (pregnancy loss reported during ANC visit) OR MNH19 (pregnancy loss reported during hospitalization) OR if a maternal death is reported prior to delivery. </span>"))  %>%

  tab_footnote(
    footnote = html("<span style='font-size: 18px'><sup>b</sup> This denominator is restricted to pregnancies ending in a delivery at/after 20 weeks gestation AND included labor or attempted labor induction. Pregnancies ending in a c-section prior to labor initiation and without any attempted induction are excluded. </span>"))

```

```{r, out.width = '100%'}

gtsave(induced_tab_output, file = "induced_tab_output.png", path = path_to_save, expand = 10)
knitr::include_graphics(paste0(path_to_save, "induced_tab_output.png"))

```



