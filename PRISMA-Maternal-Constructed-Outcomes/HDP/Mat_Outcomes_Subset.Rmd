---
title: "Mat_Outcomes_Subset"
author: "Fouzia Farooq"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---
title: "PRISMA_ Maternal-Infant-Constructed-Outcomes - Individual Forms"
author: "Fouzia Farooq"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

README: 
This file creates a subset data that will be used in the GDM variable construction. 
1. Run this file first.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, warning=FALSE}
library(readxl)
library(dplyr)
library(ggplot2)
library(knitr)
library(stringr)
library(purrr)
library(lubridate)
library(readr)
library(tidyr)
library(haven)
library(tableone)
library(kableExtra)

```


```{r echo=FALSE}
# path_to_data <- 'Z:/SynapseCSVs/Kenya/2023-07-28/' # If MNH*.xlsx files are located elsewhere, set this to, for example, 'data/' or '//TNT/...'
# path_to_data <- 'Z:/Processed Data/2023-07-28/'

# path_to_data <- 'Z:/Stacked Data/2023-09-15/' # - for AWS data

path_to_data <-  'D:/Users/fouziafarooq/Documents/PRISMA_constructed-outcomes/data/2023-10-06/'# - for AWS data that

# path_to_data <- 'data' # for Mac R.
UploadDate = "2023-10-06"

uploadDate <- as.Date(UploadDate, format = "%Y-%m-%d")
```

For CSV files in **AWS**:
```{r echo=FALSE}
########################################################################################
recreate_mnh_list <- FALSE #if I want to recreate the big data list then set this to TRUE
########################################################################################
tic <- Sys.time()
if(recreate_mnh_list == TRUE){
  mnh_list <- list() # create an empty list first.
  list_mnh <- dir(path = path_to_data, pattern = "*.csv", full.names = TRUE) #creates a list of all the csv files in the directory
  for (data_file in list_mnh[]) { #can test by just bringing in a small number (add 1:2 inside the bracket to do so)
    form_num <- substr(basename(data_file), 1,5) #substr pulls out the 1:5 spaces in a char (will pull out "mnh00" etc);
    #basename() pulls out just the name of the file from the entire directory/path.
    print(paste("Reading", form_num))
    mnh_list[[form_num]] <- read.csv(data_file)
  }
  saveRDS(mnh_list, file = paste0("MNH_list_", basename(path_to_data), ".RDS"))
}
toc <- Sys.time()
print(toc - tic)

# mnh_list <- readRDS(paste0("MNH_list_", basename(path_to_data), ".RDS"))  #read in the RDS objects with all the MNH files as a massive list.

mnh_list <- readRDS(file = 'MNH_list_2023-10-06.RDS')
```

```{r}
# mnh01_df <- mnh_list[["mnh01"]]
# df <- mnh01_df %>% filter(SITE=="Zambia")
```

For SAS files from **Test data**.
```{r echo=FALSE}
########################################################################################
 # recreate_mnh_list <- FALSE #if I want to recreate the big data list then set this to TRUE
########################################################################################
# 
# if(recreate_mnh_list == TRUE){
#   mnh_list <- list() # create an empty list first.
#   list_mnh <- dir(path = path_to_data, pattern = "*.sas7bdat", full.names = TRUE) #creates a list of all the csv files in the directory
#   for (data_file in list_mnh[]) { #can test by just bringing in a small number (add 1:2 inside the bracket to do so)
#     form_num <- substr(basename(data_file), 1,5) #substr pulls out the 1:5 spaces in a char (will pull out "mnh00" etc);
#     #basename() pulls out just the name of the file from the entire directory/path.
#     print(paste("Reading", form_num))
#     mnh_list[[form_num]] <- read_sas(data_file, )
#   }
#   saveRDS(mnh_list, file = paste0("MNH_list_", basename(path_to_data), ".RDS"))
# }
# 
# mnh_list <- readRDS("MNH_list_data.RDS")  #read in the RDS objects with all the MNH files as a massive list.

```


### Hard code TYPE_VISIT for M00=1, M02=1, M03=1, M09=6, M10=6, M11=6, M17=6, M18=12 ***
```{r echo=FALSE}
if("mnh00" %in% names(mnh_list)){
  mnh_list[["mnh00"]] <- mnh_list[["mnh00"]] %>% 
    mutate(M00_TYPE_VISIT = 1) 
} else{
  "MNH00 doesn't exist in the list"
}

if("mnh02" %in% names(mnh_list)){
  mnh_list[["mnh02"]] <- mnh_list[["mnh02"]] %>% 
    mutate(M02_TYPE_VISIT = 1) 
} else{
  "MNH02 doesn't exist in the list"
}

if("mnh03" %in% names(mnh_list)){
  mnh_list[["mnh03"]] <- mnh_list[["mnh03"]] %>% 
    mutate(M03_TYPE_VISIT = 1) 
} else{
  "MNH03 doesn't exist in the list"
}

if("mnh09" %in% names(mnh_list)){
  mnh_list[["mnh09"]] <- mnh_list[["mnh09"]] %>% 
    mutate(M09_TYPE_VISIT = 6) 
} else{
  "MNH09 doesn't exist in the list"
}

if("mnh10" %in% names(mnh_list)){
  mnh_list[["mnh10"]] <- mnh_list[["mnh10"]] %>% 
    mutate(M10_TYPE_VISIT = 6) 
} else{
  "MNH10 doesn't exist in the list"
}

if("mnh11" %in% names(mnh_list)){
  mnh_list[["mnh11"]] <- mnh_list[["mnh11"]] %>% 
    mutate(M11_TYPE_VISIT = 6) 
} else{
  "MNH11 doesn't exist in the list"
}

if("mnh17" %in% names(mnh_list)){
  mnh_list[["mnh17"]] <- mnh_list[["mnh17"]] %>% 
    mutate(M17_TYPE_VISIT = 6) 
} else{
  "MNH17 doesn't exist in the list"
}

if("mnh16" %in% names(mnh_list)){
  mnh_list[["mnh16"]] <- mnh_list[["mnh16"]] %>% 
    mutate(M16_TYPE_VISIT = 5) 
} else{
  "MNH16 doesn't exist in the list"
}

if("mnh18" %in% names(mnh_list)){
  mnh_list[["mnh18"]] <- mnh_list[["mnh18"]] %>% 
    mutate(M18_TYPE_VISIT = 12) 
} else{
  "MNH18 doesn't exist in the list"
}

if("mnh19" %in% names(mnh_list)){
  mnh_list[["mnh19"]] <- mnh_list[["mnh19"]] %>% 
    mutate(M19_TYPE_VISIT = 13) 
} else{
  "MNH19 doesn't exist in the list"
}

```

# Create a SITE variable for Test data only on Mac - can let it run in AWS.***FOR TEST DATA ONLY***
```{r echo=FALSE}
# for(form_name in names(mnh_list)) { 
#   if(!('SITE' %in% names(form_name))) {
#     mnh_list[[form_name]]$SITE <- NA
#   }
# }
```

# Change wrong values for MNH01 TYPE_VISIT (value was 36 but SL mentioned it probably is week 36 so visit 5)
```{r echo=FALSE}
   
# mnh_list[["mnh01"]] <- mnh_list[["mnh01"]] %>% 
 # mutate(M01_TYPE_VISIT = ifelse(M01_TYPE_VISIT == 36, 5, M01_TYPE_VISIT))
```


# MNH00 and MNH01 don't have MOMID and PREGID in Kenya and Zambia. Merge it in from MNH02. 
# THERE ARE NA'S AND THEN THERE ARE "" IN ZAMBIA MOMID AND PREGID
Keep an eye on SITE variable. 
```{r echo=FALSE}
mnh_list[["mnh00"]] <- mnh_list[["mnh00"]] %>% select(-PREGID, -MOMID) # Only need to run this line outside of AWS when I need to add Mxx prefix.

# mnh_list[["mnh00"]] <- mnh_list[["mnh00"]] %>% filter(!is.na(SCRN_OBSSTDAT)) # had to remove 2 rows of garbage.
# mnh_list[["mnh00"]]$SCRNID <- as.double(mnh_list[["mnh00"]]$SCRNID) # Just for Test Kenya data on Mac

# mnh_list[["mnh00"]]$SCRNID <- as.character(mnh_list[["mnh00"]]$SCRNID)

mnh_list[["mnh00"]] <- left_join(mnh_list[["mnh00"]],
                                 mnh_list[["mnh02"]] %>% select(SCRNID, MOMID, PREGID, SITE),
                                 by = c("SCRNID", "SITE"))

mnh_list[["mnh01"]] <- mnh_list[["mnh01"]] %>% select(-PREGID, -MOMID)
mnh_list[["mnh01"]] <- left_join(mnh_list[["mnh01"]],
                                 mnh_list[["mnh02"]] %>% select(SCRNID, MOMID, PREGID, SITE),
                                 by = c("SCRNID", "SITE"))

mnh_list[["mnh00"]] <- mnh_list[["mnh00"]] %>% filter(PREGID !="")
mnh_list[["mnh01"]] <- mnh_list[["mnh01"]] %>% filter(PREGID !="")
mnh_list[["mnh02"]] <- mnh_list[["mnh02"]] %>% filter(PREGID !="")

test.df <- mnh_list[["mnh00"]] %>% filter(SITE=="Zambia") %>%
  select(SCRNID, MOMID, PREGID, SITE) # M01_US_GA_DAYS_AGE_FTS1 )

test.df <- mnh_list[["mnh01"]] %>% filter(SITE=="Zambia") %>%
  select(SCRNID, MOMID, PREGID, SITE) # M01_US_GA_DAYS_AGE_FTS1 )

test.df <- mnh_list[["mnh02"]] %>% filter(SITE=="Zambia") %>%
  select(SCRNID, MOMID, PREGID, SITE) 

test.df <- mnh_list[["mnh04"]] %>% filter(SITE=="Zambia") %>%
  select(MOMID, PREGID, SITE)
```

# Adding a prefix of M_XX: *Just for Test Kenya data on mac*
Using modify() from Purrr library and a lambda function.
```{r echo=FALSE}
#############################################################################################################################################
# THIS DOESN'T NOT NEED TO BE RUN WHEN RUNNING IN AWS DATA - THIS IS ONLY NEEDED FOR TEST DATA OUTSIDE B/C THOSE VARS DIDN'T HAVE PREFIX Mxx
#############################################################################################################################################
# dont_fix <- c("SCRNID", "MOMID", "PREGID", "SITE") 
# 
# for (form_name in names(mnh_list)) {
#   col_names_vec <- names(mnh_list[[form_name]])
#   var_prefix <- paste0('M',substr(form_name, 4, 5))
#   names(mnh_list[[form_name]]) <- modify(col_names_vec,
#                                          function(x) {
#     ifelse(x %in% dont_fix | startsWith(x, var_prefix), #second part is checking if variable already has M_XX.
#            x,
#            paste0(var_prefix, "_", x))}) #x is whatever name is passed in.
# }
```

# CLEANING UP EMPTY ROWS
```{r echo=FALSE}

mnh_list[["mnh00"]] <- mnh_list[["mnh00"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>% #try using 'drop_na (variables)
  distinct (MOMID, PREGID, SITE, M00_TYPE_VISIT, .keep_all = TRUE) # keep_all keeps the first row rather than dropping both duplicates. 


mnh_list[["mnh01"]] <- mnh_list[["mnh01"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>%
  distinct ( SITE, SCRNID, M01_TYPE_VISIT, .keep_all = TRUE) #MOMID, PREGID,

mnh_list[["mnh02"]] <- mnh_list[["mnh02"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, M02_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh04"]] <- mnh_list[["mnh04"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, M04_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh05"]] <- mnh_list[["mnh05"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, M05_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh06"]] <- mnh_list[["mnh06"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, M06_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh07"]] <- mnh_list[["mnh07"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, M07_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh08"]] <- mnh_list[["mnh08"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, M08_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh11"]] <- mnh_list[["mnh11"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>%
  distinct (MOMID, PREGID, SITE, M11_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh12"]] <- mnh_list[["mnh12"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, M12_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh13"]] <- mnh_list[["mnh13"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>%
  distinct (MOMID, PREGID, SITE, M13_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh14"]] <- mnh_list[["mnh14"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>%
  distinct (MOMID, PREGID, SITE, M14_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh15"]] <- mnh_list[["mnh15"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>%
  distinct (MOMID, PREGID, SITE, M15_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh19"]] <- mnh_list[["mnh19"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  drop_na(MOMID, PREGID) %>%
  distinct (MOMID, PREGID, SITE, M19_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh25"]] <- mnh_list[["mnh25"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>%
  distinct (MOMID, PREGID, SITE, M25_TYPE_VISIT, .keep_all = TRUE)

mnh_list[["mnh26"]] <- mnh_list[["mnh26"]] %>%
  filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
  filter(!is.na(MOMID)) %>%
  distinct (MOMID, PREGID, SITE, M26_TYPE_VISIT, .keep_all = TRUE)
```

# ADD TYPE_VISIT AS A SUFFIX
```{r echo=FALSE}
mnh_list_wide <- list()

#Once I run through this code, I will no longer have TYPE_VISIT variable in my mnh_list_wide datasets. 
for (form_name in names(mnh_list)) {
  var_prefix <- paste0('M',substr(form_name, 4, 5))
  if(!(paste0(var_prefix, "_TYPE_VISIT") %in% names(mnh_list[[form_name]]))){ #if type_visit variable doesn't exist then skip it, but still copy the data frame to the list of wide frames (otherwise that MNH data will not be included).
    mnh_list_wide[[form_name]] <- mnh_list[[form_name]]
    next
  }
  if(form_name!="mnh19"){
    mnh_list_wide[[form_name]] <- mnh_list[[form_name]] %>% # do the pivot here
      filter(get(paste0(var_prefix, '_TYPE_VISIT'))!=13)
  }

    #keeps a single row of duplicate rows based on MOMID, _TYPE_VISIT, and PREGID.
   # mnh_list_wide[!duplicated(mnh_list_wide)] %>%
  # distinct (MOMID, PREGID, paste0(var_prefix, '_TYPE_VISIT'), .keep_all = TRUE) %>%
  mnh_list_wide[[form_name]] <- mnh_list[[form_name]] %>% # do the pivot here
    pivot_wider(id_cols = c('MOMID', 'PREGID', 'SITE'),
                names_from = paste0(var_prefix, '_TYPE_VISIT'),
                values_from = starts_with(var_prefix) & !ends_with('_TYPE_VISIT'),
                values_fill = NA)
   # filter(MOMID!="") %>% #Moved filter to the end so we can create all the variables with TYPE_VISIT at the end of the var name before rows get dropped out
   # filter(!is.na(MOMID)) 
}
# distinct (MOMID, PREGID, paste0(var_prefix, '_TYPE_VISIT'), .keep_all = TRUE) %>%
```


# CONVERT LISTS INTO DATAFRAMES. 
```{r echo=FALSE}
for(form_name in names(mnh_list)){
assign(paste0(form_name, "_df"), mnh_list_wide[[form_name]]) # assign is the opposite of get()
}
```


# MERGE together all the forms. - ENROLLED 
```{r echo=FALSE}
merged_df <- mnh02_df 
merged_df <- merged_df %>% 
  mutate(ENROLLED_FF = ifelse(M02_AGE_IEORRES_1 ==1 & M02_PC_IEORRES_1==1 & 
                                M02_CATCHMENT_IEORRES_1==1 & M02_CATCH_REMAIN_IEORRES_1==1 & 
                                M02_CONSENT_IEORRES_1==1, 1,0)) %>% filter(ENROLLED_FF ==1) # THIS DOES DROP SOME WOMEN!

# merged_df <- left_join(merged_df, mnh00_df, by = c("MOMID", "PREGID", "SITE"))
# merged_df <- left_join(merged_df, mnh01_df, by = c("MOMID", "PREGID", "SITE"))


duplicate_df <- merged_df %>% group_by(MOMID, PREGID) %>%  filter(n()>1)
duplicate_df2 <- duplicate_df %>% distinct(MOMID, PREGID)

###############################
# FIGURE OUT WHERE DUPLICATES ARE 
DUPLICATE <- FALSE
################################
if(DUPLICATE==TRUE){
  for(i in 0:26) {
    form_name <- paste0("mnh", sprintf(fmt="%02d", i), "_df") #sprintf adds a leading 0 to digits below 10.
    dup_form_name <- paste0("dup_mnh", sprintf(fmt="%02d", i), "_df")
    #if(exists(form_name) & !form_name %in% dont_merge[]) {
    if(exists(form_name) & !form_name %in% c("mnh02", "mnh11", "mnh13", "mnh14", "mnh15", "mnh24")) { # taking out the infant forms from the maternal merge. 
      form_df <- get(form_name)
      duplicate_df <- form_df %>% group_by(MOMID, PREGID, SITE) %>%  filter(n()>1)
      assign(dup_form_name, duplicate_df)
    }
  }
}

dont_merge <- c("mnh02_df", "mnh11_df", "mnh13_df", "mnh14_df", "mnh15_df", "mnh24_df")
for(i in 0:26) {
  form_name <- paste0("mnh", sprintf(fmt="%02d", i), "_df") #sprintf adds a leading 0 to digits below 10.
 if(exists(form_name) & !(form_name %in% dont_merge)) { # taking out the infant forms from the maternal merge. 
 #if(exists(form_name) & !form_name %in% c("mnh11", "mnh13", "mnh14", "mnh15", "mnh24")) { 
    form_df <- get(form_name) %>% distinct(MOMID, PREGID, SITE, .keep_all = TRUE) # THIS REMOVES DUPLICATE ROWS. 
    merged_df <- left_join(merged_df, form_df, by = c("MOMID", "PREGID", "SITE"))
  }
}
```


# Convert "1907-07-07" to NA:
# CATEGORICAL: 
# ---- 77, Not applicable 
# ---- 55, Missing 
# ---- 66, Refused to answer
# ---- 99, Don't know

# CONTINUOUS:
# ---- -7, Not applicable 
# ---- -5, Missing 
# ---- -6, Refused to answer
# ---- -9, Don't know
# DATE: 
# ---- 07-07-1907, Not applicable 
# ---- 05-05-1905, Missing 
# ---- 06-06-1906, Refused to answer
# ---- 09-09-1909, Don't know

# TIME: 
# ---- 77:77, Not applicable 
# ---- 55:55, Missing 
# ---- 66:66, Refused to answer
# ---- 99:99, Don't know
```{r echo=FALSE}
CONVERT_NA <- FALSE
if(CONVERT_NA ==TRUE){
  tic <- Sys.time()
  merged_df <- merged_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter.
    mutate_all(function(d) {
      if_else(d=="1907-07-07", NA, d)
    })
  
  merged_df <- merged_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter.
    mutate_all(function(d) {
      if_else(d==-7, NA, d)
    })
  
  merged_df <- merged_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter.
    mutate_all(function(d) {
      if_else(d==77, NA, d)
    })
  
  # -5 IS MISSING FOR CONTINUOUS
  merged_df <- merged_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
    mutate_all(function(d) {
      if_else(d==-5, NA, d) 
    })
  
  # 55 IS MISSING FOR CATEGORICAL
  merged_df <- merged_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
    mutate_all(function(d) {
      if_else(d==55, NA, d) 
    })
  
  # 55:55 IS MISSING FOR TIME
  merged_df <- merged_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
    mutate_all(function(d) {
      if_else(d=='55:55', NA, d)
    })
  
  toc <- Sys.time()
}
time_diff <- toc-tic
time_diff
```

# ADD VARIABLES THAT DON'T EXIST HERE
```{r echo=FALSE}
##############
# ANC VISITS # 
##############

tic <- Sys.time()
# # Visit 3 doesn't have M08_CBC_HB_LBORRES_3:
# merged_df$M08_CBC_HB_LBORRES_3 <- ifelse("M08_CBC_HB_LBORRES_3" %in% names(merged_df),
#                                              merged_df$M08_CBC_HB_LBORRES_3, NA)
# 
# merged_df$M08_CBC_HB_LBORRES_4 <- ifelse("M08_CBC_HB_LBORRES_4" %in% names(merged_df),
#                                              merged_df$M08_CBC_HB_LBORRES_4, NA)
# 
# merged_df$M08_CBC_HB_LBORRES_5 <- ifelse("M08_CBC_HB_LBORRES_5" %in% names(merged_df),
#                                              merged_df$M08_CBC_HB_LBORRES_5, NA)
# 
# # VISIT 6 doesn't have M06_HB_POC_LBORRES_6:it's optional at L&D to do MNH08 and MNH06:
# merged_df$M06_HB_POC_LBORRES_6 <- ifelse("M06_HB_POC_LBORRES_6" %in% names(merged_df),
#                                              merged_df$M06_HB_POC_LBORRES_6, NA) 
# 
# merged_df$M08_CBC_HB_LBORRES_6 <- ifelse("M08_CBC_HB_LBORRES_6" %in% names(merged_df),
#                                              merged_df$M08_CBC_HB_LBORRES_6, NA)
# 
# # VISIT 10 doesn't have M08_CBC_HB_LBORRES_10: 
# merged_df$M08_CBC_HB_LBORRES_10 <- ifelse("M08_CBC_HB_LBORRES_10" %in% names(merged_df),
#                                              merged_df$M08_CBC_HB_LBORRES_10, NA) 


# VISIT 11 and 12 hasn't happened for anyone (PNC26 and PNC52) so variable M08_CBC_HB_LBORRES_11 or _12 don't exist:
merged_df$M08_CBC_HB_LBORRES_11 <- ifelse("M08_CBC_HB_LBORRES_11" %in% names(merged_df),
                                            merged_df$M08_CBC_HB_LBORRES_11, NA) 

merged_df$M08_CBC_HB_LBORRES_12 <- ifelse("M08_CBC_HB_LBORRES_12" %in% names(merged_df),
                                            merged_df$M08_CBC_HB_LBORRES_12, NA)

merged_df$M06_HB_POC_LBORRES_12 <- ifelse("M06_HB_POC_LBORRES_12" %in% names(merged_df),
                                            merged_df$M06_HB_POC_LBORRES_12, NA)

merged_df$M12_MAT_VITAL_MNH12_12 <- ifelse("M12_MAT_VITAL_MNH12_12" %in% names(merged_df),
                                            merged_df$M12_MAT_VITAL_MNH12_12, NA)

merged_df$M12_MAT_VITAL_MNH12_12 <- ifelse("M12_MAT_VITAL_MNH12_12" %in% names(merged_df),
                                            merged_df$M12_MAT_VITAL_MNH12_12, NA)

# PNC-52 BP measures 
merged_df$M06_BP_SYS_VSORRES_1_12 <- ifelse("M06_BP_SYS_VSORRES_1_12" %in% names(merged_df),
                                            merged_df$M06_BP_SYS_VSORRES_1_12, NA)

merged_df$M06_BP_SYS_VSORRES_2_12 <- ifelse("M06_BP_SYS_VSORRES_2_12" %in% names(merged_df),
                                            merged_df$M06_BP_SYS_VSORRES_2_12, NA)

merged_df$M06_BP_SYS_VSORRES_3_12 <- ifelse("M06_BP_SYS_VSORRES_3_12" %in% names(merged_df),
                                            merged_df$M06_BP_SYS_VSORRES_3_12, NA)

merged_df$M06_BP_DIA_VSORRES_1_12 <- ifelse("M06_BP_DIA_VSORRES_1_12" %in% names(merged_df),
                                            merged_df$M06_BP_DIA_VSORRES_1_12, NA)

merged_df$M06_BP_DIA_VSORRES_2_12 <- ifelse("M06_BP_DIA_VSORRES_2_12" %in% names(merged_df),
                                            merged_df$M06_BP_SYS_VSORRES_2_12, NA)

merged_df$M06_BP_DIA_VSORRES_3_12 <- ifelse("M06_BP_DIA_VSORRES_3_12" %in% names(merged_df),
                                            merged_df$M06_BP_SYS_VSORRES_3_12, NA)


merged_df$M19_BP_SYS_VSORRES_14 <- ifelse("M19_BP_SYS_VSORRES_14" %in% names(merged_df),
                                            merged_df$M19_BP_SYS_VSORRES_14, NA)

merged_df$M19_BP_DIA_VSORRES_14 <- ifelse("M19_BP_DIA_VSORRES_14" %in% names(merged_df),
                                            merged_df$M19_BP_DIA_VSORRES_14, NA)

# PROTEINURIA VARS
merged_df$M08_UA_PROT_LBORRES_8 <- ifelse("M08_UA_PROT_LBORRES_8" %in% names(merged_df),
                                            merged_df$M08_UA_PROT_LBORRES_8, NA)

merged_df$M08_UA_PROT_LBORRES_9 <- ifelse("M08_UA_PROT_LBORRES_9" %in% names(merged_df),
                                            merged_df$M08_UA_PROT_LBORRES_9, NA)


merged_df$M08_UA_PROT_LBORRES_13 <- ifelse("M08_UA_PROT_LBORRES_13" %in% names(merged_df),
                                            merged_df$M08_UA_PROT_LBORRES_13, NA)

merged_df$M08_UA_PROT_LBORRES_14 <- ifelse("M08_UA_PROT_LBORRES_14" %in% names(merged_df),
                                            merged_df$M08_UA_PROT_LBORRES_14, NA)

# INFECTION TEST VARS - SITES HAVEN'T STARTED USING THESE TESTS YETS - 09/20/2023
merged_df$M08_SYPH_TITER_LBPERF_1_1 <- ifelse("M08_SYPH_TITER_LBPERF_1_1" %in% names(merged_df),
                                            merged_df$M08_SYPH_TITER_LBPERF_1_1, NA)

merged_df$M08_SYPH_TITER_LBPERF_1_2 <- ifelse("M08_SYPH_TITER_LBPERF_1_2" %in% names(merged_df),
                                            merged_df$M08_SYPH_TITER_LBPERF_1_2, NA)

merged_df$M08_SYPH_TITER_LBPERF_1_3 <- ifelse("M08_SYPH_TITER_LBPERF_1_3" %in% names(merged_df),
                                            merged_df$M08_SYPH_TITER_LBPERF_1_3, NA)

merged_df$M08_SYPH_TITER_LBPERF_1_4 <- ifelse("M08_SYPH_TITER_LBPERF_1_4" %in% names(merged_df),
                                            merged_df$M08_SYPH_TITER_LBPERF_1_4, NA)

merged_df$M08_SYPH_TITER_LBPERF_1_5 <- ifelse("M08_SYPH_TITER_LBPERF_1_5" %in% names(merged_df),
                                            merged_df$M08_SYPH_TITER_LBPERF_1_5, NA)

merged_df$M08_SYPH_TITER_LBPERF_1_10 <- ifelse("M08_SYPH_TITER_LBPERF_1_10" %in% names(merged_df),
                                            merged_df$M08_SYPH_TITER_LBPERF_1_10, NA)

merged_df$M08_HEV_IGM_LBORRES_1 <- ifelse("M08_HEV_IGM_LBORRES_1" %in% names(merged_df),
                                            merged_df$M08_HEV_IGM_LBORRES_1, NA)

merged_df$M08_HEV_IGM_LBORRES_2 <- ifelse("M08_HEV_IGM_LBORRES_2" %in% names(merged_df),
                                            merged_df$M08_HEV_IGM_LBORRES_2, NA)

merged_df$M08_HEV_IGM_LBORRES_3 <- ifelse("M08_HEV_IGM_LBORRES_3" %in% names(merged_df),
                                            merged_df$M08_HEV_IGM_LBORRES_3, NA)

merged_df$M08_HEV_IGM_LBORRES_4 <- ifelse("M08_HEV_IGM_LBORRES_4" %in% names(merged_df),
                                            merged_df$M08_HEV_IGM_LBORRES_4, NA)

merged_df$M08_HEV_IGM_LBORRES_5 <- ifelse("M08_HEV_IGM_LBORRES_5" %in% names(merged_df),
                                            merged_df$M08_HEV_IGM_LBORRES_5, NA)

merged_df$M08_HEV_IGM_LBORRES_10 <- ifelse("M08_HEV_IGM_LBORRES_10" %in% names(merged_df),
                                            merged_df$M08_HEV_IGM_LBORRES_10, NA)

merged_df$M08_CTNG_CT_LBORRES_1 <- ifelse("M08_CTNG_CT_LBORRES_1" %in% names(merged_df),
                                            merged_df$M08_CTNG_CT_LBORRES_1, NA)

merged_df$M08_CTNG_CT_LBORRES_2 <- ifelse("M08_CTNG_CT_LBORRES_2" %in% names(merged_df),
                                            merged_df$M08_CTNG_CT_LBORRES_2, NA)

merged_df$M08_CTNG_CT_LBORRES_3 <- ifelse("M08_CTNG_CT_LBORRES_3" %in% names(merged_df),
                                            merged_df$M08_CTNG_CT_LBORRES_3, NA)

merged_df$M08_CTNG_CT_LBORRES_4 <- ifelse("M08_CTNG_CT_LBORRES_4" %in% names(merged_df),
                                            merged_df$M08_CTNG_CT_LBORRES_4, NA)

merged_df$M08_CTNG_CT_LBORRES_5 <- ifelse("M08_CTNG_CT_LBORRES_5" %in% names(merged_df),
                                            merged_df$M08_CTNG_CT_LBORRES_5, NA)

merged_df$M08_CTNG_CT_LBORRES_10 <- ifelse("M08_CTNG_CT_LBORRES_10" %in% names(merged_df),
                                            merged_df$M08_CTNG_CT_LBORRES_10, NA)

merged_df$M08_CTNG_NG_LBORRES_1 <- ifelse("M08_CTNG_NG_LBORRES_1" %in% names(merged_df),
                                            merged_df$M08_CTNG_NG_LBORRES_1, NA)

merged_df$M08_CTNG_NG_LBORRES_2 <- ifelse("M08_CTNG_NG_LBORRES_2" %in% names(merged_df),
                                            merged_df$M08_CTNG_NG_LBORRES_2, NA)

merged_df$M08_CTNG_NG_LBORRES_3 <- ifelse("M08_CTNG_NG_LBORRES_3" %in% names(merged_df),
                                            merged_df$M08_CTNG_NG_LBORRES_3, NA)

merged_df$M08_CTNG_NG_LBORRES_4 <- ifelse("M08_CTNG_NG_LBORRES_4" %in% names(merged_df),
                                            merged_df$M08_CTNG_NG_LBORRES_4, NA)

merged_df$M08_CTNG_NG_LBORRES_5 <- ifelse("M08_CTNG_NG_LBORRES_5" %in% names(merged_df),
                                            merged_df$M08_CTNG_NG_LBORRES_5, NA)

merged_df$M08_CTNG_NG_LBORRES_10 <- ifelse("M08_CTNG_NG_LBORRES_10" %in% names(merged_df),
                                            merged_df$M08_CTNG_NG_LBORRES_10, NA)

merged_df$M08_ZCD_ZIKIGM_LBORRES_1 <- ifelse("M08_ZCD_ZIKIGM_LBORRES_1" %in% names(merged_df),
                                            merged_df$M08_ZCD_ZIKIGM_LBORRES_1, NA)

merged_df$M08_ZCD_ZIKIGM_LBORRES_2 <- ifelse("M08_ZCD_ZIKIGM_LBORRES_2" %in% names(merged_df),
                                            merged_df$M08_ZCD_ZIKIGM_LBORRES_2, NA)

merged_df$M08_ZCD_ZIKIGM_LBORRES_3 <- ifelse("M08_ZCD_ZIKIGM_LBORRES_3" %in% names(merged_df),
                                            merged_df$M08_ZCD_ZIKIGM_LBORRES_3, NA)

merged_df$M08_ZCD_ZIKIGM_LBORRES_4 <- ifelse("M08_ZCD_ZIKIGM_LBORRES_4" %in% names(merged_df),
                                            merged_df$M08_ZCD_ZIKIGM_LBORRES_4, NA)

merged_df$M08_ZCD_ZIKIGM_LBORRES_5 <- ifelse("M08_ZCD_ZIKIGM_LBORRES_5" %in% names(merged_df),
                                            merged_df$M08_ZCD_ZIKIGM_LBORRES_5, NA)

merged_df$M08_ZCD_ZIKIGM_LBORRES_10 <- ifelse("M08_ZCD_ZIKIGM_LBORRES_10" %in% names(merged_df),
                                            merged_df$M08_ZCD_ZIKIGM_LBORRES_10, NA)

merged_df$M08_ZCD_CHKIGM_LBORRES_1 <- ifelse("M08_ZCD_CHKIGM_LBORRES_1" %in% names(merged_df),
                                            merged_df$M08_ZCD_CHKIGM_LBORRES_1, NA)

merged_df$M08_ZCD_CHKIGM_LBORRES_2 <- ifelse("M08_ZCD_CHKIGM_LBORRES_2" %in% names(merged_df),
                                            merged_df$M08_ZCD_CHKIGM_LBORRES_2, NA)

merged_df$M08_ZCD_CHKIGM_LBORRES_3 <- ifelse("M08_ZCD_CHKIGM_LBORRES_3" %in% names(merged_df),
                                            merged_df$M08_ZCD_CHKIGM_LBORRES_3, NA)

merged_df$M08_ZCD_CHKIGM_LBORRES_4 <- ifelse("M08_ZCD_CHKIGM_LBORRES_4" %in% names(merged_df),
                                            merged_df$M08_ZCD_CHKIGM_LBORRES_4, NA)

merged_df$M08_ZCD_CHKIGM_LBORRES_5 <- ifelse("M08_ZCD_CHKIGM_LBORRES_5" %in% names(merged_df),
                                            merged_df$M08_ZCD_CHKIGM_LBORRES_5, NA)

merged_df$M08_ZCD_CHKIGM_LBORRES_10 <- ifelse("M08_ZCD_CHKIGM_LBORRES_10" %in% names(merged_df),
                                            merged_df$M08_ZCD_CHKIGM_LBORRES_10, NA)

merged_df$M08_ZCD_DENIGM_LBORRES_1 <- ifelse("M08_ZCD_DENIGM_LBORRES_1" %in% names(merged_df),
                                            merged_df$M08_ZCD_DENIGM_LBORRES_1, NA)

merged_df$M08_ZCD_DENIGM_LBORRES_2 <- ifelse("M08_ZCD_DENIGM_LBORRES_2" %in% names(merged_df),
                                            merged_df$M08_ZCD_DENIGM_LBORRES_2, NA)

merged_df$M08_ZCD_DENIGM_LBORRES_3 <- ifelse("M08_ZCD_DENIGM_LBORRES_3" %in% names(merged_df),
                                            merged_df$M08_ZCD_DENIGM_LBORRES_3, NA)

merged_df$M08_ZCD_DENIGM_LBORRES_4 <- ifelse("M08_ZCD_DENIGM_LBORRES_4" %in% names(merged_df),
                                            merged_df$M08_ZCD_DENIGM_LBORRES_4, NA)

merged_df$M08_ZCD_DENIGM_LBORRES_5 <- ifelse("M08_ZCD_DENIGM_LBORRES_5" %in% names(merged_df),
                                            merged_df$M08_ZCD_DENIGM_LBORRES_5, NA)

merged_df$M08_ZCD_DENIGM_LBORRES_10 <- ifelse("M08_ZCD_DENIGM_LBORRES_10" %in% names(merged_df),
                                            merged_df$M08_ZCD_DENIGM_LBORRES_10, NA)

merged_df$M08_LEPT_IGM_LBORRES_1 <- ifelse("M08_LEPT_IGM_LBORRES_1" %in% names(merged_df),
                                            merged_df$M08_LEPT_IGM_LBORRES_1, NA)

merged_df$M08_LEPT_IGM_LBORRES_2 <- ifelse("M08_LEPT_IGM_LBORRES_2" %in% names(merged_df),
                                            merged_df$M08_LEPT_IGM_LBORRES_2, NA)

merged_df$M08_LEPT_IGM_LBORRES_3 <- ifelse("M08_LEPT_IGM_LBORRES_3" %in% names(merged_df),
                                            merged_df$M08_LEPT_IGM_LBORRES_3, NA)

merged_df$M08_LEPT_IGM_LBORRES_4 <- ifelse("M08_LEPT_IGM_LBORRES_4" %in% names(merged_df),
                                            merged_df$M08_LEPT_IGM_LBORRES_4, NA)

merged_df$M08_LEPT_IGM_LBORRES_5 <- ifelse("M08_LEPT_IGM_LBORRES_5" %in% names(merged_df),
                                            merged_df$M08_LEPT_IGM_LBORRES_5, NA)

merged_df$M08_LEPT_IGM_LBORRES_10 <- ifelse("M08_LEPT_IGM_LBORRES_10" %in% names(merged_df),
                                            merged_df$M08_LEPT_IGM_LBORRES_10, NA)

# INFECTION VARIALBES DURING HOSPITALIZATION DURING PNC _14:

merged_df$M19_PRIMARY_MHTERM_14 <- ifelse("M19_PRIMARY_MHTERM_14" %in% names(merged_df),
                                            merged_df$M19_PRIMARY_MHTERM_14, NA)

merged_df$M19_INFECTION_MHTERM_1_14 <- ifelse("M19_INFECTION_MHTERM_1_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_1_14, NA)

merged_df$M19_INFECTION_MHTERM_2_14 <- ifelse("M19_INFECTION_MHTERM_2_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_2_14, NA)

merged_df$M19_INFECTION_MHTERM_3_14 <- ifelse("M19_INFECTION_MHTERM_3_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_3_14, NA)

merged_df$M19_INFECTION_MHTERM_4_14 <- ifelse("M19_INFECTION_MHTERM_4_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_4_14, NA)

merged_df$M19_INFECTION_MHTERM_5_14 <- ifelse("M19_INFECTION_MHTERM_5_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_5_14, NA)

merged_df$M19_INFECTION_MHTERM_6_14 <- ifelse("M19_INFECTION_MHTERM_6_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_6_14, NA)

merged_df$M19_INFECTION_MHTERM_7_14 <- ifelse("M19_INFECTION_MHTERM_7_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_7_14, NA)

merged_df$M19_INFECTION_MHTERM_8_14 <- ifelse("M19_INFECTION_MHTERM_8_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_8_14, NA)

merged_df$M19_INFECTION_MHTERM_9_14 <- ifelse("M19_INFECTION_MHTERM_9_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_9_14, NA)

merged_df$M19_INFECTION_MHTERM_10_14 <- ifelse("M19_INFECTION_MHTERM_10_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_10_14, NA)

merged_df$M19_INFECTION_MHTERM_11_14 <- ifelse("M19_INFECTION_MHTERM_11_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_11_14, NA)

merged_df$M19_INFECTION_MHTERM_12_14 <- ifelse("M19_INFECTION_MHTERM_12_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_12_14, NA) # MATERNAL SEPSIS

merged_df$M19_INFECTION_MHTERM_13_14 <- ifelse("M19_INFECTION_MHTERM_13_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_13_14, NA)

merged_df$M19_INFECTION_MHTERM_14_14 <- ifelse("M19_INFECTION_MHTERM_14_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_14_14, NA)

merged_df$M19_INFECTION_MHTERM_15_14 <- ifelse("M19_INFECTION_MHTERM_15_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_15_14, NA)

merged_df$M19_INFECTION_MHTERM_16_14 <- ifelse("M19_INFECTION_MHTERM_16_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_16_14, NA)

merged_df$M19_INFECTION_MHTERM_17_14 <- ifelse("M19_INFECTION_MHTERM_17_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_17_14, NA)

merged_df$M19_INFECTION_MHTERM_18_14 <- ifelse("M19_INFECTION_MHTERM_18_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_18_14, NA)

merged_df$M19_INFECTION_MHTERM_19_14 <- ifelse("M19_INFECTION_MHTERM_19_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_19_14, NA)

merged_df$M19_INFECTION_MHTERM_88_14 <- ifelse("M19_INFECTION_MHTERM_88_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_88_14, NA)

merged_df$M19_ABX_CMOCCUR_14 <- ifelse("M19_ABX_CMOCCUR_14" %in% names(merged_df),
                                            merged_df$M19_ABX_CMOCCUR_14, NA)

merged_df$M19_ABX_CMTRT_1_14 <- ifelse("M19_ABX_CMTRT_1_14" %in% names(merged_df),
                                            merged_df$M19_ABX_CMTRT_1_14, NA)

merged_df$M19_ABX_CMTRT_2_14 <- ifelse("M19_ABX_CMTRT_2_14" %in% names(merged_df),
                                            merged_df$M19_ABX_CMTRT_2_14, NA)

merged_df$M19_ABX_CMTRT_3_14 <- ifelse("M19_ABX_CMTRT_3_14" %in% names(merged_df),
                                            merged_df$M19_ABX_CMTRT_3_14, NA)

merged_df$M19_ABX_CMTRT_4_14 <- ifelse("M19_ABX_CMTRT_4_14" %in% names(merged_df),
                                            merged_df$M19_ABX_CMTRT_4_14, NA)

merged_df$M19_ABX_CMTRT_5_14 <- ifelse("M19_ABX_CMTRT_5_14" %in% names(merged_df),
                                            merged_df$M19_ABX_CMTRT_5_14, NA)

merged_df$M19_ABX_CMTRT_6_14 <- ifelse("M19_ABX_CMTRT_6_14" %in% names(merged_df),
                                            merged_df$M19_ABX_CMTRT_6_14, NA)

merged_df$M19_ABX_CMTRT_7_14 <- ifelse("M19_ABX_CMTRT_7_14" %in% names(merged_df),
                                            merged_df$M19_ABX_CMTRT_7_14, NA)

merged_df$M19_ABX_CMTRT_8_14 <- ifelse("M19_ABX_CMTRT_8_14" %in% names(merged_df),
                                            merged_df$M19_ABX_CMTRT_8_14, NA)

merged_df$M19_ABX_CMTRT_9_14 <- ifelse("M19_ABX_CMTRT_9_14" %in% names(merged_df),
                                            merged_df$M19_ABX_CMTRT_9_14, NA)

merged_df$M19_ABX_CMTRT_88_14 <- ifelse("M19_ABX_CMTRT_88_14" %in% names(merged_df),
                                            merged_df$M19_ABX_CMTRT_88_14, NA)

merged_df$M19_ABX_CMINDC_14 <- ifelse("M19_ABX_CMINDC_14" %in% names(merged_df),
                                            merged_df$M19_ABX_CMINDC_14, NA)

# MATERNAL HOSPITALIZATION DURING PNC (_14) - ORGAN DYSFUNCTION AND SEPSIS

merged_df$M19_PRIMARY_MHTERM_1 <- ifelse("M19_PRIMARY_MHTERM_1" %in% names(merged_df),
                                            merged_df$M19_PRIMARY_MHTERM_1, NA)

merged_df$M19_ORGAN_FAIL_MHTERM_1_14 <- ifelse("M19_ORGAN_FAIL_MHTERM_1_14" %in% names(merged_df),
                                            merged_df$M19_ORGAN_FAIL_MHTERM_1_14, NA)

merged_df$M19_ORGAN_FAIL_MHTERM_2_14 <- ifelse("M19_ORGAN_FAIL_MHTERM_2_14" %in% names(merged_df),
                                            merged_df$M19_ORGAN_FAIL_MHTERM_2_14, NA)

merged_df$M19_ORGAN_FAIL_MHTERM_3_14 <- ifelse("M19_ORGAN_FAIL_MHTERM_3_14" %in% names(merged_df),
                                            merged_df$M19_ORGAN_FAIL_MHTERM_3_14, NA)

merged_df$M19_ORGAN_FAIL_MHTERM_4_14 <- ifelse("M19_ORGAN_FAIL_MHTERM_4_14" %in% names(merged_df),
                                            merged_df$M19_ORGAN_FAIL_MHTERM_4_14, NA)

merged_df$M19_ORGAN_FAIL_MHTERM_5_14 <- ifelse("M19_ORGAN_FAIL_MHTERM_5_14" %in% names(merged_df),
                                            merged_df$M19_ORGAN_FAIL_MHTERM_5_14, NA)

merged_df$M19_ORGAN_FAIL_MHTERM_6_14 <- ifelse("M19_ORGAN_FAIL_MHTERM_6_14" %in% names(merged_df),
                                            merged_df$M19_ORGAN_FAIL_MHTERM_6_14, NA)

merged_df$M19_ORGAN_FAIL_MHTERM_7_14 <- ifelse("M19_ORGAN_FAIL_MHTERM_7_14" %in% names(merged_df),
                                            merged_df$M19_ORGAN_FAIL_MHTERM_7_14, NA)

merged_df$M19_ORGAN_FAIL_MHTERM_88_14 <- ifelse("M19_ORGAN_FAIL_MHTERM_88_14" %in% names(merged_df),
                                            merged_df$M19_ORGAN_FAIL_MHTERM_88_14, NA)

merged_df$M19_ORGAN_FAIL_MHTERM_99_14 <- ifelse("M19_ORGAN_FAIL_MHTERM_99_14" %in% names(merged_df),
                                            merged_df$M19_ORGAN_FAIL_MHTERM_99_14, NA)

merged_df$M19_INFECTION_MHTERM_12_14 <- ifelse("M19_INFECTION_MHTERM_12_14" %in% names(merged_df),
                                            merged_df$M19_INFECTION_MHTERM_12_14, NA)

# MNH19 HOSPITALIZATION GESTATIONAL HYPTERNSION TREATMENT
merged_df$M19_HDP_HTN_MHOCCUR_4_13 <- ifelse("M19_HDP_HTN_MHOCCUR_4_13" %in% names(merged_df),
                                            merged_df$M19_HDP_HTN_MHOCCUR_4_13, NA)

merged_df$M19_HDP_HTN_MHOCCUR_5_13 <- ifelse("M19_HDP_HTN_MHOCCUR_5_13" %in% names(merged_df),
                                            merged_df$M19_HDP_HTN_MHOCCUR_5_13, NA)

merged_df$M19_HDP_HTN_MHOCCUR_6_13 <- ifelse("M19_HDP_HTN_MHOCCUR_6_13" %in% names(merged_df),
                                            merged_df$M19_HDP_HTN_MHOCCUR_6_13, NA)

merged_df$M19_HDP_HTN_MHOCCUR_7_13 <- ifelse("M19_HDP_HTN_MHOCCUR_7_13" %in% names(merged_df),
                                            merged_df$M19_HDP_HTN_MHOCCUR_7_13, NA)

merged_df$M19_HDP_HTN_MHOCCUR_8_13 <- ifelse("M19_HDP_HTN_MHOCCUR_8_13" %in% names(merged_df),
                                            merged_df$M19_HDP_HTN_MHOCCUR_8_13, NA)

merged_df$M19_HDP_HTN_MHOCCUR_9_13 <- ifelse("M19_HDP_HTN_MHOCCUR_9_13" %in% names(merged_df),
                                            merged_df$M19_HDP_HTN_MHOCCUR_9_13, NA)

merged_df$M19_HDP_HTN_MHOCCUR_10_13 <- ifelse("M19_HDP_HTN_MHOCCUR_10_13" %in% names(merged_df),
                                            merged_df$M19_HDP_HTN_MHOCCUR_10_13, NA)

merged_df$M19_HDP_HTN_MHOCCUR_88_13 <- ifelse("M19_HDP_HTN_MHOCCUR_88_13" %in% names(merged_df),
                                            merged_df$M19_HDP_HTN_MHOCCUR_88_13, NA)

toc <- Sys.time()
time_diff <- toc - tic
time_diff
```


# WOMEN WHO DELIVERED!
```{r}
merged_df <- merged_df %>%
  mutate(DELIVERED_FF = case_when((!is.na(M09_DELIV_DSSTDAT_INF1_6)) | M09_DELIV_DSSTDAT_INF1_6!="1907-07-07" |
                                  (!is.na(M09_DELIV_DSSTDAT_INF2_6)) | M09_DELIV_DSSTDAT_INF2_6!="1907-07-07" |
                                     (!is.na(M09_DELIV_DSSTDAT_INF3_6)) | M09_DELIV_DSSTDAT_INF3_6!="1907-07-07" | 
                                        (!is.na(M09_DELIV_DSSTDAT_INF4_6)) | M09_DELIV_DSSTDAT_INF4_6!="1907-07-07" ~ 1,
                                  TRUE ~ as.numeric(0)))

table(merged_df$DELIVERED_FF, merged_df$SITE, useNA = "always")
round(prop.table(table(merged_df$DELIVERED_FF, merged_df$SITE, useNA = "always"), margin=2)*100, 2)
```

# CREATE VECTOR OF ENROLLED IDs.
```{r}
merged_df <- merged_df %>% 
  mutate(ENROLL = ifelse(M02_AGE_IEORRES_1 == 1 & 
                           M02_PC_IEORRES_1 == 1 & 
                           M02_CATCHMENT_IEORRES_1 == 1 & 
                           M02_CATCH_REMAIN_IEORRES_1 == 1 & 
                           M02_CONSENT_IEORRES_1 == 1, 1, 0)) %>%
  filter(ENROLL == 1)

enrolled_ids_vec <- as.vector(merged_df$PREGID)
## if a participant is missing an enrollment form then they will be EXCLULDED from the following analyses
```


# CREATE BOE AND EDD_BOE (BOE = just at enrollment)
```{r}
merged_df <- merged_df %>%
  mutate(M01_US_OHOSTDAT_1 = ymd(M01_US_OHOSTDAT_1))

# momid <- mnh02_df %>% select(MOMID, SCRNID, PREGID, SITE)
# mnh01_constructed_df <- left_join()
mnh01_constructed_df <- mnh01_df %>%
  # only want participants who are enrolled
  filter(PREGID %in% enrolled_ids_vec) %>% 
  
  ## only want the first ultrasound visit -- take the earliest date for each participant
  # group_by(SITE, MOMID, PREGID) %>%
  # arrange(M01_US_OHOSTDAT) %>%
  # slice(1) %>%
  # filter(M01_TYPE_VISIT == 1) %>% 
  # select a subset of variables
  
  select(SITE, MOMID,PREGID, M01_US_OHOSTDAT_1,
         M01_US_GA_WKS_AGE_FTS1_1, M01_US_GA_WKS_AGE_FTS2_1,
         M01_US_GA_WKS_AGE_FTS3_1, M01_US_GA_WKS_AGE_FTS4_1,
         M01_US_GA_DAYS_AGE_FTS1_1, M01_US_GA_DAYS_AGE_FTS2_1,
         M01_US_GA_DAYS_AGE_FTS3_1, M01_US_GA_DAYS_AGE_FTS4_1,
         M01_GA_LMP_WEEKS_SCORRES_1, M01_GA_LMP_DAYS_SCORRES_1) %>%
  
  mutate(M01_US_OHOSTDAT_1 = ymd(M01_US_OHOSTDAT_1)) %>%
  
  # filter out any ultrasound visit dates that are 07-07-1907
  filter(M01_US_OHOSTDAT_1 != ymd("1907-07-07")) %>%   
  # calculate us ga in days with reported ga in wks + days. if ga is -7 or -5, replace with NA
  mutate(GA_US_DAYS_FTS1_1 =  ifelse(M01_US_GA_WKS_AGE_FTS1_1!= -7 & M01_US_GA_DAYS_AGE_FTS1_1 != -7 & M01_US_GA_WKS_AGE_FTS1_1 != -5 & M01_US_GA_DAYS_AGE_FTS1_1 != -5,  (M01_US_GA_WKS_AGE_FTS1_1 * 7 + M01_US_GA_DAYS_AGE_FTS1_1), NA), 
         GA_US_DAYS_FTS2_1 =  ifelse(M01_US_GA_WKS_AGE_FTS2_1!= -7 & M01_US_GA_DAYS_AGE_FTS2_1 != -7 & M01_US_GA_WKS_AGE_FTS2_1 != -5 & M01_US_GA_WKS_AGE_FTS2_1 != -5,  (M01_US_GA_WKS_AGE_FTS2_1 * 7 + M01_US_GA_DAYS_AGE_FTS2_1), NA),
         GA_US_DAYS_FTS3_1 =  ifelse(M01_US_GA_WKS_AGE_FTS3_1!= -7 & M01_US_GA_DAYS_AGE_FTS3_1 != -7 & M01_US_GA_WKS_AGE_FTS3_1 != -5 & M01_US_GA_WKS_AGE_FTS3_1 != -5,  (M01_US_GA_WKS_AGE_FTS3_1 * 7 + M01_US_GA_DAYS_AGE_FTS3_1), NA),
         GA_US_DAYS_FTS4_1 =  ifelse(M01_US_GA_WKS_AGE_FTS4_1!= -7 & M01_US_GA_DAYS_AGE_FTS4_1 != -7 & M01_US_GA_WKS_AGE_FTS4_1 != -5 & M01_US_GA_WKS_AGE_FTS4_1 != -5,  (M01_US_GA_WKS_AGE_FTS4_1 * 7 + M01_US_GA_DAYS_AGE_FTS4_1), NA)) %>% 
  #  pull the largest GA for multiple fetuses + convert to weeks
  mutate(US_GA_DAYS = pmax(GA_US_DAYS_FTS1_1, GA_US_DAYS_FTS2_1, GA_US_DAYS_FTS3_1, GA_US_DAYS_FTS4_1, na.rm = TRUE)) %>% ## where GA_US_DAYS_FTSx is the reported GA by ultrasound (added together M01_US_GA_WKS_AGE_FTSx and M01_US_GA_DAYS_AGE_FTSx to get a single estimate in days)
  mutate(US_GA_WKS = floor(US_GA_DAYS/7)) %>% 
  #  convert ga by LMP to days and wks
  # on US meaturement for all 4 babies. 
  # For LMP we just have info on one baby.
  mutate(LMP_GA_DAYS =  ifelse(M01_GA_LMP_WEEKS_SCORRES_1 != -7 & M01_GA_LMP_DAYS_SCORRES_1 != -7,  (M01_GA_LMP_WEEKS_SCORRES_1 * 7 + M01_GA_LMP_DAYS_SCORRES_1), NA)) %>% 
  mutate(LMP_GA_WKS = floor(LMP_GA_DAYS/7)) %>%
  ## generate indicator variable for missing US 
  mutate(MISSING_BOTH_US_LMP = ifelse((US_GA_WKS < 0 & LMP_GA_WKS < 0) | 
                                        (is.na(US_GA_WKS) & is.na(LMP_GA_WKS)), 1, 0)) %>% 
  #  calculate the difference in days between reported LMP and reported US
  mutate(GA_DIFF_DAYS = LMP_GA_DAYS-US_GA_DAYS) %>%
  #  obtain best obstetric estimate in weeks
  mutate(BOE_GA_WKS = case_when(LMP_GA_WKS %/% 7 < 9 ~
                                  if_else(abs(GA_DIFF_DAYS) <= 5,
                                          LMP_GA_WKS,
                                          US_GA_WKS),
                                LMP_GA_WKS %/% 7 < 16 ~
                                  if_else(abs(GA_DIFF_DAYS) <=7,
                                          LMP_GA_WKS, US_GA_WKS),
                                LMP_GA_WKS %/% 7 >= 16 ~
                                  if_else(abs(GA_DIFF_DAYS) <=10,
                                          LMP_GA_WKS, US_GA_WKS),
                                TRUE ~ US_GA_WKS)) %>%
  mutate(BOE_GA_DAYS = BOE_GA_WKS*7) %>%
 
   # generate indicator variable if LMP or US was used (where 1 = US and 2 = LMP)
  mutate(BOE_METHOD = ifelse(BOE_GA_WKS == US_GA_WKS, 1, 
                             ifelse(BOE_GA_WKS == LMP_GA_WKS, 2, 55))) %>%
 
   # generate EDD_BOE based on BOE 
  # "zero out" GA and obtain the estimated "date of conception" 
  mutate(EST_CONCEP_DATE = M01_US_OHOSTDAT_1 - BOE_GA_DAYS) %>% 
  # add 280 days to EST_CONCEP_DATE to generate EDD based on BOE 
  mutate(EDD_BOE = EST_CONCEP_DATE + 280)

mnh01_constructed_df2 <- mnh01_constructed_df %>%
  select(MOMID, PREGID, SITE, 
         GA_US_DAYS_FTS1_1, GA_US_DAYS_FTS2_1, GA_US_DAYS_FTS3_1, GA_US_DAYS_FTS4_1,
         US_GA_DAYS, US_GA_WKS, LMP_GA_DAYS, LMP_GA_WKS, MISSING_BOTH_US_LMP, GA_DIFF_DAYS, 
         BOE_GA_WKS, BOE_GA_DAYS, BOE_METHOD, US_GA_DAYS,
         EST_CONCEP_DATE, EDD_BOE)
```

# MERGED EST CONCEPTION DATE, EDD_BOE, BOE_GA vars here with merged_df
```{r}
merged_df <- left_join(merged_df, mnh01_constructed_df2, 
                       by = c("MOMID", "SITE", "PREGID"))
```

# GA AT ENROLLMENT
```{r}
# EXTRACT GA AT ENROLLMENT:
# CREATE MERGED FILE FIRST. 
merged_df <- merged_df %>%
  rowwise() %>%
  mutate(DIFFDAYS = as.numeric(difftime(M02_SCRN_OBSSTDAT_1, M01_US_OHOSTDAT_1, units = "days"))) %>% # EXTRACT THE DIFFERENCE IN NUM OF DAYS B/W SCREENING US AND ENROLLMENT VISIT
  # MNH02 is being used as definitive enrollment. 
  # MNH01 visit 1 is when US is done. 
  mutate(DIFFDAYS = ifelse(DIFFDAYS < 0,0,DIFFDAYS)) %>% #IF THE DIFF IS NEG, REPLACE WITH 0 (JUST USE DATE OF ULTRASOUND SCREENING)
   mutate(GA_ENROLL_WKS = floor(as.numeric((DIFFDAYS + US_GA_DAYS)/7)), #TODO Stacie had this as GA_US_DAYS_1
         GA_ENROLL_DAYS = floor(as.numeric(DIFFDAYS + US_GA_DAYS))) #TODO Stacie had this as GA_US_DAYS_1

#TODO STACIE SAID SHE USED GA_US_DAYS IN THE MONITORING REPORT AND IN MATERNAL_WIDE FILE HAS US_GA_DAYS - SAME THING

  # mutate(GA_ENROLL_WKS = floor(as.numeric((DIFFDAYS + GA_US_DAYS_1)/7)), #TODO Stacie had this as GA_US_DAYS_1
  #        GA_ENROLL_DAYS = floor(as.numeric(DIFFDAYS + GA_US_DAYS_1))) #TODO Stacie had this as GA_US_DAYS_1

```

# MNH09 to create var: DOB
```{r}
## For each participant, extract the minimum delivery time and minimum delivery date 
  
mnh09_subset_df <- mnh09_df %>% select(SITE, MOMID, PREGID, M09_INFANTS_FAORRES_6, 
                             M09_DELIV_DSSTDAT_INF1_6, M09_DELIV_DSSTDAT_INF2_6, 
                             M09_DELIV_DSSTDAT_INF3_6, M09_DELIV_DSSTDAT_INF4_6,
                             M09_DELIV_DSSTTIM_INF1_6, M09_DELIV_DSSTTIM_INF2_6, 
                             M09_DELIV_DSSTTIM_INF3_6, M09_DELIV_DSSTTIM_INF4_6)

 # replace default value date with NA 
mnh09_subset_df <- mnh09_subset_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter.
    mutate_all(function(d) {
      if_else(d=="1907-07-07", NA, d)
    })

# replace default value time with NA 
mnh09_subset_df <- mnh09_subset_df %>% 
    mutate_all(function(d) {
      if_else(d=="77:77", NA, d)
    })

mnh09_subset_df <- mnh09_subset_df %>%
  # concatenate date and time of birth 
  mutate(DELIVERY_DATETIME_INF1_6 = paste(M09_DELIV_DSSTDAT_INF1_6, M09_DELIV_DSSTTIM_INF1_6),
         DELIVERY_DATETIME_INF2_6 = paste(M09_DELIV_DSSTDAT_INF2_6, M09_DELIV_DSSTTIM_INF2_6),
         DELIVERY_DATETIME_INF3_6 = paste(M09_DELIV_DSSTDAT_INF3_6, M09_DELIV_DSSTTIM_INF3_6),
         DELIVERY_DATETIME_INF4_6 = paste(M09_DELIV_DSSTDAT_INF4_6, M09_DELIV_DSSTTIM_INF4_6)) %>% 
  # assign time field type for time of birth
  mutate(DELIVERY_DATETIME_INF1_6 = as.POSIXct(DELIVERY_DATETIME_INF1_6, format= "%Y-%m-%d %H:%M"),
         DELIVERY_DATETIME_INF2_6 = as.POSIXct(DELIVERY_DATETIME_INF2_6, format= "%Y-%m-%d %H:%M"),
         DELIVERY_DATETIME_INF3_6 = as.POSIXct(DELIVERY_DATETIME_INF3_6, format= "%Y-%m-%d %H:%M"),
         DELIVERY_DATETIME_INF4_6 = as.POSIXct(DELIVERY_DATETIME_INF4_6, format= "%Y-%m-%d %H:%M")) %>%
  # assign minimum dob and time of birth
  mutate(DOB = # fist baby gives us DOB and time. 
           pmin(DELIVERY_DATETIME_INF1_6, DELIVERY_DATETIME_INF2_6, 
                DELIVERY_DATETIME_INF3_6, DELIVERY_DATETIME_INF4_6, na.rm = TRUE)) %>% 
  select(SITE, MOMID, PREGID, DOB)

# MERGE WITH MERGED_DF
merged_df <- left_join(merged_df, mnh09_subset_df, by = c("MOMID", "PREGID", "SITE"))
```

# MNH04 
# SETTING UP ANC WINDOWS: 
# MAT_VISIT_MNH04  - is the visit complete? 
if this variables is missing and window has passed, then form is missing. 
do this for MNH08 for diabetees esp. calc M08_MAT_VISIT_FORM_COMPLETED__1.
If its NA, nothing was reported - no form there. 
Wass the visit actually completed? AT_VISIT_MNH08 - when it's 1 or 2, if she missed the visit the HCW still has to fill out the form and the response options are 3-88. 

# VISIT COMPLETE OR NOT LOOKING AT THE DATE: MAT_VISIT_MNHxx
# ANC 4 NOT FILLED OUT AT BIRTH (VISIT 6)
```{r}
# From M04_MAT_VISIT_MNH04_1 create: M04_MAT_VISIT_FORM_COMPLETED_= Was the visit completed.  If it was filled out by staff, then yes. otherwise no. 
# From M04_MAT_VISIT_MNH04_1 create: M04_MAT_VISIT_wPERSON_COMPLETED_1 = if the form is filled out by staff, was the visit in person or by phone, if yes, then 1, otherwise woman didn't show or died etc. 
mnh04_constructed_df <- mnh04_df %>% 
  # VISIT 1
  mutate(M04_MAT_VISIT_FORM_COMPLETED_1 = case_when(!is.na(M04_MAT_VISIT_MNH04_1) ~ 1, 
                                                    TRUE ~ 0),
         M04_MAT_VISIT_wPERSON_COMPLETED_1 = case_when(M04_MAT_VISIT_MNH04_1 %in% c(1,2) ~ 1,  
                                                       TRUE ~ 0),
         # VISIT 2
         M04_MAT_VISIT_FORM_COMPLETED_2 = case_when(!is.na(M04_MAT_VISIT_MNH04_2) ~ 1, 
                                                    TRUE ~ 0),
         M04_MAT_VISIT_wPERSON_COMPLETED_2 = case_when(M04_MAT_VISIT_MNH04_2 %in% c(1,2) ~ 1, 
                                                       TRUE ~ 0),
         # VISIT 3
         M04_MAT_VISIT_FORM_COMPLETED_3 = case_when(!is.na(M04_MAT_VISIT_MNH04_3) ~ 1, 
                                                    TRUE ~ 0),
         M04_MAT_VISIT_wPERSON_COMPLETED_3 = case_when(M04_MAT_VISIT_MNH04_3 %in% c(1,2) ~ 1, 
                                                       TRUE ~ 0),
         # VISIT 4
         M04_MAT_VISIT_FORM_COMPLETED_4 = case_when(!is.na(M04_MAT_VISIT_MNH04_4) ~ 1, 
                                                    TRUE ~ 0),
         M04_MAT_VISIT_wPERSON_COMPLETED_4 = case_when(M04_MAT_VISIT_MNH04_4 %in% c(1,2) ~ 1, 
                                                       TRUE ~ 0),
         # VISIT 5
         M04_MAT_VISIT_FORM_COMPLETED_5 = case_when(!is.na(M04_MAT_VISIT_MNH04_5) ~ 1, 
                                                    TRUE ~ 0),
         M04_MAT_VISIT_wPERSON_COMPLETED_5 = case_when(M04_MAT_VISIT_MNH04_5 %in% c(1,2) ~ 1, 
                                                       TRUE ~ 0),
          # VISIT 13 Hosp
         M04_MAT_VISIT_FORM_COMPLETED_13 = case_when(!is.na(M04_MAT_VISIT_MNH04_13) ~ 1, 
                                                    TRUE ~ 0),
         M04_MAT_VISIT_wPERSON_COMPLETED_13 = case_when(M04_MAT_VISIT_MNH04_13 %in% c(1,2) ~ 1, 
                                                       TRUE ~ 0))
  
  mnh04_constructed_df2 <- mnh04_constructed_df %>%
    select(MOMID, PREGID, SITE, starts_with(c("M04_MAT_VISIT_FORM_COMPLETED_", "M04_MAT_VISIT_wPERSON_COMPLETED_")))
```

# SETTING UP: IS MNH08 VISIT COMPLETE? 
# MNH08 IS OPTIONAL AT VISIT 8 (SO SOME PLACES WILL HAVE, SOME WONT.) - NOT INCLUDING HERE ATM.
```{r}
mnh08_constructed_df <- mnh08_df %>% 
  # VISIT 1
  mutate(M08_MAT_VISIT_FORM_COMPLETED_1 = case_when(!is.na(M08_MAT_VISIT_MNH08_1) ~ 1, # M08_MAT_VISIT_MNH08_1 is always 1,2, 3 etc number or NA
                                                    TRUE ~ 0),
         M08_MAT_VISIT_wPERSON_COMPLETED_1 = case_when(M08_MAT_VISIT_MNH08_1 %in% c(1,2) ~ 1, 
                                                       TRUE ~ 0),
         # VISIT 2
         M08_MAT_VISIT_FORM_COMPLETED_2 = case_when(!is.na(M08_MAT_VISIT_MNH08_2) ~ 1, 
                                                    TRUE ~ 0),
         M08_MAT_VISIT_wPERSON_COMPLETED_2 = case_when(M08_MAT_VISIT_MNH08_2 %in% c(1,2) ~ 1, 
                                                       TRUE ~ 0),
         # VISIT 3
         M08_MAT_VISIT_FORM_COMPLETED_3 = case_when(!is.na(M08_MAT_VISIT_MNH08_3) ~ 1, 
                                                    TRUE ~ 0),
         M08_MAT_VISIT_wPERSON_COMPLETED_3 = case_when(M08_MAT_VISIT_MNH08_3 %in% c(1,2) ~ 1, 
                                                       TRUE ~ 0),
         # VISIT 4
         M08_MAT_VISIT_FORM_COMPLETED_4 = case_when(!is.na(M08_MAT_VISIT_MNH08_4) ~ 1, 
                                                    TRUE ~ 0),
         M08_MAT_VISIT_wPERSON_COMPLETED_4 = case_when(M08_MAT_VISIT_MNH08_4 %in% c(1,2) ~ 1, 
                                                       TRUE ~ 0),
         # VISIT 5
         M08_MAT_VISIT_FORM_COMPLETED_5 = case_when(!is.na(M08_MAT_VISIT_MNH08_5) ~ 1, 
                                                    TRUE ~ 0),
         M08_MAT_VISIT_wPERSON_COMPLETED_5 = case_when(M08_MAT_VISIT_MNH08_5 %in% c(1,2) ~ 1, 
                                                       TRUE ~ 0))
          # VISIT 13 Hosp
        # M08_MAT_VISIT_FORM_COMPLETED_13 = case_when(!is.na(M08_MAT_VISIT_MNH08_13) ~ 1, 
         #                                           TRUE ~ 0),
        # M08_MAT_VISIT_wPERSON_COMPLETED_13 = case_when(M08_MAT_VISIT_MNH08_13 %in% c(1,2) ~ 1, 
         #                                              TRUE ~ 0))

  test.df <- mnh08_constructed_df %>%
    select(MOMID, PREGID, SITE, M08_MAT_VISIT_MNH08_1, M08_MAT_VISIT_FORM_COMPLETED_1)
  
  # NEED THIS CONSTRUCTED_DF2 TO BE MERGED NEXT:
  mnh08_constructed_df2 <- mnh08_constructed_df %>%
    select(MOMID, PREGID, SITE, starts_with(c( "M08_MAT_VISIT_FORM_COMPLETED_", "M08_MAT_VISIT_wPERSON_COMPLETED_")))
```

# COMBINE MNH04_CONSTRUCTED AND MNH08_CONSTRUCTED WITH MNH01_CONSTRUCTED
```{r}
merged_df <- left_join(merged_df, mnh04_constructed_df2,
                                          by = c("MOMID", "PREGID", "SITE"))

merged_df <- left_join(merged_df, mnh08_constructed_df2,
                                        by = c("MOMID", "PREGID", "SITE"))
```

```{r}
# USE UPLOAD DATE

merged_df <- merged_df %>%
  # EDD BY BOE
  ## CALCULATE ON TIME AND LATE ANC WINDOWS 
  mutate(ENROLL_ONTIME = (EDD_BOE - as.difftime(280, unit="days")) + as.difftime(139, unit="days"), #EDD-280 = conception date + and then estimate the right hand of the window. Gives a date
         ENROLL_LATE = (EDD_BOE - as.difftime(280, unit="days")) + as.difftime(139, unit="days"), # doesn't have a late window.
         ANC20_ONTIME = (EDD_BOE - as.difftime(280, unit="days")) + as.difftime(160, unit="days"), 
         ANC20_LATE = (EDD_BOE - as.difftime(280, unit="days")) + as.difftime(181, unit="days"),
         ANC28_ONTIME = (EDD_BOE - as.difftime(280, unit="days")) + as.difftime(216, unit="days"), # if miss this ANC 28 on time window, you miss the visit, there is no late window
         ANC28_LATE = (EDD_BOE - as.difftime(280, unit="days")) + as.difftime(216, unit="days"), 
         ANC32_ONTIME = (EDD_BOE - as.difftime(280, unit="days")) + as.difftime(237, unit="days"), 
         ANC32_LATE = (EDD_BOE - as.difftime(280, unit="days")) + as.difftime(244, unit="days"), ## will need to ask about this
         ANC36_ONTIME = (EDD_BOE - as.difftime(280, unit="days")) + as.difftime(272, unit="days"), 
         ANC36_LATE = (EDD_BOE - as.difftime(280, unit="days")) + as.difftime(300, unit="days")) %>% 
  
  #####################
#TODO FIX NEEDS TO FIXED. 
# QUESTION FOR STACIE: WHY DID SHE USE ONTIME WINDOWS TO CALC OVERDUE AND NOT LATE WINDOWS. 


  ## CALCULATE INDICATOR VARIABLES for missed ANC visits ON-TIME WINDOWS
  ## max date has to be less than the upload date
  mutate(M04_ENROLL_OVERDUE = ifelse(UploadDate>ENROLL_ONTIME & (M04_MAT_VISIT_FORM_COMPLETED_1==0), 1, 0),
         M08_ENROLL_OVERDUE = ifelse(UploadDate>ENROLL_ONTIME & (M08_MAT_VISIT_FORM_COMPLETED_1==0), 1, 0),#TODO DO THIS FOR MNH08
         
          # if this window ANC20 is passed, then this var would be NA b/c they don't have to have ANC20 visit. 
         M04_ANC20_OVERDUE = ifelse(UploadDate>ANC20_ONTIME & (M04_MAT_VISIT_FORM_COMPLETED_2==0) & GA_ENROLL_WKS <= 17, 1, 0), # GA_ENROLL_WKS is in weeks. 
         M08_ANC20_OVERDUE = ifelse(UploadDate>ANC20_ONTIME & (M08_MAT_VISIT_FORM_COMPLETED_2==0) & GA_ENROLL_WKS <= 17, 1, 0),
         
         M04_ANC28_OVERDUE = ifelse(UploadDate>ANC28_ONTIME & (M04_MAT_VISIT_FORM_COMPLETED_3==0), 1, 0), #IF 1 this will mean she is missing the form.
         M08_ANC28_OVERDUE = ifelse(UploadDate>ANC28_ONTIME & (M08_MAT_VISIT_FORM_COMPLETED_3==0), 1, 0),
         
         M04_ANC32_OVERDUE = ifelse(UploadDate>ANC32_ONTIME & (M04_MAT_VISIT_FORM_COMPLETED_4==0), 1, 0),
         M08_ANC32_OVERDUE = ifelse(UploadDate>ANC32_ONTIME & (M08_MAT_VISIT_FORM_COMPLETED_4==0), 1, 0),
         
         M04_ANC36_OVERDUE = ifelse(UploadDate>ANC36_ONTIME & (M04_MAT_VISIT_FORM_COMPLETED_5==0), 1, 0),
         M08_ANC36_OVERDUE = ifelse(UploadDate>ANC36_ONTIME & (M08_MAT_VISIT_FORM_COMPLETED_5==0), 1, 0)) %>% 
  
  ## CALCULATE INDICATOR VARIABLES for passed ON-TIME ANC WINDOWS - same as overdue code, but exclude the visit completion piece
  ## using upload date
  mutate(ENROLL_PASS = ifelse(ENROLL_ONTIME<UploadDate, 1, 0), # WINDOW HAS PASSED. IF YOUR ENROLL WINDOW END IS JAN 1ST, BUT UPLOAD JAN 5TH. THEN YOU'RE LATE MEANING ON TIME WINDOW IS PASSED. 
         ANC20_PASS = ifelse(ANC20_ONTIME<UploadDate & GA_ENROLL_WKS <= 17, 1, 0), #IF A WINDOW IS PASSED AND HER GA AT ENROLLEMENT WAS <17 WEEKS, SHE DOES GET AN ANC 20. IF SHE'S >18 THEN HER ANC20 FORMS WILL BE NA B/C SHE'S NOT SUPPOSED TO HAVE IT.
         ANC28_PASS = ifelse(ANC28_ONTIME<UploadDate, 1, 0),
         ANC32_PASS = ifelse(ANC32_ONTIME<UploadDate, 1, 0),
         ANC36_PASS = ifelse(ANC36_ONTIME<UploadDate, 1, 0)) %>% 
  ## CALCULATE INDICATOR VARIABLES for missed PASSED LATE WINDOWS
  mutate(ENROLL_PASS_LATE = ifelse(ENROLL_LATE<UploadDate, 1, 0),
         ANC20_PASS_LATE = ifelse(ANC20_LATE<UploadDate & GA_ENROLL_WKS <= 17, 1, 0),
         ANC28_PASS_LATE = ifelse(ANC28_LATE<UploadDate, 1, 0),
         ANC32_PASS_LATE = ifelse(ANC32_LATE<UploadDate, 1, 0),
         ANC36_PASS_LATE = ifelse(ANC36_LATE<UploadDate, 1, 0)) 
```

# VISIT date from the form, estimated conception date (visit date - estimated conception date = this is estimated GA at that visit in days or weeks)
# CALC. GA AT VISIT.
```{r}
# XX_GA_AT_VISIT_X can have NAs
merged_df <- merged_df %>%
  mutate(M04_GA_AT_VISIT_1 = as.Date(M04_ANC_OBSSTDAT_1) - EST_CONCEP_DATE, #DATE OF VISIT - CONCEPTION DATE = GA AT VISIT. 
         M04_GA_AT_VISIT_2 = as.Date(M04_ANC_OBSSTDAT_2) - EST_CONCEP_DATE,
         M04_GA_AT_VISIT_3 = as.Date(M04_ANC_OBSSTDAT_3) - EST_CONCEP_DATE,
         M04_GA_AT_VISIT_4 = as.Date(M04_ANC_OBSSTDAT_4) - EST_CONCEP_DATE,
         M04_GA_AT_VISIT_5 = as.Date(M04_ANC_OBSSTDAT_5) - EST_CONCEP_DATE) 

merged_df <- merged_df %>%
  mutate(M08_GA_AT_VISIT_1 = as.Date(M08_LBSTDAT_1) - EST_CONCEP_DATE,
         M08_GA_AT_VISIT_2 = as.Date(M08_LBSTDAT_2) - EST_CONCEP_DATE,
         M08_GA_AT_VISIT_3 = as.Date(M08_LBSTDAT_3) - EST_CONCEP_DATE,
         M08_GA_AT_VISIT_4 = as.Date(M08_LBSTDAT_4) - EST_CONCEP_DATE,
         M08_GA_AT_VISIT_5 = as.Date(M08_LBSTDAT_5) - EST_CONCEP_DATE)

temp.df <- merged_df %>%
  select(MOMID, SITE, M04_GA_AT_VISIT_1, M04_ANC_OBSSTDAT_1, 
         EST_CONCEP_DATE, M01_US_OHOSTDAT_1, BOE_GA_DAYS)  %>% filter(SITE=="Pakistan")
# VISIT 6 CALCULATION IS DONE BELOW (GA AT DELIVERY VISIT)
```

# GA AT DELIVERY VISIT
```{r}
# NEED JUST DATE FROM DOB DATETIME VARIABLE FOR CREATING GA AT DELIVERY:
merged_df <- merged_df %>% 
  mutate(DOB_DATEONLY = as.Date(DOB))

# GA AT DELIVERY: DOB - CONCEPTION DATE. SEP THE DOB FIRST. TIME BECOMES IMPORTANT FOR PNC VISITS LATER.
merged_df <- merged_df %>%
  mutate(GA_AT_DELIV_6 = DOB_DATEONLY - EST_CONCEP_DATE)
```


# WINDOW SUBSET
```{r}
window_subset_df <- merged_df %>% 
  select(MOMID, PREGID, SITE, DELIVERED_FF, BOE_GA_WKS, BOE_GA_DAYS, EST_CONCEP_DATE,
         EDD_BOE, GA_ENROLL_WKS, GA_ENROLL_DAYS, DOB, DOB_DATEONLY, 
         
         starts_with(c("M04_MAT_VISIT_FORM_", "M04_MAT_VISIT_wPERSON_",
                       "M06_MAT_VISIT_FORM_", "M06_MAT_VISIT_wPERSON_",
                       "M08_MAT_VISIT_FORM_", "M08_MAT_VISIT_wPERSON_")),
         
         ENROLL_ONTIME, ENROLL_LATE, 
         ANC20_ONTIME, ANC20_LATE,
         ANC28_ONTIME, ANC28_LATE,
         ANC32_ONTIME, ANC28_LATE,
         ANC36_ONTIME, ANC36_LATE,
         
         M04_ENROLL_OVERDUE, M04_ANC20_OVERDUE, M04_ANC28_OVERDUE,
         M04_ANC32_OVERDUE, M04_ANC36_OVERDUE,
         
         M08_ENROLL_OVERDUE, M08_ANC20_OVERDUE, M08_ANC28_OVERDUE,
         M08_ANC32_OVERDUE, M08_ANC36_OVERDUE,
         
         M08_MAT_VISIT_MNH08_1, M08_MAT_VISIT_MNH08_2, M08_MAT_VISIT_MNH08_3,
         
         ENROLL_PASS, ANC20_PASS, ANC28_PASS, ANC32_PASS, ANC36_PASS,
         
         ENROLL_PASS_LATE, ANC20_PASS_LATE, ANC28_PASS_LATE, ANC32_PASS_LATE, ANC36_PASS_LATE,
         
          
         
         # GA AT VISIT:
         M04_GA_AT_VISIT_1, M04_GA_AT_VISIT_2, M04_GA_AT_VISIT_3, M04_GA_AT_VISIT_4, M04_GA_AT_VISIT_5,
         M08_GA_AT_VISIT_1,  M08_GA_AT_VISIT_2,  M08_GA_AT_VISIT_3,  M08_GA_AT_VISIT_4,  M08_GA_AT_VISIT_5,
         GA_AT_DELIV_6,# JUST NEED ONE B/C M08 IS OPTIONAL AT DELIVERY
         M04_GA_ENROLL_LT18) # This is an indicator for when GA at enroll is <=17 or not.

write.csv(window_subset_df, '../data_out/window_subset_df.csv')
```

#################################################
# WRITE OUT A CSV FILE FOR DIABETES/GDM ANALYSIS
#################################################
```{r}
diabetes_df <- merged_df %>%
  select(MOMID, PREGID, SITE, DELIVERED_FF, M08_LBSTDAT_1, M08_LBSTDAT_3,
        M04_DIABETES_EVER_MHOCCUR_3, M04_DIABETES_EVER_MHOCCUR_4, M04_DIABETES_EVER_MHOCCUR_5,
        M09_GEST_DIAB_MHOCCUR_6, M09_INDUCED_PROCCUR_6, M09_INDUCED_PRINDC_6,
        M19_PRIMARY_MHTERM_13, M19_LD_COMPL_MHTERM_3_13,
        #MEASURED VARS:
        M08_HBA1C_PRCNT_1,
        M08_BGLUC_PRETEST_MMOLL_LBORRES_3, 
        M08_BGLUC_ORAL_1HR_MMOLL_LBORRES_3, M08_BGLUC_ORAL_2HR_MMOLL_LBORRES_3 )

write.csv(diabetes_df, '../data_out/mat_diabetes_vars.csv')
```

#####################################
#### WRITE OUT CSV FILE  FOR HDP
####################################
```{r}
htn_df <- merged_df %>% 
  select(MOMID, PREGID, SITE, DELIVERED_FF, M06_HB_POC_LBORRES_4, M08_CBC_HB_LBORRES_4,
         M04_ANC_OBSSTDAT_1, # Date ANC1 from MNH04
         M04_HTN_EVER_MHOCCUR_1, M04_HTN_MHSTDAT_1, # CHRONIC HYPERTENSION
         M04_HPD_MHTERM_1, M04_HPD_MHTERM_2, M04_HPD_MHTERM_3,# Chronic hypertension or gHTN or PE or Don't know. 
         M04_HPD_MHTERM_4, M04_HPD_MHTERM_5, M04_HPD_MHTERM_13,
         starts_with(c("M04_HPD_OECTRT_")),
         starts_with(c("M04_HPD_MHTERM_")),
         #Delivery form has _1-3, _77, _99 that I need to keep b/c it is a "No HDP diagnosis" and "No treatment received"
         M09_HDP_HTN_MHOCCUR_1_6, M09_HDP_HTN_MHOCCUR_2_6, 
         M09_HDP_HTN_MHOCCUR_3_6, M09_HDP_HTN_MHOCCUR_77_6, M09_HDP_HTN_MHOCCUR_99_6,
         # variables for HDP medication during Delivery:
         starts_with(c("M09_HDP_HTN_PROCCUR_")), 
         # BP:
         M19_BP_SYS_VSORRES_13, M19_BP_DIA_VSORRES_13, M19_BP_SYS_VSORRES_14, M19_BP_DIA_VSORRES_14,
         # Other labs
         M08_CBC_HB_LBORRES_4, M06_HB_POC_LBORRES_4, 
         M08_IBILIRUBIN_LBORRES_4, M08_AST_UL_LBORRES_4, M08_ALT_UL_LBORRES_4,
         M08_CBC_PLATE_LBORRES_4, M08_CREAT_UMOLL_LBORRES_4,
         # Hospitalization HELLP:
         M19_OBSSTDAT_13, # DATE OF HOSP.
         M19_CBC_HB_LBORRES_13, M19_CBC_PLATELET_LBORRES_13,
         M19_AST_UL_LBORRES_13, 
         M19_ALT_UL_LBORRES_13,M19_ALT_UKATL_LBORRESU_13, 
         M19_CREAT_LBORRESU_13,
         M19_UA_PROT_LBORRES_13,
         # OTHER VARS
         starts_with(c("M06_BP_SYS_VSORRES_", "M06_BP_DIA_VSORRES_", "M04_HTN_CMTRT_", 
                       "M04_HPD_OECTRT_", 
                      # ANC HOSP _13
                      "M19_HDP_HTN_MHOCCUR_", # was mother diagnosed
                       "M19_HPD_HTN_CMOCCUR_", # did mother receive medication
                       # PROTEINURIA
                       "M08_UA_PROT_LBORRES",
                       "M08_LBSTDAT_")))  # M08_LBSTDAT_ GIVES DATE OF THE VISIT

write.csv(htn_df, '../data_out/mat_htn.csv')

```

