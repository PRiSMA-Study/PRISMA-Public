---
title: "Mat_gHTN_analysis"
author: "Fouzia Farooq"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---


   
# NOTE: #TODO Will have to recreate this variable using gestational age at some point (b/c women who are at GA 18 or 19 can still come in for ANC20 visit (VISIT 2) so to truly count this as 20week GA at least for gHTN - I need to look at GA (10/02/2023)

# LOOK AT TWO TIME POINTS FOR cHTN - ONE HIGH BP IS NOT ENOUGH.

# Use variable: HPD_MHOCCUR for CHTN Clinical Diagnosis.
# Move chronic hyperteniosn - 1 Measurement + On treatment:
# ---Move those who have No treatment into No category in those who are missing.
# >100% missing in one of the missing vars

for HTN here's what I should do: 
If_else GA at enroll >18 or 19 use enrollment visit form only
If GA <=17 weeks, she should have an ANC20 form. use ANC20 visit.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE}
library(readxl)
library(dplyr)
library(ggplot2)
library(knitr)
library(stringr)
# library(ThemePark)
library(purrr)
library(lubridate)
library(readr)
library(tidyr)
library(haven)
library(tableone)
library(kableExtra)
```

```{r}
merged_df <- readRDS('../data_out/merged_df.RDS')
htn_df <- read.csv('../data_out/mat_htn.csv')
window_subset_df <- read.csv('../data_out/window_subset_df.csv')
htn_df <- htn_df %>% filter(DELIVERED_FF==1)
```

# MERGE IN THE TWO SUBSETS
```{r}
htn_df <- left_join(htn_df, window_subset_df, 
                         by = c("MOMID", "PREGID", "SITE"))
```

# Convert "1907-07-07" to NA:
# CATEGORICAL: 
# ---- 77, Not applicable 
# ---- 55, Missing 
# ---- 66, Refused to answer
# ---- 99, Don't know

# CONTINUOUS:
# ---- -7, Not applicable 
# ---- -5, Missing 
# ---- -6, Refused to answer
# ---- -9, Don't know
# DATE: 
# ---- 07-07-1907, Not applicable 
# ---- 05-05-1905, Missing 
# ---- 06-06-1906, Refused to answer
# ---- 09-09-1909, Don't know

# TIME: 
# ---- 77:77, Not applicable 
# ---- 55:55, Missing 
# ---- 66:66, Refused to answer
# ---- 99:99, Don't know
```{r echo=FALSE}
CONVERT_NA <- TRUE
if(CONVERT_NA ==TRUE){
  tic <- Sys.time()
  htn_df <- htn_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter.
    mutate_all(function(d) {
      if_else(d=="1907-07-07", NA, d)
    })
  
    htn_df <- htn_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter.
    mutate_all(function(d) {
      if_else(d=="1905-05-05", NA, d)
    })
  
  htn_df <- htn_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter.
    mutate_all(function(d) {
      if_else(d==-7, NA, d)
    })
  
  htn_df <- htn_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter.
    mutate_all(function(d) {
      if_else(d==77, NA, d)
    })
  
  # -5 IS MISSING FOR CONTINUOUS
  htn_df <- htn_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
    mutate_all(function(d) {
      if_else(d==-5, NA, d) 
    })
  
  # 55 IS MISSING FOR CATEGORICAL
  htn_df <- htn_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
    mutate_all(function(d) {
      if_else(d==55, NA, d) 
    })
  
  # 55:55 IS MISSING FOR TIME
  htn_df <- htn_df %>% #b/c I am passing in the entire dataframe, I don't need to specify the first parameter. 
    mutate_all(function(d) {
      if_else(d=='55:55', NA, d)
    })
  
  toc <- Sys.time()
}
time_diff <- toc-tic
time_diff
```
# INVESTIGATING MISSINGNESS
```{r}
temp.df <- htn_df %>%
  select(MOMID, SITE, DELIVERED_FF.x, M08_MAT_VISIT_MNH08_1, M08_MAT_VISIT_FORM_COMPLETED_1, ENROLL_PASS)

missing_mnh08_df <- htn_df %>%
  select(MOMID, SITE, DELIVERED_FF.x, M08_MAT_VISIT_MNH08_1, M08_MAT_VISIT_FORM_COMPLETED_1, ENROLL_PASS,
         M08_MAT_VISIT_MNH08_3, M08_MAT_VISIT_FORM_COMPLETED_3, ANC32_PASS)

temp.df %>% summarize(n())
write.csv(missing_mnh08_df, '../data_out/missing_mnh08_df_delivered_20231017.csv')
```

```{r}
  #SETTING UP VISIT 4 - ANC32.
# 3RD TRIMESTER
htn_df <- htn_df %>% 
  mutate(MAT_ANEMIA_MEAS4 = ifelse((!is.na(M08_CBC_HB_LBORRES_4) & between(M08_CBC_HB_LBORRES_4, 10, 10.99)), "mild",
                                    ifelse((!is.na(M08_CBC_HB_LBORRES_4) & between(M08_CBC_HB_LBORRES_4, 7.0, 9.99)), "moderate",
                                            ifelse((!is.na(M08_CBC_HB_LBORRES_4) & between(M08_CBC_HB_LBORRES_4, 0.0, 6.99)), "severe",
                                                    ifelse((!is.na(M08_CBC_HB_LBORRES_4) & between(M08_CBC_HB_LBORRES_4, 13.1, 14.99)), "high hb 13-<15g/dl",  
                                                           ifelse((!is.na(M08_CBC_HB_LBORRES_4) & M08_CBC_HB_LBORRES_4 > 14.99), "high hb >=15g/dl",
                                                                  ifelse((!is.na(M08_CBC_HB_LBORRES_4) & between(M08_CBC_HB_LBORRES_4, 11, 13.0)), "normal",
                                                                         
                                                                          ifelse((!is.na(M06_HB_POC_LBORRES_4) & between(M06_HB_POC_LBORRES_4, 10, 10.99)), "mild",
                                                                                 ifelse((!is.na(M06_HB_POC_LBORRES_4) & between(M06_HB_POC_LBORRES_4, 7.0, 9.99)), "moderate",
                                                                                        ifelse((!is.na(M06_HB_POC_LBORRES_4) & between(M06_HB_POC_LBORRES_4, 0.0, 6.99)), "severe",
                                                                                               ifelse((!is.na(M06_HB_POC_LBORRES_4) & between(M06_HB_POC_LBORRES_4, 13.1, 14.99)), "high hb 13-<15g/dl",
                                                                                                      ifelse((!is.na(M06_HB_POC_LBORRES_4) & M06_HB_POC_LBORRES_4 > 14.99), "high hb >=15g/dl",
                                                                                                             ifelse((!is.na(M06_HB_POC_LBORRES_4) & between(M06_HB_POC_LBORRES_4, 11, 13.0)), "normal",
                                                                                                                    as.character(NA)))))))))))))) 

temp.df <- htn_df %>% 
  select(MOMID, SITE, MAT_ANEMIA_MEAS4, M08_CBC_HB_LBORRES_4, M06_HB_POC_LBORRES_4)
  

table(htn_df$MAT_ANEMIA_MEAS4, useNA = "always", htn_df$SITE)

```

# MEAN BLOOD PRESSURE MEASUREMENTS
```{r}
temp.df <- htn_df %>% 
  select(MOMID, PREGID, SITE,
         M19_BP_SYS_VSORRES_13, M19_BP_DIA_VSORRES_13,
         starts_with(c("M06_BP_SYS_VSORRES_", "M06_BP_DIA_VSORRES_", "M04_HTN_CMTRT_"))) 


# <20 weeks (ENROLLMENT)
htn_df <- htn_df %>% 
  rowwise() %>% 
  mutate(meanSBP_ANC_LT20 = mean(c(M06_BP_SYS_VSORRES_1_1, M06_BP_SYS_VSORRES_2_1, M06_BP_SYS_VSORRES_3_1), na.rm = TRUE), # ANC
         meanDBP_ANC_LT20 = mean(c(M06_BP_DIA_VSORRES_1_1, M06_BP_DIA_VSORRES_2_1, M06_BP_DIA_VSORRES_3_1), na.rm = TRUE)) # ANC

temp.df <- htn_df %>% select(MOMID, SITE, M06_BP_SYS_VSORRES_1_1, M06_BP_SYS_VSORRES_2_1, M06_BP_SYS_VSORRES_3_1,
                             M06_BP_DIA_VSORRES_1_1, M06_BP_DIA_VSORRES_2_1, M06_BP_DIA_VSORRES_3_1)

# OTHER VISITS
htn_df <- htn_df %>% 
  rowwise() %>% 
  mutate(meanSBP_ANC20 = mean(c(M06_BP_SYS_VSORRES_1_2, M06_BP_SYS_VSORRES_2_2, M06_BP_SYS_VSORRES_3_2), na.rm = TRUE), # ANC
         meanDBP_ANC20 = mean(c(M06_BP_DIA_VSORRES_1_2, M06_BP_DIA_VSORRES_2_2, M06_BP_DIA_VSORRES_3_2), na.rm = TRUE), # ANC 
         
         meanSBP_ANC28 = mean(c(M06_BP_SYS_VSORRES_1_3, M06_BP_SYS_VSORRES_2_3, M06_BP_SYS_VSORRES_3_3), na.rm = TRUE), # ANC
         meanDBP_ANC28 = mean(c(M06_BP_DIA_VSORRES_1_3, M06_BP_DIA_VSORRES_2_3, M06_BP_DIA_VSORRES_3_3), na.rm = TRUE), # ANC
         
         meanSBP_ANC32 = mean(c(M06_BP_SYS_VSORRES_1_4, M06_BP_SYS_VSORRES_2_4, M06_BP_SYS_VSORRES_3_4), na.rm = TRUE), # ANC
         meanDBP_ANC32 = mean(c(M06_BP_DIA_VSORRES_1_4, M06_BP_DIA_VSORRES_2_4, M06_BP_DIA_VSORRES_3_4), na.rm = TRUE), # ANC
         
         meanSBP_ANC36 = mean(c(M06_BP_SYS_VSORRES_1_5, M06_BP_SYS_VSORRES_2_5, M06_BP_SYS_VSORRES_3_5), na.rm = TRUE), # ANC
         meanDBP_ANC36 = mean(c(M06_BP_DIA_VSORRES_1_5, M06_BP_DIA_VSORRES_2_5, M06_BP_DIA_VSORRES_3_5), na.rm = TRUE), # ANC
         
         meanSBP_IPC = mean(c(M06_BP_SYS_VSORRES_1_6, M06_BP_SYS_VSORRES_2_6, M06_BP_SYS_VSORRES_3_6), na.rm = TRUE), # L&D
         meanDBP_IPC = mean(c(M06_BP_DIA_VSORRES_1_6, M06_BP_DIA_VSORRES_2_6, M06_BP_DIA_VSORRES_3_6), na.rm = TRUE), # L&D
         
         meanSBP_Hosp_ANC = M19_BP_SYS_VSORRES_13, # ANC HOSPITALIZATION
         meanDBP_Hosp_ANC = M19_BP_DIA_VSORRES_13, # ANC HOSPITALIZATION
         
         meanSBP_PNC0 = mean(c(M06_BP_SYS_VSORRES_1_7, M06_BP_SYS_VSORRES_2_7, M06_BP_SYS_VSORRES_3_7), na.rm = TRUE), # PNC
         meanDBP_PNC0 = mean(c(M06_BP_DIA_VSORRES_1_7, M06_BP_DIA_VSORRES_2_7, M06_BP_DIA_VSORRES_3_7), na.rm = TRUE), # PNC
         
         meanSBP_PNC1 = mean(c(M06_BP_SYS_VSORRES_1_8, M06_BP_SYS_VSORRES_2_8, M06_BP_SYS_VSORRES_3_8), na.rm = TRUE), # PNC
         meanDBP_PNC1 = mean(c(M06_BP_DIA_VSORRES_1_8, M06_BP_DIA_VSORRES_2_8, M06_BP_DIA_VSORRES_3_8), na.rm = TRUE), # PNC
         
         meanSBP_PNC4 = mean(c(M06_BP_SYS_VSORRES_1_9, M06_BP_SYS_VSORRES_2_9, M06_BP_SYS_VSORRES_3_9), na.rm = TRUE), # PNC
         meanDBP_PNC4 = mean(c(M06_BP_DIA_VSORRES_1_9, M06_BP_DIA_VSORRES_2_9, M06_BP_DIA_VSORRES_3_9), na.rm = TRUE), # PNC
         
         meanSBP_PNC6 = mean(c(M06_BP_SYS_VSORRES_1_10, M06_BP_SYS_VSORRES_2_10, M06_BP_SYS_VSORRES_3_10), na.rm = TRUE), # PNC
         meanDBP_PNC6 = mean(c(M06_BP_DIA_VSORRES_1_10, M06_BP_DIA_VSORRES_2_10, M06_BP_DIA_VSORRES_3_10), na.rm = TRUE), # PNC
         
         meanSBP_PNC26 = mean(c(M06_BP_SYS_VSORRES_1_11, M06_BP_SYS_VSORRES_2_11, M06_BP_SYS_VSORRES_3_11), na.rm = TRUE), # PNC
         meanDBP_PNC26 = mean(c(M06_BP_DIA_VSORRES_1_11, M06_BP_DIA_VSORRES_2_11, M06_BP_DIA_VSORRES_3_11), na.rm = TRUE), # PNC
         
         meanSBP_PNC52 = mean(c(M06_BP_SYS_VSORRES_1_12, M06_BP_SYS_VSORRES_2_12, M06_BP_SYS_VSORRES_3_12), na.rm = TRUE), # PNC
         meanDBP_PNC52 = mean(c(M06_BP_DIA_VSORRES_1_12, M06_BP_DIA_VSORRES_2_12, M06_BP_DIA_VSORRES_3_12), na.rm = TRUE), # PNC
         
         meanSBP_Hosp_PNC = M19_BP_SYS_VSORRES_14, # ANC HOSPITALIZATION
         meanDBP_Hosp_PNC = M19_BP_DIA_VSORRES_14) # ANC HOSPITALIZATION

temp.df <- htn_df %>% select(MOMID, SITE,  M06_BP_SYS_VSORRES_1_2, M06_BP_SYS_VSORRES_2_2, M06_BP_SYS_VSORRES_3_2,
                             M06_BP_DIA_VSORRES_1_2, M06_BP_DIA_VSORRES_2_2, M06_BP_DIA_VSORRES_3_2, meanSBP_ANC20, meanDBP_ANC20)

temp.df <- htn_df %>% select(MOMID, SITE,  M06_BP_SYS_VSORRES_1_1, M06_BP_SYS_VSORRES_2_1, M06_BP_SYS_VSORRES_3_1,
                             M06_BP_DIA_VSORRES_1_1, M06_BP_DIA_VSORRES_2_1, M06_BP_DIA_VSORRES_3_1, meanSBP_ANC_LT20, meanDBP_ANC_LT20) %>%
  filter(SITE=="Pakistan")
```


<!-- # CHRONIC HYPERTENSION MEASURED - CHRON_HYPER_MEAS*** -->
<!-- Clinical diagnosis of chronic hypertension AND/OR systolic blood pressure ≥140 mm Hg AND/OR diastolic blood pressure ≥90 mm Hg before 20 weeks’ gestation. -->
<!-- ENROLLMENT -->

<!-- ```{r echo=FALSE} -->
<!-- htn_df <- htn_df %>% -->
<!--   filter(!is.na(M04_ANC_OBSSTDAT_1)) %>% # AMONG WOMEN WHO HAVE ENROLLMENT VISIT -->
<!--   mutate(CHRON_HYPER_MEAS = case_when((meanSBP_ANC_LT20 >=140 | meanDBP_ANC_LT20 >=90)  ~ 1, -->
<!--                                       (is.na(meanSBP_ANC_LT20) & is.na(meanDBP_ANC_LT20)) ~ as.numeric(NA), -->
<!--                                      TRUE  ~ as.numeric(0))) -->

<!-- table(htn_df$CHRON_HYPER_MEAS, SITE = htn_df$SITE, useNA = "always") -->
<!-- round(prop.table(table(htn_df$CHRON_HYPER_MEAS, SITE = htn_df$SITE, useNA = "always"), margin=2)*100, 2) -->

<!-- ``` -->
# Liver function tests and Kidney function tests are done at enrollment and week 32
# Dipstick done at VISIT 1-5.
# CHRONIC HYPERTENSION DIAGNOSIS
```{r}

# Looks like no one has been diagnosed with cHTN during the ANC visits so far (10/14/2023)
temp.df <- htn_df %>% select(MOMID, SITE, M04_HPD_MHTERM_1, M04_HPD_MHTERM_2, M04_HPD_MHTERM_3,
         M04_HPD_MHTERM_4, M04_HPD_MHTERM_5, M04_HPD_MHTERM_13,) #%>% filter(SITE=="Pakistan")

temp.df <- htn_df %>%
  select(MOMID, SITE, M04_HTN_EVER_MHOCCUR_1, M04_HTN_MHSTDAT_1)

htn_df <- htn_df %>%
  filter(!is.na(M04_ANC_OBSSTDAT_1)) %>% # AMONG WOMEN WHO HAVE ANC1 VISIT
  mutate(CHRON_HYPER_DIAG = case_when(M04_HTN_EVER_MHOCCUR_1==1 | (!is.na(M04_HTN_MHSTDAT_1)) ~ 1, # PRIOE cHTN
                                       ((3 %in% c(M04_HPD_MHTERM_1, M04_HPD_MHTERM_2, # RECENTLY DIAGNOSED HTN
                                                    M04_HPD_MHTERM_3, M04_HPD_MHTERM_4, 
                                                    M04_HPD_MHTERM_5, M04_HPD_MHTERM_13)) | 
                                          # Hospitalization:
                                          M19_HDP_HTN_MHOCCUR_1_13==1 | 
                                          # Delivery:
                                          M09_HDP_HTN_MHOCCUR_1_6==1) ~ 1,
         
                                      (is.na(M04_HTN_EVER_MHOCCUR_1) &
                                        all(is.na(c(M04_HPD_MHTERM_1, M04_HPD_MHTERM_2, # RECENTLY DIAGNOSED HTN
                                                    M04_HPD_MHTERM_3, M04_HPD_MHTERM_4, 
                                                    M04_HPD_MHTERM_5, M04_HPD_MHTERM_13, 
                                                    M09_HDP_HTN_MHOCCUR_1_6,
                                                    
                                          # Hospitalization: when all of these options are NA during hospitalization
                                          M19_HDP_HTN_MHOCCUR_1_13, M19_HDP_HTN_MHOCCUR_2_13,
                                          M19_HDP_HTN_MHOCCUR_3_13, M19_HDP_HTN_MHOCCUR_77_13, 
                                          M19_HDP_HTN_MHOCCUR_99_13,
                                          
                                          # Delivery: When all of these 5 possible options are NA
                                          M09_HDP_HTN_MHOCCUR_1_6, M09_HDP_HTN_MHOCCUR_2_6,
                                          M09_HDP_HTN_MHOCCUR_3_6, M09_HDP_HTN_MHOCCUR_77_6,
                                          M09_HDP_HTN_MHOCCUR_99_6)))) ~ as.numeric(NA),
                                      TRUE ~ as.numeric(0)))

table(htn_df$CHRON_HYPER_DIAG, SITE = htn_df$SITE, useNA = "always")
round(prop.table(table(htn_df$CHRON_HYPER_DIAG, SITE = htn_df$SITE, useNA = "always"), margin=2)*100, 2)

temp.df <- htn_df %>% select(MOMID, SITE, CHRON_HYPER_DIAG,
                             M04_HTN_EVER_MHOCCUR_1, M04_HTN_MHSTDAT_1,
                             M04_HPD_MHTERM_1, M04_HPD_MHTERM_2, M04_HPD_MHTERM_3,
                             M04_HPD_MHTERM_4, M04_HPD_MHTERM_5, M04_HPD_MHTERM_13,) #%>% filter(SITE=="Pakistan")

```

# CHRONIC HYPERTENSION TREATMENT
```{r}
# THIS MEDICATION INFO HAS TO BE COLLECTED AT ENROLLEMNT (<20 WEEKS GESTATION) FOR IT TO BE CHTN.
# THERE IS A SKIP PATTERN FOR THESE MEDICATIONS.
htn_df <- htn_df %>%
 # filter(!is.na(M04_ANC_OBSSTDAT_1)) %>% # AMONG WOMEN WHO HAVE VISIT 1 DATE.
  mutate(CHRON_HYPER_TREAT = case_when((M04_HTN_CMTRT_3_1==1 | M04_HTN_CMTRT_4_1==1 | M04_HTN_CMTRT_5_1==1 |
                                          M04_HTN_CMTRT_6_1==1 | M04_HTN_CMTRT_7_1==1 | M04_HTN_CMTRT_8_1==1 |
                                          M04_HTN_CMTRT_9_1==1 | M04_HTN_CMTRT_10_1==1 | M04_HTN_CMTRT_88_1==1) |
                                       
                                       (1 %in% c(M04_HPD_OECTRT_3_1, M04_HPD_OECTRT_3_2, M04_HPD_OECTRT_3_3,
                                                 M04_HPD_OECTRT_3_4, M04_HPD_OECTRT_3_5, M04_HPD_OECTRT_3_13,
                                                 
                                                 M04_HPD_OECTRT_4_1, M04_HPD_OECTRT_4_2, M04_HPD_OECTRT_4_3, 
                                                 M04_HPD_OECTRT_4_4, M04_HPD_OECTRT_4_5, M04_HPD_OECTRT_4_13,
                                                 
                                                 M04_HPD_OECTRT_5_1, M04_HPD_OECTRT_5_2, M04_HPD_OECTRT_5_3,
                                                 M04_HPD_OECTRT_5_4, M04_HPD_OECTRT_5_5, M04_HPD_OECTRT_5_13,
                                                 
                                                 M04_HPD_OECTRT_6_1, M04_HPD_OECTRT_6_2, M04_HPD_OECTRT_6_3,
                                                 M04_HPD_OECTRT_6_4, M04_HPD_OECTRT_6_5, M04_HPD_OECTRT_6_13,
                                                 
                                                 M04_HPD_OECTRT_7_1, M04_HPD_OECTRT_7_2, M04_HPD_OECTRT_7_3, 
                                                 M04_HPD_OECTRT_7_4, M04_HPD_OECTRT_7_5, M04_HPD_OECTRT_7_13,
                                                 
                                                 M04_HPD_OECTRT_88_1, M04_HPD_OECTRT_88_2, M04_HPD_OECTRT_88_3,
                                                 M04_HPD_OECTRT_88_4, M04_HPD_OECTRT_88_5, M04_HPD_OECTRT_88_13)) |
                                       
                                       # Hospitalization:
                                       (M19_HDP_HTN_MHOCCUR_1_13==1 & (M19_HPD_HTN_CMOCCUR_3_13==1 | M19_HPD_HTN_CMOCCUR_4_13==1 |
                                         M19_HPD_HTN_CMOCCUR_5_13==1 | M19_HPD_HTN_CMOCCUR_6_13==1 | M19_HPD_HTN_CMOCCUR_7_13==1 | 
                                         M19_HPD_HTN_CMOCCUR_8_13==1 | M19_HPD_HTN_CMOCCUR_9_13==1 | M19_HPD_HTN_CMOCCUR_10_13==1 | 
                                           M19_HPD_HTN_CMOCCUR_88_13==1))| 
                                       
                                       # Delivery: 
                                       (M09_HDP_HTN_MHOCCUR_1_6==1 & (M09_HDP_HTN_PROCCUR_3_6==1 | M09_HDP_HTN_PROCCUR_4_6==1 |
                                         M09_HDP_HTN_PROCCUR_5_6==1 | M09_HDP_HTN_PROCCUR_6_6==1 | M09_HDP_HTN_PROCCUR_7_6==1 | 
                                         M09_HDP_HTN_PROCCUR_8_6==1 | M09_HDP_HTN_PROCCUR_9_6==1 | 
                                           M09_HDP_HTN_PROCCUR_10_6==1 | M09_HDP_HTN_PROCCUR_88_6==1)) ~ 1,
                                       
                                       
                                       all(is.na(c(M04_HTN_CMTRT_3_1, M04_HTN_CMTRT_4_1,
                                                   M04_HTN_CMTRT_5_1, M04_HTN_CMTRT_6_1,
                                                   M04_HTN_CMTRT_7_1, M04_HTN_CMTRT_8_1, 
                                                   M04_HTN_CMTRT_9_1, M04_HTN_CMTRT_10_1, 
                                                   M04_HTN_CMTRT_88_1,
                                                   
                                                   M04_HPD_OECTRT_3_1, M04_HPD_OECTRT_3_2, M04_HPD_OECTRT_3_3,
                                                   M04_HPD_OECTRT_3_4, M04_HPD_OECTRT_3_5, M04_HPD_OECTRT_3_13,
                                                   
                                                   M04_HPD_OECTRT_4_1, M04_HPD_OECTRT_4_2, M04_HPD_OECTRT_4_3, 
                                                   M04_HPD_OECTRT_4_4, M04_HPD_OECTRT_4_5, M04_HPD_OECTRT_4_13,
                                                   
                                                   M04_HPD_OECTRT_5_1, M04_HPD_OECTRT_5_2, M04_HPD_OECTRT_5_3,
                                                   M04_HPD_OECTRT_5_4, M04_HPD_OECTRT_5_5, M04_HPD_OECTRT_5_13,
                                                   
                                                   M04_HPD_OECTRT_6_1, M04_HPD_OECTRT_6_2, M04_HPD_OECTRT_6_3,
                                                   M04_HPD_OECTRT_6_4, M04_HPD_OECTRT_6_5, M04_HPD_OECTRT_6_13,
                                                   
                                                   M04_HPD_OECTRT_7_1, M04_HPD_OECTRT_7_2, M04_HPD_OECTRT_7_3, 
                                                   M04_HPD_OECTRT_7_4, M04_HPD_OECTRT_7_5, M04_HPD_OECTRT_7_13,
                                                   
                                                   M04_HPD_OECTRT_88_1, M04_HPD_OECTRT_88_2, 
                                                   M04_HPD_OECTRT_88_3,M04_HPD_OECTRT_88_4, 
                                                   M04_HPD_OECTRT_88_5, M04_HPD_OECTRT_88_13,
                                                   
                                                   # Hospitalization:
                                                   M19_HDP_HTN_MHOCCUR_1_13, M19_HPD_HTN_CMOCCUR_3_13, M19_HPD_HTN_CMOCCUR_4_13,
                                                   M19_HPD_HTN_CMOCCUR_5_13, M19_HPD_HTN_CMOCCUR_6_13, M19_HPD_HTN_CMOCCUR_7_13,
                                                   M19_HPD_HTN_CMOCCUR_8_13, M19_HPD_HTN_CMOCCUR_9_13, M19_HPD_HTN_CMOCCUR_10_13,
                                                   M19_HPD_HTN_CMOCCUR_88_13, M19_HPD_HTN_CMOCCUR_77_13, 
                                                   M19_HPD_HTN_CMOCCUR_99_13,
                                                   
                                                   # Delivery:
                                                   M09_HDP_HTN_MHOCCUR_1_6, M09_HDP_HTN_PROCCUR_3_6, M09_HDP_HTN_PROCCUR_4_6, 
                                         M09_HDP_HTN_PROCCUR_5_6, M09_HDP_HTN_PROCCUR_6_6, M09_HDP_HTN_PROCCUR_7_6,  
                                         M09_HDP_HTN_PROCCUR_8_6, M09_HDP_HTN_PROCCUR_9_6,  M09_HDP_HTN_PROCCUR_10_6, M09_HDP_HTN_PROCCUR_88_6))) ~ as.numeric(NA),
                                       TRUE ~ as.numeric(0)))

temp.df <- htn_df %>%
  select(MOMID, SITE, CHRON_HYPER_TREAT, M04_HTN_CMTRT_3_1, 
         M04_HTN_CMTRT_4_1,M04_HTN_CMTRT_5_1, M04_HTN_CMTRT_6_1,
         M04_HTN_CMTRT_7_1, M04_HTN_CMTRT_8_1, 
         M04_HTN_CMTRT_9_1, M04_HTN_CMTRT_10_1, 
         M04_HTN_CMTRT_88_1,
         M04_HPD_OECTRT_3_1, M04_HPD_OECTRT_3_2, M04_HPD_OECTRT_3_3,
         M04_HPD_OECTRT_3_4, M04_HPD_OECTRT_3_5, M04_HPD_OECTRT_3_13,
         
         M04_HPD_OECTRT_4_1, M04_HPD_OECTRT_4_2, M04_HPD_OECTRT_4_3, 
         M04_HPD_OECTRT_4_4, M04_HPD_OECTRT_4_5, M04_HPD_OECTRT_4_13,
         
         M04_HPD_OECTRT_5_1, M04_HPD_OECTRT_5_2, M04_HPD_OECTRT_5_3,
         M04_HPD_OECTRT_5_4, M04_HPD_OECTRT_5_5, M04_HPD_OECTRT_5_13,
         
         M04_HPD_OECTRT_6_1, M04_HPD_OECTRT_6_2, M04_HPD_OECTRT_6_3,
         M04_HPD_OECTRT_6_4, M04_HPD_OECTRT_6_5, M04_HPD_OECTRT_6_13,
         
         M04_HPD_OECTRT_7_1, M04_HPD_OECTRT_7_2, M04_HPD_OECTRT_7_3, 
         M04_HPD_OECTRT_7_4, M04_HPD_OECTRT_7_5, M04_HPD_OECTRT_7_13,
         
         M04_HPD_OECTRT_88_1, M04_HPD_OECTRT_88_2, 
         M04_HPD_OECTRT_88_3,M04_HPD_OECTRT_88_4, 
         M04_HPD_OECTRT_88_5, M04_HPD_OECTRT_88_13)

with(htn_df, table(is.na(c(M04_HTN_CMTRT_3_1, M04_HTN_CMTRT_4_1, M04_HTN_CMTRT_5_1, 
                            M04_HTN_CMTRT_6_1, M04_HTN_CMTRT_7_1, M04_HTN_CMTRT_8_1,
                            M04_HTN_CMTRT_9_1, M04_HTN_CMTRT_88_1))))


table(htn_df$CHRON_HYPER_TREAT, SITE = htn_df$SITE, useNA = "always")
round(prop.table(table(htn_df$CHRON_HYPER_TREAT, SITE = htn_df$SITE, useNA = "always"), margin=2)*100, 2)
```

# CHRONIC HYPERTENSION TREATMENT
#### SPECIAL NOTE: THIS IS JUST FOR THE TABLE THAT I NEED TO CREATE IN "MAT_CHTN_GHTN_TABLES.RMD"
```{r}
chtn_diag_df <- htn_df %>% 
  filter(CHRON_HYPER_DIAG==1) %>%
#  filter(!is.na(M04_ANC_OBSSTDAT_1)) %>% # AMONG WOMEN WHO HAVE VISIT 1 DATE.
  mutate(CHRON_HYPER_TREAT = case_when((M04_HTN_CMTRT_3_1==1 | M04_HTN_CMTRT_4_1==1 | M04_HTN_CMTRT_5_1==1 |
                                          M04_HTN_CMTRT_6_1==1 | M04_HTN_CMTRT_7_1==1 | M04_HTN_CMTRT_8_1==1 |
                                          M04_HTN_CMTRT_9_1==1 | M04_HTN_CMTRT_88_1==1 ) ~ 1,
                                       all(is.na(c(M04_HTN_CMTRT_3_1, M04_HTN_CMTRT_4_1,
                                                   M04_HTN_CMTRT_5_1, M04_HTN_CMTRT_6_1,
                                                   M04_HTN_CMTRT_7_1, M04_HTN_CMTRT_8_1, 
                                                   M04_HTN_CMTRT_9_1, M04_HTN_CMTRT_88_1))) ~ as.numeric(NA),
                                       TRUE ~ as.numeric(0)))

with(chtn_diag_df, table(is.na(c(M04_HTN_CMTRT_3_1, M04_HTN_CMTRT_4_1, M04_HTN_CMTRT_5_1, 
                            M04_HTN_CMTRT_6_1, M04_HTN_CMTRT_7_1, M04_HTN_CMTRT_8_1,
                            M04_HTN_CMTRT_9_1, M04_HTN_CMTRT_88_1))))

table(chtn_diag_df$CHRON_HYPER_TREAT, SITE = chtn_diag_df$SITE, useNA = "always")
round(prop.table(table(chtn_diag_df$CHRON_HYPER_TREAT, SITE = chtn_diag_df$SITE, useNA = "always"), margin=2)*100, 2)
```

# WRITE THIS FILE OUT.
```{r}
write.csv(chtn_diag_df, '../data_out/chtn_diag_df.csv')
```
### END OF SPECIAL NOTE


# CREATE CHTN CATEGORIES LIKE I DID FOR GHTN. 
# FUNCTION FOR cHTN and SEVERE cHTN

```{r}
is_severe_chtn <- function(sbp, dbp, sbp_threshold = 160, dbp_threshold = 110) {
  return (is_chtn(sbp, dbp, sbp_threshold, dbp_threshold))
}

is_chtn <- function(sbp, dbp, sbp_threshold = 140, dbp_threshold = 90) {
  return (sbp >= sbp_threshold | dbp >= dbp_threshold)
}
```

# cHTN MEASURED AT ANC<20 AND ONE OTHER TP at >=20 weeks (TOTAL 2 TIMEPOINTS)
```{r}

 # WHEN Enrollment SBP or DBP is high and one additional during >20 weeks gestation is high (at any point) then it will be considered cHTN. 
htn_df <- htn_df %>%
  rowwise() %>%
  mutate(CHRON_HYPER_MEAS_ANY2 = ifelse(is_chtn(meanSBP_ANC_LT20, meanDBP_ANC_LT20) & 
                                          (any(is_chtn(meanSBP_ANC20, meanDBP_ANC20),
                                               is_chtn(meanSBP_ANC28, meanDBP_ANC28),
                                               is_chtn(meanSBP_ANC32, meanDBP_ANC32),
                                               is_chtn(meanSBP_ANC36, meanDBP_ANC36),
                                               is_chtn(meanSBP_IPC, meanDBP_IPC),
                                               is_chtn(meanSBP_Hosp_ANC, meanDBP_Hosp_ANC), na.rm=TRUE)), 1, 0),
         # OVERWRITES 0 WITH NA when all these vars are NA
         CHRON_HYPER_MEAS_ANY2 = ifelse(all(is.na(c(meanSBP_ANC_LT20, meanDBP_ANC_LT20))) |
                                          (all(is.na(c(meanSBP_ANC20, meanDBP_ANC20, 
                                                       meanSBP_ANC28, meanDBP_ANC28, 
                                                       meanSBP_ANC32, meanDBP_ANC32, 
                                                       meanSBP_ANC36, meanDBP_ANC36,
                                                       meanSBP_IPC, meanDBP_IPC, 
                                                       meanSBP_Hosp_ANC, meanDBP_Hosp_ANC)))), 
                                        as.numeric(NA),
                                        # OTHERWISE, IT LEAVES IT ALONE.
                                        CHRON_HYPER_MEAS_ANY2)) %>%
 
   # Summing up after enrollment visit - doesn't include ANC_LT20
  mutate(SUM_BP = sum(!is.na(meanSBP_ANC_LT20), 
                      !is.na(meanSBP_ANC20), 
                      !is.na(meanSBP_ANC28), 
                      !is.na(meanSBP_ANC32), 
                      !is.na(meanSBP_ANC36),
                      !is.na(meanSBP_IPC))) # THIS SUM_BP LOOKS GOOD.
                      #!is.na(meanSBP_Hosp_ANC)

table(htn_df$CHRON_HYPER_MEAS_ANY2, htn_df$SITE, useNA = "always")
round(prop.table(table(htn_df$CHRON_HYPER_MEAS_ANY2, htn_df$SITE, useNA = "always"), margin=2)*100,2)


temp.df <- htn_df %>% select(MOMID, SITE, SUM_BP, meanSBP_ANC_LT20, meanSBP_ANC20,
                             meanSBP_ANC28, meanSBP_ANC32,
                            meanSBP_ANC36, meanSBP_IPC)
  
temp.df <- htn_df %>% select(MOMID, SITE, SUM_BP, M06_BP_SYS_VSORRES_1_4, M06_BP_SYS_VSORRES_2_4, M06_BP_SYS_VSORRES_3_4,
                             M06_BP_SYS_VSORRES_1_5, M06_BP_SYS_VSORRES_2_5, M06_BP_SYS_VSORRES_3_5,
                            meanSBP_ANC36, meanSBP_IPC) %>%
  filter(SITE=="Pakistan")


temp.df <- htn_df %>%
  select(MOMID, SITE, CHRON_HYPER_MEAS_ANY2,
        meanSBP_ANC_LT20, meanDBP_ANC_LT20,
         meanSBP_ANC20, meanDBP_ANC20,
         meanSBP_ANC28, meanDBP_ANC28,
         meanSBP_ANC32, meanDBP_ANC32,
         meanSBP_ANC36, meanDBP_ANC36,
         meanSBP_IPC, meanDBP_IPC,
         meanSBP_Hosp_ANC, meanDBP_Hosp_ANC) %>% 
  filter(SITE=="Pakistan") %>%
  mutate(SUM_BP = sum(#!is.na(meanSBP_ANC_LT20), 
                      !is.na(meanSBP_ANC20), 
                      !is.na(meanSBP_ANC28), 
                      !is.na(meanSBP_ANC32), 
                      !is.na(meanSBP_ANC36),
                      !is.na(meanSBP_IPC),
                      !is.na(meanSBP_Hosp_ANC)))




```

# cHTN MEASURED ANY 1 TIMEPOINT
```{r}
# DOES SHE HAVE HIGH BP AT ANY POINT.  THIS WILL BE COMBINED WITH TREATMENT VARIABLE. IT CAN'T BE USED ALONE.
htn_df <- htn_df %>%
  rowwise() %>%
  mutate(CHRON_HYPER_MEAS_ANY1 = ifelse(any(is_chtn(meanSBP_ANC_LT20, meanDBP_ANC_LT20),
                                            is_chtn(meanSBP_ANC20, meanDBP_ANC20),
                                            is_chtn(meanSBP_ANC28, meanDBP_ANC28),
                                            is_chtn(meanSBP_ANC32, meanDBP_ANC32),
                                            is_chtn(meanSBP_ANC36, meanDBP_ANC36),
                                            is_chtn(meanSBP_IPC, meanDBP_IPC),
                                            is_chtn(meanSBP_Hosp_ANC, meanDBP_Hosp_ANC), na.rm = TRUE), 1, 0),
         # OVERWRITES 0 WITH NA when all these vars are NA
         CHRON_HYPER_MEAS_ANY1 = ifelse(all(is.na(c(meanSBP_ANC_LT20, meanDBP_ANC_LT20, 
                                                    meanSBP_ANC20, meanDBP_ANC20, 
                                                    meanSBP_ANC28, meanDBP_ANC28, 
                                                    meanSBP_ANC32, meanDBP_ANC32, 
                                                    meanSBP_ANC36, meanDBP_ANC36,
                                                    meanSBP_IPC, meanDBP_IPC, 
                                                    meanSBP_Hosp_ANC, meanDBP_Hosp_ANC))), 
                                        as.numeric(NA),
                                        # OTHERWISE, LEAVE IT ALONE.
                                        CHRON_HYPER_MEAS_ANY1))

table(htn_df$CHRON_HYPER_MEAS_ANY1, htn_df$SITE, useNA = "always")
round(prop.table(table(htn_df$CHRON_HYPER_MEAS_ANY1, htn_df$SITE, useNA = "always"), margin=2)*100,2)

temp.df <- htn_df %>% select(MOMID, SITE, CHRON_HYPER_MEAS_ANY1, meanSBP_ANC_LT20, meanDBP_ANC_LT20,
                             meanSBP_ANC20, meanDBP_ANC20,
                             meanSBP_ANC28, meanDBP_ANC28, 
                             meanSBP_ANC32, meanDBP_ANC32, 
                             meanSBP_ANC36, meanDBP_ANC36,
                             meanSBP_IPC, meanDBP_IPC, 
                             meanSBP_Hosp_ANC, meanDBP_Hosp_ANC) %>%
  filter(SITE=="Pakistan")
```

# CHRONIC HYPERTENSION MEAS1 + TREATMENT 
# change this to just traetment or measured 
```{r}
# WHEN TREATMENT INFO IS MISSING OR 1 MEASUREMET IS MISSING - THEN CAN'T DETERMINE chtn
htn_df <- htn_df %>% 
 # filter(!is.na(M04_ANC_OBSSTDAT_1)) %>% # AMONG WOMEN WHO DELIVERED
  mutate(CHRON_HYPER_MEAS1_TREAT = case_when((CHRON_HYPER_TREAT==1 & CHRON_HYPER_MEAS_ANY1==1) ~ 1,
                                             (is.na(CHRON_HYPER_MEAS_ANY1) & 
                                                  is.na(CHRON_HYPER_TREAT)) ~ as.numeric(NA),
                                            TRUE ~ as.numeric(0)))

table(htn_df$CHRON_HYPER_MEAS1_TREAT, SITE = htn_df$SITE, useNA = "always")
round(prop.table(table(htn_df$CHRON_HYPER_MEAS1_TREAT, SITE = htn_df$SITE, useNA = "always"), margin=2)*100, 2)

temp.df <- htn_df %>% select(MOMID, SITE, CHRON_HYPER_MEAS1_TREAT, CHRON_HYPER_TREAT, CHRON_HYPER_MEAS_ANY1) 
```


# SEVERE CHRONIC HTN
```{r}
htn_df <- htn_df %>%
  rowwise() %>%
  mutate(SEVERE_CHRON_HYPER_MEAS = ifelse(any(is_severe_chtn(meanSBP_ANC_LT20, meanDBP_ANC_LT20), na.rm = TRUE), 1, 0),
         # OVERWRITES 0 WITH NA when all these vars are NA
         SEVERE_CHRON_HYPER_MEAS = ifelse(all(is.na(c(meanSBP_ANC_LT20, meanDBP_ANC_LT20))), 
                                       as.numeric(NA),
                                       # OTHERWISE, LEAVE IT ALONE.
                                       SEVERE_CHRON_HYPER_MEAS))

table(htn_df$SEVERE_CHRON_HYPER_MEAS, htn_df$SITE, useNA = "always")
round(prop.table(table(htn_df$SEVERE_CHRON_HYPER_MEAS, htn_df$SITE, useNA = "always"), margin=2)*100,2)

temp.df <- htn_df %>% select(MOMID, SITE, SEVERE_CHRON_HYPER_MEAS, 
                             M06_BP_SYS_VSORRES_1_1, M06_BP_SYS_VSORRES_2_1, M06_BP_SYS_VSORRES_3_1,
                             M06_BP_DIA_VSORRES_1_1, M06_BP_DIA_VSORRES_2_1, M06_BP_DIA_VSORRES_3_1, 
                             meanSBP_ANC_LT20, meanDBP_ANC_LT20) 
```

```{r}
htn_df <- htn_df %>% 
 # filter(!is.na(M04_ANC_OBSSTDAT_1)) %>% # AMONG WOMEN WHO DELIVERED
  mutate(CHRON_HYPER = case_when((CHRON_HYPER_MEAS1_TREAT==1 | CHRON_HYPER_MEAS_ANY2==1) ~ 1,
                                            (is.na(CHRON_HYPER_MEAS_ANY2) & 
                                               is.na(CHRON_HYPER_MEAS1_TREAT==1)) ~ as.numeric(NA),
                                            TRUE ~ as.numeric(0)))

table(htn_df$CHRON_HYPER, SITE = htn_df$SITE, useNA = "always")
round(prop.table(table(htn_df$CHRON_HYPER, SITE = htn_df$SITE, useNA = "always"), margin=2)*100, 2)

temp.df <- htn_df %>% select(MOMID, SITE, CHRON_HYPER, CHRON_HYPER_MEAS1_TREAT, CHRON_HYPER_MEAS_ANY2) %>% 
  filter(SITE=="Kenya")
```

###########################################################

#  HYPERTENSION >=20 weeks

"ANC
Wk 20, 28, 32, 36 (VISITS 2-4),
Then, IPD (VISIT 6), then: MNH19 Hospitalization.

L&D"	we don't MNH04 at L&D so won't have those vars. 
MNH01	US_GA_WKS_AGE_FTS1	1st fetus: GA by ultrasound at TODAY’s visit:  weeks
		MNH04	HTN_EVER_MHOCCUR	Have you ever been diagnosed with chronic hypertension?
		MNH04	HPD_MHTERM	Specify type of HPD
		
Medications include magnesium sulfate, hydralazine, methyldopa (aldomet), atenolol, nifedipine, betamethasone, labetalol, and dexamethasone. 

```{r echo=FALSE}
###################################################################################################
#TODO 
# NOTES: 
########## NEEDS A LOT OF ATTENTION###########
# - AMONG PARTICIPANTS WITHOUT cHTN.
# LOOKING AT TWO TIMEPOINTS TO DETERMINE IF gHTN (TP DO NOT HAVE TO BE CONSECUTIVE
# ADD UNSCHEDULED VISITS - CURRENTLY, I ONLY HAVE ONE UNSCHEDULED VISIT.
# - CREATED A GEST_HYPER_MEAS_TREAT VAR THAT HAS BOTH MEDICATION AND BP DATA.
      


# DISCUSSION POINTS 09/21/2023 
# Create separate categories for DIAGNOSED, MEASURED and TREATED. 
# - Make a classic case of gHTN also where either BP high OR medication use. 
###################################################################################################

# FUNCTION FOR gHTN and SEVERE gHTN
is_severe_ghtn <- function(sbp, dbp, sbp_threshold = 160, dbp_threshold = 110) {
  return (is_ghtn(sbp, dbp, sbp_threshold, dbp_threshold))
}

is_ghtn <- function(sbp, dbp, sbp_threshold = 140, dbp_threshold = 90) {
  return (sbp >= sbp_threshold | dbp >= dbp_threshold)
}
```

# HTN >=20 weeks: MEASURED ANY 2 TIMEPOINTS and do not have cHTN
```{r}
 # WHEN ANY TWO TIMEPOINT SBP OR DBP ARE ABOVE THE THRESHOLD (DO NOT HAVE TO BE CONSECUTIVE)
# Making sure that the VISIT 2 GA >=20 weeks AND BP at that point is >=140/90. 
# Then, I am saying that VISIT 2 has to be >=140/90 AND one of the other visits later have to be >=140/90 and no CHTN OR (give mes 2 measurements)
# Any of the 2 visits after VISIT 2 (>=20 weeks) have to be >=140/90 (2 measurements).
htn_df <- htn_df %>%
  mutate(GT20_HTN_MEAS_VISIT2 = case_when(M08_GA_AT_VISIT_2/7 >=20 & 
                                            is_ghtn(meanSBP_ANC20, meanDBP_ANC20) ~ 1,
                                          all(is.na(c(meanSBP_ANC20, meanDBP_ANC20))) ~ as.numeric(NA),
                                          TRUE ~ 0))
temp.df <- htn_df %>%
  select(MOMID, SITE, GT20_HTN_MEAS_VISIT2, 
         M08_GA_AT_VISIT_2, CHRON_HYPER, 
         meanSBP_ANC20, meanDBP_ANC20)

htn_df <- htn_df %>%
  mutate(GT20_HTN_MEAS_ANY2 = case_when(CHRON_HYPER==0 & 
                                          (GT20_HTN_MEAS_VISIT2==1 & 
                                             (sum(is_ghtn(meanSBP_ANC28, meanDBP_ANC28),
                                                  is_ghtn(meanSBP_ANC32, meanDBP_ANC32),
                                                  is_ghtn(meanSBP_ANC36, meanDBP_ANC36),
                                                  is_ghtn(meanSBP_IPC, meanDBP_IPC),
                                                  is_ghtn(meanSBP_Hosp_ANC, meanDBP_Hosp_ANC), na.rm = TRUE) >=1)) | 
                                          
                                          (sum(is_ghtn(meanSBP_ANC28, meanDBP_ANC28),
                                               is_ghtn(meanSBP_ANC32, meanDBP_ANC32),
                                               is_ghtn(meanSBP_ANC36, meanDBP_ANC36),
                                               is_ghtn(meanSBP_IPC, meanDBP_IPC),
                                               is_ghtn(meanSBP_Hosp_ANC, meanDBP_Hosp_ANC), na.rm = TRUE) >=2)~ 1,
                                        
                                        # Making sure that at least 2 TP measurements are not NA at least.  
                                        (sum(!is.na(c(meanSBP_ANC20, 
                                                      meanSBP_ANC28, 
                                                      meanSBP_ANC32, 
                                                      meanSBP_ANC36, 
                                                      meanSBP_IPC, 
                                                      meanSBP_Hosp_ANC))) <2) ~ as.numeric(NA),
                                        TRUE ~ 0))



# htn_df <- htn_df %>%
#   rowwise() %>%
#   mutate(GT20_HTN_MEAS_ANY2 = ifelse(((sum(is_ghtn(meanSBP_ANC20, meanDBP_ANC20),
#                                            is_ghtn(meanSBP_ANC28, meanDBP_ANC28),
#                                            is_ghtn(meanSBP_ANC32, meanDBP_ANC32),
#                                            is_ghtn(meanSBP_ANC36, meanDBP_ANC36),
#                                            is_ghtn(meanSBP_IPC, meanDBP_IPC),
#                                            is_ghtn(meanSBP_Hosp_ANC, meanDBP_Hosp_ANC), na.rm = TRUE) >=2) & 
#                                         
#                                         CHRON_HYPER==0), 1, 0),
#          # OVERWRITES 0 WITH NA when all these vars are NA
#          # HAVE TO HAVE AT LEAST 2 MEASUREMETNS (I.E 1 PAIR)
#          GT20_HTN_MEAS_ANY2 = ifelse((sum(!is.na(c(meanSBP_ANC20, meanDBP_ANC20, meanSBP_ANC28, meanDBP_ANC28, 
#                                                   meanSBP_ANC32, meanDBP_ANC32, meanSBP_ANC36, meanDBP_ANC36,
#                                                   meanSBP_IPC, meanDBP_IPC, meanSBP_Hosp_ANC, meanDBP_Hosp_ANC)))<=2 | is.na(CHRON_HYPER)), 
#                                      as.numeric(NA),
#                                      # OTHERWISE, IT LEAVES IT ALONE.
#                                      GT20_HTN_MEAS_ANY2))

table(htn_df$GT20_HTN_MEAS_ANY2, htn_df$SITE, useNA = "always")
round(prop.table(table(htn_df$GT20_HTN_MEAS_ANY2, htn_df$SITE, useNA = "always"), margin=2)*100,2)

temp.df <- htn_df %>% select(MOMID, SITE, 
                             CHRON_HYPER,
                             GT20_HTN_MEAS_ANY2,
                             meanSBP_ANC20, meanDBP_ANC20,
                             meanSBP_ANC28, meanDBP_ANC28,
                             meanSBP_ANC32, meanDBP_ANC32,
                             meanSBP_ANC36, meanDBP_ANC36,
                             meanSBP_IPC, meanDBP_IPC,
                             meanSBP_Hosp_ANC, meanDBP_Hosp_ANC) 
```

# HTN >=20 weeks: MEASURED ANY 1 TIMEPOINT and do not have cHTN
```{r}
htn_df <- htn_df %>%
  mutate(GT20_HTN_MEAS_ANY1 = case_when(CHRON_HYPER==0 & 
                                          (GT20_HTN_MEAS_VISIT2==1 | # This is OR b/c I just need 1 measurement >=140/90 after 20 weeks 
                                             (sum(is_ghtn(meanSBP_ANC28, meanDBP_ANC28),
                                                  is_ghtn(meanSBP_ANC32, meanDBP_ANC32),
                                                  is_ghtn(meanSBP_ANC36, meanDBP_ANC36),
                                                  is_ghtn(meanSBP_IPC, meanDBP_IPC),
                                                  is_ghtn(meanSBP_Hosp_ANC, meanDBP_Hosp_ANC), na.rm = TRUE) >=1)) ~ 1,
                                        
                                          # Making sure that at least 1 TP measurements is not NA after 20 weeks GA.  
                                        (sum(!is.na(c(meanSBP_ANC20, 
                                                      meanSBP_ANC28, 
                                                      meanSBP_ANC32, 
                                                      meanSBP_ANC36, 
                                                      meanSBP_IPC, 
                                                      meanSBP_Hosp_ANC))) <1) ~ as.numeric(NA),
                                        TRUE ~ 0))
                                          
# htn_df <- htn_df %>%
#   rowwise() %>%
#   mutate(GT20_HTN_MEAS_ANY1 = ifelse((sum(is_ghtn(meanSBP_ANC20, meanDBP_ANC20),
#                                              is_ghtn(meanSBP_ANC28, meanDBP_ANC28),
#                                              is_ghtn(meanSBP_ANC32, meanDBP_ANC32),
#                                              is_ghtn(meanSBP_ANC36, meanDBP_ANC36),
#                                              is_ghtn(meanSBP_IPC, meanDBP_IPC),
#                                              is_ghtn(meanSBP_Hosp_ANC, meanDBP_Hosp_ANC), na.rm = TRUE) >=1) & # just need one TP to be high and then add in the medication piece next (it will be 1 TP high AND Medication use)
#                                           CHRON_HYPER==0, 1, 0),
#          # OVERWRITES 0 WITH NA when all these vars are NA
#          GT20_HTN_MEAS_ANY1 = ifelse((all(is.na(c(meanSBP_ANC20, meanDBP_ANC20, 
#                                                    meanSBP_ANC28, meanDBP_ANC28, 
#                                                    meanSBP_ANC32, meanDBP_ANC32, 
#                                                    meanSBP_ANC36, meanDBP_ANC36,
#                                                    meanSBP_IPC, meanDBP_IPC, 
#                                                    meanSBP_Hosp_ANC, meanDBP_Hosp_ANC))) | is.na(CHRON_HYPER)), 
#                                        as.numeric(NA),
#                                        # OTHERWISE, IT LEAVES IT ALONE.
#                                        GT20_HTN_MEAS_ANY1))

table(htn_df$GT20_HTN_MEAS_ANY1, htn_df$SITE, useNA = "always")
round(prop.table(table(htn_df$GT20_HTN_MEAS_ANY1, htn_df$SITE, useNA = "always"), margin=2)*100,2)

temp.df <- htn_df %>% select(MOMID, SITE, GT20_HTN_MEAS_ANY1, 
                             meanSBP_ANC20, meanDBP_ANC20,
                             meanSBP_ANC28, meanDBP_ANC28,
                             meanSBP_ANC32, meanDBP_ANC32,
                             meanSBP_ANC36, meanDBP_ANC36,
                             meanSBP_IPC, meanDBP_IPC,
                             meanSBP_Hosp_ANC, meanDBP_Hosp_ANC)
  
```

# TREATMENT FOR HTN >=20 weeks
```{r}
######################################
# GESTATIONAL HYPERTENSION TREATMENT #
#TODO QUERY CHECK: HDP_HTN_MHOCCUR_4 - 10 and 88 in M19 should be 1,0 variables but they don't exist.
######################################
htn_df <- htn_df %>%                      
  mutate(GT20_HTN_TREAT = case_when((M04_HPD_MHTERM_2!=3 & M04_GA_AT_VISIT_2/7>=30 & # When it is not cHTN
                                         # VISIT 20
                                         (1 %in% c(M04_HPD_OECTRT_3_2, M04_HPD_OECTRT_4_2, M04_HPD_OECTRT_5_2,
                                                   M04_HPD_OECTRT_6_2, M04_HPD_OECTRT_7_2, M04_HPD_OECTRT_8_2,
                                                   M04_HPD_OECTRT_9_2, M04_HPD_OECTRT_10_2, M04_HPD_OECTRT_88_2))) |
                                      # VISIT 28
                                      (M04_HPD_MHTERM_3!=3 & 
                                         (1 %in% c(M04_HPD_OECTRT_3_3, M04_HPD_OECTRT_4_3, M04_HPD_OECTRT_5_3,
                                       M04_HPD_OECTRT_6_3, M04_HPD_OECTRT_7_3, M04_HPD_OECTRT_8_3,
                                       M04_HPD_OECTRT_9_3, M04_HPD_OECTRT_10_3, M04_HPD_OECTRT_88_3))) |
                                                   
                                                   # VISIT 32
                                       (M04_HPD_MHTERM_4!=3 & 
                                         (1 %in% c(M04_HPD_OECTRT_3_4, M04_HPD_OECTRT_4_4, M04_HPD_OECTRT_5_4, # ANC
                                                   M04_HPD_OECTRT_6_4, M04_HPD_OECTRT_7_4, M04_HPD_OECTRT_8_4,
                                                   M04_HPD_OECTRT_9_4, M04_HPD_OECTRT_10_4, M04_HPD_OECTRT_88_4))) |
                                                   
                                                   # VISIT 36
                                                   (M04_HPD_MHTERM_5!=3 & 
                                         (1 %in% c(M04_HPD_OECTRT_3_5, M04_HPD_OECTRT_4_5, M04_HPD_OECTRT_5_5, # ANC
                                                   M04_HPD_OECTRT_6_5, M04_HPD_OECTRT_7_5, M04_HPD_OECTRT_8_5,
                                                   M04_HPD_OECTRT_9_5, M04_HPD_OECTRT_10_5, M04_HPD_OECTRT_88_5))) |
                                                   
                                                   # IPC
                                                   (M09_HDP_HTN_MHOCCUR_1_6==0 &
                                                      (1 %in% c(M09_HDP_HTN_PROCCUR_3_6, M09_HDP_HTN_PROCCUR_4_6, M09_HDP_HTN_PROCCUR_5_6,
                                                   M09_HDP_HTN_PROCCUR_6_6, M09_HDP_HTN_PROCCUR_7_6, M09_HDP_HTN_PROCCUR_8_6,
                                                   M09_HDP_HTN_PROCCUR_9_6, M09_HDP_HTN_PROCCUR_10_6, M09_HDP_HTN_PROCCUR_88_6))) |
                                                   
                                                   #M19 HOSP _13
                                         (M19_HDP_HTN_MHOCCUR_1_13==0 & 
                                         (1 %in% c(M19_HDP_HTN_MHOCCUR_3_13, M19_HDP_HTN_MHOCCUR_4_13, M19_HDP_HTN_MHOCCUR_5_13, 
                                                   M19_HDP_HTN_MHOCCUR_6_13, M19_HDP_HTN_MHOCCUR_7_13, M19_HDP_HTN_MHOCCUR_8_13, 
                                                   M19_HDP_HTN_MHOCCUR_9_13, M19_HDP_HTN_MHOCCUR_10_13, M19_HDP_HTN_MHOCCUR_88_13))) ~ 1,
                                      ############# 
                                    # I am looking at the question that says "was mother diagnosed with any HDP" for NA only instead of 
                                    # all medications being NA b/c if all the 5 options are NA then medication data doesn't make sense
                                    
                                      # WHEN ALL that ask: "Specify type of HDP" ARE NA: b/c if these are all NA, 
                                    #doesn't matter what medication info is there, it doesn't have a lot of meaning.
                                    (all(is.na(c(M04_HPD_MHTERM_2, M04_HPD_MHTERM_3, 
                                                  M04_HPD_MHTERM_4, M04_HPD_MHTERM_5,
                                                  M04_HPD_MHTERM_13, M09_HDP_HTN_MHOCCUR_1_6,
                                                 
                                                 # Hospitalization:
                                                 M19_HDP_HTN_MHOCCUR_1_13, M19_HDP_HTN_MHOCCUR_2_13, 
                                                 M19_HDP_HTN_MHOCCUR_3_13, M19_HDP_HTN_MHOCCUR_77_13, 
                                                 M19_HDP_HTN_MHOCCUR_99_13,
                                                 
                                                 # Delivery:
                                                 M09_HDP_HTN_MHOCCUR_1_6, M09_HDP_HTN_MHOCCUR_2_6, M09_HDP_HTN_MHOCCUR_3_6,
                                                 M09_HDP_HTN_MHOCCUR_77_6, M09_HDP_HTN_MHOCCUR_99_6)))) ~ as.numeric(NA), 
                                      # all(is.na(c(M04_HPD_OECTRT_3_2, M04_HPD_OECTRT_4_2, M04_HPD_OECTRT_5_2, # ANC
                                      #             M04_HPD_OECTRT_6_2, M04_HPD_OECTRT_7_2, M04_HPD_OECTRT_8_2,
                                      #             M04_HPD_OECTRT_9_2, M04_HPD_OECTRT_10_2, M04_HPD_OECTRT_88_2,
                                      #             
                                      #             # VISIT 28
                                      #             M04_HPD_OECTRT_3_3, M04_HPD_OECTRT_4_3, M04_HPD_OECTRT_5_3, # ANC
                                      #             M04_HPD_OECTRT_6_3, M04_HPD_OECTRT_7_3, M04_HPD_OECTRT_8_3,
                                      #             M04_HPD_OECTRT_9_3, M04_HPD_OECTRT_10_3, M04_HPD_OECTRT_88_3,
                                      #             
                                      #             # VISIT 32
                                      #             M04_HPD_OECTRT_3_4, M04_HPD_OECTRT_4_4, M04_HPD_OECTRT_5_4, # ANC
                                      #             M04_HPD_OECTRT_6_4, M04_HPD_OECTRT_7_4, M04_HPD_OECTRT_8_4,
                                      #             M04_HPD_OECTRT_9_4, M04_HPD_OECTRT_10_4, M04_HPD_OECTRT_88_4,
                                      #             
                                      #             # VISIT 36
                                      #             M04_HPD_OECTRT_3_5, M04_HPD_OECTRT_4_5, M04_HPD_OECTRT_5_5, # ANC
                                      #             M04_HPD_OECTRT_6_5, M04_HPD_OECTRT_7_5, M04_HPD_OECTRT_8_5,
                                      #             M04_HPD_OECTRT_9_5, M04_HPD_OECTRT_10_5, M04_HPD_OECTRT_88_5,
                                      #             
                                      #             # IPC
                                      #             M09_HDP_HTN_PROCCUR_3_6, M09_HDP_HTN_PROCCUR_4_6, M09_HDP_HTN_PROCCUR_5_6,
                                      #             M09_HDP_HTN_PROCCUR_6_6, M09_HDP_HTN_PROCCUR_7_6, M09_HDP_HTN_PROCCUR_8_6,
                                      #             M09_HDP_HTN_PROCCUR_9_6, M09_HDP_HTN_PROCCUR_10_6, M09_HDP_HTN_PROCCUR_88_6,
                                      #             
                                      #             # ANC HOSP _13
                                      #             M19_HDP_HTN_MHOCCUR_3_13, M19_HDP_HTN_MHOCCUR_4_13, M19_HDP_HTN_MHOCCUR_5_13, 
                                      #             M19_HDP_HTN_MHOCCUR_6_13, M19_HDP_HTN_MHOCCUR_7_13, M19_HDP_HTN_MHOCCUR_8_13, 
                                      #             M19_HDP_HTN_MHOCCUR_9_13, M19_HDP_HTN_MHOCCUR_10_13, M19_HDP_HTN_MHOCCUR_88_13)))) ~ as.numeric(NA),
                                      TRUE ~ as.numeric(0)))

table(GT20_HTN_TREAT = htn_df$GT20_HTN_TREAT, htn_df$SITE, useNA = "always")
round(prop.table(table(GT20_HTN_TREAT = htn_df$GT20_HTN_TREAT, SITE = htn_df$SITE, useNA = "always"), margin=2)*100,2)  

temp.df <- htn_df %>%
  select(MOMID, SITE, GT20_HTN_TREAT, 
         starts_with(c("M04_HPD_MHTERM_", "M04_HPD_OECTRT_", 
                       "M09_HDP_HTN_MHOCCUR_1_6", "M09_HDP_HTN_PROCCUR_", 
                       "M19_HDP_HTN_MHOCCUR_", "M19_HDP_HTN_CMOCCUR_")))

write.csv(temp.df, '../data_out/temp.df.csv')
```

# HYPERTENSION >=20 weeks MEASURED ONCE AND TREATMENT
```{r}
# ALREADY ACCOUNT FOR CHTN==0
htn_df <- htn_df %>%
  mutate(GT20_MEAS1_TREAT = case_when((GT20_HTN_TREAT==1 & GT20_HTN_MEAS_ANY1==1) ~ 1,
                                      (is.na(GT20_HTN_TREAT) | is.na(GT20_HTN_MEAS_ANY1)) ~ as.numeric(NA),
                                            TRUE ~ as.numeric(0)))

table(GT20_MEAS1_TREAT = htn_df$GT20_MEAS1_TREAT, htn_df$SITE, useNA = "always")
round(prop.table(table(GT20_MEAS1_TREAT = htn_df$GT20_MEAS1_TREAT, SITE = htn_df$SITE, useNA = "always"), margin=2)*100,2) 

temp.df <- htn_df %>% select(MOMID, SITE, GT20_MEAS1_TREAT, GT20_HTN_TREAT, GT20_HTN_MEAS_ANY1) %>%
  filter(SITE=="Zambia")
```

# SEVERE GESTATIONAL HYPERTENSION - SEVERE_GEST_HYPER_MEAS***
In pregnancy defined as systolic blood pressure ≥160 mmHg or a diastolic blood pressure ≥110 mmHg on two occasions at least 1 minute apart after 20 weeks gestation OR at the time of delivery defined as one systolic blood pressure ≥160 mmHg or a diastolic blood pressure ≥110 mmHg among participants without chronic hypertension.
```{r}
##################################
# SEVERE GESTATIONAL HYPERTENSION:
##################################

# NEED JUST ONE BP >160/110 NOT 2.
htn_df <- htn_df %>% 
  mutate(SEVERE_GT20_HTN_MEAS = ifelse((sum(is_severe_ghtn(meanSBP_ANC20, meanDBP_ANC20),
                                               is_severe_ghtn(meanSBP_ANC28, meanDBP_ANC28),
                                               is_severe_ghtn(meanSBP_ANC32, meanDBP_ANC32),
                                               is_severe_ghtn(meanSBP_ANC36, meanDBP_ANC36),
                                               is_severe_ghtn(meanSBP_IPC, meanDBP_IPC),
                                               is_severe_ghtn(meanSBP_Hosp_ANC, meanDBP_Hosp_ANC), na.rm = TRUE) >=1) & # just need one high measurement 
                                            CHRON_HYPER==0, 1, 0),
         # OVERWRITES 0 WITH NA when all these vars are NA:
         SEVERE_GT20_HTN_MEAS = ifelse(all(is.na(c(meanSBP_ANC20, meanDBP_ANC20, meanSBP_ANC28, meanDBP_ANC28,
                                                     meanSBP_ANC32, meanDBP_ANC32, meanSBP_ANC36, meanDBP_ANC36,
                                                     meanSBP_IPC, meanDBP_IPC, meanSBP_Hosp_ANC, meanDBP_Hosp_ANC))),
                                         as.numeric(NA),
                                         # OTHERWISE, IT LEAVES IT ALONE.
                                         SEVERE_GT20_HTN_MEAS))
           
table(SEVERE_GT20_HTN_MEAS = htn_df$SEVERE_GT20_HTN_MEAS, htn_df$SITE, useNA = "always")
round(prop.table(table(SEVERE_GT20_HTN_MEAS = htn_df$SEVERE_GT20_HTN_MEAS, SITE = htn_df$SITE, useNA = "always"), margin=2)*100,2)           
           
# temp.df <- htn_df %>% select(MOMID, PREGID, GEST_HYPER_MEAS, starts_with("M04_HTN_CMTRT_")) # I DON'T NEED THIS CHRONIC HTN MEDICATION TREATMENT DATA. 
```

# HYPERTENSION MEASURED 2+ OR (1 MEASURED & TREATMENT) OR SEVERE HTN >20 weeks (FINAL)
```{r}
# EVEN IF BP MEASUREMENTS ARE PRESENT BUT WE DON'T HAVE PROTEINRUIA IN ANC_IPC INFO. THEN GHTN CAN'T BE DETERMINED.
htn_df <- htn_df %>%
  mutate(GT20_HTN_MEAS_ANY = case_when(((GT20_MEAS1_TREAT==1 | GT20_HTN_MEAS_ANY2 ==1 | 
                                   SEVERE_GT20_HTN_MEAS ==1 & CHRON_HYPER==0)) ~ 1,
                                (all(is.na(c(GT20_MEAS1_TREAT, 
                                             GT20_HTN_MEAS_ANY2, 
                                             SEVERE_GT20_HTN_MEAS))))  ~ as.numeric(NA), 
                                TRUE ~ as.numeric(0)))

table(GT20_HTN_MEAS_ANY = htn_df$GT20_HTN_MEAS_ANY, htn_df$SITE, useNA = "always")
round(prop.table(table(GT20_HTN_MEAS_ANY = htn_df$GT20_HTN_MEAS_ANY, SITE = htn_df$SITE, useNA = "always"), margin=2)*100,2) 

temp.df <- htn_df %>%
  select(MOMID, SITE, GT20_HTN_MEAS_ANY, GT20_MEAS1_TREAT, GT20_HTN_MEAS_ANY2, SEVERE_GT20_HTN_MEAS) %>%
  filter(SITE=="Zambia")
```


########################################################
# HELLP (MAT_HELLP)
Presence of all lab abnormalities: hemolysis, elevated liver enzymes, and low platelet count.

# MNH08	AST_ul_LBORRES	Provide AST/SGOT test results:  Units/L
# Constructed	MAT_ANEMIA_ANY	Any maternal anemia
# MNH08	TBILIRUBIN_LBORRES	Provide Total Bilirubin test results:  µmol/L
# MNH08	DBILIRUBIN_LBORRES	Provide Direct Bilirubin test results:  µmol/L
# MNH08	ALP_LBORRES	Provide Alkaline phosphatase (ALP) test results:  Units/L
# MNH08	GAMMAGT_LBORRES	Provide Gamma GT test results:  units/L
# MNH08	CBC_PLATE_LBORRES	Provide results: Platelets count:  x10³/mm³

# CREAT_umoll_LBORRES - COMES FROM KIDNEYS - SO THIS DOESN'T GO IN HELLP DEFINITION. 
# ---- THIS SHOULD JUST HAVE: HEMOLYSIS, ELEVATED LIVER ENZYMES, AND LOW PLATELETS. 

# BILIRUBIN AT ANC-32 (VIST 4), PNC0 (VIST 7), PNC1 (VISIT 8)
# BILRUBIN >1.2 MG/DL OR 20.52 UMOL/L
```{r}
###################
# Results that will help confirm hemolysis are an elevated reticulocyte count, 
# increased lactate dehydrogenase (LDH), elevated unconjugated bilirubin, 
# and decreased Haptoglobin. LDH is found intracellularly, 
 #therefore when RBCs rupture, this value increases. Haptoglobin binds free hemoglobin

# - USE INDIRECT BILIRUBIN (UNCONJUGATED) IN HEMOLYSIS MEASURE - THIS IS SERUM BILI.
# - USE DIRECT BILI (CONJUGATED) IN LIVER DX.

# i can only measure hemolysis (severe anemia + bili) at week 32 with MNH08 b/c maternal bili is only checked then. 
# --> I don't think it makes sense to look at severe anemia at any point in pregnancy and only look at bili at week 32 and call it hemolysis.
# What about at L&D? - IT IS NOT CHECKED AT L&D. 

#####################
# MATERNAL HEMOLYSIS - ONLY AT ANC-32
#####################
htn_df <- htn_df %>%
  mutate(MAT_HEMOLYSIS = case_when((MAT_ANEMIA_MEAS4 == "severe" & M08_IBILIRUBIN_LBORRES_4 >=20.52) ~ 1,
                                   (is.na(MAT_ANEMIA_MEAS4) | is.na(M08_IBILIRUBIN_LBORRES_4)) ~ as.numeric(NA),
                                    TRUE ~ as.numeric(0)))
                               
table(MAT_HEMOLYSIS = htn_df$MAT_HEMOLYSIS, SITE = htn_df$SITE, useNA = "always")
round(prop.table(table(MAT_HEMOLYSIS = htn_df$MAT_HEMOLYSIS, SITE = htn_df$SITE, useNA = "always"), margin=2)*100, 2)

temp.df <- htn_df %>% select(MOMID, SITE, MAT_HEMOLYSIS, MAT_ANEMIA_MEAS4, M08_IBILIRUBIN_LBORRES_4) %>%
  filter(SITE=="Pakistan")

####################
# HELLP
####################
#TODO ADD HOSPITALIZATION VISIT ALSO
# HEELP DOESN'T INCLUDE CREATININE B/C IT'S KIDNEY FN.

# In our data dictionary: 
# AST upper normal range is set to: 45
# ALT upper normal range is set to: 60
htn_df <- htn_df %>%
  mutate(MAT_HELLP = case_when((MAT_HEMOLYSIS ==1 | M08_AST_UL_LBORRES_4 >= 90 | M08_ALT_UL_LBORRES_4 >= 120 | # AST AND ALT 2X THE UPPER NORMAL RANGE
                                  (M08_CBC_PLATE_LBORRES_4 >=0 & M08_CBC_PLATE_LBORRES_4 < 100)) ~ 1,
                               # DURING HOSPITALIZATION:
                               # Hospitalization - there is no bilirubin so can't create hemolysis.
                               ((M19_CBC_PLATELET_LBORRES_13>=0 & M19_CBC_PLATELET_LBORRES_13 < 100) |
                                  M19_AST_UL_LBORRES_13 >=90 | M19_ALT_UL_LBORRES_13 >=120) ~ 1,  # Creatinine is umol/L
                               
                               all(is.na(c(MAT_HEMOLYSIS, M08_AST_UL_LBORRES_4, M08_ALT_UL_LBORRES_4, 
                                         M08_CBC_PLATE_LBORRES_4,
                                         M19_CBC_PLATELET_LBORRES_13,
                                         M19_AST_UL_LBORRES_13, M19_ALT_UL_LBORRES_13))) ~ as.numeric(NA),
                               TRUE ~ as.numeric(0)))

table(MAT_HELLP = htn_df$MAT_HELLP, SITE = htn_df$SITE, useNA = "always")
round(prop.table(table(MAT_HELLP = htn_df$MAT_HELLP, SITE = htn_df$SITE, useNA = "always"), margin=2)*100, 2)

temp.df <- htn_df %>%
  select(MOMID, SITE, MAT_HELLP, MAT_HEMOLYSIS, M08_AST_UL_LBORRES_4, M08_ALT_UL_LBORRES_4, M08_CBC_PLATE_LBORRES_4,
         M19_CBC_PLATELET_LBORRES_13, M19_CREAT_LBORRESU_13, M19_AST_UL_LBORRES_13, M19_ALT_UL_LBORRES_13) %>%
  filter(SITE=="Kenya")
```

# SEVERE FEATURES OF PREECLAMPISA (MEASURED): is HELLP and renal insufficiency (measured by creatinine levels)
- Severe gestational hypertension (systolic >160 mmHg OR a diastolic >110 mmHg on two occasions at least 1 minute apart >20 weeks gestation or one occasion at delivery)
- Hepatic abnormality (serum transaminase concentration AST or ALT ≥2 times the upper limit of the normal range)
- Thrombocytopenia (<100,000 platelets/microL)
- Hemolysis (serum bilirubin ≥1.2 mg/dL (20.52 umol/L) and hemoglobin <7 g/dL)
- Rental insufficiency (serum creatinine >1.1 mg/dL or 97.26umol/dl)

# NOTE: SEVERE gHTN IS MEASURED AT SEVERAL TP BEYOND 20 WEEK GESTATION BUT OTHER FEATURES SUCH AS HEMOLYSIS, LIVER, PLATELET, AND KIDNEY ARE ONLY DONE AT WEEK 32. 

# SEV_GEST_HYPER
# MAT_HELLP
# CBC_PLATE_LBORRES
# CREAT_umoll_LBORRES

# AST: NORMAL RANGE = 3-45
# ALT: NORMAL RANGE = 2-60
```{r}
##################################################################################
#TODO 
# NOTES: 
# - SEVERE gHTN IS MEASURED AT SEVERAL TP BEYOND 20 WEEK GESTATION BUT OTHER FEATURES SUCH AS:
# --------HEMOLYSIS, LIVER, PLATELET, AND KIDNEY AR ONLY DONE AT WEEK 32. 
# FIX CREAT 1.1 THRESHOLD.  1.1 is in mg/dL.  This data is in mmol
##################################################################################
# IF A WOMAN HAS SEVERE HTN AND HELLP, THEN SHE HAS SEVERE FEATURES OF PREECLAMPSIA.
htn_df <- htn_df %>%
  mutate(MAT_PE_SEV_MEAS = case_when((SEVERE_GT20_HTN_MEAS==1  |
                                        MAT_HELLP==1 |
                                        M08_CREAT_UMOLL_LBORRES_4 > 97.26 |  # 1.1mg/dl or 97.26umol/dl KIDNEY FUNCTION 
                                        M19_CREAT_LBORRESU_13 >97.26) ~ 1, #HOSPITALIZATION;  Creatinine 97.26umol/dl
                                     all(is.na(c(SEVERE_GT20_HTN_MEAS, MAT_HELLP,
                                        M08_CREAT_UMOLL_LBORRES_4, M19_CREAT_LBORRESU_13))) ~ as.numeric(NA),
                                     TRUE ~ as.numeric(0)))

table(MAT_PE_SEV_MEAS = htn_df$MAT_PE_SEV_MEAS, SITE = htn_df$SITE, useNA = "always" )
round(prop.table(table(MAT_PE_SEV_MEAS = htn_df$MAT_PE_SEV_MEAS, SITE = htn_df$SITE, useNA = "always" ), margin=2)*100, 2)
                                         
```

# INDIVIDUALS VARIABLES FOR SEVERE FEATURES
```{r}
# M08_AST_UL_LBORRES_4 >= 90 | M08_ALT_UL_LBORRES_4 >= 120
# M19_AST_UL_LBORRES_13 >=90 | M19_ALT_UL_LBORRES_13 >=120
# MAT_ANEMIA_MEAS4 == "severe" & M08_IBILIRUBIN_LBORRES_4 >=20.52

# SEVERE HTN AFTER 20 WEEKS GA:
# SEVERE_GT20_HTN_MEAS
htn_df <- htn_df %>% 
  mutate(SEVERE_HTN = case_when((SEVERE_GT20_HTN_MEAS==1) ~ 1,
                         is.na(SEVERE_GT20_HTN_MEAS)~ as.numeric(NA),
                         TRUE ~ 0))

temp.df <- htn_df %>% 
  select(MOMID, SITE, SEVERE_HTN, SEVERE_GT20_HTN_MEAS)

# ANEMIA
htn_df <- htn_df %>% 
  mutate(ANEMIA = case_when((MAT_ANEMIA_MEAS4=="severe") ~ 1,
                         is.na(MAT_ANEMIA_MEAS4)~ as.numeric(NA),
                         TRUE ~ 0))

temp.df <- htn_df %>% 
  select(MOMID, SITE, MAT_ANEMIA_MEAS4, ANEMIA)

# Billirubin
htn_df <- htn_df %>% 
  mutate(BILIRUBIN = case_when((M08_IBILIRUBIN_LBORRES_4 >=20.52) ~ 1,
                         is.na(M08_IBILIRUBIN_LBORRES_4)~ as.numeric(NA),
                         TRUE ~ 0))

temp.df <- htn_df %>% 
  select(MOMID, SITE, M08_IBILIRUBIN_LBORRES_4, BILIRUBIN)


# AST
htn_df <- htn_df %>% 
  mutate(AST = case_when((M08_AST_UL_LBORRES_4 >= 90 | M19_AST_UL_LBORRES_13 >=90) ~ 1,
                         (is.na(M08_AST_UL_LBORRES_4) & is.na(M19_AST_UL_LBORRES_13 >=90))~ as.numeric(NA),
                         TRUE ~ 0))

temp.df <- htn_df %>% 
  select(MOMID, SITE, M08_AST_UL_LBORRES_4, M19_AST_UL_LBORRES_13, AST)

# ALT
htn_df <- htn_df %>% 
  mutate(ALT = case_when((M08_ALT_UL_LBORRES_4 >= 120 | M19_ALT_UL_LBORRES_13 >=120) ~ 1,
                         is.na(M08_ALT_UL_LBORRES_4) & is.na(M19_ALT_UL_LBORRES_13) ~ as.numeric(NA),
                         TRUE ~ 0))

# PLATELETS:
# (M08_CBC_PLATE_LBORRES_4 >=0 & M08_CBC_PLATE_LBORRES_4 < 100)
htn_df <- htn_df %>% 
  mutate(PLATELETS = case_when(((M08_CBC_PLATE_LBORRES_4 >=0 & M08_CBC_PLATE_LBORRES_4 < 100) | 
                                 (M19_CBC_PLATELET_LBORRES_13>=0 & M19_CBC_PLATELET_LBORRES_13 < 100)) ~ 1,
                         (is.na(M08_CBC_PLATE_LBORRES_4) & is.na(M19_CBC_PLATELET_LBORRES_13)) ~ as.numeric(NA),
                         TRUE ~ 0))

temp.df <- htn_df %>% 
  select(MOMID, SITE, PLATELETS, M08_CBC_PLATE_LBORRES_4, M19_CBC_PLATELET_LBORRES_13)

# CREATININE 
#  M08_CREAT_UMOLL_LBORRES_4 > 97.26 |  M19_CREAT_LBORRESU_13 >97.26)
htn_df <- htn_df %>% 
  mutate(CREATININE = case_when((M08_CREAT_UMOLL_LBORRES_4 > 97.26 | M19_CREAT_LBORRESU_13 >97.26) ~ 1,
                         (is.na(M08_CREAT_UMOLL_LBORRES_4) & is.na(M19_CREAT_LBORRESU_13)) ~ as.numeric(NA),
                         TRUE ~ 0))

temp.df <- htn_df %>% 
  select(MOMID, SITE, CREATININE, M08_CREAT_UMOLL_LBORRES_4,  M19_CREAT_LBORRESU_13)

```

###############################
# BASELINE PROTEINURIA - LOOKS GOOD!
# I looked at both visit 1 and 2 but as long as they were <20 weeks testing.
```{r}
# AT ENROLLMENT
temp.df <- htn_df %>% select(MOMID, SITE, M08_GA_AT_VISIT_1, M08_GA_AT_VISIT_2) %>% 
  filter(M08_GA_AT_VISIT_1/7<20 | (M08_GA_AT_VISIT_2/7)<20)


htn_df <- htn_df %>% filter(M08_GA_AT_VISIT_1/7<20 | M08_GA_AT_VISIT_2/7<20) %>% 
  mutate(PROTEINURIA_BASELINE = case_when(((M08_GA_AT_VISIT_1/7<20) & M08_UA_PROT_LBORRES_1 %in% c(1,2)) |
                                          ((M08_GA_AT_VISIT_2/7<20) & M08_UA_PROT_LBORRES_2 %in% c(1,2)) ~ 1,
                                          (is.na(M08_UA_PROT_LBORRES_1) & is.na(M08_UA_PROT_LBORRES_2)) ~ as.numeric(NA),
                                          TRUE ~ 0))

table(htn_df$PROTEINURIA_BASELINE, htn_df$SITE, useNA = "always")
round(prop.table(table(htn_df$PROTEINURIA_BASELINE, htn_df$SITE, useNA = "always"), margin=2)*100,2)

temp.df <- htn_df %>% select(MOMID, SITE, PROTEINURIA_BASELINE, 
                             M08_GA_AT_VISIT_1, M08_GA_AT_VISIT_2, 
                             M08_UA_PROT_LBORRES_1, M08_UA_PROT_LBORRES_2)
```


# GESTATIONAL PROTEINURIA - PROTEINURIA***
24 hour urine collection >300 mg protein OR single voided urine protein/creatinine ratio ≥0.3 OR Dipstick of 1+ or 2+.
Measured ANC20,28,32,36
IPC
ANC Hospitalizations.
And those who don't have proteinuria at baseline.  If baseline missing, it's included here.
```{r echo=FALSE}
# STARTING FROM VISIT 2 (ANC20)

# DIPSTICK IS NOT REQUIRED AT DELIVERY

# is.na(M08_GA_AT_VISIT_2) ~ as.numeric(NA), - I could put this code inside case_when() and it would give me NA when GA at visit2 is NA but i've decided not to do this b/c by the time she has her 4th ANC visit, her GA will def. be greater than 20 weeks and if she has a proteinuria result, she has gestational proteinuria.

htn_df <- htn_df %>% 
  mutate(PROTEINURIA_ANC_IPC = case_when((M08_GA_AT_VISIT_2/7>=20 | is.na(M08_GA_AT_VISIT_2)) &
                                           (any(c(M08_UA_PROT_LBORRES_2, M08_UA_PROT_LBORRES_3, 
                                                  M08_UA_PROT_LBORRES_4, M08_UA_PROT_LBORRES_5, 
                                                  M08_UA_PROT_LBORRES_6, 
                                                  # Hospitalization
                                                  M19_UA_PROT_LBORRES_13) %in% c(1,2)) &
                                              (PROTEINURIA_BASELINE==0 | is.na(PROTEINURIA_BASELINE))) ~ 1, 
                                         
                                         #THIS IS SAYING IF ALL OF THESE VARS ARE 55, 77, OR NA THEN THE NEW VAR IS NA 
                                         all(c(M08_UA_PROT_LBORRES_2,M08_UA_PROT_LBORRES_3, 
                                               M08_UA_PROT_LBORRES_4, M08_UA_PROT_LBORRES_5, 
                                               M08_UA_PROT_LBORRES_6, M08_UA_PROT_LBORRES_13,
                                               # Hospitalization during ANC:
                                               M19_UA_PROT_LBORRES_13) %in% c(55, 77, NA)) ~ as.numeric(NA),
                                         TRUE ~ 0))

table(PROTEINURIA_ANC_IPC = htn_df$PROTEINURIA_ANC_IPC, SITE = htn_df$SITE, useNA = "always")
round(prop.table(table(PROTEINURIA_ANC_IPC = htn_df$PROTEINURIA_ANC_IPC, SITE = htn_df$SITE, useNA = "always"), margin=2)*100,2)

temp.df <- htn_df %>% 
  select(MOMID, SITE, M08_GA_AT_VISIT_2, PROTEINURIA_BASELINE,PROTEINURIA_ANC_IPC, MAT_PE_SEV_MEAS,
         M08_UA_PROT_LBORRES_2,
         M08_UA_PROT_LBORRES_3,M08_UA_PROT_LBORRES_4,
         M08_UA_PROT_LBORRES_5,M08_UA_PROT_LBORRES_6,
         M08_UA_PROT_LBORRES_13,
         M19_UA_PROT_LBORRES_13)

```


# GESTAITONAL HYPERTENSION - No cHTN, NO PROTEINURIA (FINAL)
```{r}
# EVEN IF BP MEASUREMENTS ARE PRESENT BUT WE DON'T HAVE PROTEINRUIA IN ANC_IPC INFO. THEN GHTN CAN'T BE DETERMINED.
htn_df <- htn_df %>%
  mutate(GEST_HYPER = case_when(((GT20_HTN_MEAS_ANY ==1 | SEVERE_GT20_HTN_MEAS==1) & 
                                   CHRON_HYPER==0 & PROTEINURIA_ANC_IPC==0 &  MAT_PE_SEV_MEAS==0) ~ 1,
                                (is.na(GT20_HTN_MEAS_ANY) | is.na(PROTEINURIA_ANC_IPC) | 
                                   is.na(CHRON_HYPER) | is.na(MAT_PE_SEV_MEAS)) ~ as.numeric(NA), 
                                TRUE ~ as.numeric(0)))

table(GEST_HYPER = htn_df$GEST_HYPER, htn_df$SITE, useNA = "always")
round(prop.table(table(GEST_HYPER = htn_df$GEST_HYPER, SITE = htn_df$SITE, useNA = "always"), margin=2)*100,2) 

temp.df <- htn_df %>%
  select(MOMID, SITE, GEST_HYPER, PROTEINURIA_ANC_IPC, CHRON_HYPER, SEVERE_GT20_HTN_MEAS, GT20_HTN_MEAS_ANY,  MAT_PE_SEV_MEAS) 
```


# PREECLAMPSIA (PE) MEASURED (FINAL)
```{r}
htn_df <- htn_df %>%
  mutate(MAT_PE_MEAS = case_when((GT20_HTN_MEAS_ANY==1 & PROTEINURIA_ANC_IPC==1) | 
                                       (GT20_HTN_MEAS_ANY==1 &  MAT_PE_SEV_MEAS==1) |
                                       (CHRON_HYPER==1 & PROTEINURIA_ANC_IPC==1) |
                                       (CHRON_HYPER==1 & MAT_PE_SEV_MEAS==1) ~ 1,
                                     ((is.na(GT20_HTN_MEAS_ANY) & is.na(PROTEINURIA_ANC_IPC)) | 
                                       (is.na(GT20_HTN_MEAS_ANY) & is.na(MAT_PE_SEV_MEAS)) | 
                                       (is.na(CHRON_HYPER) & is.na(PROTEINURIA_ANC_IPC)) | 
                                       (is.na(CHRON_HYPER) & is.na(MAT_PE_SEV_MEAS))) ~ as.numeric(NA),
                                     TRUE ~ 0))


table(MAT_PE_MEAS = htn_df$MAT_PE_MEAS, SITE = htn_df$SITE, useNA = "always")
round(prop.table(table(MAT_PE_MEAS = htn_df$MAT_PE_MEAS, SITE = htn_df$SITE, useNA = "always"), margin=2)*100, 2)

temp.df <- htn_df %>% 
  select(MOMID, SITE, MAT_PE_MEAS, GT20_HTN_MEAS_ANY, PROTEINURIA_ANC_IPC, MAT_PE_SEV_MEAS, CHRON_HYPER) 

```

# HDP
if severe_features = 1 then HDP = "PE w severe features";
else if severe_features=0 and cHTN = 1 and PE = 1 then HDP =  "PE superimposed on chronic htn";
else if severe_features=0 and gHTN = 1 and PE = 1 then HDP =  "PE";
else if severe_features=0 and gHTN = 1 and PE = 0 then HDP =  "gestational hypertension";
else if severe_features=0 and cHTN = 1 and PE = 0 then HDP =  "chronic hypertension";
else HDP = "none";
```{r}
htn_df <- htn_df %>%
  mutate(HDP = case_when(MAT_PE_SEV_MEAS==1 ~ "PE with severe features",
                         MAT_PE_SEV_MEAS==0 & CHRON_HYPER==1 & MAT_PE_MEAS==1 ~ "PE superimposed on cHTN",
                         MAT_PE_SEV_MEAS==0 & GEST_HYPER==1 & MAT_PE_MEAS==1 ~ "PE", 
                         MAT_PE_SEV_MEAS==0 & GEST_HYPER==1 & MAT_PE_MEAS==0 ~ "gHTN", 
                         MAT_PE_SEV_MEAS==0 &  CHRON_HYPER==1 & MAT_PE_MEAS==0 ~ "cHTN",
                          MAT_PE_SEV_MEAS==0 & GEST_HYPER==0 & CHRON_HYPER==0 & MAT_PE_MEAS==1 ~ "PE",
                         
                         MAT_PE_SEV_MEAS==0 & CHRON_HYPER==0 & MAT_PE_MEAS==0 ~ "No HDP",
                         MAT_PE_SEV_MEAS==0 & GEST_HYPER==0 & MAT_PE_MEAS==0 ~ "No HDP",
                         MAT_PE_SEV_MEAS==0 & 
                           (CHRON_HYPER==0 | is.na(CHRON_HYPER)) & 
                           (GEST_HYPER==0 | is.na(GEST_HYPER)) & 
                           (MAT_PE_MEAS==0 | is.na(MAT_PE_MEAS)) ~ "No HDP",
                         
                         ((is.na(MAT_PE_SEV_MEAS) & is.na(CHRON_HYPER) & is.na(MAT_PE_MEAS)) | 
                            (is.na(MAT_PE_SEV_MEAS) & is.na(GEST_HYPER) & is.na(MAT_PE_MEAS))) ~ as.character(NA)))

table(HDP = htn_df$HDP, SITE = htn_df$SITE, useNA = "always")
round(prop.table(table(HDP = htn_df$HDP, SITE = htn_df$SITE, useNA = "always"), margin=2)*100, 2)

temp.df <- htn_df %>%
  select(MOMID, SITE, HDP, MAT_PE_SEV_MEAS, CHRON_HYPER, MAT_PE_MEAS, GEST_HYPER)
```

# INVESTIGATING MISSINGNESS
```{r}
# MNH08 at enrollment
temp.df <- htn_df %>%
  select(MOMID, SITE, DELIVERED_FF.x, M08_MAT_VISIT_MNH08_1, M08_MAT_VISIT_FORM_COMPLETED_1, ENROLL_PASS)

temp.df %>% summarize(sum = n())

# Gestational Proteinuria

```

# WRITE CSV OUT FOR HTML
```{r}

write.csv(htn_df, '../data_out/mat_htn_tables_20231017.csv')

```

